generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
  lastLogin DateTime?

  // Facebook connection
  fbUserId   String?
  fbUserName String?
  fbAvatar   String?
  fbToken    String?
  fbTokenExp DateTime?
  fbPages    String?  @default("[]")

  posts         Post[]
  conversations Conversation[]

  @@map("users")
}

model Post {
  id        String   @id @default(cuid())
  content   String
  mediaUrls String[] @default([])
  status    String   @default("pending")
  postFbId  String?
  errorMsg  String?

  scheduledAt DateTime?
  postedAt    DateTime?
  repeatType  String?

  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId Int
  pageId   String
  pageName String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  @@map("posts")
}

// ── Conversation: 1 cuộc hội thoại trên 1 Page ──────────────
model Conversation {
  id             String   @id                    // Facebook conversation ID
  pageId         String                           // Page ID chứa conversation
  pageName       String?                          // Tên Page
  participantId  String?                          // Facebook ID của người dùng
  participantName String?                         // Tên người dùng
  participantAvatar String?                       // Avatar người dùng
  snippet        String?                          // Tin nhắn mới nhất (preview)
  unreadCount    Int      @default(0)
  updatedTime    DateTime?                        // Thời gian cập nhật từ FB
  canReply       Boolean  @default(true)

  // Relation
  owner    User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  ownerId  Int
  messages Message[]

  fetchedAt DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([pageId])
  @@index([ownerId])
  @@map("conversations")
}

// ── Message: 1 tin nhắn trong conversation ──────────────────
model Message {
  id             String   @id                    // Facebook message ID
  conversationId String                           // FK -> conversations.id
  pageId         String                           // Page ID (để query nhanh)
  fromId         String?                          // ID người gửi
  fromName       String?                          // Tên người gửi
  toId           String?                          // ID người nhận
  toName         String?                          // Tên người nhận
  message        String?  @db.Text               // Nội dung tin nhắn
  attachments    String?  @default("[]")          // JSON array attachments
  isFromPage     Boolean  @default(false)         // true = Page gửi, false = user gửi
  createdTime    DateTime?                        // Thời gian gửi từ FB

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  fetchedAt DateTime @default(now())

  @@index([conversationId])
  @@index([pageId])
  @@index([createdTime])
  @@map("messages")
}
