<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Human Agent — GenZTech</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Inter',sans-serif;background:#060b1a;color:#e2e8f0;display:flex;min-height:100vh;overflow:hidden}

    /* ── Sidebar ── */
    .sidebar{width:240px;flex-shrink:0;background:rgba(10,14,39,.92);backdrop-filter:blur(20px);border-right:1px solid rgba(255,255,255,.06);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:40}
    .sidebar-logo{padding:18px 18px 14px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;gap:10px;text-decoration:none}
    .sidebar-logo img{width:34px;height:34px;border-radius:50%}
    .sidebar-logo span{font-size:14px;font-weight:700;letter-spacing:.5px;color:#fff}
    .sidebar-logo span em{color:#00d4ff;font-style:normal}
    .sidebar-nav{flex:1;padding:10px 0;overflow-y:auto}
    .nav-group-label{font-size:10px;font-weight:600;letter-spacing:1.2px;color:rgba(255,255,255,.3);text-transform:uppercase;padding:10px 18px 4px}
    .nav-item{display:flex;align-items:center;gap:10px;padding:9px 18px;font-size:13px;color:rgba(255,255,255,.6);text-decoration:none;transition:all .2s;border-left:2px solid transparent}
    .nav-item:hover{color:#fff;background:rgba(255,255,255,.04)}
    .nav-item.active{color:#00d4ff;background:rgba(0,212,255,.08);border-left-color:#00d4ff}
    .nav-item i{width:17px;text-align:center;font-size:14px}
    .nav-sub{display:none;padding-left:0}
    .nav-sub.open{display:block}
    .nav-sub-item{display:flex;align-items:center;gap:10px;padding:7px 18px 7px 44px;font-size:12px;color:rgba(255,255,255,.5);text-decoration:none;transition:all .2s}
    .nav-sub-item:hover{color:#fff;background:rgba(255,255,255,.04)}
    .nav-sub-item.active{color:#00d4ff}
    .sidebar-footer{padding:14px 18px;border-top:1px solid rgba(255,255,255,.06)}

    /* ── Main Layout ── */
    .main-content{margin-left:240px;flex:1;display:flex;flex-direction:column;height:100vh;overflow:hidden}
    .topbar{padding:14px 24px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;justify-content:space-between;background:rgba(10,14,39,.8);backdrop-filter:blur(10px);flex-shrink:0}
    .topbar-title{font-size:15px;font-weight:700;color:#fff;display:flex;align-items:center;gap:8px}
    .topbar-title i{color:#00d4ff}
    .topbar-actions{display:flex;align-items:center;gap:8px}

    /* ── Tabs ── */
    .tabs-bar{display:flex;gap:0;border-bottom:1px solid rgba(255,255,255,.06);background:rgba(10,14,39,.6);flex-shrink:0;padding:0 24px}
    .tab-btn{padding:12px 18px;font-size:13px;font-weight:500;color:rgba(255,255,255,.5);background:none;border:none;border-bottom:2px solid transparent;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:6px;white-space:nowrap}
    .tab-btn:hover{color:#fff}
    .tab-btn.active{color:#00d4ff;border-bottom-color:#00d4ff}
    .tab-badge{background:rgba(0,212,255,.15);color:#00d4ff;font-size:10px;font-weight:700;padding:1px 6px;border-radius:10px;min-width:18px;text-align:center}
    .tab-badge.red{background:rgba(239,68,68,.15);color:#f87171}

    /* ── Content Area ── */
    .content-area{flex:1;overflow:hidden;display:flex}
    .panel{display:none;width:100%;height:100%;overflow-y:auto;padding:24px}
    .panel.active{display:flex;flex-direction:column;gap:20px}

    /* ── Stats Row ── */
    .stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
    .stat-card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:12px;padding:16px 18px;display:flex;align-items:center;gap:14px}
    .stat-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
    .stat-icon.blue{background:rgba(0,212,255,.1);color:#00d4ff}
    .stat-icon.green{background:rgba(34,197,94,.1);color:#22c55e}
    .stat-icon.orange{background:rgba(249,115,22,.1);color:#f97316}
    .stat-icon.purple{background:rgba(168,85,247,.1);color:#a855f7}
    .stat-label{font-size:11px;color:rgba(255,255,255,.4);margin-bottom:2px}
    .stat-value{font-size:20px;font-weight:700;color:#fff}

    /* ── Page Grid ── */
    .page-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
    .page-card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:14px;padding:18px;transition:all .2s;cursor:pointer;position:relative}
    .page-card:hover{border-color:rgba(0,212,255,.3);background:rgba(0,212,255,.04)}
    .page-card.enabled{border-color:rgba(34,197,94,.3)}
    .page-card-header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
    .page-avatar{width:44px;height:44px;border-radius:50%;object-fit:cover;background:rgba(255,255,255,.1);display:flex;align-items:center;justify-content:center;font-size:18px;color:rgba(255,255,255,.4);flex-shrink:0}
    .page-avatar img{width:44px;height:44px;border-radius:50%;object-fit:cover}
    .page-name{font-size:14px;font-weight:600;color:#fff;margin-bottom:2px}
    .page-id{font-size:11px;color:rgba(255,255,255,.3)}
    .page-status{position:absolute;top:14px;right:14px}
    .toggle-switch{position:relative;width:38px;height:20px;cursor:pointer}
    .toggle-switch input{opacity:0;width:0;height:0}
    .toggle-slider{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,.15);border-radius:20px;transition:.3s}
    .toggle-slider:before{content:'';position:absolute;width:14px;height:14px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s}
    input:checked + .toggle-slider{background:#22c55e}
    input:checked + .toggle-slider:before{transform:translateX(18px)}
    .page-meta{display:flex;gap:12px;margin-bottom:14px}
    .page-meta-item{font-size:11px;color:rgba(255,255,255,.4);display:flex;align-items:center;gap:4px}
    .page-meta-item i{font-size:12px;color:#00d4ff}
    .page-actions{display:flex;gap:8px}
    .btn-sm{padding:6px 12px;font-size:12px;font-weight:500;border-radius:7px;border:none;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:5px}
    .btn-sm.primary{background:rgba(0,212,255,.15);color:#00d4ff;border:1px solid rgba(0,212,255,.2)}
    .btn-sm.primary:hover{background:rgba(0,212,255,.25)}
    .btn-sm.danger{background:rgba(239,68,68,.1);color:#f87171;border:1px solid rgba(239,68,68,.2)}
    .btn-sm.danger:hover{background:rgba(239,68,68,.2)}
    .btn-sm.success{background:rgba(34,197,94,.1);color:#22c55e;border:1px solid rgba(34,197,94,.2)}
    .btn-sm.success:hover{background:rgba(34,197,94,.2)}
    .btn-sm.gray{background:rgba(255,255,255,.06);color:rgba(255,255,255,.6);border:1px solid rgba(255,255,255,.1)}
    .btn-sm.gray:hover{background:rgba(255,255,255,.1);color:#fff}

    /* ── Conversations Panel ── */
    .conv-layout{display:flex;gap:0;height:100%;overflow:hidden}

    /* Page Selector Sidebar */
    .page-selector{width:64px;flex-shrink:0;border-right:1px solid rgba(255,255,255,.06);display:flex;flex-direction:column;overflow-y:auto;overflow-x:hidden;background:rgba(0,0,0,.15)}
    .page-selector::-webkit-scrollbar{width:3px}
    .page-selector::-webkit-scrollbar-track{background:transparent}
    .page-selector::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:2px}
    .page-selector-header{padding:10px 0 6px;text-align:center;flex-shrink:0}
    .page-selector-label{font-size:9px;color:rgba(255,255,255,.3);text-transform:uppercase;letter-spacing:.5px}
    .page-chip{position:relative;display:flex;flex-direction:column;align-items:center;padding:8px 4px;cursor:pointer;transition:all .2s;border-radius:0;gap:4px}
    .page-chip:hover{background:rgba(255,255,255,.05)}
    .page-chip.active{background:rgba(0,212,255,.08);border-right:2px solid #00d4ff}
    .page-chip-avatar{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:#fff;flex-shrink:0;transition:all .2s;border:2px solid transparent}
    .page-chip.active .page-chip-avatar{border-color:#00d4ff;box-shadow:0 0 8px rgba(0,212,255,.3)}
    .page-chip-name{font-size:8px;color:rgba(255,255,255,.35);text-align:center;line-height:1.2;max-width:56px;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;word-break:break-word}
    .page-chip.active .page-chip-name{color:rgba(0,212,255,.8)}
    .page-chip-badge{position:absolute;top:4px;right:4px;background:#6b7280;color:#fff;font-size:8px;font-weight:700;padding:1px 4px;border-radius:8px;min-width:14px;text-align:center;line-height:1.4;transition:background .2s}
    .page-chip.active .page-chip-badge{background:#22c55e}
    .page-chip-unread{position:absolute;bottom:4px;right:4px;background:#ef4444;color:#fff;font-size:7px;font-weight:700;padding:1px 3px;border-radius:6px;min-width:12px;text-align:center;line-height:1.4}
    .page-chip.active::after{content:'\2713';position:absolute;top:2px;left:4px;font-size:8px;color:#22c55e;font-weight:900;line-height:1}
    .page-chip-all{display:flex;flex-direction:column;align-items:center;padding:10px 4px 8px;cursor:pointer;transition:all .2s;border-bottom:1px solid rgba(255,255,255,.06);gap:4px}
    .page-chip-all:hover{background:rgba(255,255,255,.05)}
    .page-chip-all.active{background:rgba(0,212,255,.08);border-right:2px solid #00d4ff}
    .page-chip-all-icon{width:36px;height:36px;border-radius:10px;background:rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;font-size:16px;color:rgba(255,255,255,.5);transition:all .2s;border:2px solid transparent}
    .page-chip-all.active .page-chip-all-icon{border-color:#00d4ff;color:#00d4ff;box-shadow:0 0 8px rgba(0,212,255,.3)}
    .page-chip-all-label{font-size:8px;color:rgba(255,255,255,.35);text-align:center}
    .page-chip-all.active .page-chip-all-label{color:rgba(0,212,255,.8)}

    /* Conversation List */
    .conv-list{width:300px;flex-shrink:0;border-right:1px solid rgba(255,255,255,.06);display:flex;flex-direction:column;background:rgba(0,0,0,.08)}
    .conv-list-header{padding:12px 14px 8px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
    .conv-list-title{font-size:13px;font-weight:600;color:#fff;display:flex;align-items:center;gap:6px}
    .conv-list-count{font-size:11px;color:rgba(255,255,255,.35);font-weight:400}
    .conv-search{padding:8px 12px;border-bottom:1px solid rgba(255,255,255,.06);flex-shrink:0;position:relative}
    .conv-search-icon{position:absolute;left:20px;top:50%;transform:translateY(-50%);color:rgba(255,255,255,.3);font-size:12px;pointer-events:none}
    .conv-search input{width:100%;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:20px;padding:7px 12px 7px 30px;font-size:12px;color:#fff;outline:none;transition:all .2s}
    .conv-search input:focus{background:rgba(255,255,255,.08);border-color:rgba(0,212,255,.3)}
    .conv-search input::placeholder{color:rgba(255,255,255,.25)}
    .conv-items-wrap{flex:1;overflow-y:auto}
    .conv-items-wrap::-webkit-scrollbar{width:4px}
    .conv-items-wrap::-webkit-scrollbar-track{background:transparent}
    .conv-items-wrap::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:2px}
    .conv-items-wrap::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.2)}
    .conv-item{padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.03);cursor:pointer;transition:background .15s;display:flex;gap:10px;align-items:flex-start}
    .conv-item:hover{background:rgba(255,255,255,.04)}
    .conv-item.active{background:rgba(0,212,255,.07);border-left:2px solid #00d4ff}
    .conv-item.pending{border-left:2px solid #f97316}
    .conv-avatar{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;color:#fff;flex-shrink:0;font-weight:700;letter-spacing:-.5px}
    .conv-info{flex:1;min-width:0}
    .conv-name-row{display:flex;align-items:center;gap:5px;margin-bottom:1px}
    .conv-name{font-size:12.5px;font-weight:600;color:#e2e8f0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;min-width:0}
    .conv-page-tag{font-size:9px;color:rgba(255,255,255,.3);background:rgba(255,255,255,.06);padding:1px 5px;border-radius:4px;white-space:nowrap;flex-shrink:0;max-width:80px;overflow:hidden;text-overflow:ellipsis}
    .conv-last{font-size:11px;color:rgba(255,255,255,.35);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px}
    .conv-bottom{display:flex;align-items:center;justify-content:space-between;margin-top:3px}
    .conv-time{font-size:10px;color:rgba(255,255,255,.25);flex-shrink:0}
    .badge-unread{background:#f97316;color:#fff;font-size:9px;font-weight:700;padding:1px 5px;border-radius:10px;min-width:16px;text-align:center}
    .badge-pending{background:rgba(249,115,22,.12);color:#f97316;font-size:9px;padding:1px 5px;border-radius:4px;border:1px solid rgba(249,115,22,.2)}

    /* ── Chat Area ── */
    .chat-area{flex:1;display:flex;flex-direction:column;overflow:hidden}
    .chat-header{padding:14px 20px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
    .chat-header-info{display:flex;align-items:center;gap:10px}
    .chat-header-name{font-size:14px;font-weight:600;color:#fff}
    .chat-header-sub{font-size:11px;color:rgba(255,255,255,.4)}
    .chat-messages{flex:1;overflow-y:auto;padding:16px 20px;display:flex;flex-direction:column;gap:10px}
    .msg-row{display:flex;gap:8px;align-items:flex-end}
    .msg-row.user{flex-direction:row}
    .msg-row.assistant{flex-direction:row-reverse}
    .msg-bubble{max-width:70%;padding:10px 14px;border-radius:14px;font-size:13px;line-height:1.5}
    .msg-bubble.user{background:rgba(255,255,255,.08);color:#e2e8f0;border-bottom-left-radius:4px}
    .msg-bubble.assistant.ai{background:rgba(0,212,255,.1);color:#e2e8f0;border-bottom-right-radius:4px;border:1px solid rgba(0,212,255,.15)}
    .msg-bubble.assistant.human{background:rgba(34,197,94,.1);color:#e2e8f0;border-bottom-right-radius:4px;border:1px solid rgba(34,197,94,.15)}
    .msg-meta{font-size:10px;color:rgba(255,255,255,.3);margin-top:3px;display:flex;align-items:center;gap:4px}
    .msg-avatar{width:28px;height:28px;border-radius:50%;background:rgba(255,255,255,.1);display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0}
    .chat-input-area{padding:14px 20px;border-top:1px solid rgba(255,255,255,.06);flex-shrink:0}
    .chat-input-row{display:flex;gap:8px;align-items:flex-end}
    .chat-input{flex:1;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:10px 14px;font-size:13px;color:#fff;outline:none;resize:none;min-height:40px;max-height:120px;font-family:inherit}
    .chat-input:focus{border-color:rgba(0,212,255,.4)}
    .chat-input::placeholder{color:rgba(255,255,255,.3)}
    .chat-send-btn{padding:10px 16px;background:#00d4ff;color:#000;border:none;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:6px}
    .chat-send-btn:hover{background:#00b8d9}
    .chat-empty{flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px;color:rgba(255,255,255,.3)}
    .chat-empty i{font-size:48px;opacity:.3}
    .chat-empty p{font-size:14px}

    /* ── Config Panel ── */
    .config-layout{display:grid;grid-template-columns:260px 1fr;gap:20px;height:100%}
    .config-sidebar{display:flex;flex-direction:column;gap:12px}
    .config-page-item{padding:12px 14px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:10px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:10px}
    .config-page-item:hover{border-color:rgba(0,212,255,.2)}
    .config-page-item.active{border-color:#00d4ff;background:rgba(0,212,255,.06)}
    .config-page-name{font-size:13px;font-weight:500;color:#fff}
    .config-page-sub{font-size:11px;color:rgba(255,255,255,.4)}
    .config-main{overflow-y:auto;display:flex;flex-direction:column;gap:20px}
    .config-section{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:14px;padding:20px}
    .config-section-title{font-size:14px;font-weight:600;color:#fff;margin-bottom:16px;display:flex;align-items:center;gap:8px}
    .config-section-title i{color:#00d4ff}
    .form-group{margin-bottom:14px}
    .form-label{font-size:12px;font-weight:500;color:rgba(255,255,255,.6);margin-bottom:6px;display:block}
    .form-input{width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:9px 12px;font-size:13px;color:#fff;outline:none;font-family:inherit;transition:border-color .2s}
    .form-input:focus{border-color:rgba(0,212,255,.4)}
    .form-input::placeholder{color:rgba(255,255,255,.3)}
    textarea.form-input{resize:vertical;min-height:80px}
    .form-hint{font-size:11px;color:rgba(255,255,255,.3);margin-top:4px}

    /* ── Documents ── */
    .doc-list{display:flex;flex-direction:column;gap:8px;margin-bottom:14px}
    .doc-item{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:10px 14px;display:flex;align-items:center;gap:10px}
    .doc-icon{width:32px;height:32px;border-radius:7px;background:rgba(0,212,255,.1);color:#00d4ff;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
    .doc-name{font-size:13px;color:#fff;font-weight:500;flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .doc-size{font-size:11px;color:rgba(255,255,255,.3)}
    .upload-zone{border:2px dashed rgba(255,255,255,.15);border-radius:10px;padding:24px;text-align:center;cursor:pointer;transition:all .2s}
    .upload-zone:hover,.upload-zone.dragover{border-color:rgba(0,212,255,.4);background:rgba(0,212,255,.04)}
    .upload-zone i{font-size:28px;color:rgba(255,255,255,.3);display:block;margin-bottom:8px}
    .upload-zone p{font-size:13px;color:rgba(255,255,255,.4)}
    .upload-zone span{font-size:11px;color:rgba(255,255,255,.25)}

    /* ── Rules ── */
    .rule-item{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:12px 14px;display:flex;gap:12px;align-items:flex-start}
    .rule-content{flex:1;min-width:0}
    .rule-trigger{font-size:12px;font-weight:600;color:#00d4ff;margin-bottom:4px;display:flex;align-items:center;gap:6px}
    .rule-response{font-size:12px;color:rgba(255,255,255,.6);line-height:1.4}

    /* ── Buttons ── */
    .btn{padding:9px 18px;font-size:13px;font-weight:600;border-radius:8px;border:none;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
    .btn.primary{background:#00d4ff;color:#000}
    .btn.primary:hover{background:#00b8d9}
    .btn.secondary{background:rgba(255,255,255,.08);color:#fff;border:1px solid rgba(255,255,255,.12)}
    .btn.secondary:hover{background:rgba(255,255,255,.12)}
    .btn.danger{background:rgba(239,68,68,.15);color:#f87171;border:1px solid rgba(239,68,68,.2)}
    .btn.danger:hover{background:rgba(239,68,68,.25)}
    .btn.success{background:rgba(34,197,94,.15);color:#22c55e;border:1px solid rgba(34,197,94,.2)}
    .btn.success:hover{background:rgba(34,197,94,.25)}
    .btn:disabled{opacity:.4;cursor:not-allowed}

    /* ── Modal ── */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:1000;display:none;align-items:center;justify-content:center;padding:20px}
    .modal-overlay.open{display:flex}
    .modal{background:#0d1530;border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:28px;width:100%;max-width:520px;max-height:80vh;overflow-y:auto}
    .modal-title{font-size:16px;font-weight:700;color:#fff;margin-bottom:20px;display:flex;align-items:center;gap:8px}
    .modal-title i{color:#00d4ff}
    .modal-footer{display:flex;gap:10px;justify-content:flex-end;margin-top:20px;padding-top:16px;border-top:1px solid rgba(255,255,255,.06)}

    /* ── Setup Banner ── */
    .setup-banner{background:linear-gradient(135deg,rgba(0,212,255,.08),rgba(168,85,247,.08));border:1px solid rgba(0,212,255,.2);border-radius:14px;padding:20px 24px;display:flex;align-items:center;gap:16px}
    .setup-banner-icon{font-size:32px;color:#00d4ff;flex-shrink:0}
    .setup-banner-title{font-size:15px;font-weight:700;color:#fff;margin-bottom:4px}
    .setup-banner-desc{font-size:13px;color:rgba(255,255,255,.5);line-height:1.5}

    /* ── Toast ── */
    .toast-container{position:fixed;bottom:24px;right:24px;z-index:9999;display:flex;flex-direction:column;gap:8px}
    .toast{padding:12px 18px;border-radius:10px;font-size:13px;font-weight:500;display:flex;align-items:center;gap:8px;animation:slideIn .3s ease;max-width:320px}
    .toast.success{background:#0d2e1a;border:1px solid rgba(34,197,94,.3);color:#22c55e}
    .toast.error{background:#2e0d0d;border:1px solid rgba(239,68,68,.3);color:#f87171}
    .toast.info{background:#0d1e2e;border:1px solid rgba(0,212,255,.3);color:#00d4ff}
    @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

    /* ── Webhook Info ── */
    .webhook-box{background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:12px 14px;font-family:monospace;font-size:12px;color:#00d4ff;word-break:break-all;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .webhook-box span{flex:1}
    .copy-btn{padding:4px 10px;background:rgba(0,212,255,.1);border:1px solid rgba(0,212,255,.2);color:#00d4ff;border-radius:5px;font-size:11px;cursor:pointer;white-space:nowrap;transition:all .2s}
    .copy-btn:hover{background:rgba(0,212,255,.2)}

    /* ── Test Chat ── */
    .test-chat{background:rgba(0,0,0,.2);border-radius:10px;padding:14px;display:flex;flex-direction:column;gap:10px}
    .test-chat-messages{min-height:120px;max-height:200px;overflow-y:auto;display:flex;flex-direction:column;gap:8px}
    .test-msg{padding:8px 12px;border-radius:10px;font-size:12px;max-width:80%}
    .test-msg.user{background:rgba(255,255,255,.08);align-self:flex-start}
    .test-msg.ai{background:rgba(0,212,255,.1);border:1px solid rgba(0,212,255,.15);align-self:flex-end;color:#e2e8f0}
    .test-input-row{display:flex;gap:8px}
    .test-input{flex:1;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:7px;padding:8px 10px;font-size:12px;color:#fff;outline:none;font-family:inherit}
    .test-input:focus{border-color:rgba(0,212,255,.4)}

    /* ── Empty State ── */
    .empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:48px 24px;color:rgba(255,255,255,.3);text-align:center;gap:12px}
    .empty-state i{font-size:40px;opacity:.4}
    .empty-state p{font-size:14px}
    .empty-state span{font-size:12px;opacity:.7}

    /* ── Loading ── */
    .loading-spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.2);border-top-color:#00d4ff;border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

    /* ── Responsive ── */
    @media(max-width:768px){.sidebar{display:none}.main-content{margin-left:0}.stats-row{grid-template-columns:repeat(2,1fr)}.config-layout{grid-template-columns:1fr}.conv-list{width:100%}}
  </style>
</head>
<body>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- ── Sidebar ── -->
<aside class="sidebar">
  <a href="index.html" class="sidebar-logo">
    <img src="images/logo.png" alt="GZ" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
    <div style="width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#00d4ff,#0066ff);display:none;align-items:center;justify-content:center;font-weight:800;font-size:13px;color:#fff">GZ</div>
    <span>GENZ<em>TECH</em></span>
  </a>
  <nav class="sidebar-nav">
    <div class="nav-group-label">Tổng Quan</div>
    <a href="maindashboard.html" class="nav-item"><i class="bi bi-grid-1x2-fill"></i> Dashboard</a>
    <div class="nav-group-label">Công Cụ</div>
    <a href="auto-post.html" class="nav-item"><i class="bi bi-send"></i> Tự Động Đăng Bài</a>
    <a href="ads-assistant.html" class="nav-item" onclick="toggleSubNav(event,'subNavAds')">
      <i class="bi bi-megaphone"></i> Trợ Lý Quảng Cáo <i class="bi bi-chevron-down" style="margin-left:auto;font-size:10px"></i>
    </a>
    <div class="nav-sub" id="subNavAds">
      <a href="tool-ad-account.html" class="nav-sub-item"><i class="bi bi-shield-check"></i> Kiểm Tra TKQC</a>
      <a href="tool-fb-id.html" class="nav-sub-item"><i class="bi bi-person-badge"></i> Tìm Facebook ID</a>
      <a href="tool-budget.html" class="nav-sub-item"><i class="bi bi-graph-up-arrow"></i> Phân Tích Ngân Sách</a>
      <a href="tool-translate.html" class="nav-sub-item"><i class="bi bi-translate"></i> Dịch Thuật</a>
      <a href="tool-ads-finder.html" class="nav-sub-item"><i class="bi bi-binoculars"></i> Ads Finder</a>
      <a href="tool-policy.html" class="nav-sub-item"><i class="bi bi-journal-text"></i> Chính Sách FB</a>
      <a href="tool-cookie.html" class="nav-sub-item"><i class="bi bi-cookie"></i> Quản Lý Cookie</a>
    </div>
    <a href="tool-human-agent.html" class="nav-item active"><i class="bi bi-robot"></i> AI Human Agent</a>
    <a href="#" class="nav-item" onclick="openSettings()"><i class="bi bi-gear"></i> Cài Đặt</a>
  </nav>
  <div class="sidebar-footer">
    <div style="font-size:11px;color:rgba(255,255,255,.3)">GenzTech v3.0</div>
    <div id="serverStatus" style="font-size:11px;color:rgba(255,255,255,.3);margin-top:4px;display:flex;align-items:center;gap:4px">
      <span id="serverDot" style="width:6px;height:6px;border-radius:50%;background:#666;display:inline-block"></span>
      <span id="serverLabel">Chưa kết nối server</span>
    </div>
  </div>
</aside>

<!-- ── Main Content ── -->
<div class="main-content">
  <!-- Topbar -->
  <div class="topbar">
    <div class="topbar-title">
      <i class="bi bi-robot"></i>
      AI Human Agent
    </div>
    <div class="topbar-actions">
      <div id="pollingStatus" style="display:none;align-items:center;gap:5px;font-size:11px;color:rgba(255,255,255,.4);margin-right:4px">
        <span style="width:6px;height:6px;border-radius:50%;background:#22c55e;display:inline-block"></span>
        <span>Live</span>
      </div>
      <button class="btn secondary" onclick="openSetupModal()" style="font-size:12px">
        <i class="bi bi-key"></i> Nhập Token
      </button>
      <button class="btn primary" onclick="syncPages()" id="syncBtn" style="font-size:12px">
        <i class="bi bi-arrow-repeat"></i> Đồng bộ Pages
      </button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs-bar">
    <button class="tab-btn active" id="tab-overview" onclick="switchTab('overview')">
      <i class="bi bi-grid"></i> Tổng quan
    </button>
    <button class="tab-btn" id="tab-conversations" onclick="switchTab('conversations')">
      <i class="bi bi-chat-dots"></i> Hội thoại
      <span class="tab-badge" id="badge-conversations" style="display:none">0</span>
    </button>
    <button class="tab-btn" id="tab-config" onclick="switchTab('config')">
      <i class="bi bi-sliders"></i> Cấu hình AI
    </button>
    <button class="tab-btn" id="tab-setup" onclick="switchTab('setup')">
      <i class="bi bi-info-circle"></i> Hướng dẫn
    </button>
  </div>

  <!-- Content -->
  <div class="content-area">

    <!-- ══ PANEL: Overview ══ -->
    <div class="panel active" id="panel-overview">
      <!-- Stats -->
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-icon blue"><i class="bi bi-facebook"></i></div>
          <div>
            <div class="stat-label">Tổng Pages</div>
            <div class="stat-value" id="stat-total-pages">0</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon green"><i class="bi bi-robot"></i></div>
          <div>
            <div class="stat-label">AI đang bật</div>
            <div class="stat-value" id="stat-enabled-pages">0</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon orange"><i class="bi bi-chat-dots"></i></div>
          <div>
            <div class="stat-label">Hội thoại</div>
            <div class="stat-value" id="stat-conversations">0</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon purple"><i class="bi bi-envelope-open"></i></div>
          <div>
            <div class="stat-label">Chưa đọc</div>
            <div class="stat-value" id="stat-pending">0</div>
          </div>
        </div>
      </div>

      <!-- Setup Banner (hiện khi chưa có pages) -->
      <div class="setup-banner" id="setupBanner" style="display:none">
        <div class="setup-banner-icon"><i class="bi bi-rocket-takeoff"></i></div>
        <div style="flex:1">
          <div class="setup-banner-title">Bắt đầu sử dụng AI Human Agent</div>
          <div class="setup-banner-desc">Nhấn <strong>"Đồng bộ Pages"</strong> để tải danh sách Facebook Pages của bạn, sau đó cấu hình AI cho từng Page.</div>
        </div>
        <button class="btn primary" onclick="syncPages()"><i class="bi bi-arrow-repeat"></i> Đồng bộ ngay</button>
      </div>

      <!-- Page Grid -->
      <div>
        <div style="font-size:13px;font-weight:600;color:rgba(255,255,255,.6);margin-bottom:14px;display:flex;align-items:center;justify-content:space-between">
          <span>Danh sách Pages</span>
          <span id="pageCount" style="font-size:12px;color:rgba(255,255,255,.3)">0 pages</span>
        </div>
        <div class="page-grid" id="pageGrid">
          <div class="empty-state" style="grid-column:1/-1">
            <i class="bi bi-facebook"></i>
            <p>Chưa có Pages nào</p>
            <span>Nhập Facebook Token và nhấn "Đồng bộ Pages"</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ══ PANEL: Conversations ══ -->
    <div class="panel" id="panel-conversations" style="padding:0">
      <div class="conv-layout" style="height:100%">

        <!-- Page Selector Sidebar -->
        <div class="page-selector" id="pageSelectorSidebar">
          <div class="page-selector-header">
            <div class="page-selector-label">Pages</div>
          </div>
          <!-- "Tất cả" chip -->
          <div class="page-chip-all active" id="pageChipAll" onclick="selectedPageIds.clear();renderPageChips();filterConversations()">
            <div class="page-chip-all-icon"><i class="bi bi-grid-3x3-gap"></i></div>
            <div class="page-chip-all-label">Tất cả</div>
          </div>
          <!-- Page chips will be rendered here by JS -->
          <div id="pageChipList"></div>
        </div>

        <!-- Conversation List -->
        <div class="conv-list">
          <div class="conv-list-header">
            <span class="conv-list-title">
              Hội thoại
              <span class="conv-list-count" id="convListCount"></span>
            </span>
            <button onclick="loadConversationsDirect(true)" style="background:none;border:none;color:rgba(255,255,255,.4);cursor:pointer;padding:4px 6px;font-size:13px;border-radius:6px;transition:all .2s" title="Tải lại" onmouseover="this.style.background='rgba(255,255,255,.08)'" onmouseout="this.style.background='none'">
              <i class="bi bi-arrow-clockwise"></i>
            </button>
          </div>
          <div class="conv-search">
            <i class="bi bi-search conv-search-icon"></i>
            <input type="text" placeholder="Tìm tên khách hàng..." id="convSearch" oninput="filterConversations()">
          </div>
          <!-- Hidden select for backward compat -->
          <select id="convPageFilter" style="display:none"><option value="">Tất cả Pages</option></select>
          <div class="conv-items-wrap" id="convList">
            <div class="empty-state">
              <i class="bi bi-chat-dots"></i>
              <p>Chưa có hội thoại</p>
            </div>
          </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
          <div class="chat-empty" id="chatEmpty">
            <i class="bi bi-chat-square-dots"></i>
            <p>Chọn một hội thoại để xem</p>
          </div>
          <div id="chatView" style="display:none;flex-direction:column;height:100%">
            <div class="chat-header">
              <div class="chat-header-info">
                <div class="conv-avatar" id="chatAvatar">U</div>
                <div>
                  <div class="chat-header-name" id="chatName">Người dùng</div>
                  <div class="chat-header-sub" id="chatSub">Page: —</div>
                </div>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                <button class="btn-sm gray" id="btnRefreshMsgs" title="Tải lại tin nhắn" style="padding:6px 10px">
                  <i class="bi bi-arrow-clockwise"></i>
                </button>
                <button class="btn-sm gray" id="btnTakeover" onclick="takeoverConv()">
                  <i class="bi bi-person-raised-hand"></i> Tiếp quản
                </button>
                <button class="btn-sm success" id="btnRelease" onclick="releaseConv()" style="display:none">
                  <i class="bi bi-robot"></i> Trả về AI
                </button>
              </div>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-area">
              <div id="humanAgentTag" style="display:none;margin-bottom:8px">
                <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:rgba(255,255,255,.5);cursor:pointer">
                  <input type="checkbox" id="useHumanTag" checked style="accent-color:#f97316">
                  Dùng Human Agent Tag (cho phép nhắn tin sau 24h)
                </label>
              </div>
              <div class="chat-input-row">
                <textarea class="chat-input" id="chatInput" placeholder="Nhập tin nhắn..." rows="1"
                  onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendHumanReply()}"
                  oninput="autoResize(this)"></textarea>
                <button class="chat-send-btn" onclick="sendHumanReply()">
                  <i class="bi bi-send"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ══ PANEL: Config ══ -->
    <div class="panel" id="panel-config" style="padding:0;overflow:hidden">
      <div class="config-layout" style="padding:24px;height:100%;overflow:hidden">
        <!-- Config Sidebar: Page List -->
        <div class="config-sidebar" style="overflow-y:auto">
          <div style="font-size:12px;font-weight:600;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.8px;margin-bottom:4px">Chọn Page</div>
          <div id="configPageList">
            <div class="empty-state" style="padding:24px 0">
              <i class="bi bi-facebook"></i>
              <p style="font-size:12px">Chưa có Pages</p>
            </div>
          </div>
        </div>

        <!-- Config Main -->
        <div class="config-main" id="configMain">
          <div class="empty-state" style="height:100%;justify-content:center">
            <i class="bi bi-sliders"></i>
            <p>Chọn một Page để cấu hình</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ══ PANEL: Setup Guide ══ -->
    <div class="panel" id="panel-setup">
      <div style="max-width:720px">
        <div style="font-size:20px;font-weight:700;color:#fff;margin-bottom:6px">Hướng dẫn cài đặt AI Human Agent</div>
        <div style="font-size:13px;color:rgba(255,255,255,.4);margin-bottom:24px">Làm theo các bước dưới đây để kích hoạt AI tự động trả lời Messenger</div>

        <div style="display:flex;flex-direction:column;gap:16px">
          <!-- Step 1 -->
          <div class="config-section">
            <div class="config-section-title"><i class="bi bi-1-circle-fill"></i> Tạo Facebook App</div>
            <p style="font-size:13px;color:rgba(255,255,255,.5);line-height:1.7;margin-bottom:12px">
              Truy cập <a href="https://developers.facebook.com/apps/" target="_blank" style="color:#00d4ff">Facebook Developers</a> → Tạo App mới → Chọn loại <strong style="color:#fff">Business</strong> → Thêm sản phẩm <strong style="color:#fff">Messenger</strong>.
            </p>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
              <div class="form-group" style="margin:0">
                <div class="form-label">App ID</div>
                <div class="webhook-box"><span id="displayAppId">Chưa cấu hình</span></div>
              </div>
              <div class="form-group" style="margin:0">
                <div class="form-label">Webhook Verify Token</div>
                <div class="webhook-box"><span id="displayVerifyToken">genztech_webhook_2024</span></div>
              </div>
            </div>
          </div>

          <!-- Step 2 -->
          <div class="config-section">
            <div class="config-section-title"><i class="bi bi-2-circle-fill"></i> Cấu hình Webhook</div>
            <p style="font-size:13px;color:rgba(255,255,255,.5);line-height:1.7;margin-bottom:12px">
              Trong Facebook App → Messenger → Webhooks → Thêm Callback URL và Verify Token:
            </p>
            <div class="form-group">
              <div class="form-label">Callback URL (Webhook URL)</div>
              <div class="webhook-box">
                <span id="webhookUrl">Chưa cấu hình Server URL</span>
                <button class="copy-btn" onclick="copyText('webhookUrl')"><i class="bi bi-copy"></i> Copy</button>
              </div>
            </div>
            <div class="form-group">
              <div class="form-label">Verify Token</div>
              <div class="webhook-box">
                <span id="verifyTokenDisplay">genztech_webhook_2024</span>
                <button class="copy-btn" onclick="copyText('verifyTokenDisplay')"><i class="bi bi-copy"></i> Copy</button>
              </div>
            </div>
            <p style="font-size:12px;color:rgba(255,255,255,.4)">
              <i class="bi bi-info-circle" style="color:#00d4ff"></i>
              Subscribed fields cần chọn: <code style="background:rgba(255,255,255,.08);padding:1px 6px;border-radius:4px">messages</code>, <code style="background:rgba(255,255,255,.08);padding:1px 6px;border-radius:4px">messaging_postbacks</code>
            </p>
          </div>

          <!-- Step 3 -->
          <div class="config-section">
            <div class="config-section-title"><i class="bi bi-3-circle-fill"></i> Kết nối Pages</div>
            <p style="font-size:13px;color:rgba(255,255,255,.5);line-height:1.7;margin-bottom:12px">
              Nhập Facebook Access Token (cần quyền <code style="background:rgba(255,255,255,.08);padding:1px 5px;border-radius:3px">pages_messaging</code>, <code style="background:rgba(255,255,255,.08);padding:1px 5px;border-radius:3px">pages_show_list</code>) rồi nhấn <strong style="color:#fff">Đồng bộ Pages</strong>.
            </p>
            <button class="btn primary" onclick="syncPages()"><i class="bi bi-arrow-repeat"></i> Đồng bộ Pages ngay</button>
          </div>

          <!-- Step 4 -->
          <div class="config-section">
            <div class="config-section-title"><i class="bi bi-4-circle-fill"></i> Cấu hình AI cho từng Page</div>
            <p style="font-size:13px;color:rgba(255,255,255,.5);line-height:1.7">
              Vào tab <strong style="color:#fff">Cấu hình AI</strong> → Chọn Page → Upload tài liệu kiến thức (PDF, Word, TXT...) → Thêm quy tắc Q&A → Bật AI → Nhấn <strong style="color:#fff">Đăng ký Webhook</strong>.
            </p>
          </div>

          <!-- Step 5 -->
          <div class="config-section">
            <div class="config-section-title"><i class="bi bi-5-circle-fill"></i> Kiểm tra và vận hành</div>
            <p style="font-size:13px;color:rgba(255,255,255,.5);line-height:1.7">
              Dùng tính năng <strong style="color:#fff">Test AI</strong> trong tab Cấu hình để kiểm tra phản hồi. Theo dõi hội thoại thực tế trong tab <strong style="color:#fff">Hội thoại</strong>. Khi cần, nhân viên có thể <strong style="color:#fff">Tiếp quản</strong> và dùng <strong style="color:#fff">Human Agent Tag</strong> để nhắn tin trong 7 ngày.
            </p>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /content-area -->
</div><!-- /main-content -->

<!-- ══ Modal: Setup Server ══ -->
<div class="modal-overlay" id="setupModal">
  <div class="modal">
    <div class="modal-title"><i class="bi bi-key"></i> Nhập Facebook Access Token</div>
    <div style="background:rgba(0,212,255,.06);border:1px solid rgba(0,212,255,.15);border-radius:10px;padding:12px 14px;margin-bottom:16px;font-size:12px;color:rgba(255,255,255,.6);line-height:1.7">
      <i class="bi bi-info-circle" style="color:#00d4ff"></i> Chỉ cần nhập <strong style="color:#fff">Facebook Access Token</strong> là đủ. AI backend đã được cấu hình sẵn.
    </div>
    <div class="form-group">
      <label class="form-label">Facebook Access Token <span style="color:#f87171">*</span></label>
      <input type="text" class="form-input" id="fbTokenInput" placeholder="EAALeRpq..." autocomplete="off">
      <div class="form-hint">Token cần quyền: <strong>pages_messaging</strong>, <strong>pages_show_list</strong>, <strong>pages_manage_metadata</strong></div>
    </div>
    <div style="margin-bottom:14px">
      <a href="https://developers.facebook.com/tools/explorer/" target="_blank" style="font-size:12px;color:#00d4ff;display:inline-flex;align-items:center;gap:5px">
        <i class="bi bi-box-arrow-up-right"></i> Lấy token tại Facebook Graph API Explorer
      </a>
    </div>
    <!-- Hidden fields for backward compat -->
    <input type="hidden" id="serverUrl" value="">
    <input type="hidden" id="verifyTokenInput" value="genztech_webhook_2024">
    <div class="modal-footer">
      <button class="btn secondary" onclick="closeModal('setupModal')">Hủy</button>
      <button class="btn primary" onclick="saveSetupSimple()"><i class="bi bi-check2"></i> Lưu & Tải Pages</button>
    </div>
  </div>
</div>

<!-- ══ Modal: Add Rule ══ -->
<div class="modal-overlay" id="ruleModal">
  <div class="modal">
    <div class="modal-title"><i class="bi bi-plus-circle"></i> <span id="ruleModalTitle">Thêm Quy Tắc</span></div>
    <input type="hidden" id="editRuleId">
    <div class="form-group">
      <label class="form-label">Từ khóa / Chủ đề kích hoạt <span style="color:#f87171">*</span></label>
      <input type="text" class="form-input" id="ruleTrigger" placeholder="Ví dụ: giá sản phẩm, thời gian giao hàng, chính sách đổi trả...">
      <div class="form-hint">Khi khách hỏi về chủ đề này, AI sẽ dùng câu trả lời bên dưới</div>
    </div>
    <div class="form-group">
      <label class="form-label">Câu trả lời <span style="color:#f87171">*</span></label>
      <textarea class="form-input" id="ruleResponse" rows="4" placeholder="Nhập câu trả lời chi tiết..."></textarea>
    </div>
    <div class="form-group">
      <label class="form-label">Danh mục</label>
      <select class="form-input" id="ruleCategory">
        <option value="general">Chung</option>
        <option value="product">Sản phẩm</option>
        <option value="price">Giá cả</option>
        <option value="shipping">Vận chuyển</option>
        <option value="policy">Chính sách</option>
        <option value="support">Hỗ trợ</option>
      </select>
    </div>
    <div class="modal-footer">
      <button class="btn secondary" onclick="closeModal('ruleModal')">Hủy</button>
      <button class="btn primary" onclick="saveRule()"><i class="bi bi-check2"></i> Lưu</button>
    </div>
  </div>
</div>

<script>
// ═══════════════════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════════════════
let SERVER_URL = localStorage.getItem('HA_SERVER_URL') || '';
let FB_TOKEN = localStorage.getItem('HA_FB_TOKEN') || localStorage.getItem('FB_TOKEN_MANUAL') || '';
let VERIFY_TOKEN = localStorage.getItem('HA_VERIFY_TOKEN') || 'genztech_webhook_2024';
let allPages = [];
let allConversations = [];
let selectedConvPageId = null;
let selectedConvUserId = null;
let selectedConfigPageId = null;
let convRefreshInterval = null;

// ═══════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════
document.addEventListener('DOMContentLoaded', async () => {
  // Hiển thị giá trị đã lưu
  if (SERVER_URL) {
    document.getElementById('serverUrl').value = SERVER_URL;
    document.getElementById('webhookUrl').textContent = `${SERVER_URL}/api/human-agent/webhook`;
  }
  if (FB_TOKEN) document.getElementById('fbTokenInput').value = FB_TOKEN;
  document.getElementById('verifyTokenInput').value = VERIFY_TOKEN;
  document.getElementById('verifyTokenDisplay').textContent = VERIFY_TOKEN;

  // Kiểm tra server
  if (SERVER_URL) await checkServerStatus();

  // Load pages
  await loadPages();

  // Auto-refresh conversations (only when no server — use direct FB API)
  convRefreshInterval = setInterval(() => {
    if (document.getElementById('panel-conversations').classList.contains('active')) {
      loadConversationsDirect(false); // false = không hiển thị spinner khi auto-refresh
    }
    loadStatsLocal();
  }, 30000);
});

// ═══════════════════════════════════════════════════════
// API HELPERS
// ═══════════════════════════════════════════════════════
async function api(method, path, body = null) {
  if (!SERVER_URL) throw new Error('Chưa cấu hình Server URL. Nhấn "Cài đặt Server" để thiết lập.');
  const opts = {
    method,
    headers: { 'Content-Type': 'application/json' }
  };
  if (body) opts.body = JSON.stringify(body);
  const r = await fetch(`${SERVER_URL}${path}`, opts);
  const data = await r.json();
  if (!r.ok) throw new Error(data.error || `HTTP ${r.status}`);
  return data;
}

async function apiUpload(path, formData) {
  if (!SERVER_URL) throw new Error('Chưa cấu hình Server URL');
  const r = await fetch(`${SERVER_URL}${path}`, { method: 'POST', body: formData });
  const data = await r.json();
  if (!r.ok) throw new Error(data.error || `HTTP ${r.status}`);
  return data;
}

// ═══════════════════════════════════════════════════════
// SERVER STATUS
// ═══════════════════════════════════════════════════════
async function checkServerStatus() {
  try {
    const r = await fetch(`${SERVER_URL}/health`, { signal: AbortSignal.timeout(5000) });
    if (r.ok) {
      document.getElementById('serverDot').style.background = '#22c55e';
      document.getElementById('serverLabel').textContent = 'Server đang hoạt động';
      return true;
    }
  } catch {}
  document.getElementById('serverDot').style.background = '#f87171';
  document.getElementById('serverLabel').textContent = 'Không kết nối được server';
  return false;
}

// ═══════════════════════════════════════════════════════
// SETUP
// ═══════════════════════════════════════════════════════
function openSetupModal() {
  document.getElementById('fbTokenInput').value = FB_TOKEN;
  openModal('setupModal');
}

// Simplified setup - only Facebook Token needed
async function saveSetupSimple() {
  const token = document.getElementById('fbTokenInput').value.trim();
  if (!token) return showToast('Vui lòng nhập Facebook Access Token', 'error');

  FB_TOKEN = token;
  localStorage.setItem('HA_FB_TOKEN', FB_TOKEN);
  localStorage.setItem('FB_TOKEN_MANUAL', FB_TOKEN);

  closeModal('setupModal');
  showToast('Đang tải danh sách Pages...', 'info');
  await loadPagesDirect();
  startPolling();
}

// Keep backward compat
async function saveSetup() {
  return saveSetupSimple();
}

// ═══════════════════════════════════════════════════════
// PAGES
// ═══════════════════════════════════════════════════════
async function loadPages() {
  try {
    const data = await api('GET', '/api/human-agent/pages');
    allPages = data.pages || [];
    renderPageGrid();
    renderConfigPageList();
    loadStatsLocal();
    updateConvPageFilter();
  } catch (err) {
    if (SERVER_URL) console.warn('Load pages:', err.message);
  }
}

async function syncPages() {
  if (!FB_TOKEN) {
    openSetupModal();
    return showToast('Vui lòng nhập Facebook Token trước', 'error');
  }
  if (!SERVER_URL) {
    openSetupModal();
    return showToast('Vui lòng cấu hình Server URL trước', 'error');
  }

  const btn = document.getElementById('syncBtn');
  btn.innerHTML = '<span class="loading-spinner"></span> Đang đồng bộ...';
  btn.disabled = true;

  try {
    const data = await api('POST', '/api/human-agent/pages/sync', { accessToken: FB_TOKEN });
    showToast(`Đồng bộ thành công ${data.count} Pages`, 'success');
    await loadPages();
    document.getElementById('setupBanner').style.display = 'none';
  } catch (err) {
    showToast('Lỗi đồng bộ: ' + err.message, 'error');
  } finally {
    btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Đồng bộ Pages';
    btn.disabled = false;
  }
}

function renderPageGrid() {
  const grid = document.getElementById('pageGrid');
  const countEl = document.getElementById('pageCount');
  countEl.textContent = `${allPages.length} pages`;

  if (allPages.length === 0) {
    grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1">
      <i class="bi bi-facebook"></i>
      <p>Chưa có Pages nào</p>
      <span>Nhập Facebook Token và nhấn "Đồng bộ Pages"</span>
    </div>`;
    document.getElementById('setupBanner').style.display = 'flex';
    return;
  }

  document.getElementById('setupBanner').style.display = 'none';
  grid.innerHTML = allPages.map(p => `
    <div class="page-card ${p.enabled ? 'enabled' : ''}" id="pageCard_${p.pageId}">
      <div class="page-status">
        <label class="toggle-switch" title="${p.enabled ? 'AI đang bật' : 'AI đang tắt'}">
          <input type="checkbox" ${p.enabled ? 'checked' : ''} onchange="togglePage('${p.pageId}', this.checked)">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="page-card-header">
        <div class="page-avatar">
          ${p.pageAvatar ? `<img src="${p.pageAvatar}" alt="${p.pageName}" onerror="this.parentElement.textContent='${p.pageName[0]}'">` : p.pageName[0]}
        </div>
        <div>
          <div class="page-name">${escHtml(p.pageName)}</div>
          <div class="page-id">${p.pageId}</div>
        </div>
      </div>
      <div class="page-meta">
        <div class="page-meta-item"><i class="bi bi-file-text"></i> ${p.documentCount} tài liệu</div>
        <div class="page-meta-item"><i class="bi bi-list-check"></i> ${p.ruleCount} quy tắc</div>
      </div>
      <div class="page-actions">
        <button class="btn-sm primary" onclick="openConfigPage('${p.pageId}')">
          <i class="bi bi-sliders"></i> Cấu hình
        </button>
        <button class="btn-sm success" onclick="subscribeWebhook('${p.pageId}')">
          <i class="bi bi-broadcast"></i> Webhook
        </button>
      </div>
    </div>
  `).join('');
}

async function togglePage(pageId, enabled) {
  try {
    await api('PUT', `/api/human-agent/pages/${pageId}`, { enabled });
    const page = allPages.find(p => p.pageId === pageId);
    if (page) page.enabled = enabled;
    const card = document.getElementById(`pageCard_${pageId}`);
    if (card) card.classList.toggle('enabled', enabled);
    showToast(enabled ? 'Đã bật AI cho Page này' : 'Đã tắt AI cho Page này', 'info');
    loadStatsLocal();
  } catch (err) {
    showToast('Lỗi: ' + err.message, 'error');
  }
}

async function subscribeWebhook(pageId) {
  try {
    await api('POST', `/api/human-agent/pages/${pageId}/subscribe`);
    showToast('Đã đăng ký webhook thành công!', 'success');
  } catch (err) {
    showToast('Lỗi đăng ký webhook: ' + err.message, 'error');
  }
}

// ═══════════════════════════════════════════════════════
// STATS
// ═══════════════════════════════════════════════════════
async function loadStats() {
  // Try server first, fallback to local
  if (SERVER_URL) {
    try {
      const data = await api('GET', '/api/human-agent/stats');
      document.getElementById('stat-total-pages').textContent = data.totalPages || 0;
      document.getElementById('stat-enabled-pages').textContent = data.enabledPages || 0;
      document.getElementById('stat-conversations').textContent = data.totalConversations || 0;
      document.getElementById('stat-pending').textContent = data.pendingHuman || 0;
      const pending = data.pendingHuman || 0;
      document.getElementById('badge-conversations').textContent = pending;
      document.getElementById('badge-conversations').style.display = pending > 0 ? 'inline-block' : 'none';
      return;
    } catch {}
  }
  loadStatsLocal();
}

function loadStatsLocal() {
  // Calculate stats from local data (no server needed)
  const totalPages = allPages.length;
  const enabledPages = allPages.filter(p => p.enabled).length;
  const totalConvs = allConversations.length;
  const pending = allConversations.filter(c => c.unread > 0 || c.unreadCount > 0).length;
  const el = (id, v) => { const e = document.getElementById(id); if (e) e.textContent = v; };
  el('stat-total-pages', totalPages);
  el('stat-enabled-pages', enabledPages);
  el('stat-conversations', totalConvs);
  el('stat-pending', pending);
  el('stat-convs', totalConvs);
  el('stat-waiting', pending);
  // Update tab badge for conversations
  const badge = document.getElementById('badge-conversations');
  if (badge) { 
    badge.textContent = totalConvs; 
    badge.style.display = totalConvs > 0 ? 'inline-block' : 'none';
    badge.className = pending > 0 ? 'tab-badge red' : 'tab-badge';
  }
  // Update stat-ai (enabled pages count)
  el('stat-ai', enabledPages);
}

// ═══════════════════════════════════════════════════════
// CONVERSATIONS
// ═══════════════════════════════════════════════════════
function updateConvPageFilter() {
  // Update hidden select for backward compat
  const sel = document.getElementById('convPageFilter');
  if (sel) {
    const current = sel.value;
    sel.innerHTML = '<option value="">Tất cả Pages</option>' +
      allPages.map(p => `<option value="${p.pageId}" ${current === p.pageId ? 'selected' : ''}>${escHtml(p.pageName)}</option>`).join('');
  }
  // Render page chips sidebar
  renderPageChips();
}

// Multi-select page filter state
let selectedPageIds = new Set(); // empty = all pages

function renderPageChips() {
  const container = document.getElementById('pageChipList');
  if (!container) return;
  container.innerHTML = allPages.map(p => {
    const color = getAvatarColor(p.pageId);
    const initials = (p.pageName || p.pageId).split(' ').slice(0,2).map(w=>w[0]).join('').toUpperCase().slice(0,2);
    const convCount = allConversations.filter(c => c.pageId === p.pageId).length;
    const unreadCount = allConversations.filter(c => c.pageId === p.pageId && (c.unread||c.unreadCount) > 0).length;
    const isActive = selectedPageIds.has(p.pageId);
    return `
    <div class="page-chip ${isActive ? 'active' : ''}" onclick="togglePageFilter('${p.pageId}')" title="${escHtml(p.pageName)}">
      <div class="page-chip-avatar" style="background:${color}">${initials}</div>
      <div class="page-chip-name">${escHtml((p.pageName||'').split(' ').slice(0,3).join(' '))}</div>
      ${convCount > 0 ? `<span class="page-chip-badge" style="background:${isActive?'#22c55e':'#6b7280'}">${convCount}</span>` : ''}
      ${unreadCount > 0 ? `<span class="page-chip-unread">${unreadCount}</span>` : ''}
    </div>
    `;
  }).join('');
  // Update "Tất cả" chip
  const allChip = document.getElementById('pageChipAll');
  if (allChip) allChip.classList.toggle('active', selectedPageIds.size === 0);
}

function togglePageFilter(pageId) {
  if (selectedPageIds.has(pageId)) {
    selectedPageIds.delete(pageId);
  } else {
    selectedPageIds.add(pageId);
  }
  renderPageChips();
  filterConversations();
}

function selectPageFilter(pageId) {
  // Legacy: single select (kept for backward compat)
  if (!pageId) {
    selectedPageIds.clear();
  } else {
    selectedPageIds.clear();
    selectedPageIds.add(pageId);
  }
  renderPageChips();
  filterConversations();
}

async function loadConversations(showLoading = true) {
  const pageFilter = document.getElementById('convPageFilter').value;
  const pagesToLoad = pageFilter ? [pageFilter] : allPages.map(p => p.pageId);

  allConversations = [];
  for (const pageId of pagesToLoad) {
    try {
      const data = await api('GET', `/api/human-agent/pages/${pageId}/conversations`);
      for (const conv of (data.conversations || [])) {
        conv.pageId = pageId;
        conv.pageName = allPages.find(p => p.pageId === pageId)?.pageName || pageId;
        allConversations.push(conv);
      }
    } catch {}
  }

  allConversations.sort((a, b) => b.lastTimestamp - a.lastTimestamp);
  renderConvList(allConversations);
}

// Avatar color palette for conversations
const AVATAR_COLORS = [
  '#6366f1','#8b5cf6','#ec4899','#f97316','#10b981','#06b6d4','#3b82f6','#f59e0b',
  '#ef4444','#14b8a6','#a855f7','#22c55e','#0ea5e9','#e11d48','#7c3aed','#059669'
];
function getAvatarColor(str) {
  let h = 0;
  for (let i = 0; i < (str||'').length; i++) h = (h * 31 + str.charCodeAt(i)) & 0xffffffff;
  return AVATAR_COLORS[Math.abs(h) % AVATAR_COLORS.length];
}

function renderConvList(convs) {
  const el = document.getElementById('convList');
  // Update count
  const countEl = document.getElementById('convListCount');
  if (countEl) countEl.textContent = convs.length > 0 ? convs.length : '';
  if (convs.length === 0) {
    el.innerHTML = `<div class="empty-state"><i class="bi bi-chat-dots"></i><p>Chưa có hội thoại</p></div>`;
    return;
  }
  // Check if showing all pages
  const pageFilter = document.getElementById('convPageFilter')?.value;
  const showPageTag = !pageFilter;
  el.innerHTML = convs.map(c => {
    const name = c.userName || ('Khách ' + c.userId.slice(-6));
    const initials = name.split(' ').slice(-2).map(w => w[0]).join('').toUpperCase().slice(0,2);
    const color = getAvatarColor(c.userId || c.convId || name);
    const pageShort = (c.pageName || '').split(' ').slice(0,3).join(' ');
    return `
    <div class="conv-item ${c.isPending ? 'pending' : ''} ${selectedConvUserId === c.userId ? 'active' : ''}"
      onclick="openConversation('${c.pageId}', '${c.userId}', '${escHtml(c.pageName)}')">
      <div class="conv-avatar" style="background:${color}">${initials}</div>
      <div class="conv-info">
        <div class="conv-name-row">
          <span class="conv-name">${escHtml(name)}</span>
          ${showPageTag && pageShort ? `<span class="conv-page-tag" title="${escHtml(c.pageName)}">${escHtml(pageShort)}</span>` : ''}
        </div>
        <div class="conv-last">${escHtml(c.lastMessage || '')}</div>
        <div class="conv-bottom">
          <div style="display:flex;gap:4px;align-items:center">
            ${c.isPending ? '<span class="badge-pending">Chờ HAgent</span>' : ''}
            ${(c.unread||c.unreadCount) > 0 ? `<span class="badge-unread">${c.unread||c.unreadCount}</span>` : ''}
          </div>
          <span class="conv-time">${formatTime(c.lastTimestamp || c.updatedAt)}</span>
        </div>
      </div>
    </div>
  `}).join('');
}

function filterConversations() {
  const q = document.getElementById('convSearch').value.toLowerCase();
  const filtered = allConversations.filter(c => {
    // Multi-select page filter: if no pages selected, show all
    if (selectedPageIds.size > 0 && !selectedPageIds.has(c.pageId)) return false;
    // Filter by search text
    if (q) {
      return (c.userName || '').toLowerCase().includes(q) ||
        (c.userId || '').toLowerCase().includes(q) ||
        (c.lastMessage || '').toLowerCase().includes(q) ||
        (c.pageName || '').toLowerCase().includes(q);
    }
    return true;
  });
  renderConvList(filtered);
}

async function openConversation(pageId, userId, pageName) {
  selectedConvPageId = pageId;
  selectedConvUserId = userId;

  // Find conversation in cache
  const conv = allConversations.find(c => c.userId === userId || c.convId === userId);
  const userName = conv?.userName || pageName || 'Khách hàng';
  const initials = userName.split(' ').slice(-2).map(w => w[0]).join('').toUpperCase() || 'K';
  const page = allPages.find(p => p.pageId === pageId);

  document.getElementById('chatEmpty').style.display = 'none';
  const chatView = document.getElementById('chatView');
  chatView.style.display = 'flex';

  document.getElementById('chatAvatar').textContent = initials;
  document.getElementById('chatName').textContent = userName;
  document.getElementById('chatSub').textContent = page ? `Page: ${page.pageName}` : `Page: ${pageName}`;

  // Update buttons
  const btnTakeover = document.getElementById('btnTakeover');
  const btnRelease = document.getElementById('btnRelease');
  if (btnTakeover) { btnTakeover.style.display = 'flex'; btnTakeover.onclick = () => takeoverConvDirect(conv?.fbConvId || userId); }
  if (btnRelease) { btnRelease.style.display = 'none'; }

  // Update send/input
  const chatInput = document.getElementById('chatInput');
  const sendBtn = document.querySelector('.chat-send-btn');
  if (chatInput) {
    chatInput.value = '';
    chatInput.onkeydown = function(e) {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessageDirect(conv?.fbConvId || userId, conv?.userId || userId); }
    };
  }
  if (sendBtn) sendBtn.onclick = () => sendMessageDirect(conv?.fbConvId || userId, conv?.userId || userId);

  // Load messages from Facebook API directly
  const container = document.getElementById('chatMessages');
  if (container) container.innerHTML = '<div style="text-align:center;padding:20px"><span class="loading-spinner"></span></div>';

  if (page && conv) {
    try {
      const convId = conv.fbConvId || conv.convId;
      // Use ?fields=messages endpoint which works with page token
      const url = `https://graph.facebook.com/v19.0/${convId}?fields=messages{id,message,from,created_time}&access_token=${page.accessToken}`;
      const r = await fetch(url);
      const d = await r.json();
      if (d.error) throw new Error(d.error.message);
      const msgs = (d.messages?.data || []).reverse();
      if (container) {
        if (!msgs.length) {
          container.innerHTML = '<div class="empty-state"><i class="bi bi-chat"></i><p>Chưa có tin nhắn</p></div>';
        } else {
          container.innerHTML = msgs.map(m => {
            const isPage = m.from?.id === pageId;
            const time = formatTime(m.created_time);
            return `<div class="msg-row ${isPage ? 'assistant' : 'user'}">
              ${!isPage ? `<div class="msg-avatar">${initials}</div>` : ''}
              <div>
                <div class="msg-bubble ${isPage ? 'assistant ai' : 'user'}">${escHtml(m.message || '')}</div>
                <div class="msg-meta">${time}</div>
              </div>
            </div>`;
          }).join('');
          container.scrollTop = container.scrollHeight;
        }
      }
    } catch(e) {
      if (container) container.innerHTML = `<div class="empty-state"><i class="bi bi-exclamation-triangle"></i><p>Lỗi: ${escHtml(e.message)}</p></div>`;
    }
  } else if (!page) {
    if (container) container.innerHTML = '<div class="empty-state"><p>Không tìm thấy Page token</p></div>';
  }

  // Update conv list active state
  document.querySelectorAll('.conv-item').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.conv-item').forEach(el => {
    if (el.getAttribute('onclick')?.includes(userId)) el.classList.add('active');
  });
}

function renderMessages(messages) {
  const el = document.getElementById('chatMessages');
  el.innerHTML = messages.map(m => {
    const isUser = m.role === 'user';
    const label = isUser ? '' : (m.isHuman ? '<i class="bi bi-person-fill"></i> Nhân viên' : '<i class="bi bi-robot"></i> AI');
    return `
      <div class="msg-row ${isUser ? 'user' : 'assistant'}">
        <div class="msg-avatar">${isUser ? '👤' : (m.isHuman ? '👨‍💼' : '🤖')}</div>
        <div>
          <div class="msg-bubble ${isUser ? 'user' : (m.isHuman ? 'assistant human' : 'assistant ai')}">
            ${escHtml(m.content)}
          </div>
          <div class="msg-meta">${label} ${formatTime(m.timestamp)}</div>
        </div>
      </div>
    `;
  }).join('');
  el.scrollTop = el.scrollHeight;
}

async function sendHumanReply() {
  const msg = document.getElementById('chatInput').value.trim();
  if (!msg || !selectedConvPageId || !selectedConvUserId) return;

  const useTag = document.getElementById('useHumanTag').checked;
  document.getElementById('chatInput').value = '';

  try {
    await api('POST', `/api/human-agent/pages/${selectedConvPageId}/conversations/${selectedConvUserId}/reply`, {
      message: msg,
      useHumanAgentTag: useTag
    });
    await openConversation(selectedConvPageId, selectedConvUserId,
      allPages.find(p => p.pageId === selectedConvPageId)?.pageName || '');
  } catch (err) {
    showToast('Lỗi gửi tin nhắn: ' + err.message, 'error');
  }
}

async function takeoverConv() {
  if (!selectedConvPageId || !selectedConvUserId) return;
  try {
    await api('POST', `/api/human-agent/pages/${selectedConvPageId}/conversations/${selectedConvUserId}/takeover`);
    document.getElementById('btnTakeover').style.display = 'none';
    document.getElementById('btnRelease').style.display = 'flex';
    document.getElementById('humanAgentTag').style.display = 'block';
    showToast('Đã tiếp quản hội thoại. AI sẽ không tự động trả lời.', 'info');
  } catch (err) {
    showToast('Lỗi: ' + err.message, 'error');
  }
}

async function releaseConv() {
  if (!selectedConvPageId || !selectedConvUserId) return;
  try {
    await api('POST', `/api/human-agent/pages/${selectedConvPageId}/conversations/${selectedConvUserId}/release`);
    document.getElementById('btnTakeover').style.display = 'flex';
    document.getElementById('btnRelease').style.display = 'none';
    document.getElementById('humanAgentTag').style.display = 'none';
    showToast('Đã trả hội thoại về cho AI', 'success');
  } catch (err) {
    showToast('Lỗi: ' + err.message, 'error');
  }
}

// ═══════════════════════════════════════════════════════
// CONFIG
// ═══════════════════════════════════════════════════════
function renderConfigPageList() {
  const el = document.getElementById('configPageList');
  if (allPages.length === 0) {
    el.innerHTML = `<div class="empty-state" style="padding:24px 0">
      <i class="bi bi-facebook"></i>
      <p style="font-size:12px">Chưa có Pages</p>
    </div>`;
    return;
  }
  el.innerHTML = allPages.map(p => `
    <div class="config-page-item ${selectedConfigPageId === p.pageId ? 'active' : ''}" onclick="openConfigPage('${p.pageId}')">
      <div class="page-avatar" style="width:32px;height:32px;font-size:13px">
        ${p.pageAvatar ? `<img src="${p.pageAvatar}" alt="${p.pageName[0]}" onerror="this.parentElement.textContent='${p.pageName[0]}'">` : p.pageName[0]}
      </div>
      <div style="flex:1;min-width:0">
        <div class="config-page-name" style="display:flex;align-items:center;gap:5px">
          ${escHtml(p.pageName)}
          ${p.enabled ? '<span style="width:6px;height:6px;border-radius:50%;background:#22c55e;flex-shrink:0" title="AI đang bật"></span>' : ''}
        </div>
        <div class="config-page-sub">${p.documentCount} tài liệu · ${p.ruleCount} quy tắc</div>
      </div>
    </div>
  `).join('');
}

async function openConfigPage(pageId) {
  selectedConfigPageId = pageId;
  switchTab('config');

  // Update active state in sidebar
  document.querySelectorAll('.config-page-item').forEach(el => el.classList.remove('active'));
  const items = document.querySelectorAll('.config-page-item');
  items.forEach(el => {
    if (el.getAttribute('onclick')?.includes(pageId)) el.classList.add('active');
  });

  const page = allPages.find(p => p.pageId === pageId);
  if (!page) return;

  const main = document.getElementById('configMain');
  main.innerHTML = `<div style="text-align:center;padding:40px"><span class="loading-spinner"></span></div>`;

  try {
    const [docsData, rulesData] = await Promise.all([
      api('GET', `/api/human-agent/pages/${pageId}/documents`),
      api('GET', `/api/human-agent/pages/${pageId}/rules`)
    ]);

    const docs = docsData.documents || [];
    const rules = rulesData.rules || [];

    main.innerHTML = `
      <!-- AI Config -->
      <div class="config-section">
        <div class="config-section-title"><i class="bi bi-robot"></i> Cấu hình AI — ${escHtml(page.pageName)}</div>
        <div class="form-group">
          <label class="form-label">System Prompt (Hướng dẫn cho AI)</label>
          <textarea class="form-input" id="cfg_systemPrompt" rows="5"
            placeholder="Bạn là trợ lý AI chăm sóc khách hàng của [Tên cửa hàng]...">${escHtml(page.aiConfig?.systemPrompt || '')}</textarea>
          <div class="form-hint">Mô tả vai trò, phong cách trả lời và các giới hạn của AI</div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div class="form-group" style="margin:0">
            <label class="form-label">Độ dài tối đa (tokens)</label>
            <input type="number" class="form-input" id="cfg_maxTokens" value="${page.aiConfig?.maxTokens || 500}" min="100" max="2000">
          </div>
          <div class="form-group" style="margin:0">
            <label class="form-label">Ngôn ngữ chính</label>
            <select class="form-input" id="cfg_language">
              <option value="vi" ${page.aiConfig?.language === 'vi' ? 'selected' : ''}>Tiếng Việt</option>
              <option value="en" ${page.aiConfig?.language === 'en' ? 'selected' : ''}>English</option>
              <option value="auto">Tự động theo khách</option>
            </select>
          </div>
        </div>
        <div style="display:flex;gap:10px;margin-top:14px">
          <button class="btn primary" onclick="saveAIConfig('${pageId}')">
            <i class="bi bi-check2"></i> Lưu cấu hình
          </button>
          <label class="btn secondary" style="cursor:pointer">
            <input type="checkbox" id="cfg_enabled" ${page.enabled ? 'checked' : ''} onchange="togglePage('${pageId}', this.checked)" style="margin-right:6px;accent-color:#22c55e">
            Bật AI cho Page này
          </label>
        </div>
      </div>

      <!-- Documents -->
      <div class="config-section">
        <div class="config-section-title"><i class="bi bi-file-earmark-text"></i> Tài liệu kiến thức (${docs.length})</div>
        <p style="font-size:12px;color:rgba(255,255,255,.4);margin-bottom:14px">
          Upload tài liệu để AI học và trả lời dựa trên nội dung. Hỗ trợ: TXT, MD, PDF, DOCX, CSV, JSON, HTML (tối đa 10MB/file)
        </p>
        <div class="doc-list" id="docList_${pageId}">
          ${docs.length === 0 ? '<div style="font-size:12px;color:rgba(255,255,255,.3);padding:8px 0">Chưa có tài liệu nào</div>' :
            docs.map(d => renderDocItem(d, pageId)).join('')}
        </div>
        <div class="upload-zone" id="uploadZone_${pageId}"
          ondragover="event.preventDefault();this.classList.add('dragover')"
          ondragleave="this.classList.remove('dragover')"
          ondrop="handleFileDrop(event,'${pageId}')"
          onclick="document.getElementById('fileInput_${pageId}').click()">
          <i class="bi bi-cloud-upload"></i>
          <p>Kéo thả file vào đây hoặc nhấn để chọn</p>
          <span>TXT, MD, PDF, DOCX, CSV, JSON, HTML — Tối đa 10MB/file</span>
        </div>
        <input type="file" id="fileInput_${pageId}" style="display:none" multiple
          accept=".txt,.md,.pdf,.docx,.doc,.csv,.json,.html"
          onchange="uploadDocuments('${pageId}', this.files)">
      </div>

      <!-- Rules -->
      <div class="config-section">
        <div class="config-section-title"><i class="bi bi-list-check"></i> Quy tắc Q&A (${rules.length})</div>
        <p style="font-size:12px;color:rgba(255,255,255,.4);margin-bottom:14px">
          Thêm các cặp câu hỏi - trả lời cụ thể. AI sẽ ưu tiên dùng quy tắc này khi khách hỏi về chủ đề tương ứng.
        </p>
        <div id="ruleList_${pageId}" style="display:flex;flex-direction:column;gap:8px;margin-bottom:14px">
          ${rules.length === 0 ? '<div style="font-size:12px;color:rgba(255,255,255,.3);padding:8px 0">Chưa có quy tắc nào</div>' :
            rules.map(r => renderRuleItem(r, pageId)).join('')}
        </div>
        <button class="btn secondary" onclick="openAddRule('${pageId}')">
          <i class="bi bi-plus"></i> Thêm quy tắc
        </button>
      </div>

      <!-- Test AI -->
      <div class="config-section">
        <div class="config-section-title"><i class="bi bi-chat-square-text"></i> Test AI</div>
        <p style="font-size:12px;color:rgba(255,255,255,.4);margin-bottom:12px">Thử nghiệm AI trả lời với cấu hình hiện tại</p>
        <div class="test-chat">
          <div class="test-chat-messages" id="testMessages_${pageId}">
            <div class="test-msg ai">Xin chào! Tôi là AI trợ lý của ${escHtml(page.pageName)}. Bạn cần hỗ trợ gì?</div>
          </div>
          <div class="test-input-row">
            <input type="text" class="test-input" id="testInput_${pageId}"
              placeholder="Nhập câu hỏi để test AI..."
              onkeydown="if(event.key==='Enter'&&!event.isComposing){event.preventDefault();testAI('${pageId}')}">
            <button class="btn-sm primary" onclick="testAI('${pageId}')">
              <i class="bi bi-send"></i> Gửi
            </button>
          </div>
        </div>
      </div>

      <!-- Webhook -->
      <div class="config-section">
        <div class="config-section-title"><i class="bi bi-broadcast"></i> Đăng ký Webhook</div>
        <p style="font-size:12px;color:rgba(255,255,255,.4);margin-bottom:12px">
          Đăng ký webhook để Facebook gửi tin nhắn đến server của bạn.
        </p>
        <button class="btn success" onclick="subscribeWebhook('${pageId}')">
          <i class="bi bi-broadcast"></i> Đăng ký Webhook cho Page này
        </button>
      </div>
    `;
  } catch (err) {
    main.innerHTML = `<div class="empty-state"><i class="bi bi-exclamation-triangle"></i><p>Lỗi tải cấu hình: ${err.message}</p></div>`;
  }
}

function renderDocItem(doc, pageId) {
  const icons = { '.pdf': 'bi-file-pdf', '.docx': 'bi-file-word', '.doc': 'bi-file-word',
    '.txt': 'bi-file-text', '.md': 'bi-markdown', '.csv': 'bi-table', '.json': 'bi-braces', '.html': 'bi-code' };
  const icon = icons[doc.ext] || 'bi-file-earmark';
  return `
    <div class="doc-item" id="doc_${doc.id}">
      <div class="doc-icon"><i class="bi ${icon}"></i></div>
      <div>
        <div class="doc-name">${escHtml(doc.name)}</div>
        <div class="doc-size">${formatBytes(doc.size)} · ${(doc.chars || 0).toLocaleString()} ký tự</div>
      </div>
      <button class="btn-sm danger" onclick="deleteDocument('${pageId}','${doc.id}')">
        <i class="bi bi-trash"></i>
      </button>
    </div>
  `;
}

function renderRuleItem(rule, pageId) {
  const catColors = { product: '#00d4ff', price: '#22c55e', shipping: '#f97316', policy: '#a855f7', support: '#f59e0b', general: '#64748b' };
  const color = catColors[rule.category] || '#64748b';
  return `
    <div class="rule-item" id="rule_${rule.id}">
      <div class="rule-content">
        <div class="rule-trigger">
          <span style="width:8px;height:8px;border-radius:50%;background:${color};display:inline-block"></span>
          ${escHtml(rule.trigger)}
        </div>
        <div class="rule-response">${escHtml(rule.response)}</div>
      </div>
      <div style="display:flex;gap:6px;flex-shrink:0">
        <button class="btn-sm gray" onclick="openEditRule('${pageId}','${rule.id}','${escHtml(rule.trigger).replace(/'/g,"\\'")}','${escHtml(rule.response).replace(/'/g,"\\'")}','${rule.category}')">
          <i class="bi bi-pencil"></i>
        </button>
        <button class="btn-sm danger" onclick="deleteRule('${pageId}','${rule.id}')">
          <i class="bi bi-trash"></i>
        </button>
      </div>
    </div>
  `;
}

async function saveAIConfig(pageId) {
  const systemPrompt = document.getElementById('cfg_systemPrompt')?.value;
  const maxTokens = parseInt(document.getElementById('cfg_maxTokens')?.value) || 500;
  const language = document.getElementById('cfg_language')?.value || 'vi';

  try {
    await api('PUT', `/api/human-agent/pages/${pageId}`, {
      aiConfig: { systemPrompt, maxTokens, language }
    });
    const page = allPages.find(p => p.pageId === pageId);
    if (page) page.aiConfig = { ...page.aiConfig, systemPrompt, maxTokens, language };
    showToast('Đã lưu cấu hình AI', 'success');
  } catch (err) {
    showToast('Lỗi lưu cấu hình: ' + err.message, 'error');
  }
}

// ── Documents ──
async function uploadDocuments(pageId, files) {
  if (!files || files.length === 0) return;
  const formData = new FormData();
  for (const f of files) formData.append('files', f);

  const zone = document.getElementById(`uploadZone_${pageId}`);
  if (zone) zone.innerHTML = '<span class="loading-spinner"></span> Đang upload...';

  try {
    const data = await apiUpload(`/api/human-agent/pages/${pageId}/documents`, formData);
    showToast(`Đã upload ${data.uploaded.length} tài liệu`, 'success');
    await openConfigPage(pageId);
  } catch (err) {
    showToast('Lỗi upload: ' + err.message, 'error');
    await openConfigPage(pageId);
  }
}

function handleFileDrop(event, pageId) {
  event.preventDefault();
  document.getElementById(`uploadZone_${pageId}`)?.classList.remove('dragover');
  uploadDocuments(pageId, event.dataTransfer.files);
}

async function deleteDocument(pageId, docId) {
  if (!confirm('Xóa tài liệu này?')) return;
  try {
    await api('DELETE', `/api/human-agent/pages/${pageId}/documents/${docId}`);
    document.getElementById(`doc_${docId}`)?.remove();
    showToast('Đã xóa tài liệu', 'info');
    const page = allPages.find(p => p.pageId === pageId);
    if (page) page.documentCount = Math.max(0, page.documentCount - 1);
    renderConfigPageList();
  } catch (err) {
    showToast('Lỗi xóa: ' + err.message, 'error');
  }
}

// ── Rules ──
let currentRulePageId = null;

function openAddRule(pageId) {
  currentRulePageId = pageId;
  document.getElementById('ruleModalTitle').textContent = 'Thêm Quy Tắc';
  document.getElementById('editRuleId').value = '';
  document.getElementById('ruleTrigger').value = '';
  document.getElementById('ruleResponse').value = '';
  document.getElementById('ruleCategory').value = 'general';
  openModal('ruleModal');
}

function openEditRule(pageId, ruleId, trigger, response, category) {
  currentRulePageId = pageId;
  document.getElementById('ruleModalTitle').textContent = 'Sửa Quy Tắc';
  document.getElementById('editRuleId').value = ruleId;
  document.getElementById('ruleTrigger').value = trigger;
  document.getElementById('ruleResponse').value = response;
  document.getElementById('ruleCategory').value = category || 'general';
  openModal('ruleModal');
}

async function saveRule() {
  const pageId = currentRulePageId;
  const ruleId = document.getElementById('editRuleId').value;
  const trigger = document.getElementById('ruleTrigger').value.trim();
  const response = document.getElementById('ruleResponse').value.trim();
  const category = document.getElementById('ruleCategory').value;

  if (!trigger || !response) return showToast('Vui lòng điền đầy đủ thông tin', 'error');

  try {
    if (ruleId) {
      await api('PUT', `/api/human-agent/pages/${pageId}/rules/${ruleId}`, { trigger, response, category });
      showToast('Đã cập nhật quy tắc', 'success');
    } else {
      await api('POST', `/api/human-agent/pages/${pageId}/rules`, { trigger, response, category });
      showToast('Đã thêm quy tắc mới', 'success');
    }
    closeModal('ruleModal');
    await openConfigPage(pageId);
    const page = allPages.find(p => p.pageId === pageId);
    if (page && !ruleId) page.ruleCount++;
    renderConfigPageList();
  } catch (err) {
    showToast('Lỗi lưu quy tắc: ' + err.message, 'error');
  }
}

async function deleteRule(pageId, ruleId) {
  if (!confirm('Xóa quy tắc này?')) return;
  try {
    await api('DELETE', `/api/human-agent/pages/${pageId}/rules/${ruleId}`);
    document.getElementById(`rule_${ruleId}`)?.remove();
    showToast('Đã xóa quy tắc', 'info');
    const page = allPages.find(p => p.pageId === pageId);
    if (page) page.ruleCount = Math.max(0, page.ruleCount - 1);
    renderConfigPageList();
  } catch (err) {
    showToast('Lỗi xóa: ' + err.message, 'error');
  }
}

// ── Test AI ──
async function testAI(pageId) {
  const input = document.getElementById(`testInput_${pageId}`);
  const msg = input?.value.trim();
  if (!msg) return;
  input.value = '';

  const container = document.getElementById(`testMessages_${pageId}`);
  container.innerHTML += `<div class="test-msg user">${escHtml(msg)}</div>`;
  container.innerHTML += `<div class="test-msg ai" id="testThinking"><span class="loading-spinner"></span> Đang suy nghĩ...</div>`;
  container.scrollTop = container.scrollHeight;

  try {
    const data = await api('POST', `/api/human-agent/pages/${pageId}/test`, { message: msg });
    document.getElementById('testThinking')?.remove();
    container.innerHTML += `<div class="test-msg ai">${escHtml(data.reply)}${data.needsHuman ? '<br><em style="color:#f97316;font-size:10px">→ Sẽ chuyển cho nhân viên</em>' : ''}</div>`;
    container.scrollTop = container.scrollHeight;
  } catch (err) {
    document.getElementById('testThinking')?.remove();
    container.innerHTML += `<div class="test-msg ai" style="color:#f87171">Lỗi: ${err.message}</div>`;
  }
}

// ═══════════════════════════════════════════════════════
// UI HELPERS
// ═══════════════════════════════════════════════════════
function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById(`tab-${tab}`)?.classList.add('active');
  document.getElementById(`panel-${tab}`)?.classList.add('active');

  if (tab === 'conversations' && (!allConversations || allConversations.length === 0)) loadConversations();
}

function toggleSubNav(e, id) {
  e.preventDefault();
  document.getElementById(id)?.classList.toggle('open');
}

function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

function openSettings() {}

function showToast(msg, type = 'info') {
  const c = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  const icons = { success: 'bi-check-circle-fill', error: 'bi-x-circle-fill', info: 'bi-info-circle-fill' };
  t.innerHTML = `<i class="bi ${icons[type] || 'bi-info-circle-fill'}"></i> ${msg}`;
  c.appendChild(t);
  setTimeout(() => t.remove(), 4000);
}

function copyText(elId) {
  const text = document.getElementById(elId)?.textContent;
  if (!text) return;
  navigator.clipboard.writeText(text).then(() => showToast('Đã copy!', 'success'));
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

function escHtml(str) {
  if (!str) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function formatTime(ts) {
  if (!ts) return '';
  const d = new Date(ts);
  const now = new Date();
  const diff = now - d;
  if (diff < 60000) return 'Vừa xong';
  if (diff < 3600000) return `${Math.floor(diff/60000)} phút`;
  if (diff < 86400000) return `${Math.floor(diff/3600000)} giờ`;
  return d.toLocaleDateString('vi-VN');
}

function formatBytes(bytes) {
  if (!bytes) return '0 B';
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1048576) return (bytes/1024).toFixed(1) + ' KB';
  return (bytes/1048576).toFixed(1) + ' MB';
}

// Close modal on overlay click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.classList.remove('open');
  });
});

// ═══════════════════════════════════════════════════════
// HYBRID MODE: Direct Facebook API + OpenAI (no server needed)
// ═══════════════════════════════════════════════════════

// Override loadPages to work directly with Facebook API
const _originalLoadPages = loadPages;
loadPages = async function() {
  // Always use direct FB API
  await loadPagesDirect();
};

async function loadPagesDirect() {
  const token = FB_TOKEN || localStorage.getItem('HA_FB_TOKEN') || localStorage.getItem('FB_TOKEN_MANUAL');
  if (!token) return;
  try {
    const pages = await fetchAllFBPages(token);
    // Load saved configs from localStorage
    const savedConfigs = JSON.parse(localStorage.getItem('HA_PAGE_CONFIGS') || '{}');
    allPages = pages.map(p => ({
      pageId: p.id,
      pageName: p.name,
      pageAvatar: p.picture?.data?.url || '',
      pageCategory: p.category || '',
      fanCount: p.fan_count || 0,
      enabled: savedConfigs[p.id]?.enabled || false,
      accessToken: p.access_token,
      aiConfig: savedConfigs[p.id]?.aiConfig || { systemPrompt: '', maxTokens: 500, language: 'vi' },
      documentCount: (savedConfigs[p.id]?.documents || []).length,
      ruleCount: (savedConfigs[p.id]?.rules || []).length
    }));
    renderPageList();
    renderConfigPageList();
    loadStatsLocal();
    updateConvPageFilter(); // Populate dropdown filter theo page
    showToast(`Đã tải ${allPages.length} Pages`, 'success');
  } catch(e) {
    showToast('Lỗi tải Pages: ' + e.message, 'error');
  }
}

async function fetchAllFBPages(token) {
  const pages = [];
  let url = `https://graph.facebook.com/v19.0/me/accounts?fields=id,name,access_token,category,fan_count,picture&limit=100&access_token=${token}`;
  while (url) {
    const r = await fetch(url);
    const d = await r.json();
    if (d.error) throw new Error(d.error.message);
    pages.push(...(d.data || []));
    url = d.paging?.next || null;
  }
  return pages;
}

// Alias: renderPageList -> renderPageGrid (backward compat)
function renderPageList() { renderPageGrid(); }

// Override syncPages — always use direct FB API, server is optional
syncPages = async function() {
  const btn = document.getElementById('syncBtn');
  if (btn) { btn.disabled = true; btn.innerHTML = '<span class="loading-spinner"></span> Đang tải...'; }
  try {
    // Check if we have FB token
    const token = FB_TOKEN || localStorage.getItem('HA_FB_TOKEN') || localStorage.getItem('fb_token') || localStorage.getItem('FB_TOKEN_MANUAL');
    if (!token) {
      openSetupModal();
      showToast('Vui lòng nhập Facebook Token trước', 'error');
      return;
    }
    FB_TOKEN = token;
    // Try server first if configured, fallback to direct
    if (SERVER_URL) {
      try {
        const r = await fetch(`${SERVER_URL}/api/human-agent/sync-pages`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ fbToken: FB_TOKEN }),
          signal: AbortSignal.timeout(5000)
        });
        if (r.ok) {
          const data = await r.json();
          allPages = data.pages || [];
          renderPageList();
          renderConfigPageList();
          loadStatsLocal();
          updateConvPageFilter(); // Populate dropdown filter theo page
          showToast(`Đã đồng bộ ${allPages.length} Pages`, 'success');
          return;
        }
      } catch(e) {
        console.warn('Server không khả dụng, dùng trực tiếp Facebook API');
      }
    }
    // Direct Facebook API
    await loadPagesDirect();
  } finally {
    if (btn) { btn.disabled = false; btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Đồng bộ Pages'; }
  }
};

// Override loadConversations to work directly with Facebook API
const _origLoadConversations = loadConversations;
loadConversations = async function(showLoading = true) {
  // Always use direct FB API (server is optional and may not be available)
  await loadConversationsDirect(showLoading);
};

let _isLoadingConvs = false;
async function loadConversationsDirect(showLoading = true) {
  // Tránh chạy song song
  if (_isLoadingConvs) return;
  _isLoadingConvs = true;
  const el = document.getElementById('convList');
  // Chỉ hiển thị spinner nếu chưa có data và showLoading=true
  if (showLoading && el && allConversations.length === 0) el.innerHTML = '<div style="text-align:center;padding:20px"><span class="loading-spinner"></span></div>';

  const userToken = FB_TOKEN || localStorage.getItem('HA_FB_TOKEN') || localStorage.getItem('FB_TOKEN_MANUAL');
  if (!userToken || !allPages.length) {
    if (el) el.innerHTML = '<div class="empty-state"><i class="bi bi-chat-dots"></i><p>Chưa có token hoặc Pages</p></div>';
    _isLoadingConvs = false;
    return;
  }

  try {
    allConversations = [];
    // Load song song từ TẤT CẢ pages với Promise.all để đảm bảo đủ 46 pages
    const pagesToLoad = allPages.filter(p => p.accessToken);
    
    // Cập nhật UI để người dùng thấy tiến trình
    if (el && showLoading) el.innerHTML = `<div style="text-align:center;padding:20px"><span class="loading-spinner"></span><p style="font-size:12px;color:#9ca3af;margin-top:8px">Đang tải ${pagesToLoad.length} pages...</p></div>`;
    
    // Load tất cả pages song song với Promise.allSettled (không dừng nếu 1 page lỗi)
    const results = await Promise.allSettled(pagesToLoad.map(async page => {
      const pageUrl = `https://graph.facebook.com/v19.0/${page.pageId}/conversations?fields=id,snippet,updated_time,unread_count,participants&limit=30&access_token=${page.accessToken}`;
      const pr = await fetch(pageUrl);
      const pd = await pr.json();
      if (pd.error || !pd.data) return [];
      return (pd.data || []).map(c => {
        const customer = (c.participants?.data || []).find(p => p.id !== page.pageId) || {};
        return {
          convId: c.id, userId: customer.id || c.id, userName: customer.name || '',
          lastMessage: c.snippet || '', updatedAt: c.updated_time,
          lastTimestamp: c.updated_time ? new Date(c.updated_time).getTime() : Date.now(),
          unread: c.unread_count || 0, unreadCount: c.unread_count || 0,
          pageId: page.pageId, pageName: page.pageName,
          fbConvId: c.id, accessToken: page.accessToken, isPending: false
        };
      });
    }));
    
    // Gộp tất cả kết quả
    for (const result of results) {
      if (result.status === 'fulfilled' && Array.isArray(result.value)) {
        allConversations.push(...result.value);
      }
    }
    
    // Deduplicate by convId
    const seen = new Set();
    allConversations = allConversations.filter(c => {
      if (seen.has(c.convId)) return false;
      seen.add(c.convId);
      return true;
    });
    // Sort by latest
    allConversations.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
    
    // Apply page filter if selected
    const pageFilterVal = document.getElementById('convPageFilter')?.value;
    const toRender = pageFilterVal 
      ? allConversations.filter(c => c.pageId === pageFilterVal)
      : allConversations;
    renderConvList(toRender);
    
    // Update stats
    const unread = allConversations.filter(c => c.unreadCount > 0).length;
    const statConvs = document.getElementById('stat-convs');
    const statWaiting = document.getElementById('stat-waiting');
    if (statConvs) statConvs.textContent = allConversations.length;
    if (statWaiting) statWaiting.textContent = unread;
    // Re-render page chips to update badges
    renderPageChips();
    const badge = document.getElementById('tab-conversations')?.querySelector('.tab-badge');
    if (badge) {
      badge.textContent = allConversations.length;
      badge.style.display = allConversations.length > 0 ? 'inline-block' : 'none';
    }
  } catch(e) {
    if (el) el.innerHTML = `<div class="empty-state"><i class="bi bi-exclamation-triangle"></i><p>Lỗi: ${escHtml(e.message)}</p></div>`;
  } finally {
    _isLoadingConvs = false; // Cho phép gọi lại sau khi hoàn thành
  }
}

// Override openConversation to load messages directly from Facebook API
const _origOpenConv = openConversation;
openConversation = async function(pageId, userId, userName) {
  selectedConvPageId = pageId;
  selectedConvUserId = userId;
  // Ensure we're on the conversations tab
  switchTab('conversations');
  await openConversationDirect(pageId, userId, userName);
};

async function openConversationDirect(pageId, userId, userName) {
  const page = allPages.find(p => p.pageId === pageId);
  if (!page) return;
  const conv = allConversations.find(c => c.userId === userId || c.convId === userId);
  const convId = conv?.fbConvId || userId;
  const name = conv?.userName || userName || 'Khách hàng';
  const initials = name.split(' ').slice(-2).map(w => w[0]).join('').toUpperCase() || 'K';

  // Update conv list active state
  document.querySelectorAll('.conv-item').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.conv-item').forEach(el => {
    if (el.getAttribute('onclick')?.includes(userId)) el.classList.add('active');
  });

  // Use the existing HTML structure
  const chatEmpty = document.getElementById('chatEmpty');
  const chatView = document.getElementById('chatView');
  if (chatEmpty) chatEmpty.style.display = 'none';
  if (chatView) chatView.style.display = 'flex';

  // Update header info
  const chatAvatar = document.getElementById('chatAvatar');
  const chatName = document.getElementById('chatName');
  const chatSub = document.getElementById('chatSub');
  if (chatAvatar) chatAvatar.textContent = initials;
  if (chatName) chatName.textContent = name;
  if (chatSub) chatSub.textContent = page.enabled ? '🤖 AI đang trả lời tự động' : `Page: ${page.pageName}`;

  // Update buttons with direct API handlers
  const btnTakeover = document.getElementById('btnTakeover');
  const btnRelease = document.getElementById('btnRelease');
  const btnRefresh = document.getElementById('btnRefreshMsgs');
  if (btnTakeover) {
    btnTakeover.style.display = 'flex';
    btnTakeover.onclick = () => takeoverConvDirect(convId);
  }
  if (btnRelease) {
    btnRelease.style.display = 'none';
    btnRelease.onclick = () => releaseConvDirect(convId);
  }
  if (btnRefresh) {
    btnRefresh.onclick = () => openConversationDirect(pageId, conv?.userId || userId, name);
  }

  // Update send button and input
  const chatInput = document.getElementById('chatInput');
  const sendBtn = document.querySelector('.chat-send-btn');
  if (chatInput) {
    chatInput.value = '';
    chatInput.onkeydown = function(e) {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessageDirect(convId, conv?.userId || userId); }
    };
  }
  if (sendBtn) sendBtn.onclick = () => sendMessageDirect(convId, conv?.userId || userId);

  // Show loading in messages
  const container = document.getElementById('chatMessages');
  if (container) container.innerHTML = '<div style="text-align:center;padding:20px"><span class="loading-spinner"></span></div>';

  // Load messages from Facebook API (try multiple endpoints)
  try {
    let msgs = [];
    let lastErr = '';
    // Strategy 1: GET /{convId}/messages (page token, limit 50)
    const url1 = `https://graph.facebook.com/v19.0/${convId}/messages?fields=id,message,from,created_time,sticker,attachments&limit=50&access_token=${page.accessToken}`;
    const r1 = await fetch(url1);
    const d1 = await r1.json();
    let nextPageUrl = null;
    if (!d1.error && d1.data) {
      msgs = (d1.data || []).reverse();
      nextPageUrl = d1.paging?.previous || null; // 'previous' = older messages
      lastErr = '';
    } else {
      lastErr = d1.error?.message || 'Unknown error';
      // Strategy 2: GET /{convId}?fields=messages (fallback)
      const url2 = `https://graph.facebook.com/v19.0/${convId}?fields=messages.limit(50){id,message,from,created_time}&access_token=${page.accessToken}`;
      const r2 = await fetch(url2);
      const d2 = await r2.json();
      if (!d2.error && d2.messages?.data) {
        msgs = (d2.messages.data || []).reverse();
        lastErr = '';
      } else {
        lastErr = d2.error?.message || lastErr;
        // Strategy 3: Try with user token
        const userToken = FB_TOKEN || localStorage.getItem('HA_FB_TOKEN');
        if (userToken && userToken !== page.accessToken) {
          const url3 = `https://graph.facebook.com/v19.0/${convId}/messages?fields=id,message,from,created_time&limit=50&access_token=${userToken}`;
          const r3 = await fetch(url3);
          const d3 = await r3.json();
          if (!d3.error && d3.data) {
            msgs = (d3.data || []).reverse();
            nextPageUrl = d3.paging?.previous || null;
            lastErr = '';
          } else {
            lastErr = d3.error?.message || lastErr;
          }
        }
      }
    }
    if (lastErr) throw new Error(lastErr);
    if (!container) return;
    if (!msgs.length) {
      container.innerHTML = '<div class="empty-state"><i class="bi bi-chat"></i><p>Chưa có tin nhắn</p></div>';
      return;
    }
    // Render tin nhắn với fix: so sánh string, xử lý attachment/sticker
    function renderMsgHtml(m) {
      const fromId = String(m.from?.id || '');
      const pid = String(pageId);
      const isPage = fromId === pid;
      const time = formatTime(m.created_time);
      // Nội dung tin nhắn
      let content = '';
      if (m.message) content = escHtml(m.message);
      else if (m.sticker) content = `<img src="${m.sticker}" style="max-width:80px" alt="sticker">`;
      else if (m.attachments?.data?.length) {
        content = m.attachments.data.map(att => {
          if (att.image_data?.url) return `<img src="${att.image_data.url}" style="max-width:200px;border-radius:8px" alt="ảnh">`;
          if (att.video_data?.url) return `<video src="${att.video_data.url}" controls style="max-width:200px"></video>`;
          return `<span style="opacity:0.6">[${att.type || 'file'}]</span>`;
        }).join('');
      } else content = '<span style="opacity:0.5">[Sticker / File]</span>';
      return `<div class="msg-row ${isPage ? 'assistant' : 'user'}">
        ${!isPage ? `<div class="msg-avatar">${initials}</div>` : ''}
        <div>
          <div class="msg-bubble ${isPage ? 'assistant ai' : 'user'}">${content}</div>
          <div class="msg-meta">${time}</div>
        </div>
      </div>`;
    }
    // Thêm nút Load thêm nếu có trang trước
    let loadMoreHtml = '';
    if (nextPageUrl) {
      const escapedUrl = nextPageUrl.replace(/'/g, "\\'");
      loadMoreHtml = `<div id="loadMoreMsgs" style="text-align:center;padding:8px">
        <button onclick="loadMoreMessages('${escapedUrl}', '${pageId}', '${initials}')" 
          style="background:rgba(255,255,255,.08);border:none;color:#9ca3af;font-size:12px;padding:6px 16px;border-radius:20px;cursor:pointer">
          <i class="bi bi-arrow-up-circle"></i> Tải thêm tin nhắn cũ
        </button>
      </div>`;
    }
    container.innerHTML = loadMoreHtml + msgs.map(renderMsgHtml).join('');
    container.scrollTop = container.scrollHeight;
  } catch(e) {
    if (container) container.innerHTML = `<div class="empty-state"><i class="bi bi-exclamation-triangle"></i><p>Lỗi: ${escHtml(e.message)}</p></div>`;
  }
}

// Hàm load thêm tin nhắn cũ
async function loadMoreMessages(url, pageId, initials) {
  const btn = document.getElementById('loadMoreMsgs');
  if (btn) btn.innerHTML = '<span class="loading-spinner"></span>';
  try {
    const r = await fetch(url);
    const d = await r.json();
    if (d.error || !d.data) { if (btn) btn.remove(); return; }
    const olderMsgs = (d.data || []).reverse();
    const container = document.getElementById('chatMessages');
    if (!container) return;
    const newNextUrl = d.paging?.previous || null;
    const newHtml = olderMsgs.map(m => {
      const fromId = String(m.from?.id || '');
      const isPage = fromId === String(pageId);
      const time = formatTime(m.created_time);
      let content = m.message ? escHtml(m.message) : '<span style="opacity:0.5">[Sticker / File]</span>';
      return `<div class="msg-row ${isPage ? 'assistant' : 'user'}">
        ${!isPage ? `<div class="msg-avatar">${initials}</div>` : ''}
        <div><div class="msg-bubble ${isPage ? 'assistant ai' : 'user'}">${content}</div>
        <div class="msg-meta">${time}</div></div></div>`;
    }).join('');
    // Thêm vào đầu container (trước tin nhắn hiện tại)
    const prevScrollHeight = container.scrollHeight;
    if (btn) {
      let newLoadMore = '';
      if (newNextUrl) {
        const escapedUrl = newNextUrl.replace(/'/g, "\\'");
        newLoadMore = `<div id="loadMoreMsgs" style="text-align:center;padding:8px">
          <button onclick="loadMoreMessages('${escapedUrl}', '${pageId}', '${initials}')" 
            style="background:rgba(255,255,255,.08);border:none;color:#9ca3af;font-size:12px;padding:6px 16px;border-radius:20px;cursor:pointer">
            <i class="bi bi-arrow-up-circle"></i> Tải thêm tin nhắn cũ
          </button>
        </div>`;
      }
      btn.outerHTML = newLoadMore + newHtml;
    }
    // Giữ vị trí scroll
    container.scrollTop = container.scrollHeight - prevScrollHeight;
  } catch(e) {
    if (btn) btn.remove();
  }
}

async function sendMessageDirect(convId, recipientId) {
  const input = document.getElementById('chatInput');
  const text = input?.value.trim();
  if (!text) return;
  const page = allPages.find(p => p.pageId === selectedConvPageId);
  if (!page) return;
  input.value = '';
  input.disabled = true;
  
  // Check if Human Agent Tag should be used
  const useHumanTag = document.getElementById('useHumanTag')?.checked || false;
  const isHumanMode = document.getElementById('btnRelease')?.style.display !== 'none';
  
  const msgBody = { 
    recipient: { id: recipientId }, 
    message: { text }, 
    access_token: page.accessToken 
  };
  // Add Human Agent Tag if in takeover mode and checkbox is checked
  if (isHumanMode && useHumanTag) {
    msgBody.tag = 'HUMAN_AGENT';
  }
  
  try {
    const r = await fetch(`https://graph.facebook.com/v19.0/${page.pageId}/messages`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(msgBody)
    });
    const d = await r.json();
    if (d.error) throw new Error(d.error.message);
    const container = document.getElementById('chatMessages');
    if (container) {
      const div = document.createElement('div');
      div.className = 'msg-row assistant';
      const tagLabel = (isHumanMode && useHumanTag) ? ' <span style="font-size:9px;background:rgba(249,115,22,.2);color:#f97316;padding:1px 5px;border-radius:3px">7 ngày</span>' : '';
      div.innerHTML = `<div><div class="msg-bubble assistant human">${escHtml(text)}</div><div class="msg-meta">Nhân viên · Vừa xong${tagLabel}</div></div>`;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }
    showToast('Đã gửi tin nhắn', 'success');
  } catch(e) {
    showToast('Lỗi gửi: ' + e.message, 'error');
    if (input) input.value = text;
  } finally {
    if (input) { input.disabled = false; input.focus(); }
  }
}

async function sendHumanAgentTagDirect(convId, recipientId) {
  const page = allPages.find(p => p.pageId === selectedConvPageId);
  if (!page) return;
  const text = prompt('Nhập tin nhắn gửi với Human Agent Tag (cho phép nhắn trong 7 ngày):');
  if (!text) return;
  try {
    const r = await fetch(`https://graph.facebook.com/v19.0/${page.pageId}/messages`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ recipient: { id: recipientId }, message: { text }, tag: 'HUMAN_AGENT', access_token: page.accessToken })
    });
    const d = await r.json();
    if (d.error) throw new Error(d.error.message);
    showToast('Gửi với Human Agent Tag thành công!', 'success');
  } catch(e) {
    showToast('Lỗi: ' + e.message, 'error');
  }
}

function takeoverConvDirect(convId) {
  document.getElementById('btnTakeover').style.display = 'none';
  document.getElementById('btnRelease').style.display = 'flex';
  document.getElementById('chatSub').textContent = '👨‍💼 Human Agent đang tiếp quản';
  // Show Human Agent Tag option
  const tagArea = document.getElementById('humanAgentTag');
  if (tagArea) tagArea.style.display = 'block';
  showToast('Bạn đang tiếp quản hội thoại này. AI sẽ không tự động trả lời.', 'info');
}

function releaseConvDirect(convId) {
  document.getElementById('btnTakeover').style.display = 'flex';
  document.getElementById('btnRelease').style.display = 'none';
  const page = allPages.find(p => p.pageId === selectedConvPageId);
  document.getElementById('chatSub').textContent = page?.enabled ? '🤖 AI đang trả lời tự động' : `Page: ${page?.pageName || ''}`;
  // Hide Human Agent Tag option
  const tagArea = document.getElementById('humanAgentTag');
  if (tagArea) tagArea.style.display = 'none';
  showToast('Đã trả hội thoại về cho AI', 'success');
}

// Override openConfigPage to work with localStorage
const _origOpenConfigPage = openConfigPage;
openConfigPage = async function(pageId) {
  await openConfigPageDirect(pageId);
};

async function openConfigPageDirect(pageId) {
  selectedConfigPageId = pageId;
  switchTab('config');
  document.querySelectorAll('.config-page-item').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.config-page-item').forEach(el => {
    if (el.getAttribute('onclick')?.includes(pageId)) el.classList.add('active');
  });
  const page = allPages.find(p => p.pageId === pageId);
  if (!page) return;
  const savedConfigs = JSON.parse(localStorage.getItem('HA_PAGE_CONFIGS') || '{}');
  const cfg = savedConfigs[pageId] || { aiConfig: {}, documents: [], rules: [] };
  const docs = cfg.documents || [];
  const rules = cfg.rules || [];
  const main = document.getElementById('configMain');
  if (!main) return;
  main.innerHTML = `
    <div class="config-section">
      <div class="config-section-title"><i class="bi bi-robot"></i> Cấu hình AI — ${escHtml(page.pageName)}</div>
      <div class="form-group">
        <label class="form-label">System Prompt (Hướng dẫn cho AI)</label>
        <textarea class="form-input" id="cfg_systemPrompt" rows="5"
          placeholder="Bạn là trợ lý AI chăm sóc khách hàng của ${escHtml(page.pageName)}. Hãy trả lời lịch sự, ngắn gọn và chính xác bằng tiếng Việt...">${escHtml(cfg.aiConfig?.systemPrompt || '')}</textarea>
        <div class="form-hint">Mô tả vai trò, phong cách trả lời và các giới hạn của AI</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="form-group" style="margin:0">
          <label class="form-label">Độ dài tối đa (tokens)</label>
          <input type="number" class="form-input" id="cfg_maxTokens" value="${cfg.aiConfig?.maxTokens || 500}" min="100" max="2000">
        </div>
        <div class="form-group" style="margin:0">
          <label class="form-label">Ngôn ngữ chính</label>
          <select class="form-input" id="cfg_language">
            <option value="vi" ${cfg.aiConfig?.language !== 'en' ? 'selected' : ''}>Tiếng Việt</option>
            <option value="en" ${cfg.aiConfig?.language === 'en' ? 'selected' : ''}>English</option>
            <option value="auto">Tự động theo khách</option>
          </select>
        </div>
      </div>
      <div style="display:flex;gap:10px;margin-top:14px;align-items:center">
        <button class="btn primary" onclick="saveAIConfigDirect('${pageId}')">
          <i class="bi bi-check2"></i> Lưu cấu hình
        </button>
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;color:rgba(255,255,255,.6)">
          <input type="checkbox" id="cfg_enabled" ${page.enabled ? 'checked' : ''} onchange="togglePageDirect('${pageId}', this.checked)" style="accent-color:#22c55e">
          Bật AI cho Page này
        </label>
      </div>
    </div>

    <div class="config-section">
      <div class="config-section-title"><i class="bi bi-file-earmark-text"></i> Tài liệu kiến thức (${docs.length})</div>
      <p style="font-size:12px;color:rgba(255,255,255,.4);margin-bottom:14px">
        Upload tài liệu để AI học và trả lời dựa trên nội dung. Hỗ trợ: TXT, MD, PDF, DOCX, CSV, JSON, HTML
      </p>
      <div class="doc-list" id="docList_${pageId}">
        ${docs.length === 0 ? '<div style="font-size:12px;color:rgba(255,255,255,.3);padding:8px 0">Chưa có tài liệu nào</div>' :
          docs.map((d,i) => renderDocItemDirect(d, pageId, i)).join('')}
      </div>
      <div class="upload-zone" id="uploadZone_${pageId}"
        ondragover="event.preventDefault();this.classList.add('dragover')"
        ondragleave="this.classList.remove('dragover')"
        ondrop="handleFileDropDirect(event,'${pageId}')"
        onclick="document.getElementById('fileInput_${pageId}').click()">
        <i class="bi bi-cloud-upload"></i>
        <p>Kéo thả file vào đây hoặc nhấn để chọn</p>
        <span>TXT, MD, PDF, DOCX, CSV, JSON, HTML — Tối đa 10MB/file</span>
      </div>
      <input type="file" id="fileInput_${pageId}" style="display:none" multiple
        accept=".txt,.md,.pdf,.docx,.doc,.csv,.json,.html"
        onchange="uploadDocumentsDirect('${pageId}', this.files)">
    </div>

    <div class="config-section">
      <div class="config-section-title"><i class="bi bi-list-check"></i> Quy tắc Q&A (${rules.length})</div>
      <p style="font-size:12px;color:rgba(255,255,255,.4);margin-bottom:14px">
        Thêm các cặp câu hỏi - trả lời cụ thể. AI sẽ ưu tiên dùng quy tắc này khi khách hỏi về chủ đề tương ứng.
      </p>
      <div id="ruleList_${pageId}" style="display:flex;flex-direction:column;gap:8px;margin-bottom:14px">
        ${rules.length === 0 ? '<div style="font-size:12px;color:rgba(255,255,255,.3);padding:8px 0">Chưa có quy tắc nào</div>' :
          rules.map((r,i) => renderRuleItemDirect(r, pageId, i)).join('')}
      </div>
      <button class="btn secondary" onclick="openAddRuleDirect('${pageId}')">
        <i class="bi bi-plus"></i> Thêm quy tắc
      </button>
    </div>

    <div class="config-section">
      <div class="config-section-title"><i class="bi bi-chat-square-text"></i> Test AI</div>
      <p style="font-size:12px;color:rgba(255,255,255,.4);margin-bottom:12px">Thử nghiệm AI trả lời với cấu hình hiện tại</p>
      <div class="test-chat">
        <div class="test-chat-messages" id="testMessages_${pageId}">
          <div class="test-msg ai">Xin chào! Tôi là AI trợ lý của ${escHtml(page.pageName)}. Bạn cần hỗ trợ gì?</div>
        </div>
        <div class="test-input-row">
          <input type="text" class="test-input" id="testInput_${pageId}"
            placeholder="Nhập câu hỏi để test AI..."
            onkeydown="if(event.key==='Enter'&&!event.isComposing){event.preventDefault();testAIDirect('${pageId}')}">
          <button class="btn-sm primary" onclick="testAIDirect('${pageId}')">
            <i class="bi bi-send"></i> Gửi
          </button>
        </div>
      </div>
    </div>

    <div class="config-section">
      <div class="config-section-title"><i class="bi bi-broadcast"></i> Đăng ký Webhook</div>
      <p style="font-size:12px;color:rgba(255,255,255,.4);margin-bottom:12px">
        Đăng ký webhook để Facebook gửi tin nhắn đến server của bạn. (Tùy chọn - không bắt buộc cho chế độ Direct API)
      </p>
      <button class="btn success" onclick="subscribeWebhookDirect('${pageId}')">
        <i class="bi bi-broadcast"></i> Đăng ký Webhook cho Page này
      </button>
    </div>

    <div class="config-section" style="background:rgba(0,212,255,.04);border-color:rgba(0,212,255,.15)">
      <div class="config-section-title"><i class="bi bi-info-circle" style="color:#00d4ff"></i> Hướng dẫn AI Auto-Response</div>
      <div style="font-size:12px;color:rgba(255,255,255,.5);line-height:1.7">
        <p>✅ <strong style="color:#fff">Bật AI</strong> bằng toggle ở trên → AI sẽ tự động trả lời khi có tin nhắn mới (polling mỗi 15 giây)</p>
        <p>✅ <strong style="color:#fff">Upload tài liệu</strong> để AI học nội dung sản phẩm, chính sách, FAQ</p>
        <p>✅ <strong style="color:#fff">Thêm Q&A rules</strong> để AI trả lời chính xác hơn theo từng chủ đề</p>
        <p>✅ <strong style="color:#fff">Tiếp quản</strong> bất kỳ lúc nào trong tab Hội thoại → AI sẽ dừng trả lời hội thoại đó</p>
        <p>✅ <strong style="color:#fff">Human Agent Tag</strong> cho phép nhắn tin trong 7 ngày sau lần tương tác cuối</p>
        <p style="margin-top:8px;color:rgba(34,197,94,.7)"><i class="bi bi-check-circle"></i> <strong>AI backend đã được cấu hình sẵn</strong> — chỉ cần nhập Facebook Access Token là AI sẵn sàng hoạt động</p>
      </div>
    </div>`;
}

function renderDocItemDirect(doc, pageId, idx) {
  const icons = { pdf: 'bi-file-pdf', docx: 'bi-file-word', doc: 'bi-file-word', txt: 'bi-file-text', md: 'bi-markdown', csv: 'bi-table', json: 'bi-braces', html: 'bi-code' };
  const ext = doc.name?.split('.').pop()?.toLowerCase() || '';
  return `<div class="doc-item" id="docD_${pageId}_${idx}">
    <div class="doc-icon"><i class="bi ${icons[ext] || 'bi-file-earmark'}"></i></div>
    <div><div class="doc-name">${escHtml(doc.name)}</div><div class="doc-size">${formatBytes(doc.size || 0)} · ${(doc.chars || 0).toLocaleString()} ký tự</div></div>
    <button class="btn-sm danger" onclick="deleteDocumentDirect('${pageId}',${idx})"><i class="bi bi-trash"></i></button>
  </div>`;
}

function renderRuleItemDirect(rule, pageId, idx) {
  const catColors = { product: '#00d4ff', price: '#22c55e', shipping: '#f97316', policy: '#a855f7', support: '#f59e0b', general: '#64748b' };
  const color = catColors[rule.category] || '#64748b';
  return `<div class="rule-item" id="ruleD_${pageId}_${idx}">
    <div class="rule-content">
      <div class="rule-trigger"><span style="width:8px;height:8px;border-radius:50%;background:${color};display:inline-block"></span> ${escHtml(rule.trigger)}</div>
      <div class="rule-response">${escHtml(rule.response)}</div>
    </div>
    <div style="display:flex;gap:6px;flex-shrink:0">
      <button class="btn-sm danger" onclick="deleteRuleDirect('${pageId}',${idx})"><i class="bi bi-trash"></i></button>
    </div>
  </div>`;
}

function saveAIConfigDirect(pageId) {
  const systemPrompt = document.getElementById('cfg_systemPrompt')?.value || '';
  const maxTokens = parseInt(document.getElementById('cfg_maxTokens')?.value) || 500;
  const language = document.getElementById('cfg_language')?.value || 'vi';
  const savedConfigs = JSON.parse(localStorage.getItem('HA_PAGE_CONFIGS') || '{}');
  if (!savedConfigs[pageId]) savedConfigs[pageId] = {};
  savedConfigs[pageId].aiConfig = { systemPrompt, maxTokens, language };
  localStorage.setItem('HA_PAGE_CONFIGS', JSON.stringify(savedConfigs));
  const page = allPages.find(p => p.pageId === pageId);
  if (page) page.aiConfig = { systemPrompt, maxTokens, language };
  showToast('Đã lưu cấu hình AI', 'success');
}

function togglePageDirect(pageId, enabled) {
  const savedConfigs = JSON.parse(localStorage.getItem('HA_PAGE_CONFIGS') || '{}');
  if (!savedConfigs[pageId]) savedConfigs[pageId] = {};
  savedConfigs[pageId].enabled = enabled;
  localStorage.setItem('HA_PAGE_CONFIGS', JSON.stringify(savedConfigs));
  const page = allPages.find(p => p.pageId === pageId);
  if (page) page.enabled = enabled;
  renderPageList();
  const aiActive = allPages.filter(p => p.enabled).length;
  document.getElementById('stat-ai').textContent = aiActive;
  showToast(enabled ? 'AI đã bật cho Page này' : 'AI đã tắt', enabled ? 'success' : 'info');
}

async function uploadDocumentsDirect(pageId, files) {
  if (!files || !files.length) return;
  const savedConfigs = JSON.parse(localStorage.getItem('HA_PAGE_CONFIGS') || '{}');
  if (!savedConfigs[pageId]) savedConfigs[pageId] = {};
  if (!savedConfigs[pageId].documents) savedConfigs[pageId].documents = [];
  for (const file of files) {
    const ext = file.name.split('.').pop().toLowerCase();
    let content = '';
    if (['txt','md','csv','json','html'].includes(ext)) {
      content = await file.text();
    } else {
      content = `[${ext.toUpperCase()}: ${file.name}] - Nội dung sẽ được xử lý trên server khi kết nối`;
    }
    savedConfigs[pageId].documents.push({ name: file.name, size: file.size, chars: content.length, content: content.substring(0, 50000) });
    showToast(`Đã tải lên: ${file.name}`, 'success');
  }
  localStorage.setItem('HA_PAGE_CONFIGS', JSON.stringify(savedConfigs));
  const page = allPages.find(p => p.pageId === pageId);
  if (page) page.documentCount = savedConfigs[pageId].documents.length;
  renderConfigPageList();
  await openConfigPageDirect(pageId);
}

function handleFileDropDirect(event, pageId) {
  event.preventDefault();
  document.getElementById(`uploadZone_${pageId}`)?.classList.remove('dragover');
  uploadDocumentsDirect(pageId, event.dataTransfer.files);
}

function deleteDocumentDirect(pageId, idx) {
  if (!confirm('Xóa tài liệu này?')) return;
  const savedConfigs = JSON.parse(localStorage.getItem('HA_PAGE_CONFIGS') || '{}');
  if (savedConfigs[pageId]?.documents) {
    savedConfigs[pageId].documents.splice(idx, 1);
    localStorage.setItem('HA_PAGE_CONFIGS', JSON.stringify(savedConfigs));
    const page = allPages.find(p => p.pageId === pageId);
    if (page) page.documentCount = savedConfigs[pageId].documents.length;
    renderConfigPageList();
    openConfigPageDirect(pageId);
    showToast('Đã xóa tài liệu', 'info');
  }
}

let _currentRulePageIdDirect = null;
function openAddRuleDirect(pageId) {
  _currentRulePageIdDirect = pageId;
  document.getElementById('ruleModalTitle').textContent = 'Thêm Quy Tắc';
  document.getElementById('editRuleId').value = '';
  document.getElementById('ruleTrigger').value = '';
  document.getElementById('ruleResponse').value = '';
  document.getElementById('ruleCategory').value = 'general';
  openModal('ruleModal');
  // Override saveRule for direct mode
  window._saveRuleDirect = true;
}

const _origSaveRule = saveRule;
saveRule = function() {
  if (!window._saveRuleDirect) return _origSaveRule();
  const pageId = _currentRulePageIdDirect;
  const trigger = document.getElementById('ruleTrigger').value.trim();
  const response = document.getElementById('ruleResponse').value.trim();
  const category = document.getElementById('ruleCategory').value;
  if (!trigger || !response) return showToast('Vui lòng điền đầy đủ thông tin', 'error');
  const savedConfigs = JSON.parse(localStorage.getItem('HA_PAGE_CONFIGS') || '{}');
  if (!savedConfigs[pageId]) savedConfigs[pageId] = {};
  if (!savedConfigs[pageId].rules) savedConfigs[pageId].rules = [];
  savedConfigs[pageId].rules.push({ trigger, response, category, id: Date.now().toString() });
  localStorage.setItem('HA_PAGE_CONFIGS', JSON.stringify(savedConfigs));
  const page = allPages.find(p => p.pageId === pageId);
  if (page) page.ruleCount = savedConfigs[pageId].rules.length;
  renderConfigPageList();
  closeModal('ruleModal');
  openConfigPageDirect(pageId);
  showToast('Đã thêm quy tắc mới', 'success');
  window._saveRuleDirect = false;
};

function deleteRuleDirect(pageId, idx) {
  if (!confirm('Xóa quy tắc này?')) return;
  const savedConfigs = JSON.parse(localStorage.getItem('HA_PAGE_CONFIGS') || '{}');
  if (savedConfigs[pageId]?.rules) {
    savedConfigs[pageId].rules.splice(idx, 1);
    localStorage.setItem('HA_PAGE_CONFIGS', JSON.stringify(savedConfigs));
    const page = allPages.find(p => p.pageId === pageId);
    if (page) page.ruleCount = savedConfigs[pageId].rules.length;
    renderConfigPageList();
    openConfigPageDirect(pageId);
    showToast('Đã xóa quy tắc', 'info');
  }
}

async function testAIDirect(pageId) {
  const input = document.getElementById(`testInput_${pageId}`);
  const msg = input?.value.trim();
  if (!msg) return;
  input.value = '';
  const container = document.getElementById(`testMessages_${pageId}`);
  if (!container) return;
  container.innerHTML += `<div class="test-msg user">${escHtml(msg)}</div>`;
  const thinkingId = 'testThinking_' + Date.now();
  container.innerHTML += `<div class="test-msg ai" id="${thinkingId}"><span class="loading-spinner"></span> Đang suy nghĩ...</div>`;
  container.scrollTop = container.scrollHeight;

  const page = allPages.find(p => p.pageId === pageId);
  const savedConfigs = JSON.parse(localStorage.getItem('HA_PAGE_CONFIGS') || '{}');
  const cfg = savedConfigs[pageId] || {};
  
  // Đầu tiên thử gọi qua backend Railway (không cần user nhập API key)
  const BACKEND = 'https://genztech-production.up.railway.app';
  try {
    // Sync config to backend first
    if (page?.accessToken) {
      await fetch(`${BACKEND}/api/human-agent/pages`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-page-token': FB_TOKEN || '' },
        body: JSON.stringify({
          pageId, pageName: page.pageName, accessToken: page.accessToken,
          enabled: page.enabled || false,
          systemPrompt: cfg.aiConfig?.systemPrompt || '',
          documents: (cfg.documents || []).map(d => ({ name: d.name, content: (d.content || '').substring(0, 5000) })),
          rules: cfg.rules || []
        })
      }).catch(() => {});
    }
    // Call test endpoint
    const r = await fetch(`${BACKEND}/api/human-agent/pages/${pageId}/test`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-page-token': FB_TOKEN || '' },
      body: JSON.stringify({ message: msg })
    });
    const d = await r.json();
    if (d.error) throw new Error(d.error);
    document.getElementById(thinkingId)?.remove();
    const aiText = d.reply || d.message || 'Không có phản hồi';
    container.innerHTML += `<div class="test-msg ai">${escHtml(aiText).replace(/\n/g, '<br>')}</div>`;
  } catch(e) {
    // Fallback: thử OpenAI trực tiếp nếu có key
    const openaiKey = localStorage.getItem('HA_OPENAI_KEY') || localStorage.getItem('OPENAI_KEY');
    if (openaiKey) {
      try {
        let context = '';
        if (cfg.documents?.length) {
          context += '\n\n=== TÀI LIỆU KIẼN THỨC ===\n';
          cfg.documents.forEach(d => { context += `\n--- ${d.name} ---\n${(d.content || '').substring(0, 4000)}\n`; });
        }
        if (cfg.rules?.length) {
          context += '\n\n=== QUY TẮc Q&A ===\n';
          cfg.rules.forEach(r => { context += `Hỏi: ${r.trigger}\nTrả lời: ${r.response}\n\n`; });
        }
        const systemPrompt = (cfg.aiConfig?.systemPrompt || `Bạn là nhân viên CSKH của ${page?.pageName || 'cửa hàng'}. Hãy trả lời lịch sự, ngắn gọn bằng tiếng Việt.`) + context;
        const r2 = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${openaiKey}` },
          body: JSON.stringify({ model: 'gpt-4o-mini', messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: msg }], max_tokens: cfg.aiConfig?.maxTokens || 500, temperature: 0.7 })
        });
        const d2 = await r2.json();
        if (d2.error) throw new Error(d2.error.message);
        document.getElementById(thinkingId)?.remove();
        container.innerHTML += `<div class="test-msg ai">${escHtml(d2.choices[0].message.content).replace(/\n/g, '<br>')}</div>`;
      } catch(e2) {
        document.getElementById(thinkingId)?.remove();
        container.innerHTML += `<div class="test-msg ai" style="color:#f87171">Lỗi: ${escHtml(e2.message)}</div>`;
      }
    } else {
      document.getElementById(thinkingId)?.remove();
      container.innerHTML += `<div class="test-msg ai" style="color:#f97316">Backend không khả dụng: ${escHtml(e.message)}</div>`;
    }
  }
  container.scrollTop = container.scrollHeight;
}

async function subscribeWebhookDirect(pageId) {
  const page = allPages.find(p => p.pageId === pageId);
  if (!page) return;
  // Direct subscribe via Facebook API
  try {
    const r = await fetch(`https://graph.facebook.com/v19.0/${pageId}/subscribed_apps`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ subscribed_fields: 'messages,messaging_postbacks,messaging_handovers', access_token: page.accessToken })
    });
    const d = await r.json();
    if (d.error) throw new Error(d.error.message);
    if (d.success) showToast('Đăng ký webhook thành công!', 'success');
    else showToast('Cần cấu hình App ID trong Facebook App trước', 'info');
  } catch(e) {
    showToast('Lỗi: ' + e.message, 'error');
  }
}

// ═══════════════════════════════════════════════════════
// AI AUTO-RESPONSE ENGINE
// ═══════════════════════════════════════════════════════

// Track last message IDs to detect new messages
let lastMessageIds = {}; // pageId -> { convId -> lastMsgId }
let aiProcessingConvs = new Set(); // convIds being processed by AI

async function checkAndAutoRespond() {
  // Only run if any page has AI enabled
  const enabledPages = allPages.filter(p => p.enabled);
  if (!enabledPages.length) return;
  
  for (const page of enabledPages) {
    try {
      // Get latest conversations for this page
      const url = `https://graph.facebook.com/v19.0/${page.pageId}/conversations?fields=id,snippet,updated_time,unread_count,participants&limit=10&access_token=${page.accessToken}`;
      const r = await fetch(url);
      const d = await r.json();
      if (d.error || !d.data) continue;
      
      for (const conv of d.data) {
        // Skip if no unread messages
        if (!conv.unread_count || conv.unread_count === 0) continue;
        // Skip if already processing
        if (aiProcessingConvs.has(conv.id)) continue;
        // Skip if human has taken over this conv
        if (humanTakeoverConvs.has(conv.id)) continue;
        
        const customer = (conv.participants?.data || []).find(p => p.id !== page.pageId);
        if (!customer) continue;
        
        // Get latest message
        const msgUrl = `https://graph.facebook.com/v19.0/${conv.id}?fields=messages{id,message,from,created_time}&access_token=${page.accessToken}`;
        const mr = await fetch(msgUrl);
        const md = await mr.json();
        if (md.error || !md.messages?.data?.length) continue;
        
        const msgs = md.messages.data;
        const latestMsg = msgs[0]; // Most recent first
        
        // Skip if latest message is from the page (already replied)
        if (latestMsg.from?.id === page.pageId) continue;
        
        // Check if this is a new message we haven't processed
        const lastId = lastMessageIds[page.pageId]?.[conv.id];
        if (lastId === latestMsg.id) continue; // Already processed
        
        // Mark as processing
        aiProcessingConvs.add(conv.id);
        if (!lastMessageIds[page.pageId]) lastMessageIds[page.pageId] = {};
        lastMessageIds[page.pageId][conv.id] = latestMsg.id;
        
        // Generate AI response
        try {
          const aiReply = await generateAIResponse(page, latestMsg.message, msgs.slice(0, 5));
          if (aiReply) {
            // Send AI response
            await fetch(`https://graph.facebook.com/v19.0/${page.pageId}/messages`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                recipient: { id: customer.id },
                message: { text: aiReply },
                access_token: page.accessToken
              })
            });
            // Update conversation list if visible
            const convInList = allConversations.find(c => c.convId === conv.id);
            if (convInList) {
              convInList.lastMessage = aiReply;
              convInList.updatedAt = new Date().toISOString();
            }
            // If this conv is currently open, refresh messages
            if (selectedConvPageId === page.pageId && selectedConvUserId === customer.id) {
              const container = document.getElementById('chatMessages');
              if (container) {
                const div = document.createElement('div');
                div.className = 'msg-row assistant';
                div.innerHTML = `<div><div class="msg-bubble assistant ai">${escHtml(aiReply)}</div><div class="msg-meta"><i class="bi bi-robot"></i> AI · Vừa xong</div></div>`;
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
              }
            }
          }
        } catch(e) {
          console.warn('AI auto-response error:', e.message);
        } finally {
          aiProcessingConvs.delete(conv.id);
        }
      }
    } catch(e) {
      // Silent fail for auto-response
    }
  }
}

async function generateAIResponse(page, userMessage, recentMsgs = []) {
  const BACKEND = 'https://genztech-production.up.railway.app';
  const savedConfigs = JSON.parse(localStorage.getItem('HA_PAGE_CONFIGS') || '{}');
  const cfg = savedConfigs[page.pageId] || {};
  
  // Thử gọi qua backend Railway trước (không cần user nhập API key)
  try {
    // Sync config to backend
    await fetch(`${BACKEND}/api/human-agent/pages`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-page-token': FB_TOKEN || '' },
      body: JSON.stringify({
        pageId: page.pageId, pageName: page.pageName, accessToken: page.accessToken,
        enabled: true,
        systemPrompt: cfg.aiConfig?.systemPrompt || '',
        documents: (cfg.documents || []).map(d => ({ name: d.name, content: (d.content || '').substring(0, 5000) })),
        rules: cfg.rules || []
      })
    });
    // Call test endpoint with user message
    const r = await fetch(`${BACKEND}/api/human-agent/pages/${page.pageId}/test`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-page-token': FB_TOKEN || '' },
      body: JSON.stringify({ message: userMessage })
    });
    const d = await r.json();
    if (d.error) throw new Error(d.error);
    return d.reply || null;
  } catch(e) {
    // Fallback: thử OpenAI trực tiếp nếu có key
    const openaiKey = localStorage.getItem('HA_OPENAI_KEY') || localStorage.getItem('OPENAI_KEY');
    if (!openaiKey) return null;
    
    let context = '';
    if (cfg.documents?.length) {
      context += '\n\n=== TÀI LIỆU KIẼN THỨC ===\n';
      cfg.documents.forEach(d => { context += `\n--- ${d.name} ---\n${(d.content || '').substring(0, 4000)}\n`; });
    }
    if (cfg.rules?.length) {
      context += '\n\n=== QUY TẮc Q&A ===\n';
      cfg.rules.forEach(r => { context += `Hỏi: ${r.trigger}\nTrả lời: ${r.response}\n\n`; });
    }
    const systemPrompt = (cfg.aiConfig?.systemPrompt || 
      `Bạn là nhân viên CSKH của ${page.pageName}. Hãy trả lời lịch sự, ngắn gọn bằng tiếng Việt.`) + context;
    const messages = [{ role: 'system', content: systemPrompt }];
    const historyMsgs = [...recentMsgs].reverse().slice(-4);
    historyMsgs.forEach(m => {
      messages.push({ role: m.from?.id === page.pageId ? 'assistant' : 'user', content: m.message || '' });
    });
    if (!historyMsgs.find(m => m.message === userMessage && m.from?.id !== page.pageId)) {
      messages.push({ role: 'user', content: userMessage });
    }
    try {
      const r2 = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${openaiKey}` },
        body: JSON.stringify({ model: 'gpt-4o-mini', messages, max_tokens: cfg.aiConfig?.maxTokens || 300, temperature: 0.7 })
      });
      const d2 = await r2.json();
      if (d2.error) throw new Error(d2.error.message);
      return d2.choices[0].message.content;
    } catch(e2) {
      console.warn('AI fallback error:', e2.message);
      return null;
    }
  }
}

// Track human takeover conversations
let humanTakeoverConvs = new Set();

// Override takeoverConvDirect to track
const _origTakeoverDirect = takeoverConvDirect;
takeoverConvDirect = function(convId) {
  humanTakeoverConvs.add(convId);
  _origTakeoverDirect(convId);
};

// Override releaseConvDirect to untrack
const _origReleaseDirect = releaseConvDirect;
releaseConvDirect = function(convId) {
  humanTakeoverConvs.delete(convId);
  _origReleaseDirect(convId);
};

// ═══════════════════════════════════════════════════════
// REAL-TIME POLLING
// ═══════════════════════════════════════════════════════

let pollingInterval = null;
let lastConvTimestamps = {}; // convId -> timestamp

async function pollNewMessages() {
  if (!allPages.length) return;
  
  // Get enabled pages or first 5 pages
  const pagesToPoll = allPages.filter(p => p.accessToken).slice(0, 5);
  let hasNewMessages = false;
  
  for (const page of pagesToPoll) {
    try {
      const url = `https://graph.facebook.com/v19.0/${page.pageId}/conversations?fields=id,snippet,updated_time,unread_count,participants&limit=10&access_token=${page.accessToken}`;
      const r = await fetch(url);
      const d = await r.json();
      if (d.error || !d.data) continue;
      
      for (const conv of d.data) {
        const newTs = new Date(conv.updated_time).getTime();
        const oldTs = lastConvTimestamps[conv.id] || 0;
        
        if (newTs > oldTs && oldTs > 0) {
          hasNewMessages = true;
          // Update in allConversations
          const existing = allConversations.find(c => c.convId === conv.id);
          if (existing) {
            existing.lastMessage = conv.snippet || existing.lastMessage;
            existing.updatedAt = conv.updated_time;
            existing.lastTimestamp = newTs;
            existing.unreadCount = conv.unread_count || 0;
            existing.unread = conv.unread_count || 0;
          }
          // If this conv is open, refresh messages
          if (selectedConvPageId === page.pageId) {
            const convInList = allConversations.find(c => c.convId === conv.id);
            const customer = (conv.participants?.data || []).find(p => p.id !== page.pageId);
            if (customer && selectedConvUserId === customer.id) {
              // Refresh messages for open conversation
              openConversationDirect(page.pageId, customer.id, customer.name || '');
            }
          }
        }
        lastConvTimestamps[conv.id] = newTs;
      }
    } catch(e) { /* silent */ }
  }
  
  if (hasNewMessages) {
    // Re-sort and re-render conv list
    allConversations.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
    renderConvList(allConversations);
    loadStatsLocal();
    // Show notification
    const badge = document.getElementById('tab-conversations')?.querySelector('.tab-badge');
    if (badge) badge.classList.add('red');
  }
  
  // Run AI auto-response if any page has AI enabled
  const hasEnabledPages = allPages.some(p => p.enabled);
  if (hasEnabledPages) {
    await checkAndAutoRespond();
  }
}

function startPolling() {
  if (pollingInterval) clearInterval(pollingInterval);
  // Poll every 15 seconds
  pollingInterval = setInterval(pollNewMessages, 15000);
  // Show live indicator
  const status = document.getElementById('pollingStatus');
  if (status) status.style.display = 'flex';
}

function stopPolling() {
  if (pollingInterval) { clearInterval(pollingInterval); pollingInterval = null; }
  const status = document.getElementById('pollingStatus');
  if (status) status.style.display = 'none';
}

document.addEventListener('DOMContentLoaded', () => {
  // Auto-load pages if token exists (always try, server is optional)
  const token = localStorage.getItem('HA_FB_TOKEN') || localStorage.getItem('FB_TOKEN_MANUAL') || localStorage.getItem('fb_token');
  if (token) {
    FB_TOKEN = token;
    setTimeout(async () => {
      await loadPagesDirect();
      updateConvPageFilter(); // Populate dropdown filter sau khi load pages
      // Start polling after pages are loaded
      setTimeout(() => {
        startPolling();
        // Initialize lastConvTimestamps from current conversations
        allConversations.forEach(c => {
          if (c.updatedAt) lastConvTimestamps[c.convId] = new Date(c.updatedAt).getTime();
        });
      }, 2000);
    }, 500);
  }
});
</script>
</body>
</html>
