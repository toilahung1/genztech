<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Tìm Facebook ID — GenZTech</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <style>
    html,body{scrollbar-width:none;-ms-overflow-style:none;cursor:none;-webkit-user-select:none;user-select:none;margin:0;padding:0;font-family:'Inter',sans-serif;background:#080c1e;color:#fff}
    html::-webkit-scrollbar,body::-webkit-scrollbar{display:none;width:0}
    canvas.bg-canvas{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0}
    #custom-cursor{position:fixed;width:20px;height:20px;border-radius:50%;border:2px solid rgba(0,212,255,.8);pointer-events:none;z-index:9999;transform:translate(-50%,-50%);transition:opacity .3s;opacity:0;mix-blend-mode:screen}
    .app-layout{display:flex;min-height:100vh;position:relative;z-index:1}
    /* Sidebar */
    .sidebar{width:240px;flex-shrink:0;background:rgba(10,14,39,.92);backdrop-filter:blur(20px);border-right:1px solid rgba(255,255,255,.06);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:40}
    .sidebar-logo{padding:18px 18px 14px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;gap:10px;text-decoration:none}
    .sidebar-logo img{width:34px;height:34px;border-radius:50%}
    .sidebar-logo span{font-size:14px;font-weight:700;letter-spacing:.5px;color:#fff}
    .sidebar-logo span em{color:#00d4ff;font-style:normal}
    .sidebar-nav{flex:1;padding:10px 0;overflow-y:auto}
    .nav-group-label{font-size:10px;font-weight:600;letter-spacing:1.2px;color:rgba(255,255,255,.3);text-transform:uppercase;padding:10px 18px 4px}
    .nav-item{display:flex;align-items:center;gap:10px;padding:9px 18px;font-size:13px;color:rgba(255,255,255,.6);text-decoration:none;transition:all .2s;border-left:2px solid transparent}
    .nav-item:hover{color:#fff;background:rgba(255,255,255,.04)}
    .nav-item.active{color:#00d4ff;background:rgba(0,212,255,.08);border-left-color:#00d4ff}
    .nav-item i{width:17px;text-align:center;font-size:14px}
    .nav-sub-item{display:flex;align-items:center;gap:10px;padding:7px 18px 7px 34px;font-size:12px;color:rgba(255,255,255,.5);text-decoration:none;transition:all .2s;border-left:2px solid transparent}
    .nav-sub-item:hover{color:#fff;background:rgba(255,255,255,.04)}
    .nav-sub-item.active{color:#00d4ff;background:rgba(0,212,255,.06);border-left-color:#00d4ff}
    .sidebar-footer{padding:14px 18px;border-top:1px solid rgba(255,255,255,.06)}
    /* Main */
    .main-content{margin-left:240px;flex:1;display:flex;flex-direction:column;min-height:100vh}
    .topbar{position:sticky;top:0;z-index:30;background:rgba(10,14,39,.9);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,.06);padding:0 24px;height:58px;display:flex;align-items:center;justify-content:space-between}
    .breadcrumb{font-size:12.5px;color:rgba(255,255,255,.4);display:flex;align-items:center;gap:6px}
    .breadcrumb span{color:#fff;font-weight:600}
    .btn{padding:7px 14px;border-radius:8px;font-size:12.5px;font-weight:600;border:none;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
    .btn-primary{background:#1877f2;color:#fff}.btn-primary:hover{background:#1565d8}
    .btn-outline{background:transparent;color:rgba(255,255,255,.7);border:1px solid rgba(255,255,255,.15)}.btn-outline:hover{border-color:#00d4ff;color:#00d4ff}
    .btn-sm{padding:5px 12px;font-size:12px}
    .btn-icon{padding:6px 10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);color:rgba(255,255,255,.6);border-radius:8px;cursor:pointer;font-size:13px;display:inline-flex;align-items:center;gap:5px;transition:all .2s}.btn-icon:hover{background:rgba(255,255,255,.1);color:#fff}
    /* Page */
    .page-body{padding:20px 24px;flex:1}
    /* Card */
    .card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:12px;overflow:hidden;margin-bottom:16px}
    .card-header{padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;justify-content:space-between}
    .card-title{font-size:13.5px;font-weight:700;display:flex;align-items:center;gap:8px}
    .card-body{padding:18px}
    /* Form */
    .form-group{margin-bottom:14px}
    .form-label{font-size:11.5px;font-weight:600;color:rgba(255,255,255,.5);margin-bottom:6px;display:block;text-transform:uppercase;letter-spacing:.5px}
    .form-control{width:100%;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:9px 13px;color:#fff;font-size:13px;transition:border-color .2s;box-sizing:border-box;font-family:'Inter',sans-serif}
    .form-control:focus{outline:none;border-color:#38bdf8;box-shadow:0 0 0 3px rgba(56,189,248,.08)}
    .form-control::placeholder{color:rgba(255,255,255,.25)}
    textarea.form-control{resize:vertical;min-height:120px;line-height:1.6}
    /* Tabs */
    .tab-bar{display:flex;gap:3px;padding:4px;background:rgba(0,0,0,.25);border-radius:10px;margin-bottom:18px}
    .tab-btn{flex:1;padding:8px 10px;border:none;border-radius:7px;background:transparent;color:rgba(255,255,255,.45);font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:5px;font-family:'Inter',sans-serif}
    .tab-btn.active{background:rgba(56,189,248,.15);color:#38bdf8;box-shadow:0 0 0 1px rgba(56,189,248,.2)}
    .tab-pane{display:none}
    .tab-pane.active{display:block}
    /* Result */
    .result-box{background:rgba(56,189,248,.04);border:1px solid rgba(56,189,248,.2);border-radius:12px;padding:20px;text-align:center;margin-bottom:14px}
    .result-id-big{font-size:32px;font-weight:800;color:#38bdf8;letter-spacing:2px;font-family:monospace;margin-bottom:4px;word-break:break-all}
    .result-name{font-size:14px;font-weight:600;color:#fff;margin-bottom:12px}
    .result-meta{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:14px}
    .meta-chip{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:20px;padding:4px 12px;font-size:11.5px;color:rgba(255,255,255,.7);display:flex;align-items:center;gap:5px}
    .meta-chip i{color:#38bdf8;font-size:12px}
    .copy-actions{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
    .copy-btn{padding:8px 16px;border-radius:8px;font-size:12.5px;font-weight:600;border:none;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:6px;font-family:'Inter',sans-serif}
    .copy-btn-primary{background:linear-gradient(135deg,#1877f2,#38bdf8);color:#fff}
    .copy-btn-primary:hover{opacity:.9;transform:translateY(-1px)}
    .copy-btn-outline{background:rgba(255,255,255,.06);color:rgba(255,255,255,.7);border:1px solid rgba(255,255,255,.12)}
    .copy-btn-outline:hover{border-color:#38bdf8;color:#38bdf8}
    /* Bulk */
    .bulk-row{display:grid;grid-template-columns:1fr 160px 120px 40px;gap:8px;align-items:center;background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.06);border-radius:8px;padding:10px 14px;margin-bottom:6px;transition:border-color .2s}
    .bulk-input{font-size:12px;color:rgba(255,255,255,.55);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .bulk-id{font-size:13px;font-weight:700;color:#38bdf8;font-family:monospace}
    .bulk-name{font-size:12px;color:rgba(255,255,255,.5);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    /* History */
    .history-item{background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.06);border-radius:8px;padding:10px 14px;margin-bottom:6px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;transition:all .15s}
    .history-item:hover{border-color:rgba(56,189,248,.3);background:rgba(56,189,248,.04)}
    /* Spinner */
    .spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.15);border-top-color:#38bdf8;border-radius:50%;animation:spin .6s linear infinite;flex-shrink:0}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* Toast */
    #toast{position:fixed;bottom:24px;right:24px;z-index:9999;display:flex;flex-direction:column;gap:8px;pointer-events:none}
    .toast-item{background:rgba(15,23,42,.95);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:11px 16px;font-size:13px;display:flex;align-items:center;gap:10px;min-width:240px;animation:slideIn .3s ease;box-shadow:0 8px 24px rgba(0,0,0,.5);pointer-events:auto}
    .toast-item.success{border-left:3px solid #22c55e}
    .toast-item.error{border-left:3px solid #ef4444}
    .toast-item.info{border-left:3px solid #38bdf8}
    @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
    /* Grid */
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    @media(max-width:960px){.grid-2{grid-template-columns:1fr}}
    @media(max-width:768px){.sidebar{display:none}.main-content{margin-left:0}}
    /* Token banner */
    .token-ok{background:rgba(34,197,94,.06);border:1px solid rgba(34,197,94,.15);border-radius:8px;padding:10px 14px;font-size:12px;display:flex;align-items:center;gap:8px;margin-bottom:14px}
    .token-warn{background:rgba(251,191,36,.06);border:1px solid rgba(251,191,36,.15);border-radius:8px;padding:10px 14px;font-size:12px;display:flex;align-items:center;gap:8px;margin-bottom:14px}
    /* Example chips */
    .example-chip{font-size:11px;padding:3px 10px;background:rgba(56,189,248,.08);border:1px solid rgba(56,189,248,.15);border-radius:6px;cursor:pointer;color:#7dd3fc;transition:all .15s;display:inline-block}
    .example-chip:hover{background:rgba(56,189,248,.15);border-color:rgba(56,189,248,.3)}
    /* Empty state */
    .empty-state{text-align:center;padding:36px 20px;color:rgba(255,255,255,.3)}
    .empty-state i{font-size:36px;display:block;margin-bottom:10px;opacity:.5}
    /* Shared token notice */
    .shared-token-notice{background:rgba(56,189,248,.04);border:1px solid rgba(56,189,248,.1);border-radius:8px;padding:10px 14px;font-size:11.5px;color:rgba(255,255,255,.5);margin-bottom:14px;display:flex;align-items:flex-start;gap:8px}
  </style>
</head>
<body>
<canvas class="bg-canvas" id="bgCanvas"></canvas>
<div id="custom-cursor"></div>
<div id="toast"></div>

<div class="app-layout">
  <!-- Sidebar -->
  <aside class="sidebar">
    <a href="index.html" class="sidebar-logo">
      <img src="https://ui-avatars.com/api/?name=GZ&background=1877f2&color=fff&bold=true" alt="logo">
      <span>GENZ<em>TECH</em></span>
    </a>
    <nav class="sidebar-nav">
      <div class="nav-group-label">Công Cụ</div>
      <a href="index.html" class="nav-item"><i class="bi bi-grid-1x2"></i> Dashboard</a>
      <a href="auto-post.html" class="nav-item"><i class="bi bi-send"></i> Tự Động Đăng Bài</a>
      <a href="ads-assistant.html" class="nav-item" onclick="toggleSubNav(event,'subNavAds')">
        <i class="bi bi-megaphone"></i> Trợ Lý Quảng Cáo
        <i class="bi bi-chevron-down" id="subNavAdsArrow" style="margin-left:auto;font-size:11px;transition:transform .2s"></i>
      </a>
      <div id="subNavAds" style="display:block">
        <a href="tool-ad-account.html" class="nav-sub-item"><i class="bi bi-shield-check"></i> Kiểm Tra TKQC</a>
        <a href="tool-fb-id.html" class="nav-sub-item active"><i class="bi bi-person-badge"></i> Tìm Facebook ID</a>
        <a href="tool-budget.html" class="nav-sub-item"><i class="bi bi-graph-up-arrow"></i> Phân Tích Ngân Sách</a>
        <a href="tool-translate.html" class="nav-sub-item"><i class="bi bi-translate"></i> Dịch Thuật</a>
        <a href="tool-ads-finder.html" class="nav-sub-item"><i class="bi bi-binoculars"></i> Ads Finder</a>
        <a href="tool-policy.html" class="nav-sub-item"><i class="bi bi-journal-text"></i> Chính Sách FB</a>
        <a href="tool-cookie.html" class="nav-sub-item"><i class="bi bi-cookie"></i> Quản Lý Cookie</a>
      </div>
      <a href="#" class="nav-item" onclick="openSettings()"><i class="bi bi-gear"></i> Cài Đặt</a>
    </nav>
    <div class="sidebar-footer">
      <div style="font-size:11px;color:rgba(255,255,255,.3);display:flex;align-items:center;gap:6px">
        <i class="bi bi-person-badge" style="color:#38bdf8"></i> Tìm Facebook ID v2.0
      </div>
    </div>
  </aside>

  <!-- Main -->
  <div class="main-content">
    <div class="topbar">
      <div class="topbar-left">
        <div class="breadcrumb">
          <a href="ads-assistant.html" style="color:rgba(255,255,255,.4);text-decoration:none">Trợ Lý QC</a>
          <i class="bi bi-chevron-right" style="font-size:10px"></i>
          <span>Tìm Facebook ID</span>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <button class="btn-icon" onclick="clearHistory()" title="Xóa lịch sử"><i class="bi bi-trash"></i></button>
        <button class="btn-icon" onclick="exportHistory()" title="Xuất CSV"><i class="bi bi-download"></i></button>
      </div>
    </div>

    <div class="page-body">

      <!-- Token banner -->
      <div id="tokenBanner" class="token-warn" style="display:none">
        <i class="bi bi-exclamation-triangle-fill" style="color:#fbbf24;font-size:15px;flex-shrink:0"></i>
        <div style="flex:1">
          <strong style="color:#fbbf24">Chưa có Access Token</strong> — Một số tra cứu cần token. Nhập token vào ô bên dưới.
        </div>
      </div>
      <div id="tokenOkBanner" class="token-ok" style="display:none">
        <i class="bi bi-key-fill" style="color:#4ade80;font-size:15px;flex-shrink:0"></i>
        <div style="flex:1;font-size:12px"><strong style="color:#4ade80">Token đã sẵn sàng</strong> — Gọi thẳng Facebook Graph API.</div>
        <button class="btn btn-outline btn-sm" onclick="clearToken()" style="color:#f87171;border-color:rgba(248,113,113,.2)">Xóa</button>
      </div>

      <!-- Tabs -->
      <div class="tab-bar">
        <button class="tab-btn active" id="tabSingle" onclick="switchTab('single')"><i class="bi bi-person"></i> Tra Cứu Đơn Lẻ</button>
        <button class="tab-btn" id="tabBulk" onclick="switchTab('bulk')"><i class="bi bi-people"></i> Tra Cứu Hàng Loạt</button>
        <button class="tab-btn" id="tabHistory" onclick="switchTab('history')"><i class="bi bi-clock-history"></i> Lịch Sử <span id="historyCount" style="background:rgba(56,189,248,.2);color:#38bdf8;font-size:10px;padding:1px 7px;border-radius:20px;margin-left:2px">0</span></button>
      </div>

      <!-- ── Tab: Single ── -->
      <div id="paneSingle" class="tab-pane active">
        <div class="grid-2">
          <!-- Input -->
          <div>
            <div class="card">
              <div class="card-header">
                <div class="card-title"><i class="bi bi-search" style="color:#38bdf8"></i> Nhập Link / Username</div>
              </div>
              <div class="card-body">
                <div class="form-group">
                  <label class="form-label">Link Facebook hoặc Username</label>
                  <input type="text" class="form-control" id="fbInput"
                    placeholder="https://facebook.com/username hoặc username..."
                    onkeydown="if(event.key==='Enter')doFind()" autocomplete="off" spellcheck="false">
                </div>

                <div class="form-group">
                  <label class="form-label"><i class="bi bi-key" style="color:#fbbf24"></i> Access Token <span style="color:rgba(255,255,255,.3);font-weight:400;text-transform:none;letter-spacing:0">(bắt buộc để tra cứu)</span></label>
                  <input type="password" class="form-control" id="fbTokenInput"
                    placeholder="EAAxxxxxxxxxxxxxxx..."
                    style="font-family:monospace;font-size:12px" oninput="onTokenInput()" autocomplete="off">
                  <div style="font-size:11px;color:rgba(255,255,255,.28);margin-top:5px">
                    <i class="bi bi-shield-lock"></i> Token lưu trong trình duyệt, không gửi lên server. Gọi thẳng Facebook Graph API.
                  </div>
                </div>

                <div style="margin-bottom:16px">
                  <div style="font-size:11px;color:rgba(255,255,255,.3);margin-bottom:7px;text-transform:uppercase;letter-spacing:.5px">Ví dụ hợp lệ</div>
                  <div style="display:flex;flex-wrap:wrap;gap:6px">
                    <span class="example-chip" onclick="setExample('https://facebook.com/zuck')">facebook.com/zuck</span>
                    <span class="example-chip" onclick="setExample('https://www.facebook.com/profile.php?id=4')">profile.php?id=4</span>
                    <span class="example-chip" onclick="setExample('https://www.facebook.com/groups/123456789')">groups/ID</span>
                    <span class="example-chip" onclick="setExample('https://www.facebook.com/pages/PageName/123456789')">pages/Name/ID</span>
                    <span class="example-chip" onclick="setExample('zuck')">username</span>
                  </div>
                </div>

                <button class="btn btn-primary" style="width:100%;justify-content:center;padding:10px" onclick="doFind()" id="findBtn">
                  <i class="bi bi-search"></i> Tìm Facebook ID
                </button>
              </div>
            </div>

            <!-- How it works -->
            <div class="card">
              <div class="card-header">
                <div class="card-title"><i class="bi bi-info-circle" style="color:#a78bfa"></i> Cách hoạt động</div>
              </div>
              <div class="card-body" style="font-size:12.5px;color:rgba(255,255,255,.5);line-height:1.8">
                <div style="margin-bottom:8px"><i class="bi bi-1-circle" style="color:#38bdf8"></i> <strong style="color:rgba(255,255,255,.7)">URL có ID số sẵn</strong> — Trích xuất trực tiếp, không cần token</div>
                <div style="margin-bottom:8px"><i class="bi bi-2-circle" style="color:#38bdf8"></i> <strong style="color:rgba(255,255,255,.7)">URL dùng username</strong> — Gọi Facebook Graph API để lấy ID</div>
                <div><i class="bi bi-3-circle" style="color:#38bdf8"></i> <strong style="color:rgba(255,255,255,.7)">Hỗ trợ</strong> — Profile cá nhân, Page, Group, App</div>
              </div>
            </div>
          </div>

          <!-- Result -->
          <div>
            <div id="loadingCard" style="display:none">
              <div class="card">
                <div class="card-body" style="display:flex;align-items:center;gap:12px;color:rgba(255,255,255,.4);font-size:13px;padding:24px">
                  <span class="spinner"></span> Đang tra cứu Facebook ID...
                </div>
              </div>
            </div>

            <div id="resultCard" style="display:none">
              <div class="card">
                <div class="card-header">
                  <div class="card-title"><i class="bi bi-check-circle-fill" style="color:#4ade80"></i> Kết Quả</div>
                  <button class="btn btn-outline btn-sm" onclick="openProfile()"><i class="bi bi-box-arrow-up-right"></i> Mở trang</button>
                </div>
                <div class="card-body">
                  <div class="result-box">
                    <div style="font-size:10px;color:rgba(255,255,255,.35);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px">Facebook ID</div>
                    <div class="result-id-big" id="resultId">—</div>
                    <div class="result-name" id="resultName">—</div>
                    <div class="result-meta" id="resultMeta"></div>
                    <div class="copy-actions">
                      <button class="copy-btn copy-btn-primary" onclick="copyId()">
                        <i class="bi bi-clipboard"></i> Copy ID
                      </button>
                      <button class="copy-btn copy-btn-outline" onclick="copyLink()">
                        <i class="bi bi-link-45deg"></i> Copy Link
                      </button>
                    </div>
                  </div>
                  <div id="resultExtra" style="font-size:12px;color:rgba(255,255,255,.4);background:rgba(0,0,0,.2);border-radius:8px;padding:10px 12px;line-height:1.7"></div>
                </div>
              </div>
            </div>

            <div id="emptyCard">
              <div class="card">
                <div class="card-body">
                  <div class="empty-state">
                    <i class="bi bi-person-badge"></i>
                    <div style="font-size:13px">Nhập link Facebook và nhấn <strong style="color:#38bdf8">Tìm Facebook ID</strong></div>
                    <div style="font-size:11.5px;margin-top:6px">Hỗ trợ: Profile cá nhân · Page · Group</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ── Tab: Bulk ── -->
      <div id="paneBulk" class="tab-pane">
        <div class="card">
          <div class="card-header">
            <div class="card-title"><i class="bi bi-people" style="color:#38bdf8"></i> Tra Cứu Hàng Loạt</div>
            <div style="display:flex;gap:8px">
              <button class="btn btn-outline btn-sm" onclick="exportBulkCSV()"><i class="bi bi-download"></i> Xuất CSV</button>
              <button class="btn btn-primary btn-sm" onclick="doBulkFind()" id="bulkBtn"><i class="bi bi-search"></i> Tra Cứu Tất Cả</button>
            </div>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label class="form-label">Danh sách link/username <span style="color:rgba(255,255,255,.3);text-transform:none;letter-spacing:0;font-weight:400">(mỗi dòng một link, tối đa 50)</span></label>
              <textarea class="form-control" id="bulkInput"
                placeholder="https://facebook.com/page1&#10;https://facebook.com/page2&#10;username3&#10;..."
                style="min-height:130px;font-size:12px;font-family:monospace"></textarea>
            </div>
            <div class="shared-token-notice">
              <i class="bi bi-info-circle" style="color:#38bdf8;flex-shrink:0;margin-top:1px"></i>
              <div>Token nhập ở tab <strong style="color:#38bdf8">Tra Cứu Đơn Lẻ</strong> sẽ được dùng chung cho tra cứu hàng loạt. Nếu URL chứa ID số sẵn thì không cần token.</div>
            </div>
          </div>
        </div>
        <div id="bulkResults"></div>
      </div>

      <!-- ── Tab: History ── -->
      <div id="paneHistory" class="tab-pane">
        <div class="card">
          <div class="card-header">
            <div class="card-title"><i class="bi bi-clock-history" style="color:#38bdf8"></i> Lịch Sử Tra Cứu</div>
            <div style="display:flex;gap:8px">
              <button class="btn btn-outline btn-sm" onclick="exportHistory()"><i class="bi bi-download"></i> Xuất CSV</button>
              <button class="btn btn-outline btn-sm" onclick="clearHistory()" style="color:#f87171;border-color:rgba(248,113,113,.2)"><i class="bi bi-trash"></i> Xóa tất cả</button>
            </div>
          </div>
          <div class="card-body" id="historyList">
            <div class="empty-state"><i class="bi bi-clock-history"></i>Chưa có lịch sử tra cứu</div>
          </div>
        </div>
      </div>

    </div><!-- /page-body -->
  </div><!-- /main-content -->
</div><!-- /app-layout -->

<script>
// ── Constants ──
const FB_GRAPH = 'https://graph.facebook.com/v25.0';
let _history = JSON.parse(localStorage.getItem('genz_fbid_history') || '[]');
let _lastResult = null;

// ── Token ──
function getToken() {
  return document.getElementById('fbTokenInput')?.value.trim() ||
         localStorage.getItem('gz_manual_fb_token') || '';
}
function onTokenInput() {
  const t = document.getElementById('fbTokenInput').value.trim();
  if (t) {
    localStorage.setItem('gz_fbid_token', t);
    document.getElementById('tokenBanner').style.display = 'none';
    document.getElementById('tokenOkBanner').style.display = 'flex';
  } else {
    localStorage.removeItem('gz_fbid_token');
    document.getElementById('tokenOkBanner').style.display = 'none';
    document.getElementById('tokenBanner').style.display = 'flex';
  }
}
function clearToken() {
  document.getElementById('fbTokenInput').value = '';
  localStorage.removeItem('gz_fbid_token');
  document.getElementById('tokenOkBanner').style.display = 'none';
  document.getElementById('tokenBanner').style.display = 'flex';
  toast('Đã xóa token', 'info');
}

// ── URL Parser ──
// Trích xuất ID số hoặc username từ URL Facebook
function parseUrl(raw) {
  raw = raw.trim();
  if (!raw) return null;

  // Thêm protocol nếu thiếu
  const url = raw.startsWith('http') ? raw : 'https://facebook.com/' + raw;

  try {
    const u = new URL(url);
    const path = u.pathname.replace(/\/$/, '');
    const parts = path.split('/').filter(Boolean);

    // profile.php?id=XXXXXXX
    if (u.searchParams.get('id')) {
      const id = u.searchParams.get('id');
      if (/^\d+$/.test(id)) return { type: 'numeric_id', value: id };
    }

    // /groups/XXXXXXX
    if (parts[0] === 'groups' && parts[1]) {
      if (/^\d+$/.test(parts[1])) return { type: 'numeric_id', value: parts[1] };
      return { type: 'username', value: parts[1] };
    }

    // /pages/PageName/XXXXXXX
    if (parts[0] === 'pages' && parts.length >= 3) {
      const last = parts[parts.length - 1];
      if (/^\d+$/.test(last)) return { type: 'numeric_id', value: last };
      return { type: 'username', value: last };
    }

    // /username hoặc bare username
    if (parts.length === 1) {
      if (/^\d+$/.test(parts[0])) return { type: 'numeric_id', value: parts[0] };
      return { type: 'username', value: parts[0].replace(/^@/, '') };
    }

    // Fallback: lấy phần cuối
    const last = parts[parts.length - 1];
    if (/^\d+$/.test(last)) return { type: 'numeric_id', value: last };
    return { type: 'username', value: last.replace(/^@/, '') };
  } catch {
    // Bare username
    if (/^\d+$/.test(raw)) return { type: 'numeric_id', value: raw };
    return { type: 'username', value: raw.replace(/^@/, '') };
  }
}

// ── Core lookup ──
async function lookupId(input) {
  const parsed = parseUrl(input);
  if (!parsed) throw new Error('Link không hợp lệ');

  // Nếu đã có ID số → không cần API
  if (parsed.type === 'numeric_id') {
    return {
      id: parsed.value,
      name: 'ID từ URL',
      type: 'Không xác định (từ URL)',
      username: null,
      category: null,
      likes: null,
      link: `https://facebook.com/${parsed.value}`,
      source: 'url_extract'
    };
  }

  // Cần token để gọi Graph API
  const token = getToken();
  if (!token) throw new Error('Cần Access Token để tra cứu username. Vui lòng nhập token.');

  const fields = 'id,name,username,category,fan_count,link,picture';
  const r = await fetch(`${FB_GRAPH}/${encodeURIComponent(parsed.value)}?fields=${fields}&access_token=${encodeURIComponent(token)}`);
  const d = await r.json();

  if (d.error) {
    const code = d.error.code;
    if (code === 100) throw new Error('Không tìm thấy trang/người dùng này');
    if (code === 190) throw new Error('Token không hợp lệ hoặc đã hết hạn');
    if (code === 200 || code === 10) throw new Error('Token không có quyền truy cập');
    throw new Error(d.error.message || 'Lỗi Facebook API');
  }

  let type = 'Tài khoản cá nhân';
  if (d.category) type = 'Page';
  else if (input.includes('/groups/')) type = 'Group';

  return {
    id: d.id,
    name: d.name || parsed.value,
    type,
    username: d.username || parsed.value,
    category: d.category || null,
    likes: d.fan_count || null,
    link: d.link || `https://facebook.com/${d.id}`,
    picture: d.picture?.data?.url || null,
    source: 'graph_api'
  };
}

// ── UI: Single ──
function setExample(val) {
  document.getElementById('fbInput').value = val;
  document.getElementById('fbInput').focus();
}

async function doFind() {
  const input = document.getElementById('fbInput').value.trim();
  if (!input) { toast('Vui lòng nhập link hoặc username', 'error'); return; }

  const btn = document.getElementById('findBtn');
  btn.innerHTML = '<span class="spinner"></span> Đang tìm...';
  btn.disabled = true;
  document.getElementById('resultCard').style.display = 'none';
  document.getElementById('emptyCard').style.display = 'none';
  document.getElementById('loadingCard').style.display = 'block';

  try {
    const result = await lookupId(input);
    _lastResult = result;
    showResult(result);

    // Save history
    _history.unshift({ input, ...result, time: Date.now() });
    if (_history.length > 200) _history.pop();
    localStorage.setItem('genz_fbid_history', JSON.stringify(_history));
    updateHistoryCount();

    toast(result.source === 'url_extract' ? 'Trích xuất ID từ URL thành công!' : 'Tìm thấy ID!', 'success');
  } catch(e) {
    document.getElementById('emptyCard').style.display = 'block';
    toast('Lỗi: ' + e.message, 'error');
  } finally {
    document.getElementById('loadingCard').style.display = 'none';
    btn.innerHTML = '<i class="bi bi-search"></i> Tìm Facebook ID';
    btn.disabled = false;
  }
}

function showResult(r) {
  document.getElementById('resultId').textContent = r.id;
  document.getElementById('resultName').textContent = r.name;

  // Meta chips
  const meta = [];
  if (r.type) meta.push(`<span class="meta-chip"><i class="bi bi-person"></i>${r.type}</span>`);
  if (r.username && r.username !== r.name) meta.push(`<span class="meta-chip"><i class="bi bi-at"></i>${r.username}</span>`);
  if (r.category) meta.push(`<span class="meta-chip"><i class="bi bi-tag"></i>${r.category}</span>`);
  if (r.likes) meta.push(`<span class="meta-chip"><i class="bi bi-hand-thumbs-up"></i>${fmtNum(r.likes)} lượt thích</span>`);
  document.getElementById('resultMeta').innerHTML = meta.join('');

  // Extra info
  let extra = '';
  if (r.source === 'url_extract') {
    extra = '<i class="bi bi-info-circle" style="color:#fbbf24"></i> ID được trích xuất từ URL. Nhập token để lấy thêm thông tin chi tiết (tên, loại trang...).';
  } else {
    extra = `<i class="bi bi-graph-up" style="color:#38bdf8"></i> Dùng ID này trong Facebook Ads Manager để nhắm mục tiêu, tạo Custom Audience, hoặc exclude trang/nhóm cụ thể.`;
  }
  document.getElementById('resultExtra').innerHTML = extra;

  document.getElementById('resultCard').style.display = 'block';
  document.getElementById('emptyCard').style.display = 'none';

  // Animate
  gsap.fromTo('#resultCard', {opacity:0, y:10}, {opacity:1, y:0, duration:.3, ease:'power2.out'});
}

function copyId() {
  if (!_lastResult) return;
  navigator.clipboard.writeText(_lastResult.id).then(() => toast('Đã copy ID: ' + _lastResult.id, 'success'));
}
function copyLink() {
  if (!_lastResult) return;
  navigator.clipboard.writeText(_lastResult.link).then(() => toast('Đã copy link!', 'success'));
}
function openProfile() {
  if (!_lastResult) return;
  window.open(_lastResult.link, '_blank');
}

// ── UI: Bulk ──
async function doBulkFind() {
  const lines = document.getElementById('bulkInput').value.split('\n').map(l => l.trim()).filter(Boolean);
  if (!lines.length) { toast('Vui lòng nhập danh sách link', 'error'); return; }
  if (lines.length > 50) { toast('Tối đa 50 link mỗi lần', 'error'); return; }

  const btn = document.getElementById('bulkBtn');
  btn.innerHTML = '<span class="spinner"></span> Đang tra cứu...';
  btn.disabled = true;

  const resultsDiv = document.getElementById('bulkResults');
  resultsDiv.innerHTML = '';

  let successCount = 0;
  const allResults = [];

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    const row = document.createElement('div');
    row.className = 'bulk-row';
    row.innerHTML = `<div class="bulk-input" title="${line}">${line}</div><span class="spinner"></span><span class="bulk-name" style="color:rgba(255,255,255,.3)">Đang tra...</span><span></span>`;
    resultsDiv.appendChild(row);

    try {
      const r = await lookupId(line);
      allResults.push({ input: line, ...r });
      successCount++;
      row.innerHTML = `
        <div class="bulk-input" title="${line}">${line}</div>
        <div class="bulk-id">${r.id}</div>
        <div class="bulk-name">${r.name}</div>
        <div style="display:flex;gap:4px">
          <button onclick="navigator.clipboard.writeText('${r.id}');toast('Đã copy!','success')"
            style="background:rgba(56,189,248,.12);border:1px solid rgba(56,189,248,.2);border-radius:5px;padding:3px 8px;color:#38bdf8;cursor:pointer;font-size:11px;font-family:Inter,sans-serif">
            <i class="bi bi-clipboard"></i>
          </button>
        </div>`;
      row.style.borderColor = 'rgba(34,197,94,.2)';
    } catch(e) {
      row.innerHTML = `<div class="bulk-input" title="${line}">${line}</div><div style="color:#f87171;font-size:12px">Lỗi</div><div style="font-size:11px;color:#f87171">${e.message}</div><span></span>`;
      row.style.borderColor = 'rgba(239,68,68,.2)';
    }

    // Small delay to avoid rate limit
    if (i < lines.length - 1) await new Promise(r => setTimeout(r, 300));
  }

  btn.innerHTML = '<i class="bi bi-search"></i> Tra Cứu Tất Cả';
  btn.disabled = false;
  toast(`Hoàn thành ${successCount}/${lines.length} tra cứu`, 'success');
}

function exportBulkCSV() {
  const rows = document.querySelectorAll('.bulk-row');
  if (!rows.length) { toast('Không có dữ liệu để xuất', 'error'); return; }
  const lines = ['Input,ID,Tên'];
  rows.forEach(r => {
    const cells = r.querySelectorAll('div');
    const input = cells[0]?.textContent?.trim() || '';
    const id = cells[1]?.textContent?.trim() || '';
    const name = cells[2]?.textContent?.trim() || '';
    lines.push(`"${input}","${id}","${name}"`);
  });
  downloadCSV(lines.join('\n'), `fbid_bulk_${Date.now()}.csv`);
}

// ── UI: History ──
function updateHistoryCount() {
  document.getElementById('historyCount').textContent = _history.length;
}

function renderHistory() {
  const el = document.getElementById('historyList');
  if (!_history.length) {
    el.innerHTML = '<div class="empty-state"><i class="bi bi-clock-history"></i>Chưa có lịch sử tra cứu</div>';
    return;
  }
  el.innerHTML = _history.map((h, i) => `
    <div class="history-item" onclick="reuseHistory(${i})">
      <div style="flex:1;min-width:0">
        <div style="font-size:12px;color:rgba(255,255,255,.5);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${h.input}</div>
        <div style="font-size:15px;font-weight:700;color:#38bdf8;font-family:monospace;margin:2px 0">${h.id}</div>
        <div style="font-size:11px;color:rgba(255,255,255,.35)">${h.name} · ${new Date(h.time).toLocaleString('vi-VN')}</div>
      </div>
      <div style="display:flex;gap:6px;flex-shrink:0;margin-left:10px">
        <button onclick="event.stopPropagation();navigator.clipboard.writeText('${h.id}');toast('Đã copy!','success')"
          style="background:rgba(56,189,248,.1);border:1px solid rgba(56,189,248,.2);border-radius:6px;padding:5px 10px;color:#38bdf8;cursor:pointer;font-size:11px;font-family:Inter,sans-serif">
          <i class="bi bi-clipboard"></i>
        </button>
        <button onclick="event.stopPropagation();deleteHistory(${i})"
          style="background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.15);border-radius:6px;padding:5px 10px;color:#f87171;cursor:pointer;font-size:11px;font-family:Inter,sans-serif">
          <i class="bi bi-trash"></i>
        </button>
      </div>
    </div>`).join('');
}

function reuseHistory(i) {
  document.getElementById('fbInput').value = _history[i].input;
  switchTab('single');
  doFind();
}

function deleteHistory(i) {
  _history.splice(i, 1);
  localStorage.setItem('genz_fbid_history', JSON.stringify(_history));
  updateHistoryCount();
  renderHistory();
}

function clearHistory() {
  if (!_history.length) { toast('Lịch sử đã trống', 'info'); return; }
  _history = [];
  localStorage.removeItem('genz_fbid_history');
  updateHistoryCount();
  renderHistory();
  toast('Đã xóa lịch sử', 'info');
}

function exportHistory() {
  if (!_history.length) { toast('Không có dữ liệu để xuất', 'error'); return; }
  const lines = ['Input,ID,Tên,Loại,Username,Thời gian'];
  _history.forEach(h => {
    lines.push(`"${h.input}","${h.id}","${h.name}","${h.type||''}","${h.username||''}","${new Date(h.time).toLocaleString('vi-VN')}"`);
  });
  downloadCSV(lines.join('\n'), `fbid_history_${Date.now()}.csv`);
}

// ── UI: Tabs ──
function switchTab(tab) {
  ['single','bulk','history'].forEach(t => {
    const cap = t.charAt(0).toUpperCase() + t.slice(1);
    document.getElementById('pane' + cap).classList.toggle('active', t === tab);
    document.getElementById('tab' + cap).classList.toggle('active', t === tab);
  });
  if (tab === 'history') renderHistory();
}

// ── Helpers ──
function toast(msg, type='info') {
  const el = document.createElement('div');
  el.className = `toast-item ${type}`;
  const icons = {success:'check-circle-fill', error:'x-circle-fill', info:'info-circle-fill'};
  el.innerHTML = `<i class="bi bi-${icons[type]||'info-circle-fill'}" style="color:${type==='success'?'#4ade80':type==='error'?'#f87171':'#38bdf8'}"></i> ${msg}`;
  document.getElementById('toast').appendChild(el);
  setTimeout(() => el.remove(), 3500);
}

function fmtNum(n) {
  if (!n) return '0';
  n = parseInt(n);
  if (n >= 1e9) return (n/1e9).toFixed(1) + 'B';
  if (n >= 1e6) return (n/1e6).toFixed(1) + 'M';
  if (n >= 1e3) return (n/1e3).toFixed(0) + 'K';
  return n.toLocaleString('vi-VN');
}

function downloadCSV(csv, filename) {
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  toast('Đã xuất CSV!', 'success');
}

function toggleSubNav(e, id) {
  e.preventDefault();
  const el = document.getElementById(id);
  const arrow = document.getElementById(id + 'Arrow');
  const isOpen = el.style.display !== 'none';
  el.style.display = isOpen ? 'none' : 'block';
  if (arrow) arrow.style.transform = isOpen ? '' : 'rotate(180deg)';
}

function openSettings() {}

// ── Init ──
document.addEventListener('DOMContentLoaded', () => {
  updateHistoryCount();

  // Load saved token
  const savedToken = localStorage.getItem('gz_fbid_token') || localStorage.getItem('gz_manual_fb_token');
  if (savedToken) {
    document.getElementById('fbTokenInput').value = savedToken;
    document.getElementById('tokenOkBanner').style.display = 'flex';
  } else {
    document.getElementById('tokenBanner').style.display = 'flex';
  }
});
</script>

<!-- Background animation -->
<script>
(function(){
  const c = document.getElementById('bgCanvas');
  if (!c) return;
  const ctx = c.getContext('2d');
  function resize() { c.width = window.innerWidth; c.height = window.innerHeight; }
  resize();
  window.addEventListener('resize', resize);
  const stars = Array.from({length:150}, () => ({
    x: Math.random() * c.width, y: Math.random() * c.height,
    r: Math.random() * 1.5 + 0.3, o: Math.random() * 0.5 + 0.1,
    vx: (Math.random() - 0.5) * 0.1, vy: (Math.random() - 0.5) * 0.1,
    p: Math.random() * Math.PI * 2
  }));
  function draw() {
    ctx.clearRect(0, 0, c.width, c.height);
    stars.forEach(s => {
      s.x += s.vx; s.y += s.vy; s.p += 0.015;
      if (s.x < 0) s.x = c.width; if (s.x > c.width) s.x = 0;
      if (s.y < 0) s.y = c.height; if (s.y > c.height) s.y = 0;
      const o = s.o * (0.7 + Math.sin(s.p) * 0.3);
      const g = ctx.createRadialGradient(s.x, s.y, 0, s.x, s.y, s.r * 2.5);
      g.addColorStop(0, `rgba(56,189,248,${o})`);
      g.addColorStop(1, 'rgba(56,189,248,0)');
      ctx.fillStyle = g;
      ctx.beginPath();
      ctx.arc(s.x, s.y, s.r * 2.5, 0, Math.PI * 2);
      ctx.fill();
    });
    requestAnimationFrame(draw);
  }
  draw();
})();

// Custom cursor
(function(){
  const cur = document.getElementById('custom-cursor');
  if (!cur || 'ontouchstart' in window) return;
  let shown = false;
  document.addEventListener('mousemove', e => {
    cur.style.left = e.clientX + 'px';
    cur.style.top = e.clientY + 'px';
    if (!shown) { cur.style.opacity = '1'; shown = true; }
  });
  document.addEventListener('mouseleave', () => { cur.style.opacity = '0'; shown = false; });
})();
</script>
</body>
</html>
