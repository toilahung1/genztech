<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ads Finder – GenzTech</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#0a0e27;color:#fff;display:flex;min-height:100vh;font-size:14px}
.sidebar{width:260px;flex-shrink:0;background:rgba(10,14,39,.95);backdrop-filter:blur(20px);border-right:1px solid rgba(255,255,255,.06);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:40}
.sidebar-logo{padding:20px 20px 16px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;gap:10px;text-decoration:none}
.sidebar-logo img{width:36px;height:36px;border-radius:50%}
.sidebar-logo span{font-size:15px;font-weight:700;letter-spacing:.5px;color:#fff}
.sidebar-logo span em{color:#00d4ff;font-style:normal}
.sidebar-nav{flex:1;padding:12px 0;overflow-y:auto}
.nav-group-label{font-size:10px;font-weight:700;color:rgba(255,255,255,.25);text-transform:uppercase;letter-spacing:1.2px;padding:12px 20px 4px}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 20px;font-size:13.5px;color:rgba(255,255,255,.6);text-decoration:none;transition:all .2s;border-left:2px solid transparent}
.nav-item:hover{color:#fff;background:rgba(255,255,255,.04)}
.nav-item.active{color:#00d4ff;background:rgba(0,212,255,.08);border-left-color:#00d4ff}
.nav-item i{width:18px;text-align:center;font-size:15px}
.nav-sub .nav-item{font-size:12.5px;padding:7px 20px 7px 36px}
.main-content{margin-left:260px;flex:1;display:flex;flex-direction:column;min-height:100vh}
.topbar{padding:14px 28px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;justify-content:space-between;background:rgba(10,14,39,.8);backdrop-filter:blur(10px);position:sticky;top:0;z-index:30}
.breadcrumb{display:flex;align-items:center;gap:8px;font-size:12.5px;color:rgba(255,255,255,.4)}
.btn-sm{padding:7px 14px;border-radius:8px;border:none;cursor:pointer;font-size:12.5px;font-weight:600;transition:all .2s;display:inline-flex;align-items:center;gap:6px;text-decoration:none}
.btn-primary{background:linear-gradient(135deg,#1877f2,#0a5dc2);color:#fff}
.btn-primary:hover{opacity:.9;transform:translateY(-1px)}
.btn-outline{background:transparent;color:rgba(255,255,255,.7);border:1px solid rgba(255,255,255,.15)}
.btn-outline:hover{border-color:#1877f2;color:#60a5fa}
.page-body{flex:1;display:flex;flex-direction:column}
.adlib-header{background:rgba(255,255,255,.03);border-bottom:1px solid rgba(255,255,255,.07);padding:14px 28px}
.adlib-topbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.adlib-logo{display:flex;align-items:center;gap:7px;font-size:14px;font-weight:700;color:#1877f2;margin-right:6px;white-space:nowrap}
.adlib-logo i{font-size:18px}
.adlib-search-wrap{flex:1;min-width:240px;position:relative}
.adlib-search-input{width:100%;background:rgba(255,255,255,.06);border:1.5px solid rgba(255,255,255,.12);border-radius:20px;padding:9px 16px 9px 40px;color:#fff;font-size:13.5px;transition:all .2s}
.adlib-search-input:focus{outline:none;border-color:#1877f2;background:rgba(24,119,242,.08)}
.adlib-search-input::placeholder{color:rgba(255,255,255,.3)}
.adlib-search-icon{position:absolute;left:13px;top:50%;transform:translateY(-50%);color:rgba(255,255,255,.4);font-size:15px;pointer-events:none}
.adlib-select{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:20px;padding:7px 28px 7px 14px;color:#fff;font-size:12.5px;cursor:pointer;transition:all .2s;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='white' opacity='0.4'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center;background-color:rgba(255,255,255,.06)}
.adlib-select:focus{outline:none;border-color:#1877f2}
.adlib-select option{background:#1a2035;color:#fff}
.adlib-filters{display:flex;align-items:center;gap:8px;flex-wrap:wrap;padding:10px 28px;background:rgba(255,255,255,.02);border-bottom:1px solid rgba(255,255,255,.06)}
.adlib-content{padding:20px 28px;flex:1}
.ads-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
@media(max-width:1400px){.ads-grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:960px){.ads-grid{grid-template-columns:1fr}}
.ad-card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;overflow:hidden;transition:all .2s;display:flex;flex-direction:column}
.ad-card:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.35);border-color:rgba(255,255,255,.15)}
.ad-card-header{padding:10px 14px;display:flex;align-items:flex-start;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,.05)}
.ad-status{display:flex;align-items:center;gap:5px;font-size:11.5px;font-weight:600}
.ad-status.active{color:#4ade80}
.ad-status.active::before{content:'';width:6px;height:6px;border-radius:50%;background:#4ade80;display:inline-block}
.ad-status.inactive{color:rgba(255,255,255,.4)}
.ad-status.inactive::before{content:'';width:6px;height:6px;border-radius:50%;background:rgba(255,255,255,.3);display:inline-block}
.ad-lib-id{font-size:10px;color:rgba(255,255,255,.3);margin-top:2px}
.ad-start-date{font-size:10px;color:rgba(255,255,255,.3);margin-top:1px}
.ad-platforms{display:flex;gap:4px;margin-top:4px}
.ad-platform-icon{font-size:12px;color:rgba(255,255,255,.4)}
.ad-platform-icon.facebook{color:#1877f2}
.ad-platform-icon.instagram{color:#e1306c}
.ad-platform-icon.whatsapp{color:#25d366}
.ad-platform-icon.messenger{color:#0084ff}
.ad-media{width:100%;height:175px;background:rgba(0,0,0,.3);position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;cursor:pointer}
.ad-media:hover .ad-media-overlay{opacity:1}
.ad-media-overlay{position:absolute;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s}
.ad-media-overlay i{font-size:32px;color:#fff}
.ad-media-placeholder{color:rgba(255,255,255,.12);font-size:32px;display:flex;flex-direction:column;align-items:center;gap:6px}
.ad-media-placeholder span{font-size:11px;color:rgba(255,255,255,.18)}
.ad-body{padding:12px 14px;flex:1}
.ad-page-row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.ad-page-avatar{width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,#1877f2,#0a5dc2);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff;flex-shrink:0}
.ad-page-info{flex:1;min-width:0}
.ad-page-name{font-size:13px;font-weight:700;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ad-page-name a{color:#fff;text-decoration:none}
.ad-page-name a:hover{color:#60a5fa}
.ad-page-type{font-size:11px;color:rgba(255,255,255,.4)}
.ad-text{font-size:12.5px;color:rgba(255,255,255,.65);line-height:1.55;margin-bottom:10px;display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;overflow:hidden}
.ad-link-preview{background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.07);border-radius:8px;padding:9px 11px;margin-bottom:10px}
.ad-link-domain{font-size:10px;color:rgba(255,255,255,.3);text-transform:uppercase;margin-bottom:2px}
.ad-link-title{font-size:12.5px;font-weight:600;color:rgba(255,255,255,.8);margin-bottom:2px}
.ad-link-desc{font-size:11px;color:rgba(255,255,255,.4)}
.ad-footer{display:flex;gap:5px;padding:9px 14px;border-top:1px solid rgba(255,255,255,.05)}
.ad-btn{flex:1;padding:6px;border-radius:7px;border:none;cursor:pointer;font-size:11.5px;font-weight:600;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:4px;text-decoration:none}
.ad-btn-detail{background:rgba(255,255,255,.07);color:rgba(255,255,255,.7)}
.ad-btn-detail:hover{background:rgba(255,255,255,.12);color:#fff}
.ad-btn-save{background:rgba(234,88,12,.1);color:#fb923c}
.ad-btn-save:hover{background:rgba(234,88,12,.2)}
.ad-btn-save.saved{background:rgba(34,197,94,.1);color:#4ade80}
.ad-btn-open{background:rgba(24,119,242,.1);color:#60a5fa}
.ad-btn-open:hover{background:rgba(24,119,242,.2)}
.tab-bar{display:flex;gap:4px;padding:4px;background:rgba(0,0,0,.25);border-radius:10px;margin-bottom:20px;width:fit-content}
.tab-btn{padding:7px 16px;border:none;border-radius:7px;background:transparent;color:rgba(255,255,255,.5);font-size:12.5px;font-weight:600;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:5px}
.tab-btn.active{background:rgba(24,119,242,.15);color:#60a5fa}
.tab-pane{display:none}
.tab-pane.active{display:block}
.saved-list{display:flex;flex-direction:column;gap:10px}
.saved-item{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);border-radius:10px;padding:12px 14px;display:flex;align-items:center;gap:12px}
.saved-item-info{flex:1;min-width:0}
.saved-item-page{font-size:13px;font-weight:700;color:#fff}
.saved-item-text{font-size:12px;color:rgba(255,255,255,.5);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px}
.saved-item-actions{display:flex;gap:6px}
.spinner-wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;gap:14px;color:rgba(255,255,255,.4)}
.spinner{width:36px;height:36px;border:3px solid rgba(255,255,255,.1);border-top-color:#1877f2;border-radius:50%;animation:spin .7s linear infinite}
.spinner-sm{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.2);border-top-color:#1877f2;border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.empty-state{text-align:center;padding:60px 20px;color:rgba(255,255,255,.3)}
.empty-state i{font-size:48px;margin-bottom:14px;display:block;color:rgba(255,255,255,.15)}
.empty-state h3{font-size:15px;font-weight:600;margin-bottom:6px;color:rgba(255,255,255,.5)}
.empty-state p{font-size:12.5px;line-height:1.6}
.hidden{display:none!important}
.toast-container{position:fixed;bottom:24px;right:24px;z-index:999;display:flex;flex-direction:column;gap:8px}
.toast{background:#1e293b;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:12px 16px;font-size:13px;display:flex;align-items:center;gap:10px;min-width:260px;animation:slideIn .3s ease;box-shadow:0 8px 24px rgba(0,0,0,.4)}
.toast.success{border-left:3px solid #22c55e}.toast.error{border-left:3px solid #ef4444}.toast.info{border-left:3px solid #60a5fa}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:100;display:flex;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px)}
.modal-overlay.hidden{display:none}
.modal{background:#0f1630;border:1px solid rgba(255,255,255,.1);border-radius:16px;max-width:680px;width:100%;max-height:90vh;overflow-y:auto}
.modal-header{padding:18px 22px;border-bottom:1px solid rgba(255,255,255,.07);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:#0f1630;z-index:1}
.modal-title{font-size:15px;font-weight:700}
.modal-close{background:none;border:none;color:rgba(255,255,255,.5);font-size:20px;cursor:pointer;padding:4px;border-radius:6px}
.modal-close:hover{color:#fff;background:rgba(255,255,255,.08)}
.modal-body{padding:22px}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.detail-chip{background:rgba(255,255,255,.05);border-radius:8px;padding:10px 14px}
.detail-chip .label{font-size:10.5px;color:rgba(255,255,255,.35);margin-bottom:3px;text-transform:uppercase;letter-spacing:.5px}
.detail-chip .value{font-size:13px;font-weight:600;color:#fff}
.detail-label{font-size:11px;font-weight:700;color:rgba(255,255,255,.35);text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px;margin-top:16px}
.detail-value{font-size:13.5px;color:rgba(255,255,255,.8);line-height:1.6;background:rgba(255,255,255,.04);border-radius:8px;padding:12px;margin-bottom:8px}
</style>
</head>
<body>
<aside class="sidebar">
  <a href="index.html" class="sidebar-logo"><img src="images/logo.png" alt="Logo"><span>GENZ<em>TECH</em></span></a>
  <nav class="sidebar-nav">
    <div class="nav-group-label">Tổng quan</div>
    <a href="index.html" class="nav-item"><i class="bi bi-grid-1x2"></i> Dashboard</a>
    <div class="nav-group-label">Công cụ</div>
    <a href="auto-post.html" class="nav-item"><i class="bi bi-send-fill"></i> Tự Động Đăng Bài</a>
    <a href="ads-assistant.html" class="nav-item"><i class="bi bi-robot"></i> Trợ Lý Quảng Cáo</a>
    <div class="nav-sub">
      <a href="tool-ad-account.html" class="nav-item"><i class="bi bi-shield-check"></i> Kiểm Tra TKQC</a>
      <a href="tool-fb-id.html" class="nav-item"><i class="bi bi-person-badge"></i> Tìm Facebook ID</a>
      <a href="tool-budget.html" class="nav-item"><i class="bi bi-graph-up-arrow"></i> Phân Tích Ngân Sách</a>
      <a href="tool-translate.html" class="nav-item"><i class="bi bi-translate"></i> Dịch Thuật</a>
      <a href="tool-ads-finder.html" class="nav-item active"><i class="bi bi-binoculars"></i> Ads Finder</a>
      <a href="tool-policy.html" class="nav-item"><i class="bi bi-journal-text"></i> Chính Sách FB</a>
      <a href="tool-cookie.html" class="nav-item"><i class="bi bi-cookie"></i> Quản Lý Cookie</a>
    </div>
    <div class="nav-group-label">Hệ thống</div>
    <a href="#" class="nav-item"><i class="bi bi-gear"></i> Cài Đặt</a>
  </nav>
</aside>

<div class="main-content">
  <header class="topbar">
    <div class="breadcrumb">
      <i class="bi bi-house"></i><i class="bi bi-chevron-right" style="font-size:10px"></i>
      <span style="color:rgba(255,255,255,.4)">Công cụ</span>
      <i class="bi bi-chevron-right" style="font-size:10px"></i><span>Ads Finder</span>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn-sm btn-outline" onclick="switchTab('saved')"><i class="bi bi-bookmark-fill"></i> Đã lưu (<span id="savedCount">0</span>)</button>
      <a href="https://www.facebook.com/ads/library" target="_blank" class="btn-sm btn-primary"><i class="bi bi-box-arrow-up-right"></i> Mở Ad Library</a>
    </div>
  </header>

  <main class="page-body">
    <div class="adlib-header">
      <div class="adlib-topbar">
        <div class="adlib-logo"><i class="bi bi-meta"></i> Ad Library</div>
        <div class="adlib-search-wrap">
          <i class="bi bi-search adlib-search-icon"></i>
          <input type="text" class="adlib-search-input" id="searchInput" placeholder="Tìm kiếm theo từ khóa hoặc tên trang..." onkeydown="if(event.key==='Enter')doSearch()">
        </div>
        <select class="adlib-select" id="countrySelect">
          <option value="VN">Vietnam</option>
          <option value="ALL">All countries</option>
          <option value="US">United States</option>
          <option value="TH">Thailand</option>
          <option value="SG">Singapore</option>
          <option value="MY">Malaysia</option>
          <option value="ID">Indonesia</option>
          <option value="PH">Philippines</option>
          <option value="GB">United Kingdom</option>
          <option value="AU">Australia</option>
        </select>
        <select class="adlib-select" id="adTypeSelect">
          <option value="all">All ads</option>
          <option value="political_and_issue_ads">Political &amp; Issue ads</option>
          <option value="housing_ads">Housing ads</option>
          <option value="employment_ads">Employment ads</option>
          <option value="credit_ads">Credit ads</option>
        </select>
        <button class="btn-sm btn-primary" onclick="doSearch()"><i class="bi bi-search"></i> Search</button>
      </div>
    </div>

    <div class="adlib-filters">
      <select class="adlib-select" id="statusSelect">
        <option value="active">Active ads</option>
        <option value="inactive">Inactive ads</option>
        <option value="all">All status</option>
      </select>
      <select class="adlib-select" id="mediaTypeSelect">
        <option value="all">All formats</option>
        <option value="image">Image</option>
        <option value="video">Video</option>
        <option value="meme">Text only</option>
      </select>
      <select class="adlib-select" id="sortSelect">
        <option value="total_impressions">Sort by: Impressions</option>
        <option value="relevance_score">Sort by: Relevance</option>
        <option value="start_date">Sort by: Start date</option>
      </select>
    </div>

    <div class="adlib-content">
      <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('results')" id="tab-results"><i class="bi bi-grid-3x3-gap"></i> Kết quả</button>
        <button class="tab-btn" onclick="switchTab('saved')" id="tab-saved"><i class="bi bi-bookmark-fill"></i> Đã lưu (<span id="savedCountTab">0</span>)</button>
      </div>

      <div class="tab-pane active" id="pane-results">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;padding-bottom:10px;border-bottom:1px solid rgba(255,255,255,.06)">
          <span id="resultsCount" style="color:rgba(255,255,255,.5);font-size:12.5px"></span>
          <a id="openLibraryLink" href="https://www.facebook.com/ads/library" target="_blank" style="font-size:12px;color:#60a5fa;text-decoration:none;display:flex;align-items:center;gap:4px"><i class="bi bi-box-arrow-up-right"></i> Xem trên Facebook Ads Library</a>
        </div>

        <div class="empty-state" id="emptyState">
          <i class="bi bi-binoculars"></i>
          <h3>Tìm kiếm quảng cáo</h3>
          <p>Nhập từ khóa hoặc tên trang để tìm quảng cáo đang chạy.<br>Dữ liệu từ <strong style="color:#60a5fa">Facebook Ads Library</strong> — công khai, không cần đăng nhập.</p>
          <div style="margin-top:20px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
            <button class="btn-sm btn-outline" onclick="quickSearch('Shopee')"><i class="bi bi-lightning-fill"></i> Shopee</button>
            <button class="btn-sm btn-outline" onclick="quickSearch('thoi trang')"><i class="bi bi-lightning-fill"></i> Thời trang</button>
            <button class="btn-sm btn-outline" onclick="quickSearch('my pham')"><i class="bi bi-lightning-fill"></i> Mỹ phẩm</button>
            <button class="btn-sm btn-outline" onclick="quickSearch('bat dong san')"><i class="bi bi-lightning-fill"></i> Bất động sản</button>
            <button class="btn-sm btn-outline" onclick="quickSearch('khoa hoc online')"><i class="bi bi-lightning-fill"></i> Khóa học</button>
          </div>
        </div>

        <div class="spinner-wrap hidden" id="loadingState">
          <div class="spinner"></div>
          <span>Đang tải dữ liệu từ Facebook Ads Library...</span>
        </div>

        <div class="ads-grid" id="adsGrid"></div>

        <div id="loadMoreWrap" style="text-align:center;margin-top:24px;display:none">
          <button class="btn-sm btn-outline" onclick="loadMore()" id="loadMoreBtn" style="padding:10px 28px"><i class="bi bi-arrow-down-circle"></i> Tải thêm quảng cáo</button>
        </div>
      </div>

      <div class="tab-pane" id="pane-saved">
        <div id="savedEmpty" class="empty-state">
          <i class="bi bi-bookmark"></i>
          <h3>Chưa có quảng cáo nào được lưu</h3>
          <p>Nhấn nút <strong>Lưu</strong> trên mỗi quảng cáo để lưu vào đây.</p>
        </div>
        <div class="saved-list" id="savedList"></div>
        <div id="savedActions" style="margin-top:16px;gap:8px;display:none">
          <button class="btn-sm btn-outline" onclick="exportSaved()"><i class="bi bi-download"></i> Xuất CSV</button>
          <button class="btn-sm btn-outline" style="color:#ef4444;border-color:rgba(239,68,68,.3)" onclick="clearSaved()"><i class="bi bi-trash"></i> Xóa tất cả</button>
        </div>
      </div>
    </div>
  </main>
</div>

<div class="modal-overlay hidden" id="modalOverlay" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title" id="modalTitle">Chi tiết quảng cáo</span>
      <button class="modal-close" onclick="closeModal()"><i class="bi bi-x-lg"></i></button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
const BACKEND = 'https://genztech-production.up.railway.app';
let currentAds = [], savedAds = JSON.parse(localStorage.getItem('gz_saved_ads')||'[]');
let currentCursor = null, currentQuery = '', isLoading = false;

function toast(msg,type='info'){
  const c=document.getElementById('toastContainer'),t=document.createElement('div');
  t.className='toast '+type;
  const ic={success:'check-circle-fill',error:'x-circle-fill',info:'info-circle-fill'};
  t.innerHTML='<i class="bi bi-'+(ic[type]||'info-circle-fill')+'"></i><span>'+msg+'</span>';
  c.appendChild(t);setTimeout(()=>{t.style.opacity='0';setTimeout(()=>t.remove(),300);},3000);
}
function getInitials(n){if(!n)return'?';return n.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);}
function isSaved(id){return savedAds.some(a=>a.id===id);}
function updateSavedCount(){const n=savedAds.length;document.getElementById('savedCount').textContent=n;document.getElementById('savedCountTab').textContent=n;}
function buildLibraryURL(q){
  const c=document.getElementById('countrySelect').value,at=document.getElementById('adTypeSelect').value,
    st=document.getElementById('statusSelect').value,mt=document.getElementById('mediaTypeSelect').value,
    so=document.getElementById('sortSelect').value;
  const p=new URLSearchParams({active_status:st==='all'?'all':st,ad_type:at||'all',country:c||'VN',q:q||'',search_type:'keyword_unordered',media_type:mt||'all'});
  if(so){p.set('sort_data[mode]',so);p.set('sort_data[direction]','desc');}
  return 'https://www.facebook.com/ads/library/?'+p.toString();
}
function quickSearch(kw){document.getElementById('searchInput').value=kw;doSearch();}
function doSearch(){
  const q=document.getElementById('searchInput').value.trim();
  if(!q){toast('Vui lòng nhập từ khóa','error');return;}
  currentQuery=q;currentCursor=null;currentAds=[];
  document.getElementById('adsGrid').innerHTML='';fetchAds(q,true);
}
function loadMore(){if(!currentQuery||isLoading)return;fetchAds(currentQuery,false);}

async function fetchAds(q,isNew){
  if(isLoading)return;isLoading=true;
  const libURL=buildLibraryURL(q);
  document.getElementById('openLibraryLink').href=libURL;
  if(isNew){
    document.getElementById('emptyState').classList.add('hidden');
    document.getElementById('loadingState').classList.remove('hidden');
    document.getElementById('loadMoreWrap').style.display='none';
    document.getElementById('resultsCount').textContent='';
  } else {
    document.getElementById('loadMoreBtn').innerHTML='<span class="spinner-sm"></span> Đang tải...';
  }
  try{
    const resp=await fetch(BACKEND+'/api/facebook/scrape-ads-library',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({q,country:document.getElementById('countrySelect').value,adType:document.getElementById('adTypeSelect').value,status:document.getElementById('statusSelect').value,mediaType:document.getElementById('mediaTypeSelect').value,sort:document.getElementById('sortSelect').value,cursor:currentCursor}),
      signal:AbortSignal.timeout(25000)
    });
    if(!resp.ok)throw new Error('HTTP '+resp.status);
    const data=await resp.json();
    if(data.error)throw new Error(data.error);
    const ads=data.ads||[];
    currentCursor=data.next_cursor||null;
    if(isNew)currentAds=ads;else currentAds=[...currentAds,...ads];
    renderAds(ads,isNew);
    const total=data.total_count?'>'+Number(data.total_count).toLocaleString('vi')+' ket qua':currentAds.length+' quang cao';
    document.getElementById('resultsCount').textContent=total;
    document.getElementById('loadMoreWrap').style.display=(currentCursor&&ads.length>0)?'block':'none';
    if(isNew&&ads.length===0)showNoResult(q,libURL);
  }catch(err){
    console.error(err);showFallback(q,libURL);
    toast('Khong the tai du lieu. Da chuyen sang link truc tiep.','info');
  }finally{
    isLoading=false;
    document.getElementById('loadingState').classList.add('hidden');
    document.getElementById('loadMoreBtn').innerHTML='<i class="bi bi-arrow-down-circle"></i> Tai them quang cao';
  }
}

function showNoResult(q,libURL){
  const el=document.getElementById('emptyState');el.classList.remove('hidden');
  el.innerHTML='<i class="bi bi-search"></i><h3>Khong tim thay ket qua</h3><p>Khong co quang cao nao khop voi "<strong>'+q+'</strong>".</p><div style="margin-top:16px"><a href="'+libURL+'" target="_blank" class="btn-sm btn-primary"><i class="bi bi-box-arrow-up-right"></i> Tim tren Facebook Ads Library</a></div>';
}
function showFallback(q,libURL){
  const el=document.getElementById('emptyState');el.classList.remove('hidden');
  const country=document.getElementById('countrySelect').value;
  const brands=['Shopee','Lazada','Tiki','Grab','VinFast','Vinamilk'];
  el.innerHTML='<i class="bi bi-box-arrow-up-right" style="color:#1877f2"></i><h3 style="color:rgba(255,255,255,.7)">Mo truc tiep tren Facebook Ads Library</h3><p>Nhan nut ben duoi de xem ket qua tim kiem "<strong>'+q+'</strong>" truc tiep tren Facebook.</p><div style="margin-top:20px"><a href="'+libURL+'" target="_blank" class="btn-sm btn-primary" style="padding:10px 24px;margin:0 auto"><i class="bi bi-facebook"></i> Xem "'+q+'" tren Ads Library</a></div><div style="margin-top:20px;font-size:12px;color:rgba(255,255,255,.25)">Tim kiem nhanh:</div><div style="margin-top:10px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap">'+brands.map(p=>'<a href="https://www.facebook.com/ads/library/?active_status=active&ad_type=all&country='+country+'&q='+encodeURIComponent(p)+'&search_type=keyword_unordered" target="_blank" class="btn-sm btn-outline">'+p+'</a>').join('')+'</div>';
}

function renderAds(ads,isNew){
  const grid=document.getElementById('adsGrid');
  if(isNew)grid.innerHTML='';
  if(!ads.length)return;
  ads.forEach(ad=>{
    const saved=isSaved(ad.id);
    const platforms=(ad.publisher_platforms||['facebook']).map(p=>{
      const map={facebook:'bi-facebook facebook',instagram:'bi-instagram instagram',whatsapp:'bi-whatsapp whatsapp',messenger:'bi-messenger messenger'};
      return '<i class="bi '+(map[p]||'bi-globe')+' ad-platform-icon '+p+'"></i>';
    }).join('');
    const bodyText=(ad.ad_creative_bodies||[ad.body||'']).filter(Boolean)[0]||'';
    const linkTitle=(ad.ad_creative_link_titles||[])[0]||'';
    const linkDesc=(ad.ad_creative_link_descriptions||[])[0]||'';
    const linkCaption=(ad.ad_creative_link_captions||[])[0]||'';
    const startDate=ad.ad_delivery_start_time?new Date(ad.ad_delivery_start_time).toLocaleDateString('vi-VN'):'N/A';
    const isActive=ad.is_active!==false;
    const card=document.createElement('div');
    card.className='ad-card';card.dataset.id=ad.id;
    card.innerHTML=
      '<div class="ad-card-header"><div>'+
        '<div class="ad-status '+(isActive?'active':'inactive')+'">'+(isActive?'Active':'Inactive')+'</div>'+
        '<div class="ad-lib-id">Library ID: '+(ad.id||'N/A')+'</div>'+
        '<div class="ad-start-date">Bat dau: '+startDate+'</div>'+
        '<div class="ad-platforms">'+platforms+'</div>'+
      '</div>'+
      '<button class="btn-sm btn-outline" style="padding:5px 10px;font-size:11px" onclick="openDetail(\''+ad.id+'\')"><i class="bi bi-info-circle"></i> Chi tiet</button>'+
      '</div>'+
      (ad.snapshot_url
        ?'<a href="'+ad.snapshot_url+'" target="_blank"><div class="ad-media"><div class="ad-media-placeholder"><i class="bi bi-play-circle"></i><span>Xem quang cao</span></div><div class="ad-media-overlay"><i class="bi bi-play-circle-fill"></i></div></div></a>'
        :'<div class="ad-media"><div class="ad-media-placeholder"><i class="bi bi-image"></i><span>Khong co anh</span></div></div>')+
      '<div class="ad-body">'+
        '<div class="ad-page-row">'+
          '<div class="ad-page-avatar">'+getInitials(ad.page_name)+'</div>'+
          '<div class="ad-page-info">'+
            '<div class="ad-page-name"><a href="https://www.facebook.com/'+(ad.page_id||'')+'" target="_blank">'+(ad.page_name||'Trang an danh')+'</a></div>'+
            '<div class="ad-page-type">Sponsored</div>'+
          '</div>'+
        '</div>'+
        (bodyText?'<div class="ad-text">'+bodyText.replace(/</g,'&lt;').replace(/>/g,'&gt;')+'</div>':'')+
        (linkTitle?'<div class="ad-link-preview">'+(linkCaption?'<div class="ad-link-domain">'+linkCaption+'</div>':'')+'<div class="ad-link-title">'+linkTitle+'</div>'+(linkDesc?'<div class="ad-link-desc">'+linkDesc+'</div>':'')+'</div>':'')+
      '</div>'+
      '<div class="ad-footer">'+
        '<button class="ad-btn ad-btn-save '+(saved?'saved':'')+'" onclick="toggleSave(\''+ad.id+'\')"><i class="bi bi-bookmark'+(saved?'-fill':'')+'"></i> '+(saved?'Da luu':'Luu')+'</button>'+
        (ad.snapshot_url?'<a href="'+ad.snapshot_url+'" target="_blank" class="ad-btn ad-btn-open"><i class="bi bi-eye"></i> Xem QC</a>':'')+
        '<a href="https://www.facebook.com/ads/library/?id='+ad.id+'" target="_blank" class="ad-btn ad-btn-detail"><i class="bi bi-box-arrow-up-right"></i> Ads Lib</a>'+
      '</div>';
    grid.appendChild(card);
  });
}

function toggleSave(id){
  const ad=currentAds.find(a=>a.id===id)||savedAds.find(a=>a.id===id);if(!ad)return;
  const idx=savedAds.findIndex(a=>a.id===id);
  if(idx>=0){savedAds.splice(idx,1);toast('Da bo luu','info');}
  else{savedAds.push({...ad,savedAt:new Date().toISOString()});toast('Da luu quang cao','success');}
  localStorage.setItem('gz_saved_ads',JSON.stringify(savedAds));updateSavedCount();
  const btn=document.querySelector('.ad-card[data-id="'+id+'"] .ad-btn-save');
  if(btn){const s=isSaved(id);btn.className='ad-btn ad-btn-save '+(s?'saved':'');btn.innerHTML='<i class="bi bi-bookmark'+(s?'-fill':'')+'"></i> '+(s?'Da luu':'Luu');}
  renderSavedList();
}

function renderSavedList(){
  const list=document.getElementById('savedList'),empty=document.getElementById('savedEmpty'),actions=document.getElementById('savedActions');
  if(!savedAds.length){empty.style.display='block';list.innerHTML='';actions.style.display='none';return;}
  empty.style.display='none';actions.style.display='flex';
  list.innerHTML=savedAds.map(ad=>
    '<div class="saved-item">'+
      '<div class="ad-page-avatar" style="width:36px;height:36px;font-size:13px">'+getInitials(ad.page_name)+'</div>'+
      '<div class="saved-item-info">'+
        '<div class="saved-item-page">'+(ad.page_name||'Trang an danh')+'</div>'+
        '<div class="saved-item-text">'+((ad.ad_creative_bodies||[''])[0]||'Khong co noi dung')+'</div>'+
      '</div>'+
      '<div class="saved-item-actions">'+
        (ad.snapshot_url?'<a href="'+ad.snapshot_url+'" target="_blank" class="btn-sm btn-outline" style="padding:5px 10px"><i class="bi bi-eye"></i></a>':'')+
        '<a href="https://www.facebook.com/ads/library/?id='+ad.id+'" target="_blank" class="btn-sm btn-outline" style="padding:5px 10px"><i class="bi bi-box-arrow-up-right"></i></a>'+
        '<button class="btn-sm btn-outline" style="padding:5px 10px;color:#ef4444;border-color:rgba(239,68,68,.3)" onclick="toggleSave(\''+ad.id+'\')"><i class="bi bi-trash"></i></button>'+
      '</div>'+
    '</div>'
  ).join('');
}

function clearSaved(){if(!confirm('Xoa tat ca quang cao da luu?'))return;savedAds=[];localStorage.removeItem('gz_saved_ads');updateSavedCount();renderSavedList();toast('Da xoa tat ca','info');}
function exportSaved(){
  if(!savedAds.length)return;
  const rows=[['ID','Trang','Noi dung','Ngay bat dau','Link Ads Library','Ngay luu']];
  savedAds.forEach(ad=>rows.push([ad.id,ad.page_name||'',((ad.ad_creative_bodies||[''])[0]||'').replace(/"/g,'""'),ad.ad_delivery_start_time||'','https://www.facebook.com/ads/library/?id='+ad.id,ad.savedAt||'']));
  const csv=rows.map(r=>r.map(c=>'"'+c+'"').join(',')).join('\n');
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8'}));
  a.download='saved_ads_'+new Date().toISOString().slice(0,10)+'.csv';a.click();toast('Da xuat CSV','success');
}

function openDetail(id){
  const ad=currentAds.find(a=>a.id===id)||savedAds.find(a=>a.id===id);if(!ad)return;
  document.getElementById('modalTitle').textContent=ad.page_name||'Quang cao';
  const bodies=ad.ad_creative_bodies||[],titles=ad.ad_creative_link_titles||[],descs=ad.ad_creative_link_descriptions||[];
  document.getElementById('modalBody').innerHTML=
    '<div class="detail-grid">'+
      '<div class="detail-chip"><div class="label">Library ID</div><div class="value">'+ad.id+'</div></div>'+
      '<div class="detail-chip"><div class="label">Trang</div><div class="value">'+(ad.page_name||'N/A')+'</div></div>'+
      '<div class="detail-chip"><div class="label">Trang thai</div><div class="value" style="color:'+(ad.is_active!==false?'#4ade80':'rgba(255,255,255,.5)')+'">'+(ad.is_active!==false?'Dang chay':'Da dung')+'</div></div>'+
      '<div class="detail-chip"><div class="label">Bat dau</div><div class="value">'+(ad.ad_delivery_start_time?new Date(ad.ad_delivery_start_time).toLocaleDateString('vi-VN'):'N/A')+'</div></div>'+
      (ad.impressions&&ad.impressions.lower_bound?'<div class="detail-chip"><div class="label">Luot hien thi</div><div class="value">'+Number(ad.impressions.lower_bound).toLocaleString('vi')+'+ </div></div>':'')+
      (ad.spend&&ad.spend.lower_bound?'<div class="detail-chip"><div class="label">Chi phi</div><div class="value">'+Number(ad.spend.lower_bound).toLocaleString('vi')+' '+(ad.currency||'USD')+'+ </div></div>':'')+
    '</div>'+
    (bodies.length?'<div class="detail-label">Noi dung quang cao</div>'+bodies.map(b=>'<div class="detail-value">'+b.replace(/</g,'&lt;').replace(/\n/g,'<br>')+'</div>').join(''):'')+
    (titles.length?'<div class="detail-label">Tieu de link</div><div class="detail-value">'+titles.join('<br>')+'</div>':'')+
    (descs.length?'<div class="detail-label">Mo ta</div><div class="detail-value" style="color:rgba(255,255,255,.6)">'+descs.join('<br>')+'</div>':'')+
    '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:16px">'+
      (ad.snapshot_url?'<a href="'+ad.snapshot_url+'" target="_blank" class="btn-sm btn-primary"><i class="bi bi-eye"></i> Xem quang cao goc</a>':'')+
      '<a href="https://www.facebook.com/ads/library/?id='+ad.id+'" target="_blank" class="btn-sm btn-outline"><i class="bi bi-box-arrow-up-right"></i> Mo trong Ads Library</a>'+
      '<button class="btn-sm btn-outline" onclick="toggleSave(\''+ad.id+'\');closeModal()"><i class="bi bi-bookmark'+(isSaved(ad.id)?'-fill':'')+'"></i> '+(isSaved(ad.id)?'Bo luu':'Luu')+'</button>'+
    '</div>';
  document.getElementById('modalOverlay').classList.remove('hidden');
}
function closeModal(){document.getElementById('modalOverlay').classList.add('hidden');}
function switchTab(tab){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
  const tb=document.getElementById('tab-'+tab),pb=document.getElementById('pane-'+tab);
  if(tb)tb.classList.add('active');if(pb)pb.classList.add('active');
  if(tab==='saved')renderSavedList();
}
updateSavedCount();
</script>
</body>
</html>
