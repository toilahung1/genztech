<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Phân Tích Ngân Sách & Đối Thủ – GenzTech</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#070b1e;color:#fff;display:flex;min-height:100vh}
.sidebar{width:240px;flex-shrink:0;background:rgba(10,14,39,.92);backdrop-filter:blur(20px);border-right:1px solid rgba(255,255,255,.06);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:40}
.sidebar-logo{padding:18px 18px 14px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;gap:10px;text-decoration:none}
.sidebar-logo img{width:34px;height:34px;border-radius:50%}
.sidebar-logo span{font-size:14px;font-weight:700;letter-spacing:.5px;color:#fff}
.sidebar-logo span em{color:#00d4ff;font-style:normal}
.sidebar-nav{flex:1;padding:10px 0;overflow-y:auto}
.nav-group-label{padding:8px 18px 4px;font-size:10px;font-weight:700;color:rgba(255,255,255,.25);text-transform:uppercase;letter-spacing:1px}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 18px;font-size:13px;color:rgba(255,255,255,.6);text-decoration:none;transition:all .2s;border-left:2px solid transparent;cursor:pointer}
.nav-item:hover{color:#fff;background:rgba(255,255,255,.04)}
.nav-item.active{color:#00d4ff;background:rgba(0,212,255,.08);border-left-color:#00d4ff}
.nav-item i{width:17px;text-align:center;font-size:14px}
.nav-sub-item{display:flex;align-items:center;gap:10px;padding:7px 18px 7px 40px;font-size:12.5px;color:rgba(255,255,255,.5);text-decoration:none;transition:all .2s;border-left:2px solid transparent}
.nav-sub-item:hover{color:#fff;background:rgba(255,255,255,.04)}
.nav-sub-item.active{color:#00d4ff;background:rgba(0,212,255,.06);border-left-color:#00d4ff}
.sidebar-footer{padding:14px 18px;border-top:1px solid rgba(255,255,255,.06)}
.conn-status{display:flex;align-items:center;gap:8px;font-size:12px;color:rgba(255,255,255,.4)}
.conn-dot{width:7px;height:7px;border-radius:50%;background:#6b7280}
.conn-dot.online{background:#22c55e;box-shadow:0 0 6px #22c55e}
.main-content{margin-left:240px;flex:1;display:flex;flex-direction:column;min-height:100vh}
.topbar{height:52px;background:rgba(10,14,39,.85);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;justify-content:space-between;padding:0 20px;position:sticky;top:0;z-index:30}
.topbar-left{display:flex;align-items:center;gap:12px}
.breadcrumb{display:flex;align-items:center;gap:6px;font-size:12.5px;color:rgba(255,255,255,.4)}
.topbar-right{display:flex;align-items:center;gap:8px}
.btn-icon{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:6px 10px;color:rgba(255,255,255,.7);cursor:pointer;font-size:13px;transition:all .2s}
.btn-icon:hover{background:rgba(255,255,255,.1);color:#fff}
.page-body{padding:20px;flex:1}
.page-tabs{display:flex;gap:4px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:4px;margin-bottom:20px;width:fit-content}
.page-tab{padding:8px 18px;border-radius:9px;font-size:13px;font-weight:600;color:rgba(255,255,255,.5);cursor:pointer;transition:all .2s;border:none;background:none;display:flex;align-items:center;gap:7px}
.page-tab.active{background:linear-gradient(135deg,#1877f2,#00d4ff);color:#fff;box-shadow:0 2px 12px rgba(24,119,242,.4)}
.card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:20px;margin-bottom:16px}
.card-title{font-size:13px;font-weight:700;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:.7px;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.card-title i{color:#00d4ff}
.form-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.form-grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.form-group{display:flex;flex-direction:column;gap:5px}
.form-label{font-size:11.5px;font-weight:600;color:rgba(255,255,255,.45);text-transform:uppercase;letter-spacing:.5px}
.form-control{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:9px 12px;color:#fff;font-size:13px;outline:none;transition:border-color .2s;width:100%}
.form-control:focus{border-color:#00d4ff}
select.form-control option{background:#0f1535;color:#fff}
textarea.form-control{resize:vertical;min-height:70px}
.btn{display:inline-flex;align-items:center;gap:7px;padding:9px 18px;border-radius:9px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;border:none}
.btn-primary{background:linear-gradient(135deg,#1877f2,#00d4ff);color:#fff;box-shadow:0 2px 12px rgba(24,119,242,.3)}
.btn-primary:hover{opacity:.9;transform:translateY(-1px)}
.btn-primary:disabled{opacity:.5;cursor:not-allowed;transform:none}
.btn-outline{background:transparent;border:1px solid rgba(255,255,255,.15);color:rgba(255,255,255,.7)}
.btn-outline:hover{background:rgba(255,255,255,.06);color:#fff}
.stats-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:16px}
.stat-card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);border-radius:12px;padding:14px 16px}
.stat-label{font-size:10.5px;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.6px;margin-bottom:6px}
.stat-value{font-size:20px;font-weight:800}
.stat-sub{font-size:11px;color:rgba(255,255,255,.3);margin-top:3px}
.tab-bar{display:flex;gap:4px;border-bottom:1px solid rgba(255,255,255,.07);margin-bottom:16px}
.tab-btn{padding:8px 16px;font-size:12.5px;font-weight:600;color:rgba(255,255,255,.45);cursor:pointer;border:none;background:none;border-bottom:2px solid transparent;transition:all .2s}
.tab-btn.active{color:#00d4ff;border-bottom-color:#00d4ff}
.tab-pane{display:none}
.tab-pane.active{display:block}
.charts-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
.chart-box{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:12px;padding:16px}
.chart-title{font-size:12px;font-weight:700;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:.6px;margin-bottom:12px}
.chart-wrap{position:relative;height:200px}
.ai-loading{text-align:center;padding:50px 20px;color:rgba(255,255,255,.4)}
.ai-loading .spin{width:40px;height:40px;border:3px solid rgba(0,212,255,.2);border-top-color:#00d4ff;border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 16px}
@keyframes spin{to{transform:rotate(360deg)}}
.score-circle{width:100px;height:100px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;margin:0 auto 12px;font-weight:800;font-size:28px;border:4px solid}
.score-good{border-color:#22c55e;color:#22c55e;background:rgba(34,197,94,.08)}
.score-avg{border-color:#f59e0b;color:#f59e0b;background:rgba(245,158,11,.08)}
.score-bad{border-color:#ef4444;color:#ef4444;background:rgba(239,68,68,.08)}
.kpi-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin:16px 0}
.kpi-item{background:rgba(255,255,255,.04);border-radius:10px;padding:12px 14px;border-left:3px solid}
.kpi-good{border-color:#22c55e}
.kpi-avg{border-color:#f59e0b}
.kpi-bad{border-color:#ef4444}
.kpi-name{font-size:11px;font-weight:700;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.kpi-val{font-size:16px;font-weight:800;margin-bottom:2px}
.kpi-bench{font-size:11px;color:rgba(255,255,255,.35)}
.kpi-comment{font-size:12px;color:rgba(255,255,255,.6);margin-top:6px;line-height:1.5}
.rec-item{background:rgba(255,255,255,.04);border-radius:10px;padding:14px 16px;margin-bottom:10px;border-left:3px solid}
.rec-high{border-color:#ef4444}
.rec-mid{border-color:#f59e0b}
.rec-low{border-color:#22c55e}
.rec-header{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.rec-badge{font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;text-transform:uppercase}
.rec-badge-high{background:rgba(239,68,68,.15);color:#f87171}
.rec-badge-mid{background:rgba(245,158,11,.15);color:#fbbf24}
.rec-badge-low{background:rgba(34,197,94,.15);color:#4ade80}
.rec-title{font-size:13.5px;font-weight:700}
.rec-desc{font-size:12.5px;color:rgba(255,255,255,.6);line-height:1.6}
.rec-impact{font-size:11.5px;color:#00d4ff;margin-top:6px;display:flex;align-items:center;gap:5px}
.forecast-table{width:100%;border-collapse:collapse;margin-top:12px}
.forecast-table th{padding:10px 14px;font-size:11px;font-weight:700;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.6px;text-align:left;border-bottom:1px solid rgba(255,255,255,.07)}
.forecast-table td{padding:12px 14px;font-size:13px;border-bottom:1px solid rgba(255,255,255,.04)}
.forecast-table tr:last-child td{border-bottom:none}
.forecast-table .num{font-weight:700;font-size:14px}
.forecast-chart-wrap{height:250px;margin-top:16px}
.comp-url-row{display:flex;gap:10px;align-items:flex-end;margin-bottom:12px}
.comp-url-row .form-group{flex:1}
.comp-list{display:flex;flex-direction:column;gap:12px}
.comp-card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:16px}
.comp-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.comp-name{font-size:15px;font-weight:700}
.comp-url-link{font-size:11.5px;color:#00d4ff;text-decoration:none}
.threat-badge{padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700}
.threat-low{background:rgba(34,197,94,.15);color:#4ade80}
.threat-mid{background:rgba(245,158,11,.15);color:#fbbf24}
.threat-high{background:rgba(239,68,68,.15);color:#f87171}
.threat-very-high{background:rgba(239,68,68,.25);color:#f87171;border:1px solid rgba(239,68,68,.4)}
.sw-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0}
.sw-box{background:rgba(255,255,255,.03);border-radius:10px;padding:12px 14px}
.sw-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.sw-title.str{color:#4ade80}
.sw-title.weak{color:#f87171}
.sw-item{font-size:12.5px;color:rgba(255,255,255,.65);padding:4px 0;border-bottom:1px solid rgba(255,255,255,.04);display:flex;gap:6px}
.sw-item:last-child{border-bottom:none}
.comp-strat-item{background:rgba(255,255,255,.04);border-radius:10px;padding:12px 14px;margin-bottom:8px;border-left:3px solid}
.strat-high{border-color:#ef4444}
.strat-mid{border-color:#f59e0b}
.strat-low{border-color:#22c55e}
.strat-header{display:flex;align-items:center;gap:8px;margin-bottom:5px}
.strat-title{font-size:13px;font-weight:700}
.strat-desc{font-size:12.5px;color:rgba(255,255,255,.6);line-height:1.5}
.strat-timeline{font-size:11px;color:rgba(255,255,255,.35);margin-top:5px;display:flex;align-items:center;gap:5px}
.comp-vs-table{width:100%;border-collapse:collapse;margin-top:12px}
.comp-vs-table th{padding:10px 14px;font-size:11px;font-weight:700;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.5px;text-align:left;background:rgba(255,255,255,.03)}
.comp-vs-table td{padding:10px 14px;font-size:12.5px;border-bottom:1px solid rgba(255,255,255,.04)}
.comp-vs-table tr:last-child td{border-bottom:none}
.adv-you{color:#4ade80}
.adv-them{color:#f87171}
#toast{position:fixed;bottom:24px;right:24px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast-item{background:#1e2a4a;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:12px 18px;font-size:13px;display:flex;align-items:center;gap:10px;animation:slideIn .3s ease;min-width:260px}
.toast-item.success{border-left:3px solid #22c55e}
.toast-item.error{border-left:3px solid #ef4444}
.toast-item.info{border-left:3px solid #00d4ff}
@keyframes slideIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
@media(max-width:768px){.sidebar{display:none}.main-content{margin-left:0}.stats-grid{grid-template-columns:repeat(2,1fr)}.form-grid{grid-template-columns:1fr}.charts-grid{grid-template-columns:1fr}.kpi-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<!-- Sidebar -->
<aside class="sidebar">
  <a href="index.html" class="sidebar-logo">
    <img src="https://ui-avatars.com/api/?name=GZ&background=1877f2&color=fff&bold=true" alt="logo">
    <span>GENZ<em>TECH</em></span>
  </a>
  <nav class="sidebar-nav">
    <div class="nav-group-label">Công Cụ</div>
    <a href="index.html" class="nav-item"><i class="bi bi-grid-1x2"></i> Dashboard</a>
    <a href="auto-post.html" class="nav-item"><i class="bi bi-send"></i> Tự Động Đăng Bài</a>
    <a href="ads-assistant.html" class="nav-item" onclick="toggleSubNav(event,'subNavAds')">
      <i class="bi bi-megaphone"></i> Trợ Lý Quảng Cáo
      <i class="bi bi-chevron-down" id="subNavAdsArrow" style="margin-left:auto;font-size:11px;transition:transform .2s"></i>
    </a>
    <div id="subNavAds" style="display:block">
      <a href="tool-ad-account.html" class="nav-sub-item"><i class="bi bi-shield-check"></i> Kiểm Tra TKQC</a>
      <a href="tool-fb-id.html" class="nav-sub-item"><i class="bi bi-person-badge"></i> Tìm Facebook ID</a>
      <a href="tool-budget.html" class="nav-sub-item active"><i class="bi bi-graph-up-arrow"></i> Phân Tích Ngân Sách</a>
      <a href="tool-translate.html" class="nav-sub-item"><i class="bi bi-translate"></i> Dịch Thuật</a>
      <a href="tool-ads-finder.html" class="nav-sub-item"><i class="bi bi-binoculars"></i> Ads Finder</a>
      <a href="tool-policy.html" class="nav-sub-item"><i class="bi bi-journal-text"></i> Chính Sách FB</a>
      <a href="tool-cookie.html" class="nav-sub-item"><i class="bi bi-cookie"></i> Quản Lý Cookie</a>
    </div>
    <a href="#" class="nav-item" onclick="openSettings()"><i class="bi bi-gear"></i> Cài Đặt</a>
  </nav>
  <div class="sidebar-footer">
    <div class="conn-status" id="connStatus">
      <div class="conn-dot" id="connDot"></div>
      <span id="connText">Đang kiểm tra...</span>
    </div>
  </div>
</aside>

<!-- Main -->
<div class="main-content">
  <div class="topbar">
    <div class="topbar-left">
      <div class="breadcrumb">
        <a href="ads-assistant.html" style="color:rgba(255,255,255,.4);text-decoration:none">Trợ Lý QC</a>
        <i class="bi bi-chevron-right" style="font-size:10px"></i>
        <span style="color:#fff;font-weight:600">Phân Tích Ngân Sách & Đối Thủ</span>
      </div>
    </div>
    <div class="topbar-right">
      <button class="btn-icon" onclick="resetForm()"><i class="bi bi-arrow-counterclockwise"></i> Reset</button>
    </div>
  </div>

  <div class="page-body">
    <!-- Page tabs -->
    <div class="page-tabs">
      <button class="page-tab active" id="tabBudget" onclick="switchPageTab('budget',this)"><i class="bi bi-graph-up-arrow"></i> Phân Tích Ngân Sách</button>
      <button class="page-tab" id="tabComp" onclick="switchPageTab('competitor',this)"><i class="bi bi-binoculars"></i> Phân Tích Đối Thủ</button>
    </div>

    <!-- ═══ PAGE: BUDGET ═══ -->
    <div id="pageBudget">
      <div class="card">
        <div class="card-title"><i class="bi bi-input-cursor-text"></i> Nhập Dữ Liệu Chiến Dịch (1 Tháng Thực Tế)</div>
        <div class="form-grid" style="margin-bottom:12px">
          <div class="form-group">
            <label class="form-label">Ngành nghề</label>
            <select class="form-control" id="industry">
              <option value="">-- Chọn ngành --</option>
              <option value="Thời trang & Phụ kiện">Thời trang & Phụ kiện</option>
              <option value="Ẩm thực & Đồ uống">Ẩm thực & Đồ uống</option>
              <option value="Sức khỏe & Làm đẹp">Sức khỏe & Làm đẹp</option>
              <option value="Nội thất & Gia dụng">Nội thất & Gia dụng</option>
              <option value="Thể thao & Giải trí">Thể thao & Giải trí</option>
              <option value="Thú cưng">Thú cưng</option>
              <option value="Giáo dục">Giáo dục</option>
              <option value="Bất động sản">Bất động sản</option>
              <option value="Dịch vụ tài chính">Dịch vụ tài chính</option>
              <option value="Công nghệ">Công nghệ</option>
              <option value="Dịch vụ khác">Dịch vụ khác</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Mục tiêu chiến dịch</label>
            <select class="form-control" id="objective">
              <option value="Chuyển đổi (Conversions)">Chuyển đổi (Conversions)</option>
              <option value="Tin nhắn (Messages)">Tin nhắn (Messages)</option>
              <option value="Lưu lượng (Traffic)">Lưu lượng (Traffic)</option>
              <option value="Tương tác (Engagement)">Tương tác (Engagement)</option>
              <option value="Nhận thức thương hiệu">Nhận thức thương hiệu</option>
              <option value="Tạo khách hàng tiềm năng (Leads)">Tạo khách hàng tiềm năng (Leads)</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Thời gian chạy</label>
            <select class="form-control" id="duration">
              <option value="30">30 ngày</option>
              <option value="14">14 ngày</option>
              <option value="7">7 ngày</option>
            </select>
          </div>
        </div>
        <div class="form-grid" style="margin-bottom:12px">
          <div class="form-group">
            <label class="form-label">Tổng chi phí (VNĐ)</label>
            <input type="number" class="form-control" id="totalSpend" placeholder="VD: 15000000">
          </div>
          <div class="form-group">
            <label class="form-label">Tổng doanh thu (VNĐ)</label>
            <input type="number" class="form-control" id="totalRevenue" placeholder="VD: 45000000">
          </div>
          <div class="form-group">
            <label class="form-label">Tổng lượt hiển thị</label>
            <input type="number" class="form-control" id="impressions" placeholder="VD: 500000">
          </div>
        </div>
        <div class="form-grid" style="margin-bottom:12px">
          <div class="form-group">
            <label class="form-label">Tổng lượt nhấp (Clicks)</label>
            <input type="number" class="form-control" id="clicks" placeholder="VD: 5000">
          </div>
          <div class="form-group">
            <label class="form-label">Tổng chuyển đổi / Đơn hàng</label>
            <input type="number" class="form-control" id="conversions" placeholder="VD: 150">
          </div>
          <div class="form-group">
            <label class="form-label">Tần suất (Frequency)</label>
            <input type="number" step="0.1" class="form-control" id="frequency" placeholder="VD: 2.5">
          </div>
        </div>
        <div class="form-grid" style="margin-bottom:12px">
          <div class="form-group">
            <label class="form-label">Giá trị đơn hàng TB / AOV (VNĐ)</label>
            <input type="number" class="form-control" id="aov" placeholder="VD: 300000">
          </div>
          <div class="form-group">
            <label class="form-label">Giá vốn hàng bán / COGS (VNĐ)</label>
            <input type="number" class="form-control" id="cogs" placeholder="VD: 150000">
          </div>
          <div class="form-group">
            <label class="form-label">Ngân sách tháng tới (VNĐ)</label>
            <input type="number" class="form-control" id="nextBudget" placeholder="Để trống = giữ nguyên">
          </div>
        </div>
        <div class="form-group" style="margin-bottom:14px">
          <label class="form-label">Mô tả sản phẩm / dịch vụ (để AI phân tích chính xác hơn)</label>
          <textarea class="form-control" id="businessDesc" placeholder="VD: Bán áo thun in hình custom, giá 200-350k, target 18-35 tuổi, chạy tại TP.HCM và Hà Nội..."></textarea>
        </div>
        <div style="display:flex;gap:10px">
          <button class="btn btn-primary" onclick="runAnalysis()" id="btnAnalyze">
            <i class="bi bi-robot"></i> Phân Tích & Dự Báo AI
          </button>
          <button class="btn btn-outline" onclick="loadSample()">
            <i class="bi bi-lightning"></i> Dữ liệu mẫu
          </button>
        </div>
      </div>

      <!-- KPI Summary -->
      <div id="kpiSummary" style="display:none">
        <div class="stats-grid" id="statsRow"></div>
        <div class="tab-bar">
          <button class="tab-btn active" id="tabCharts" onclick="switchTab('charts',this)"><i class="bi bi-bar-chart-line"></i> Biểu Đồ</button>
          <button class="tab-btn" id="tabAI" onclick="switchTab('ai',this)"><i class="bi bi-robot"></i> Phân Tích AI</button>
          <button class="tab-btn" id="tabForecast" onclick="switchTab('forecast',this)"><i class="bi bi-graph-up"></i> Dự Báo 3 Tháng</button>
        </div>
        <div class="tab-pane active" id="paneCharts">
          <div class="charts-grid">
            <div class="chart-box"><div class="chart-title"><i class="bi bi-bar-chart"></i> Chi Phí vs Doanh Thu</div><div class="chart-wrap"><canvas id="chartRevenue"></canvas></div></div>
            <div class="chart-box"><div class="chart-title"><i class="bi bi-funnel"></i> Phễu Chuyển Đổi</div><div class="chart-wrap"><canvas id="chartFunnel"></canvas></div></div>
            <div class="chart-box"><div class="chart-title"><i class="bi bi-pie-chart"></i> Phân Tích Chi Phí</div><div class="chart-wrap"><canvas id="chartCost"></canvas></div></div>
            <div class="chart-box"><div class="chart-title"><i class="bi bi-speedometer2"></i> Hiệu Suất KPIs (Radar)</div><div class="chart-wrap"><canvas id="chartKpi"></canvas></div></div>
          </div>
        </div>
        <div class="tab-pane" id="paneAI">
          <div id="aiResult"><div class="ai-loading"><div class="spin"></div><p>AI đang phân tích...</p></div></div>
        </div>
        <div class="tab-pane" id="paneForecast">
          <div id="forecastResult"><div class="ai-loading"><div class="spin"></div><p>Đang tính toán dự báo...</p></div></div>
        </div>
      </div>
    </div>

    <!-- ═══ PAGE: COMPETITOR ═══ -->
    <div id="pageCompetitor" style="display:none">
      <div class="card">
        <div class="card-title"><i class="bi bi-binoculars"></i> Phân Tích Đối Thủ Cạnh Tranh</div>
        <div class="form-group" style="margin-bottom:12px">
          <label class="form-label">Mô tả doanh nghiệp của bạn (để so sánh)</label>
          <textarea class="form-control" id="yourBusinessDesc" placeholder="VD: Shop thời trang nữ online, giá 200-500k, target 18-30 tuổi, mạnh về chất liệu vải cao cấp, giao hàng nhanh..."></textarea>
        </div>
        <div class="form-group" style="margin-bottom:12px">
          <label class="form-label">Ngành nghề</label>
          <select class="form-control" id="compIndustry" style="max-width:300px">
            <option value="">-- Chọn ngành --</option>
            <option value="Thời trang & Phụ kiện">Thời trang & Phụ kiện</option>
            <option value="Ẩm thực & Đồ uống">Ẩm thực & Đồ uống</option>
            <option value="Sức khỏe & Làm đẹp">Sức khỏe & Làm đẹp</option>
            <option value="Nội thất & Gia dụng">Nội thất & Gia dụng</option>
            <option value="Thể thao & Giải trí">Thể thao & Giải trí</option>
            <option value="Thú cưng">Thú cưng</option>
            <option value="Giáo dục">Giáo dục</option>
            <option value="Bất động sản">Bất động sản</option>
            <option value="Dịch vụ tài chính">Dịch vụ tài chính</option>
            <option value="Công nghệ">Công nghệ</option>
            <option value="Dịch vụ khác">Dịch vụ khác</option>
          </select>
        </div>
        <div id="compUrlList">
          <div class="comp-url-row">
            <div class="form-group">
              <label class="form-label">Link đối thủ #1 (website hoặc fanpage)</label>
              <input type="url" class="form-control comp-url-input" placeholder="https://example.com hoặc https://facebook.com/page">
            </div>
          </div>
        </div>
        <div style="display:flex;gap:10px;margin-top:12px">
          <button class="btn btn-outline" onclick="addCompUrl()"><i class="bi bi-plus-circle"></i> Thêm đối thủ</button>
          <button class="btn btn-primary" onclick="analyzeCompetitors()" id="btnComp">
            <i class="bi bi-robot"></i> Phân Tích Đối Thủ
          </button>
        </div>
      </div>
      <div id="compResults" style="display:none">
        <div class="comp-list" id="compList"></div>
      </div>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
const BACKEND = 'https://genztech-production.up.railway.app';
let charts = {};
let compUrlCount = 1;

// ─── Page tab switch ──────────────────────────────────────────────────────────
function switchPageTab(page, btn) {
  document.querySelectorAll('.page-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('pageBudget').style.display = page === 'budget' ? 'block' : 'none';
  document.getElementById('pageCompetitor').style.display = page === 'competitor' ? 'block' : 'none';
}

// ─── Tab switch ───────────────────────────────────────────────────────────────
function switchTab(name, btn) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  const map = { charts: 'paneCharts', ai: 'paneAI', forecast: 'paneForecast' };
  const pane = document.getElementById(map[name]);
  if (pane) pane.classList.add('active');
}

// ─── Sidebar sub nav ──────────────────────────────────────────────────────────
function toggleSubNav(e, id) {
  e.preventDefault();
  const el = document.getElementById(id);
  if (el) el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

// ─── Format ───────────────────────────────────────────────────────────────────
function fmtVnd(n) {
  if (!n || isNaN(n)) return '—';
  if (n >= 1e9) return (n/1e9).toFixed(1) + ' tỷ';
  if (n >= 1e6) return (n/1e6).toFixed(1) + ' tr';
  if (n >= 1e3) return (n/1e3).toFixed(0) + 'k';
  return n.toLocaleString('vi-VN');
}
function fmtPct(n) { return isNaN(n) ? '—' : n.toFixed(2) + '%'; }
function fmtX(n) { return isNaN(n) ? '—' : n.toFixed(2) + 'x'; }

// ─── Load sample data ─────────────────────────────────────────────────────────
function loadSample() {
  document.getElementById('industry').value = 'Thời trang & Phụ kiện';
  document.getElementById('objective').value = 'Chuyển đổi (Conversions)';
  document.getElementById('totalSpend').value = 15000000;
  document.getElementById('totalRevenue').value = 42000000;
  document.getElementById('impressions').value = 480000;
  document.getElementById('clicks').value = 5760;
  document.getElementById('conversions').value = 140;
  document.getElementById('frequency').value = 2.8;
  document.getElementById('aov').value = 300000;
  document.getElementById('cogs').value = 130000;
  document.getElementById('businessDesc').value = 'Shop thời trang nữ online, chuyên áo thun in hình custom, giá 200-350k, target 18-35 tuổi, chạy tại TP.HCM và Hà Nội';
  toast('Đã điền dữ liệu mẫu', 'info');
}

// ─── Reset form ───────────────────────────────────────────────────────────────
function resetForm() {
  ['totalSpend','totalRevenue','impressions','clicks','conversions','frequency','aov','cogs','nextBudget','businessDesc'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  document.getElementById('kpiSummary').style.display = 'none';
  Object.values(charts).forEach(c => { try { c.destroy(); } catch(e){} });
  charts = {};
}

// ─── Compute KPIs ─────────────────────────────────────────────────────────────
function computeKPIs() {
  const spend = +document.getElementById('totalSpend').value || 0;
  const revenue = +document.getElementById('totalRevenue').value || 0;
  const impressions = +document.getElementById('impressions').value || 0;
  const clicks = +document.getElementById('clicks').value || 0;
  const conversions = +document.getElementById('conversions').value || 0;
  const frequency = +document.getElementById('frequency').value || 0;
  const aov = +document.getElementById('aov').value || 0;
  const cogs = +document.getElementById('cogs').value || 0;

  const cpm = impressions > 0 ? (spend / impressions * 1000) : 0;
  const ctr = impressions > 0 ? (clicks / impressions * 100) : 0;
  const cpc = clicks > 0 ? (spend / clicks) : 0;
  const cvr = clicks > 0 ? (conversions / clicks * 100) : 0;
  const cpa = conversions > 0 ? (spend / conversions) : 0;
  const roas = spend > 0 ? (revenue / spend) : 0;
  const profit = revenue - spend - (conversions * cogs);
  const roi = spend > 0 ? (profit / spend * 100) : 0;

  return { spend, revenue, impressions, clicks, conversions, frequency, aov, cogs, cpm, ctr, cpc, cvr, cpa, roas, profit, roi };
}

// ─── Render KPI stats row ─────────────────────────────────────────────────────
function renderStats(kpis) {
  const items = [
    { label: 'ROAS', value: fmtX(kpis.roas), sub: kpis.roas >= 3 ? '✓ Tốt' : kpis.roas >= 2 ? '~ Trung bình' : '✗ Yếu', color: kpis.roas >= 3 ? '#22c55e' : kpis.roas >= 2 ? '#f59e0b' : '#ef4444' },
    { label: 'CPM', value: fmtVnd(kpis.cpm), sub: kpis.cpm < 70000 ? '✓ Tốt' : kpis.cpm < 120000 ? '~ TB' : '✗ Cao', color: kpis.cpm < 70000 ? '#22c55e' : kpis.cpm < 120000 ? '#f59e0b' : '#ef4444' },
    { label: 'CTR', value: fmtPct(kpis.ctr), sub: kpis.ctr >= 2 ? '✓ Tốt' : kpis.ctr >= 1 ? '~ TB' : '✗ Thấp', color: kpis.ctr >= 2 ? '#22c55e' : kpis.ctr >= 1 ? '#f59e0b' : '#ef4444' },
    { label: 'CPA', value: fmtVnd(kpis.cpa), sub: kpis.aov > 0 ? (kpis.cpa < kpis.aov * 0.3 ? '✓ Tốt' : '✗ Cao') : '—', color: kpis.aov > 0 && kpis.cpa < kpis.aov * 0.3 ? '#22c55e' : '#f59e0b' },
    { label: 'Lợi nhuận', value: fmtVnd(kpis.profit), sub: kpis.profit > 0 ? '✓ Có lãi' : '✗ Lỗ', color: kpis.profit > 0 ? '#22c55e' : '#ef4444' }
  ];
  document.getElementById('statsRow').innerHTML = items.map(i => `
    <div class="stat-card">
      <div class="stat-label">${i.label}</div>
      <div class="stat-value" style="color:${i.color}">${i.value}</div>
      <div class="stat-sub" style="color:${i.color}">${i.sub}</div>
    </div>`).join('');
}

// ─── Render Charts ────────────────────────────────────────────────────────────
function renderCharts(kpis) {
  Object.values(charts).forEach(c => { try { c.destroy(); } catch(e){} });
  charts = {};

  const mkChart = (id, type, data, opts) => {
    const ctx = document.getElementById(id);
    if (!ctx) return;
    charts[id] = new Chart(ctx, { type, data, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: 'rgba(255,255,255,.6)', font: { size: 11 } } } }, ...opts } });
  };

  mkChart('chartRevenue', 'bar', {
    labels: ['Chi phí QC', 'Doanh thu', 'Lợi nhuận'],
    datasets: [{ data: [kpis.spend, kpis.revenue, Math.max(0, kpis.profit)], backgroundColor: ['rgba(239,68,68,.7)', 'rgba(34,197,94,.7)', 'rgba(0,212,255,.7)'], borderRadius: 6 }]
  }, { plugins: { legend: { display: false } }, scales: { x: { ticks: { color: 'rgba(255,255,255,.5)', font: { size: 10 } } }, y: { ticks: { color: 'rgba(255,255,255,.5)', font: { size: 10 }, callback: v => fmtVnd(v) } } } });

  mkChart('chartFunnel', 'bar', {
    labels: ['Hiển thị', 'Nhấp', 'Chuyển đổi'],
    datasets: [{ data: [kpis.impressions, kpis.clicks, kpis.conversions], backgroundColor: ['rgba(99,102,241,.7)', 'rgba(0,212,255,.7)', 'rgba(34,197,94,.7)'], borderRadius: 6 }]
  }, { indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { ticks: { color: 'rgba(255,255,255,.5)', font: { size: 10 } } }, y: { ticks: { color: 'rgba(255,255,255,.5)', font: { size: 10 } } } } });

  const adCost = kpis.spend;
  const cogsCost = kpis.conversions * kpis.cogs;
  const profitVal = Math.max(0, kpis.profit);
  mkChart('chartCost', 'doughnut', {
    labels: ['Chi phí QC', 'Giá vốn', 'Lợi nhuận'],
    datasets: [{ data: [adCost, cogsCost, profitVal], backgroundColor: ['rgba(239,68,68,.8)', 'rgba(245,158,11,.8)', 'rgba(34,197,94,.8)'], borderWidth: 0 }]
  });

  const roas_s = Math.min(100, kpis.roas / 4 * 100);
  const ctr_s = Math.min(100, kpis.ctr / 2 * 100);
  const cvr_s = Math.min(100, kpis.cvr / 3 * 100);
  const cpm_s = Math.min(100, Math.max(0, (120000 - kpis.cpm) / 120000 * 100));
  const freq_s = Math.min(100, Math.max(0, (4 - kpis.frequency) / 4 * 100));
  mkChart('chartKpi', 'radar', {
    labels: ['ROAS', 'CTR', 'CVR', 'CPM (thấp=tốt)', 'Frequency (thấp=tốt)'],
    datasets: [{ label: 'Hiệu suất', data: [roas_s, ctr_s, cvr_s, cpm_s, freq_s], backgroundColor: 'rgba(0,212,255,.15)', borderColor: '#00d4ff', pointBackgroundColor: '#00d4ff', pointRadius: 4 }]
  }, { scales: { r: { ticks: { color: 'rgba(255,255,255,.3)', font: { size: 9 }, backdropColor: 'transparent' }, grid: { color: 'rgba(255,255,255,.07)' }, pointLabels: { color: 'rgba(255,255,255,.5)', font: { size: 10 } }, min: 0, max: 100 } } });
}

// ─── Run Analysis ─────────────────────────────────────────────────────────────
async function runAnalysis() {
  const spend = +document.getElementById('totalSpend').value;
  if (!spend) { toast('Vui lòng nhập tổng chi phí', 'error'); return; }

  const kpis = computeKPIs();
  const industry = document.getElementById('industry').value || 'Chưa xác định';

  document.getElementById('kpiSummary').style.display = 'block';
  renderStats(kpis);
  renderCharts(kpis);

  document.getElementById('aiResult').innerHTML = `<div class="ai-loading"><div class="spin"></div><p>AI đang phân tích chuyên sâu theo ngành <strong>${industry}</strong>...</p></div>`;
  document.getElementById('forecastResult').innerHTML = `<div class="ai-loading"><div class="spin"></div><p>Đang tính toán dự báo 3 tháng tới...</p></div>`;

  const btn = document.getElementById('btnAnalyze');
  btn.disabled = true;
  btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Đang phân tích...';

  try {
    const metrics = {
      tong_chi_phi: kpis.spend,
      tong_doanh_thu: kpis.revenue,
      luot_hien_thi: kpis.impressions,
      luot_nhap: kpis.clicks,
      chuyen_doi: kpis.conversions,
      tan_suat: kpis.frequency,
      gia_tri_don_hang_tb: kpis.aov,
      gia_von: kpis.cogs,
      ngan_sach_thang_toi: +document.getElementById('nextBudget').value || kpis.spend,
      cpm: Math.round(kpis.cpm),
      ctr: kpis.ctr.toFixed(2) + '%',
      cpc: Math.round(kpis.cpc),
      cvr: kpis.cvr.toFixed(2) + '%',
      cpa: Math.round(kpis.cpa),
      roas: kpis.roas.toFixed(2),
      loi_nhuan: Math.round(kpis.profit)
    };

    const resp = await fetch(`${BACKEND}/api/ai/analyze-budget`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        metrics,
        industry,
        objective: document.getElementById('objective').value,
        currency: 'VNĐ',
        yourBusiness: document.getElementById('businessDesc').value
      })
    });

    const data = await resp.json();
    if (!data.success) throw new Error(data.error || 'Lỗi phân tích AI');

    renderAIResult(data.analysis, kpis);
    renderForecast(data.analysis, kpis);
    toast('Phân tích AI hoàn tất!', 'success');
  } catch (err) {
    document.getElementById('aiResult').innerHTML = `<div style="text-align:center;padding:30px;color:#f87171"><i class="bi bi-exclamation-triangle" style="font-size:32px;display:block;margin-bottom:10px"></i><p>${err.message}</p></div>`;
    document.getElementById('forecastResult').innerHTML = renderLocalForecast(kpis);
    toast('Lỗi AI: ' + err.message, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-robot"></i> Phân Tích & Dự Báo AI';
  }
}

// ─── Render AI Result ─────────────────────────────────────────────────────────
function renderAIResult(a, kpis) {
  if (!a || a.raw) {
    document.getElementById('aiResult').innerHTML = `<pre style="font-size:12px;color:rgba(255,255,255,.6);white-space:pre-wrap;padding:20px">${a?.raw || 'Không có dữ liệu'}</pre>`;
    return;
  }

  const scoreClass = (a.overview?.score >= 70) ? 'score-good' : (a.overview?.score >= 40) ? 'score-avg' : 'score-bad';
  const statusColor = a.overview?.status === 'Tốt' ? '#22c55e' : a.overview?.status === 'Trung bình' ? '#f59e0b' : '#ef4444';

  let kpiHtml = '';
  if (a.kpi_analysis?.length) {
    kpiHtml = `<div class="kpi-grid">${a.kpi_analysis.map(k => {
      const cls = k.status === 'Tốt' ? 'kpi-good' : k.status === 'Trung bình' ? 'kpi-avg' : 'kpi-bad';
      const valColor = k.status === 'Tốt' ? '#22c55e' : k.status === 'Trung bình' ? '#f59e0b' : '#ef4444';
      return `<div class="kpi-item ${cls}">
        <div class="kpi-name">${k.kpi}</div>
        <div class="kpi-val" style="color:${valColor}">${k.value}</div>
        <div class="kpi-bench">Benchmark ngành: ${k.benchmark}</div>
        <div class="kpi-comment">${k.comment}</div>
      </div>`;
    }).join('')}</div>`;
  }

  let swHtml = '';
  if (a.strengths?.length || a.weaknesses?.length) {
    swHtml = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0">
      <div class="sw-box"><div class="sw-title str"><i class="bi bi-check-circle-fill"></i> Điểm Mạnh</div>${(a.strengths||[]).map(s=>`<div class="sw-item"><span style="color:#4ade80">✓</span> ${s}</div>`).join('')}</div>
      <div class="sw-box"><div class="sw-title weak"><i class="bi bi-x-circle-fill"></i> Điểm Yếu / Rủi Ro</div>${(a.weaknesses||[]).map(w=>`<div class="sw-item"><span style="color:#f87171">✗</span> ${w}</div>`).join('')}</div>
    </div>`;
  }

  let recHtml = '';
  if (a.recommendations?.length) {
    recHtml = `<div style="margin-top:16px">
      <div class="card-title"><i class="bi bi-lightbulb"></i> Đề Xuất Hành Động Cụ Thể</div>
      ${a.recommendations.map(r => {
        const cls = r.priority === 'Cao' ? 'rec-high' : r.priority === 'Trung bình' ? 'rec-mid' : 'rec-low';
        const badgeCls = r.priority === 'Cao' ? 'rec-badge-high' : r.priority === 'Trung bình' ? 'rec-badge-mid' : 'rec-badge-low';
        return `<div class="rec-item ${cls}">
          <div class="rec-header"><span class="rec-badge ${badgeCls}">${r.priority}</span><span class="rec-title">${r.title}</span></div>
          <div class="rec-desc">${r.description}</div>
          ${r.expected_impact ? `<div class="rec-impact"><i class="bi bi-arrow-up-right"></i> ${r.expected_impact}</div>` : ''}
        </div>`;
      }).join('')}
    </div>`;
  }

  document.getElementById('aiResult').innerHTML = `
    <div style="text-align:center;margin-bottom:20px">
      <div class="score-circle ${scoreClass}">${a.overview?.score || '—'}<span style="font-size:12px;font-weight:500">/100</span></div>
      <div style="font-size:18px;font-weight:700;color:${statusColor}">${a.overview?.status || ''}</div>
      <div style="font-size:13px;color:rgba(255,255,255,.6);margin-top:8px;max-width:700px;margin-left:auto;margin-right:auto;line-height:1.7">${a.overview?.summary || ''}</div>
      ${a.industry_context ? `<div style="margin-top:12px;background:rgba(0,212,255,.08);border:1px solid rgba(0,212,255,.2);border-radius:8px;padding:10px 16px;font-size:12.5px;color:rgba(255,255,255,.65);text-align:left;max-width:700px;margin-left:auto;margin-right:auto;line-height:1.6"><i class="bi bi-info-circle" style="color:#00d4ff"></i> <strong>Đặc thù ngành ${a.industry_context?.industry || ''}:</strong> ${a.industry_context?.note || a.industry_context}</div>` : ''}
    </div>
    ${kpiHtml}${swHtml}${recHtml}`;
}

// ─── Render Forecast ──────────────────────────────────────────────────────────
function renderForecast(a, kpis) {
  if (!a?.forecast) {
    document.getElementById('forecastResult').innerHTML = renderLocalForecast(kpis);
    return;
  }
  const f = a.forecast;
  const rows = f.monthly || [];

  const tableHtml = `
    <table class="forecast-table">
      <thead><tr>
        <th>Tháng</th><th>Ngân sách</th><th>Doanh thu DK</th><th>ROAS DK</th><th>CPA DK</th><th>CTR DK</th><th>Loại</th>
      </tr></thead>
      <tbody>${rows.map(r => `
        <tr>
          <td><strong>${r.month}</strong></td>
          <td class="num">${fmtVnd(r.budget)}</td>
          <td class="num" style="color:${r.label==='Thực tế'?'#fff':'#4ade80'}">${fmtVnd(r.revenue)}</td>
          <td class="num" style="color:${r.label==='Thực tế'?'#fff':'#00d4ff'}">${typeof r.roas === 'number' ? r.roas.toFixed(2)+'x' : r.roas}</td>
          <td class="num">${fmtVnd(r.cpa)}</td>
          <td class="num">${r.ctr || '—'}</td>
          <td><span style="font-size:11px;padding:2px 8px;border-radius:20px;background:${r.label==='Thực tế'?'rgba(255,255,255,.08)':'rgba(0,212,255,.12)'};color:${r.label==='Thực tế'?'rgba(255,255,255,.5)':'#00d4ff'}">${r.label}</span></td>
        </tr>`).join('')}
      </tbody>
    </table>`;

  const assumptionsHtml = f.key_assumptions?.length
    ? `<div style="margin-top:14px;background:rgba(255,255,255,.03);border-radius:8px;padding:12px 14px">
        <div style="font-size:11px;font-weight:700;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.6px;margin-bottom:8px">Giả định dự báo</div>
        ${f.key_assumptions.map(a => `<div style="font-size:12.5px;color:rgba(255,255,255,.55);padding:3px 0;display:flex;gap:6px"><span style="color:#00d4ff">•</span>${a}</div>`).join('')}
      </div>` : '';

  document.getElementById('forecastResult').innerHTML = `
    <div style="margin-bottom:14px;font-size:13px;color:rgba(255,255,255,.6);line-height:1.6;background:rgba(0,212,255,.06);border:1px solid rgba(0,212,255,.15);border-radius:10px;padding:12px 14px">
      <i class="bi bi-info-circle" style="color:#00d4ff"></i> ${f.summary || 'Dự báo dựa trên dữ liệu thực tế và giả định thực hiện các đề xuất tối ưu.'}
    </div>
    ${tableHtml}
    <div class="chart-box" style="margin-top:16px">
      <div class="chart-title"><i class="bi bi-graph-up"></i> Biểu Đồ Dự Báo 4 Tháng</div>
      <div class="forecast-chart-wrap"><canvas id="chartForecast"></canvas></div>
    </div>
    ${assumptionsHtml}`;

  setTimeout(() => {
    const ctx = document.getElementById('chartForecast');
    if (!ctx) return;
    if (charts['forecast']) { try { charts['forecast'].destroy(); } catch(e){} }
    charts['forecast'] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: rows.map(r => r.month),
        datasets: [
          { label: 'Doanh thu', data: rows.map(r => r.revenue), backgroundColor: rows.map((r,i) => i===0?'rgba(34,197,94,.6)':'rgba(0,212,255,.6)'), borderRadius: 6, order: 2 },
          { label: 'Ngân sách', data: rows.map(r => r.budget), type: 'line', borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,.1)', borderWidth: 2, pointRadius: 4, fill: true, order: 1 }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { labels: { color: 'rgba(255,255,255,.6)', font: { size: 11 } } } },
        scales: {
          x: { ticks: { color: 'rgba(255,255,255,.5)', font: { size: 10 } } },
          y: { ticks: { color: 'rgba(255,255,255,.5)', font: { size: 10 }, callback: v => fmtVnd(v) } }
        }
      }
    });
  }, 100);
}

// ─── Local Forecast fallback ──────────────────────────────────────────────────
function renderLocalForecast(kpis) {
  const rows = [
    { month: 'Tháng hiện tại', roas: kpis.roas, budget: kpis.spend, label: 'Thực tế' },
    { month: 'Tháng 2 (DK)', roas: kpis.roas * 1.08, budget: kpis.spend, label: 'Dự báo' },
    { month: 'Tháng 3 (DK)', roas: kpis.roas * 1.15, budget: kpis.spend, label: 'Dự báo' },
    { month: 'Tháng 4 (DK)', roas: kpis.roas * 1.22, budget: kpis.spend, label: 'Dự báo' }
  ].map(m => ({ ...m, revenue: Math.round(m.budget * m.roas), cpa: Math.round(kpis.cpa * (m.label==='Thực tế'?1:0.93)), ctr: fmtPct(kpis.ctr * (m.label==='Thực tế'?1:1.05)) }));

  return `<div style="margin-bottom:14px;font-size:13px;color:rgba(255,255,255,.6);background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.2);border-radius:10px;padding:12px 14px">
    <i class="bi bi-calculator" style="color:#f59e0b"></i> Dự báo tính toán cục bộ. Giả định cải thiện 8%/tháng nếu thực hiện đề xuất tối ưu.
  </div>
  <table class="forecast-table">
    <thead><tr><th>Tháng</th><th>Ngân sách</th><th>Doanh thu DK</th><th>ROAS DK</th><th>CPA DK</th><th>CTR DK</th><th>Loại</th></tr></thead>
    <tbody>${rows.map(r=>`<tr>
      <td><strong>${r.month}</strong></td>
      <td class="num">${fmtVnd(r.budget)}</td>
      <td class="num" style="color:${r.label==='Thực tế'?'#fff':'#4ade80'}">${fmtVnd(r.revenue)}</td>
      <td class="num" style="color:${r.label==='Thực tế'?'#fff':'#00d4ff'}">${r.roas.toFixed(2)}x</td>
      <td class="num">${fmtVnd(r.cpa)}</td>
      <td class="num">${r.ctr}</td>
      <td><span style="font-size:11px;padding:2px 8px;border-radius:20px;background:${r.label==='Thực tế'?'rgba(255,255,255,.08)':'rgba(0,212,255,.12)'};color:${r.label==='Thực tế'?'rgba(255,255,255,.5)':'#00d4ff'}">${r.label}</span></td>
    </tr>`).join('')}</tbody>
  </table>`;
}

// ─── Competitor Analysis ──────────────────────────────────────────────────────
function addCompUrl() {
  compUrlCount++;
  const div = document.createElement('div');
  div.className = 'comp-url-row';
  div.innerHTML = `<div class="form-group" style="flex:1">
    <label class="form-label">Link đối thủ #${compUrlCount}</label>
    <input type="url" class="form-control comp-url-input" placeholder="https://example.com hoặc https://facebook.com/page">
  </div>
  <button class="btn btn-outline" style="height:38px;align-self:flex-end" onclick="this.parentElement.remove()"><i class="bi bi-x"></i></button>`;
  document.getElementById('compUrlList').appendChild(div);
}

async function analyzeCompetitors() {
  const urls = [...document.querySelectorAll('.comp-url-input')].map(i => i.value.trim()).filter(Boolean);
  if (!urls.length) { toast('Vui lòng nhập ít nhất 1 link đối thủ', 'error'); return; }

  const yourBusiness = document.getElementById('yourBusinessDesc').value;
  const industry = document.getElementById('compIndustry').value;

  const btn = document.getElementById('btnComp');
  btn.disabled = true;
  btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Đang phân tích...';

  document.getElementById('compResults').style.display = 'block';
  document.getElementById('compList').innerHTML = urls.map((url, i) => `
    <div class="comp-card" id="compCard${i}">
      <div class="ai-loading"><div class="spin"></div><p>Đang phân tích: <strong>${url}</strong></p></div>
    </div>`).join('');

  for (let i = 0; i < urls.length; i++) {
    try {
      const resp = await fetch(`${BACKEND}/api/ai/analyze-competitor`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ competitorUrl: urls[i], yourBusiness, industry })
      });
      const data = await resp.json();
      if (!data.success) throw new Error(data.error);
      renderCompCard(i, urls[i], data.analysis);
    } catch (err) {
      document.getElementById(`compCard${i}`).innerHTML = `<div style="color:#f87171;padding:20px"><i class="bi bi-exclamation-triangle"></i> Lỗi phân tích ${urls[i]}: ${err.message}</div>`;
    }
  }

  btn.disabled = false;
  btn.innerHTML = '<i class="bi bi-robot"></i> Phân Tích Đối Thủ';
  toast('Phân tích đối thủ hoàn tất!', 'success');
}

function renderCompCard(idx, url, a) {
  if (!a || a.raw) {
    document.getElementById(`compCard${idx}`).innerHTML = `<pre style="font-size:12px;color:rgba(255,255,255,.6);white-space:pre-wrap;padding:20px">${a?.raw || 'Không có dữ liệu'}</pre>`;
    return;
  }

  const threatCls = { 'Thấp': 'threat-low', 'Trung bình': 'threat-mid', 'Cao': 'threat-high', 'Rất cao': 'threat-very-high' }[a.overall_threat] || 'threat-mid';

  const strHtml = (a.strengths || []).map(s => `<div class="sw-item"><span style="color:#4ade80">✓</span> <div><strong>${s.point || s}</strong>${s.detail ? `<div style="font-size:11.5px;color:rgba(255,255,255,.5);margin-top:2px">${s.detail}</div>` : ''}</div></div>`).join('');
  const weakHtml = (a.weaknesses || []).map(w => `<div class="sw-item"><span style="color:#f87171">✗</span> <div><strong>${w.point || w}</strong>${w.detail ? `<div style="font-size:11.5px;color:rgba(255,255,255,.5);margin-top:2px">${w.detail}</div>` : ''}</div></div>`).join('');

  const compHtml = a.comparison ? `
    <div style="margin:12px 0">
      <div class="card-title" style="margin-bottom:10px"><i class="bi bi-arrow-left-right"></i> So Sánh Với Bạn</div>
      <table class="comp-vs-table">
        <thead><tr><th>Lợi thế của bạn</th><th>Bất lợi của bạn</th><th>Cơ hội khai thác</th></tr></thead>
        <tbody><tr>
          <td>${(a.comparison.your_advantages||[]).map(x=>`<div class="adv-you" style="margin-bottom:5px">✓ ${x}</div>`).join('')}</td>
          <td>${(a.comparison.your_disadvantages||[]).map(x=>`<div class="adv-them" style="margin-bottom:5px">✗ ${x}</div>`).join('')}</td>
          <td>${(a.comparison.opportunities||[]).map(x=>`<div style="color:#00d4ff;margin-bottom:5px">→ ${x}</div>`).join('')}</td>
        </tr></tbody>
      </table>
    </div>` : '';

  const stratHtml = (a.strategies || []).map(s => {
    const cls = s.priority === 'Cao' ? 'strat-high' : s.priority === 'Trung bình' ? 'strat-mid' : 'strat-low';
    const badgeCls = s.priority === 'Cao' ? 'rec-badge-high' : s.priority === 'Trung bình' ? 'rec-badge-mid' : 'rec-badge-low';
    return `<div class="comp-strat-item ${cls}">
      <div class="strat-header"><span class="rec-badge ${badgeCls}">${s.priority}</span><span class="strat-title">${s.title}</span></div>
      <div class="strat-desc">${s.description}</div>
      <div class="strat-timeline"><i class="bi bi-clock"></i> ${s.timeline}</div>
    </div>`;
  }).join('');

  document.getElementById(`compCard${idx}`).innerHTML = `
    <div class="comp-header">
      <div>
        <div class="comp-name">${a.competitor_info?.name || 'Đối thủ ' + (idx+1)}</div>
        <a href="${url}" target="_blank" class="comp-url-link">${url} <i class="bi bi-box-arrow-up-right" style="font-size:10px"></i></a>
      </div>
      <span class="threat-badge ${threatCls}">Mức đe dọa: ${a.overall_threat || '—'}</span>
    </div>
    ${a.threat_summary ? `<div style="font-size:12.5px;color:rgba(255,255,255,.55);margin-bottom:12px;padding:10px 12px;background:rgba(255,255,255,.03);border-radius:8px;line-height:1.6">${a.threat_summary}</div>` : ''}
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px">
      <div style="background:rgba(255,255,255,.03);border-radius:8px;padding:10px 12px"><div style="font-size:10px;color:rgba(255,255,255,.35);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Loại hình</div><div style="font-size:12.5px">${a.competitor_info?.type || '—'}</div></div>
      <div style="background:rgba(255,255,255,.03);border-radius:8px;padding:10px 12px"><div style="font-size:10px;color:rgba(255,255,255,.35);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Phân khúc giá</div><div style="font-size:12.5px">${a.competitor_info?.price_range || '—'}</div></div>
      <div style="background:rgba(255,255,255,.03);border-radius:8px;padding:10px 12px"><div style="font-size:10px;color:rgba(255,255,255,.35);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Thị trường</div><div style="font-size:12.5px">${a.competitor_info?.target_market || '—'}</div></div>
    </div>
    ${a.usp_analysis ? `<div style="background:rgba(0,212,255,.06);border:1px solid rgba(0,212,255,.15);border-radius:10px;padding:12px 14px;margin-bottom:12px"><div style="font-size:11px;font-weight:700;color:#00d4ff;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px"><i class="bi bi-star"></i> USP Chính</div><div style="font-size:13px;font-weight:600;margin-bottom:4px">${a.usp_analysis.main_usp || ''}</div><div style="font-size:12.5px;color:rgba(255,255,255,.55);line-height:1.5">${a.usp_analysis.messaging || ''}</div></div>` : ''}
    <div class="sw-grid">
      <div class="sw-box"><div class="sw-title str"><i class="bi bi-check-circle-fill"></i> Điểm Mạnh</div>${strHtml || '<div style="color:rgba(255,255,255,.3);font-size:12px">Không có dữ liệu</div>'}</div>
      <div class="sw-box"><div class="sw-title weak"><i class="bi bi-x-circle-fill"></i> Điểm Yếu</div>${weakHtml || '<div style="color:rgba(255,255,255,.3);font-size:12px">Không có dữ liệu</div>'}</div>
    </div>
    ${compHtml}
    ${stratHtml ? `<div style="margin-top:12px"><div class="card-title" style="margin-bottom:10px"><i class="bi bi-lightbulb"></i> Chiến Lược Cạnh Tranh Đề Xuất</div>${stratHtml}</div>` : ''}`;
}

// ─── Toast ────────────────────────────────────────────────────────────────────
function toast(msg, type = 'info') {
  const icons = { success: 'bi-check-circle-fill', error: 'bi-x-circle-fill', info: 'bi-info-circle-fill' };
  const el = document.createElement('div');
  el.className = `toast-item ${type}`;
  el.innerHTML = `<i class="bi ${icons[type]}" style="font-size:16px"></i> ${msg}`;
  document.getElementById('toast').appendChild(el);
  setTimeout(() => el.remove(), 4000);
}

// ─── Check backend connection ─────────────────────────────────────────────────
async function checkConn() {
  try {
    const r = await fetch(`${BACKEND}/health`, { signal: AbortSignal.timeout(5000) });
    if (r.ok) {
      document.getElementById('connDot').className = 'conn-dot online';
      document.getElementById('connText').textContent = 'Đã kết nối';
    } else throw new Error();
  } catch {
    document.getElementById('connText').textContent = 'Mất kết nối';
  }
}

checkConn();
</script>
</body>
</html>
