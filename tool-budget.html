<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ph√¢n T√≠ch Ng√¢n S√°ch ‚Äî GenZTech</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    html,body{scrollbar-width:none;-ms-overflow-style:none;cursor:none;margin:0;padding:0;font-family:'Inter',sans-serif;background:#080c1e;color:#fff}
    html::-webkit-scrollbar,body::-webkit-scrollbar{display:none;width:0}
    canvas.bg-canvas{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0}
    #custom-cursor{position:fixed;width:20px;height:20px;border-radius:50%;border:2px solid rgba(0,212,255,.8);pointer-events:none;z-index:9999;transform:translate(-50%,-50%);transition:opacity .3s;opacity:0;mix-blend-mode:screen}
    .app-layout{display:flex;min-height:100vh;position:relative;z-index:1}
    .sidebar{width:240px;flex-shrink:0;background:rgba(10,14,39,.92);backdrop-filter:blur(20px);border-right:1px solid rgba(255,255,255,.06);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:40}
    .sidebar-logo{padding:18px 18px 14px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;gap:10px;text-decoration:none}
    .sidebar-logo img{width:34px;height:34px;border-radius:50%}
    .sidebar-logo span{font-size:14px;font-weight:700;letter-spacing:.5px;color:#fff}
    .sidebar-logo span em{color:#00d4ff;font-style:normal}
    .sidebar-nav{flex:1;padding:10px 0;overflow-y:auto}
    .nav-group-label{font-size:10px;font-weight:600;letter-spacing:1.2px;color:rgba(255,255,255,.3);text-transform:uppercase;padding:10px 18px 4px}
    .nav-item{display:flex;align-items:center;gap:10px;padding:9px 18px;font-size:13px;color:rgba(255,255,255,.6);text-decoration:none;transition:all .2s;border-left:2px solid transparent}
    .nav-item:hover{color:#fff;background:rgba(255,255,255,.04)}
    .nav-item.active{color:#00d4ff;background:rgba(0,212,255,.08);border-left-color:#00d4ff}
    .nav-item i{width:17px;text-align:center;font-size:14px}
    .nav-sub-item{display:flex;align-items:center;gap:10px;padding:7px 18px 7px 34px;font-size:12px;color:rgba(255,255,255,.5);text-decoration:none;transition:all .2s;border-left:2px solid transparent}
    .nav-sub-item:hover{color:#fff;background:rgba(255,255,255,.04)}
    .nav-sub-item.active{color:#22c55e;background:rgba(34,197,94,.06);border-left-color:#22c55e}
    .sidebar-footer{padding:14px 18px;border-top:1px solid rgba(255,255,255,.06)}
    .main-content{margin-left:240px;flex:1;display:flex;flex-direction:column;min-height:100vh}
    .topbar{position:sticky;top:0;z-index:30;background:rgba(10,14,39,.9);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,.06);padding:0 24px;height:58px;display:flex;align-items:center;justify-content:space-between}
    .breadcrumb{font-size:12.5px;color:rgba(255,255,255,.4);display:flex;align-items:center;gap:6px}
    .breadcrumb span{color:#fff;font-weight:600}
    .btn{padding:7px 14px;border-radius:8px;font-size:12.5px;font-weight:600;border:none;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:6px;font-family:'Inter',sans-serif}
    .btn-primary{background:#22c55e;color:#fff}.btn-primary:hover{background:#16a34a;transform:translateY(-1px)}
    .btn-blue{background:#1877f2;color:#fff}.btn-blue:hover{background:#1565d8}
    .btn-outline{background:transparent;color:rgba(255,255,255,.7);border:1px solid rgba(255,255,255,.15)}.btn-outline:hover{border-color:#22c55e;color:#22c55e}
    .btn-sm{padding:5px 12px;font-size:12px}
    .btn-icon{padding:6px 10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);color:rgba(255,255,255,.6);border-radius:8px;cursor:pointer;font-size:13px;display:inline-flex;align-items:center;gap:5px;transition:all .2s;font-family:'Inter',sans-serif}.btn-icon:hover{background:rgba(255,255,255,.1);color:#fff}
    .page-body{padding:20px 24px;flex:1}
    .card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:12px;overflow:hidden;margin-bottom:16px}
    .card-header{padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;justify-content:space-between}
    .card-title{font-size:13.5px;font-weight:700;display:flex;align-items:center;gap:8px}
    .card-body{padding:18px}
    .form-group{margin-bottom:14px}
    .form-label{font-size:11.5px;font-weight:600;color:rgba(255,255,255,.5);margin-bottom:6px;display:block;text-transform:uppercase;letter-spacing:.5px}
    .form-control{width:100%;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:9px 13px;color:#fff;font-size:13px;transition:border-color .2s;box-sizing:border-box;font-family:'Inter',sans-serif}
    .form-control:focus{outline:none;border-color:#22c55e;box-shadow:0 0 0 3px rgba(34,197,94,.08)}
    .form-control::placeholder{color:rgba(255,255,255,.25)}
    select.form-control option{background:#1a2035}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
    .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    @media(max-width:1100px){.grid-4{grid-template-columns:repeat(2,1fr)}.grid-3{grid-template-columns:1fr 1fr}}
    @media(max-width:768px){.grid-2{grid-template-columns:1fr}.sidebar{display:none}.main-content{margin-left:0}}
    /* KPI Cards */
    .kpi-card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);border-radius:12px;padding:14px 16px;text-align:center;transition:all .2s}
    .kpi-label{font-size:10.5px;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px}
    .kpi-value{font-size:22px;font-weight:800;line-height:1.1;margin-bottom:3px}
    .kpi-sub{font-size:11px;color:rgba(255,255,255,.3)}
    .kpi-card.good{border-color:rgba(34,197,94,.25);background:rgba(34,197,94,.05)}
    .kpi-card.warn{border-color:rgba(251,191,36,.25);background:rgba(251,191,36,.05)}
    .kpi-card.bad{border-color:rgba(239,68,68,.25);background:rgba(239,68,68,.05)}
    /* Slider */
    .range-wrap{position:relative;margin-top:4px}
    .range-input{-webkit-appearance:none;width:100%;height:5px;border-radius:3px;background:rgba(255,255,255,.1);outline:none}
    .range-input::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:#22c55e;cursor:pointer;box-shadow:0 0 6px rgba(34,197,94,.5)}
    .range-val{position:absolute;right:0;top:-18px;font-size:11.5px;font-weight:700;color:#4ade80}
    /* Scenario */
    .scenario-card{background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.07);border-radius:10px;padding:14px;transition:all .2s;cursor:pointer}
    .scenario-card:hover{border-color:rgba(34,197,94,.3);background:rgba(34,197,94,.04)}
    .scenario-card.selected{border-color:#22c55e;background:rgba(34,197,94,.07)}
    .scenario-name{font-size:12.5px;font-weight:700;margin-bottom:8px}
    .scenario-row{display:flex;justify-content:space-between;font-size:11.5px;color:rgba(255,255,255,.5);margin-bottom:3px}
    .scenario-row strong{color:#fff}
    /* AI Analysis */
    .ai-status-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:20px;font-size:11.5px;font-weight:600}
    .ai-status-badge.good{background:rgba(34,197,94,.15);color:#4ade80;border:1px solid rgba(34,197,94,.3)}
    .ai-status-badge.warn{background:rgba(251,191,36,.15);color:#fbbf24;border:1px solid rgba(251,191,36,.3)}
    .ai-status-badge.bad{background:rgba(239,68,68,.15);color:#f87171;border:1px solid rgba(239,68,68,.3)}
    .ai-score-ring{width:80px;height:80px;position:relative;margin:0 auto 12px}
    .ai-score-ring svg{transform:rotate(-90deg)}
    .ai-score-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:20px;font-weight:800}
    .kpi-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.05)}
    .kpi-row:last-child{border-bottom:none}
    .kpi-row-name{font-size:12.5px;font-weight:600;color:rgba(255,255,255,.7)}
    .kpi-row-val{font-size:12.5px;font-weight:700}
    .kpi-row-bench{font-size:11px;color:rgba(255,255,255,.35)}
    .kpi-row-comment{font-size:11.5px;color:rgba(255,255,255,.45);margin-top:2px}
    .status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
    .status-dot.good{background:#22c55e}
    .status-dot.warn{background:#fbbf24}
    .status-dot.bad{background:#ef4444}
    .rec-card{background:rgba(0,0,0,.2);border-radius:10px;padding:13px 15px;margin-bottom:8px;border-left:3px solid transparent}
    .rec-card.high{border-left-color:#ef4444}
    .rec-card.medium{border-left-color:#fbbf24}
    .rec-card.low{border-left-color:#22c55e}
    .rec-priority{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;margin-bottom:4px}
    .rec-title{font-size:13px;font-weight:700;margin-bottom:4px}
    .rec-desc{font-size:12px;color:rgba(255,255,255,.5);line-height:1.6}
    .rec-impact{font-size:11px;color:#4ade80;margin-top:6px;display:flex;align-items:center;gap:4px}
    /* Spinner */
    .spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.15);border-top-color:#22c55e;border-radius:50%;animation:spin .6s linear infinite;flex-shrink:0}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* Toast */
    #toast{position:fixed;bottom:24px;right:24px;z-index:9999;display:flex;flex-direction:column;gap:8px;pointer-events:none}
    .toast-item{background:rgba(15,23,42,.95);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:11px 16px;font-size:13px;display:flex;align-items:center;gap:10px;min-width:240px;animation:slideIn .3s ease;box-shadow:0 8px 24px rgba(0,0,0,.5)}
    .toast-item.success{border-left:3px solid #22c55e}
    .toast-item.error{border-left:3px solid #ef4444}
    .toast-item.info{border-left:3px solid #60a5fa}
    @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
    /* Tabs */
    .tab-bar{display:flex;gap:3px;padding:4px;background:rgba(0,0,0,.25);border-radius:10px;margin-bottom:18px}
    .tab-btn{flex:1;padding:8px 10px;border:none;border-radius:7px;background:transparent;color:rgba(255,255,255,.45);font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:5px;font-family:'Inter',sans-serif}
    .tab-btn.active{background:rgba(34,197,94,.15);color:#4ade80;box-shadow:0 0 0 1px rgba(34,197,94,.2)}
    .tab-pane{display:none}.tab-pane.active{display:block}
    .chart-container{position:relative;height:220px}
    .empty-ai{text-align:center;padding:40px 20px;color:rgba(255,255,255,.3)}
    .empty-ai i{font-size:40px;display:block;margin-bottom:12px;opacity:.4}
  </style>
</head>
<body>
<canvas class="bg-canvas" id="bgCanvas"></canvas>
<div id="custom-cursor"></div>
<div id="toast"></div>

<div class="app-layout">
  <aside class="sidebar">
    <a href="index.html" class="sidebar-logo">
      <img src="https://ui-avatars.com/api/?name=GZ&background=1877f2&color=fff&bold=true" alt="logo">
      <span>GENZ<em>TECH</em></span>
    </a>
    <nav class="sidebar-nav">
      <div class="nav-group-label">C√¥ng C·ª•</div>
      <a href="index.html" class="nav-item"><i class="bi bi-grid-1x2"></i> Dashboard</a>
      <a href="auto-post.html" class="nav-item"><i class="bi bi-send"></i> T·ª± ƒê·ªông ƒêƒÉng B√†i</a>
      <a href="ads-assistant.html" class="nav-item" onclick="toggleSubNav(event,'subNavAds')">
        <i class="bi bi-megaphone"></i> Tr·ª£ L√Ω Qu·∫£ng C√°o
        <i class="bi bi-chevron-down" id="subNavAdsArrow" style="margin-left:auto;font-size:11px;transition:transform .2s;transform:rotate(180deg)"></i>
      </a>
      <div id="subNavAds" style="display:block">
        <a href="tool-ad-account.html" class="nav-sub-item"><i class="bi bi-shield-check"></i> Ki·ªÉm Tra TKQC</a>
        <a href="tool-fb-id.html" class="nav-sub-item"><i class="bi bi-person-badge"></i> T√¨m Facebook ID</a>
        <a href="tool-budget.html" class="nav-sub-item active"><i class="bi bi-graph-up-arrow"></i> Ph√¢n T√≠ch Ng√¢n S√°ch</a>
        <a href="tool-translate.html" class="nav-sub-item"><i class="bi bi-translate"></i> D·ªãch Thu·∫≠t</a>
        <a href="tool-ads-finder.html" class="nav-sub-item"><i class="bi bi-binoculars"></i> Ads Finder</a>
        <a href="tool-policy.html" class="nav-sub-item"><i class="bi bi-journal-text"></i> Ch√≠nh S√°ch FB</a>
        <a href="tool-cookie.html" class="nav-sub-item"><i class="bi bi-cookie"></i> Qu·∫£n L√Ω Cookie</a>
      </div>
      <a href="#" class="nav-item"><i class="bi bi-gear"></i> C√†i ƒê·∫∑t</a>
    </nav>
    <div class="sidebar-footer">
      <div style="font-size:11px;color:rgba(255,255,255,.3);display:flex;align-items:center;gap:6px">
        <i class="bi bi-graph-up-arrow" style="color:#22c55e"></i> Ph√¢n T√≠ch Ng√¢n S√°ch v3.0
      </div>
    </div>
  </aside>

  <div class="main-content">
    <div class="topbar">
      <div class="breadcrumb">
        <a href="ads-assistant.html" style="color:rgba(255,255,255,.4);text-decoration:none">Tr·ª£ L√Ω QC</a>
        <i class="bi bi-chevron-right" style="font-size:10px"></i>
        <span>Ph√¢n T√≠ch Ng√¢n S√°ch</span>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-outline btn-sm" onclick="resetForm()"><i class="bi bi-arrow-counterclockwise"></i> ƒê·∫∑t l·∫°i</button>
        <button class="btn btn-outline btn-sm" onclick="exportCSV()"><i class="bi bi-download"></i> Xu·∫•t CSV</button>
      </div>
    </div>

    <div class="page-body">

      <!-- ‚îÄ‚îÄ Nh·∫≠p li·ªáu ‚îÄ‚îÄ -->
      <div class="card">
        <div class="card-header">
          <div class="card-title"><i class="bi bi-sliders" style="color:#22c55e"></i> Th√¥ng S·ªë Chi·∫øn D·ªãch</div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-primary btn-sm" onclick="calculate()"><i class="bi bi-calculator"></i> T√≠nh To√°n</button>
            <button class="btn btn-blue btn-sm" onclick="analyzeWithAI()" id="aiBtn"><i class="bi bi-stars"></i> Ph√¢n T√≠ch AI</button>
          </div>
        </div>
        <div class="card-body">
          <div class="grid-2" style="gap:20px">
            <div>
              <div class="grid-2">
                <div class="form-group">
                  <label class="form-label">Ng√†nh / Lƒ©nh v·ª±c</label>
                  <select class="form-control" id="industry">
                    <option value="ecommerce">eCommerce / TMƒêT</option>
                    <option value="education">Gi√°o d·ª•c / Kh√≥a h·ªçc</option>
                    <option value="beauty">L√†m ƒë·∫πp / Spa</option>
                    <option value="food">·∫®m th·ª±c / F&B</option>
                    <option value="realestate">B·∫•t ƒë·ªông s·∫£n</option>
                    <option value="finance">T√†i ch√≠nh / B·∫£o hi·ªÉm</option>
                    <option value="health">S·ª©c kh·ªèe / Y t·∫ø</option>
                    <option value="service">D·ªãch v·ª• kh√°c</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">M·ª•c ti√™u chi·∫øn d·ªãch</label>
                  <select class="form-control" id="objective">
                    <option value="conversions">Chuy·ªÉn ƒë·ªïi / Mua h√†ng</option>
                    <option value="messages">Tin nh·∫Øn</option>
                    <option value="leads">T·∫°o kh√°ch h√†ng ti·ªÅm nƒÉng</option>
                    <option value="traffic">L∆∞u l∆∞·ª£ng truy c·∫≠p</option>
                    <option value="awareness">Nh·∫≠n th·ª©c th∆∞∆°ng hi·ªáu</option>
                    <option value="engagement">T∆∞∆°ng t√°c</option>
                  </select>
                </div>
              </div>
              <div class="grid-2">
                <div class="form-group">
                  <label class="form-label">Ng√¢n s√°ch ng√†y (VNƒê)</label>
                  <input type="number" class="form-control" id="dailyBudget" value="500000" min="0" oninput="calculate()">
                </div>
                <div class="form-group">
                  <label class="form-label">S·ªë ng√†y ch·∫°y</label>
                  <input type="number" class="form-control" id="numDays" value="30" min="1" oninput="calculate()">
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">CPM ‚Äî Chi ph√≠ 1,000 l·∫ßn hi·ªÉn th·ªã (VNƒê) <span class="range-val" id="cpmVal">50,000</span></label>
                <div class="range-wrap">
                  <input type="range" class="range-input" id="cpmRange" min="10000" max="300000" step="5000" value="50000" oninput="syncRange('cpm')">
                </div>
                <input type="number" class="form-control" id="cpmInput" value="50000" style="margin-top:8px" oninput="syncInput('cpm')">
              </div>
              <div class="form-group">
                <label class="form-label">CTR ‚Äî T·ª∑ l·ªá nh·∫•p (%) <span class="range-val" id="ctrVal">1.5%</span></label>
                <div class="range-wrap">
                  <input type="range" class="range-input" id="ctrRange" min="0.1" max="10" step="0.1" value="1.5" oninput="syncRange('ctr')">
                </div>
              </div>
            </div>
            <div>
              <div class="form-group">
                <label class="form-label">T·ª∑ l·ªá chuy·ªÉn ƒë·ªïi (%) <span class="range-val" id="convVal">2.0%</span></label>
                <div class="range-wrap">
                  <input type="range" class="range-input" id="convRange" min="0.1" max="30" step="0.1" value="2" oninput="syncRange('conv')">
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Gi√° tr·ªã ƒë∆°n h√†ng trung b√¨nh - AOV (VNƒê)</label>
                <input type="number" class="form-control" id="aov" value="350000" min="0" oninput="calculate()">
              </div>
              <div class="form-group">
                <label class="form-label">Chi ph√≠ s·∫£n xu·∫•t / COGS (VNƒê, ƒë·ªÉ t√≠nh l·ª£i nhu·∫≠n)</label>
                <input type="number" class="form-control" id="cogs" value="0" min="0" placeholder="0 = b·ªè qua" oninput="calculate()">
              </div>
              <div class="form-group">
                <label class="form-label">T·∫ßn su·∫•t hi·ªÉn th·ªã (Frequency)</label>
                <input type="number" class="form-control" id="frequency" value="1.5" min="1" step="0.1" oninput="calculate()">
              </div>
              <div class="form-group">
                <label class="form-label">Ghi ch√∫ / M√¥ t·∫£ chi·∫øn d·ªãch (cho AI)</label>
                <input type="text" class="form-control" id="campaignNote" placeholder="VD: Chi·∫øn d·ªãch b√°n √°o h√®, target 25-35 tu·ªïi, H√† N·ªôi...">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ KPI Cards ‚îÄ‚îÄ -->
      <div class="grid-4" id="kpiCards" style="margin-bottom:16px">
        <div class="kpi-card" id="kpiImpressions">
          <div class="kpi-label">L∆∞·ª£t hi·ªÉn th·ªã</div>
          <div class="kpi-value" style="color:#60a5fa">‚Äî</div>
          <div class="kpi-sub">Impressions</div>
        </div>
        <div class="kpi-card" id="kpiClicks">
          <div class="kpi-label">L∆∞·ª£t nh·∫•p</div>
          <div class="kpi-value" style="color:#a78bfa">‚Äî</div>
          <div class="kpi-sub">Clicks</div>
        </div>
        <div class="kpi-card" id="kpiConversions">
          <div class="kpi-label">Chuy·ªÉn ƒë·ªïi</div>
          <div class="kpi-value" style="color:#4ade80">‚Äî</div>
          <div class="kpi-sub">Conversions</div>
        </div>
        <div class="kpi-card" id="kpiROAS">
          <div class="kpi-label">ROAS</div>
          <div class="kpi-value" style="color:#fbbf24">‚Äî</div>
          <div class="kpi-sub">Return on Ad Spend</div>
        </div>
        <div class="kpi-card" id="kpiCPC">
          <div class="kpi-label">CPC</div>
          <div class="kpi-value" style="color:#f87171">‚Äî</div>
          <div class="kpi-sub">Chi ph√≠ / nh·∫•p</div>
        </div>
        <div class="kpi-card" id="kpiCPA">
          <div class="kpi-label">CPA</div>
          <div class="kpi-value" style="color:#fb923c">‚Äî</div>
          <div class="kpi-sub">Chi ph√≠ / chuy·ªÉn ƒë·ªïi</div>
        </div>
        <div class="kpi-card" id="kpiRevenue">
          <div class="kpi-label">Doanh thu d·ª± ki·∫øn</div>
          <div class="kpi-value" style="color:#34d399">‚Äî</div>
          <div class="kpi-sub">T·ªïng doanh thu</div>
        </div>
        <div class="kpi-card" id="kpiProfit">
          <div class="kpi-label">L·ª£i nhu·∫≠n</div>
          <div class="kpi-value" style="color:#22c55e">‚Äî</div>
          <div class="kpi-sub">Sau chi ph√≠ QC</div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ Tabs: Bi·ªÉu ƒë·ªì + AI + K·ªãch b·∫£n ‚îÄ‚îÄ -->
      <div class="tab-bar">
        <button class="tab-btn active" id="tabCharts" onclick="switchTab('charts')"><i class="bi bi-bar-chart"></i> Bi·ªÉu ƒê·ªì</button>
        <button class="tab-btn" id="tabAI" onclick="switchTab('ai')"><i class="bi bi-stars"></i> Ph√¢n T√≠ch AI</button>
        <button class="tab-btn" id="tabScenario" onclick="switchTab('scenario')"><i class="bi bi-layers"></i> K·ªãch B·∫£n</button>
      </div>

      <!-- ‚îÄ‚îÄ Tab: Bi·ªÉu ƒë·ªì ‚îÄ‚îÄ -->
      <div id="paneCharts" class="tab-pane active">
        <div class="grid-2">
          <!-- Bi·ªÉu ƒë·ªì 1: Ph√¢n b·ªï ng√¢n s√°ch theo k·ªãch b·∫£n -->
          <div class="card">
            <div class="card-header">
              <div class="card-title"><i class="bi bi-bar-chart-fill" style="color:#60a5fa"></i> So S√°nh K·ªãch B·∫£n Ng√¢n S√°ch</div>
            </div>
            <div class="card-body"><div class="chart-container"><canvas id="chartScenario"></canvas></div></div>
          </div>
          <!-- Bi·ªÉu ƒë·ªì 2: Funnel chuy·ªÉn ƒë·ªïi -->
          <div class="card">
            <div class="card-header">
              <div class="card-title"><i class="bi bi-funnel-fill" style="color:#a78bfa"></i> Ph·ªÖu Chuy·ªÉn ƒê·ªïi</div>
            </div>
            <div class="card-body"><div class="chart-container"><canvas id="chartFunnel"></canvas></div></div>
          </div>
          <!-- Bi·ªÉu ƒë·ªì 3: ROAS theo ng√¢n s√°ch -->
          <div class="card">
            <div class="card-header">
              <div class="card-title"><i class="bi bi-graph-up" style="color:#4ade80"></i> ROAS Theo M·ª©c Ng√¢n S√°ch</div>
            </div>
            <div class="card-body"><div class="chart-container"><canvas id="chartROAS"></canvas></div></div>
          </div>
          <!-- Bi·ªÉu ƒë·ªì 4: Chi ph√≠ breakdown -->
          <div class="card">
            <div class="card-header">
              <div class="card-title"><i class="bi bi-pie-chart-fill" style="color:#fbbf24"></i> Ph√¢n T√≠ch Chi Ph√≠</div>
            </div>
            <div class="card-body"><div class="chart-container"><canvas id="chartCost"></canvas></div></div>
          </div>
        </div>
        <!-- Bi·ªÉu ƒë·ªì 5: D·ª± b√°o doanh thu theo ng√†y -->
        <div class="card">
          <div class="card-header">
            <div class="card-title"><i class="bi bi-calendar-range" style="color:#34d399"></i> D·ª± B√°o T√≠ch L≈©y Theo Ng√†y</div>
          </div>
          <div class="card-body"><div class="chart-container" style="height:200px"><canvas id="chartTrend"></canvas></div></div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ Tab: AI ‚îÄ‚îÄ -->
      <div id="paneAI" class="tab-pane">
        <div id="aiEmpty">
          <div class="card">
            <div class="card-body">
              <div class="empty-ai">
                <i class="bi bi-stars"></i>
                <div style="font-size:14px;font-weight:600;color:rgba(255,255,255,.5);margin-bottom:8px">Ch∆∞a c√≥ ph√¢n t√≠ch AI</div>
                <div style="font-size:12.5px;color:rgba(255,255,255,.3);margin-bottom:16px">Nh·∫≠p th√¥ng s·ªë chi·∫øn d·ªãch v√† nh·∫•n <strong style="color:#22c55e">Ph√¢n T√≠ch AI</strong> ƒë·ªÉ nh·∫≠n nh·∫≠n x√©t chuy√™n s√¢u</div>
                <button class="btn btn-blue" onclick="analyzeWithAI()"><i class="bi bi-stars"></i> Ph√¢n T√≠ch AI Ngay</button>
              </div>
            </div>
          </div>
        </div>

        <div id="aiLoading" style="display:none">
          <div class="card">
            <div class="card-body" style="display:flex;align-items:center;gap:14px;padding:28px;color:rgba(255,255,255,.5)">
              <span class="spinner" style="width:20px;height:20px;border-top-color:#60a5fa"></span>
              <div>
                <div style="font-size:13.5px;font-weight:600;color:#fff">AI ƒëang ph√¢n t√≠ch chi·∫øn d·ªãch...</div>
                <div style="font-size:12px;margin-top:3px">ƒêang √°p d·ª•ng benchmark Facebook Ads Vi·ªát Nam v√† ƒë·ªÅ xu·∫•t c·∫£i thi·ªán</div>
              </div>
            </div>
          </div>
        </div>

        <div id="aiResult" style="display:none">
          <!-- Overview -->
          <div class="card">
            <div class="card-header">
              <div class="card-title"><i class="bi bi-stars" style="color:#fbbf24"></i> T·ªïng Quan Chi·∫øn D·ªãch</div>
              <div id="aiStatusBadge"></div>
            </div>
            <div class="card-body">
              <div class="grid-2" style="align-items:center">
                <div>
                  <div class="ai-score-ring" id="aiScoreRing">
                    <svg width="80" height="80" viewBox="0 0 80 80">
                      <circle cx="40" cy="40" r="34" fill="none" stroke="rgba(255,255,255,.08)" stroke-width="8"/>
                      <circle id="aiScoreCircle" cx="40" cy="40" r="34" fill="none" stroke="#22c55e" stroke-width="8" stroke-dasharray="213.6" stroke-dashoffset="213.6" stroke-linecap="round"/>
                    </svg>
                    <div class="ai-score-text" id="aiScoreNum" style="color:#22c55e">‚Äî</div>
                  </div>
                  <div style="text-align:center;font-size:11px;color:rgba(255,255,255,.35)">ƒêi·ªÉm t·ªïng th·ªÉ</div>
                </div>
                <div>
                  <div style="font-size:13.5px;line-height:1.7;color:rgba(255,255,255,.75)" id="aiSummary">‚Äî</div>
                </div>
              </div>
            </div>
          </div>

          <!-- KPI Analysis -->
          <div class="card">
            <div class="card-header">
              <div class="card-title"><i class="bi bi-activity" style="color:#60a5fa"></i> Ph√¢n T√≠ch Ch·ªâ S·ªë KPI</div>
            </div>
            <div class="card-body" id="aiKPIBody"></div>
          </div>

          <!-- Strengths & Weaknesses -->
          <div class="grid-2">
            <div class="card">
              <div class="card-header">
                <div class="card-title"><i class="bi bi-hand-thumbs-up-fill" style="color:#4ade80"></i> ƒêi·ªÉm M·∫°nh</div>
              </div>
              <div class="card-body" id="aiStrengths"></div>
            </div>
            <div class="card">
              <div class="card-header">
                <div class="card-title"><i class="bi bi-exclamation-triangle-fill" style="color:#f87171"></i> ƒêi·ªÉm Y·∫øu</div>
              </div>
              <div class="card-body" id="aiWeaknesses"></div>
            </div>
          </div>

          <!-- Recommendations -->
          <div class="card">
            <div class="card-header">
              <div class="card-title"><i class="bi bi-lightbulb-fill" style="color:#fbbf24"></i> ƒê·ªÅ Xu·∫•t C·∫£i Thi·ªán</div>
            </div>
            <div class="card-body" id="aiRecommendations"></div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ Tab: K·ªãch b·∫£n ‚îÄ‚îÄ -->
      <div id="paneScenario" class="tab-pane">
        <div class="card">
          <div class="card-header">
            <div class="card-title"><i class="bi bi-layers" style="color:#a78bfa"></i> So S√°nh K·ªãch B·∫£n Ng√¢n S√°ch</div>
            <button class="btn btn-outline btn-sm" onclick="exportCSV()"><i class="bi bi-download"></i> Xu·∫•t CSV</button>
          </div>
          <div class="card-body">
            <div class="grid-3" id="scenarioCards" style="gap:12px"></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
const API_BASE = 'https://genztech-production.up.railway.app';
let charts = {};
let lastMetrics = null;

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
const vnd = n => new Intl.NumberFormat('vi-VN').format(Math.round(n)) + ' VNƒê';
const num = n => new Intl.NumberFormat('vi-VN').format(Math.round(n));
const pct = n => n.toFixed(1) + '%';
const x = n => n.toFixed(2) + 'x';

function toast(msg, type='info') {
  const el = document.createElement('div');
  el.className = `toast-item ${type}`;
  const icons = {success:'check-circle-fill', error:'x-circle-fill', info:'info-circle-fill'};
  el.innerHTML = `<i class="bi bi-${icons[type]||'info-circle-fill'}" style="color:${type==='success'?'#4ade80':type==='error'?'#f87171':'#60a5fa'}"></i> ${msg}`;
  document.getElementById('toast').appendChild(el);
  setTimeout(() => el.remove(), 4000);
}

function syncRange(type) {
  if (type === 'cpm') {
    const v = document.getElementById('cpmRange').value;
    document.getElementById('cpmVal').textContent = new Intl.NumberFormat('vi-VN').format(v);
    document.getElementById('cpmInput').value = v;
  } else if (type === 'ctr') {
    const v = document.getElementById('ctrRange').value;
    document.getElementById('ctrVal').textContent = v + '%';
  } else if (type === 'conv') {
    const v = document.getElementById('convRange').value;
    document.getElementById('convVal').textContent = v + '%';
  }
  calculate();
}

function syncInput(type) {
  if (type === 'cpm') {
    const v = document.getElementById('cpmInput').value;
    document.getElementById('cpmRange').value = v;
    document.getElementById('cpmVal').textContent = new Intl.NumberFormat('vi-VN').format(v);
  }
  calculate();
}

// ‚îÄ‚îÄ T√≠nh to√°n ch√≠nh ‚îÄ‚îÄ
function calculate() {
  const daily = parseFloat(document.getElementById('dailyBudget').value) || 0;
  const days = parseInt(document.getElementById('numDays').value) || 30;
  const cpm = parseFloat(document.getElementById('cpmInput').value) || 50000;
  const ctr = parseFloat(document.getElementById('ctrRange').value) / 100;
  const cvr = parseFloat(document.getElementById('convRange').value) / 100;
  const aov = parseFloat(document.getElementById('aov').value) || 0;
  const cogs = parseFloat(document.getElementById('cogs').value) || 0;
  const freq = parseFloat(document.getElementById('frequency').value) || 1.5;

  const totalBudget = daily * days;
  const impressions = (totalBudget / cpm) * 1000;
  const clicks = impressions * ctr;
  const conversions = clicks * cvr;
  const cpc = clicks > 0 ? totalBudget / clicks : 0;
  const cpa = conversions > 0 ? totalBudget / conversions : 0;
  const revenue = conversions * aov;
  const roas = totalBudget > 0 ? revenue / totalBudget : 0;
  const profit = revenue - totalBudget - (cogs * conversions);
  const reach = impressions / freq;

  lastMetrics = { daily, days, totalBudget, cpm, ctr: ctr*100, cvr: cvr*100, aov, cogs, freq, impressions, clicks, conversions, cpc, cpa, revenue, roas, profit, reach };

  // Update KPI cards
  setKPI('kpiImpressions', num(impressions), 'Impressions', '#60a5fa', null);
  setKPI('kpiClicks', num(clicks), 'Clicks', '#a78bfa', null);
  setKPI('kpiConversions', num(conversions), 'Conversions', '#4ade80', null);
  setKPI('kpiROAS', x(roas), 'Return on Ad Spend', '#fbbf24', roas >= 3 ? 'good' : roas >= 1.5 ? 'warn' : 'bad');
  setKPI('kpiCPC', vnd(cpc), 'Chi ph√≠ / nh·∫•p', '#f87171', cpc < 4000 ? 'good' : cpc < 8000 ? 'warn' : 'bad');
  setKPI('kpiCPA', vnd(cpa), 'Chi ph√≠ / chuy·ªÉn ƒë·ªïi', '#fb923c', null);
  setKPI('kpiRevenue', vnd(revenue), 'T·ªïng doanh thu', '#34d399', null);
  setKPI('kpiProfit', vnd(profit), profit >= 0 ? 'C√≥ l√£i' : 'L·ªó', profit >= 0 ? '#22c55e' : '#ef4444', profit >= 0 ? 'good' : 'bad');

  renderCharts(daily, days, impressions, clicks, conversions, revenue, totalBudget, cpm, ctr, cvr, aov, cpa, cpc, roas);
  renderScenarios(daily, days, cpm, ctr, cvr, aov, cogs);
}

function setKPI(id, value, sub, color, status) {
  const el = document.getElementById(id);
  el.querySelector('.kpi-value').textContent = value;
  el.querySelector('.kpi-value').style.color = color;
  el.querySelector('.kpi-sub').textContent = sub;
  el.className = 'kpi-card' + (status ? ' ' + status : '');
}

// ‚îÄ‚îÄ Bi·ªÉu ƒë·ªì ‚îÄ‚îÄ
function destroyChart(id) {
  if (charts[id]) { charts[id].destroy(); delete charts[id]; }
}

const chartDefaults = {
  plugins: { legend: { labels: { color: 'rgba(255,255,255,.6)', font: { size: 11 } } } },
  scales: {
    x: { ticks: { color: 'rgba(255,255,255,.4)', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,.05)' } },
    y: { ticks: { color: 'rgba(255,255,255,.4)', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,.05)' } }
  }
};

function renderCharts(daily, days, impressions, clicks, conversions, revenue, totalBudget, cpm, ctr, cvr, aov, cpa, cpc, roas) {
  // 1. Bar: So s√°nh k·ªãch b·∫£n
  destroyChart('chartScenario');
  const scenarios = [0.5, 1, 1.5, 2, 3];
  const scenarioLabels = ['50%', '100%\n(Hi·ªán t·∫°i)', '150%', '200%', '300%'];
  charts.chartScenario = new Chart(document.getElementById('chartScenario'), {
    type: 'bar',
    data: {
      labels: scenarioLabels,
      datasets: [
        { label: 'Chi ph√≠ (tri·ªáu VNƒê)', data: scenarios.map(s => +(daily * s * days / 1e6).toFixed(2)), backgroundColor: 'rgba(96,165,250,.7)', borderRadius: 6 },
        { label: 'Doanh thu (tri·ªáu VNƒê)', data: scenarios.map(s => +((daily * s * days / cpm * 1000) * ctr * cvr * aov / 1e6).toFixed(2)), backgroundColor: 'rgba(34,197,94,.7)', borderRadius: 6 }
      ]
    },
    options: { ...chartDefaults, responsive: true, maintainAspectRatio: false }
  });

  // 2. Horizontal bar: Funnel
  destroyChart('chartFunnel');
  charts.chartFunnel = new Chart(document.getElementById('chartFunnel'), {
    type: 'bar',
    data: {
      labels: ['Hi·ªÉn th·ªã', 'Nh·∫•p', 'Chuy·ªÉn ƒë·ªïi'],
      datasets: [{
        label: 'S·ªë l∆∞·ª£ng',
        data: [impressions, clicks, conversions],
        backgroundColor: ['rgba(96,165,250,.7)', 'rgba(167,139,250,.7)', 'rgba(74,222,128,.7)'],
        borderRadius: 6
      }]
    },
    options: {
      ...chartDefaults,
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: { ...chartDefaults.plugins, legend: { display: false } }
    }
  });

  // 3. Line: ROAS theo ng√¢n s√°ch
  destroyChart('chartROAS');
  const budgetRange = [100000, 200000, 300000, 500000, 700000, 1000000, 1500000, 2000000];
  charts.chartROAS = new Chart(document.getElementById('chartROAS'), {
    type: 'line',
    data: {
      labels: budgetRange.map(b => (b/1000).toFixed(0) + 'K'),
      datasets: [{
        label: 'ROAS (x)',
        data: budgetRange.map(b => {
          const imp = (b / cpm) * 1000;
          const rev = imp * ctr * cvr * aov;
          return +(rev / b).toFixed(2);
        }),
        borderColor: '#4ade80',
        backgroundColor: 'rgba(74,222,128,.1)',
        fill: true,
        tension: 0.4,
        pointBackgroundColor: '#4ade80',
        pointRadius: 4
      }, {
        label: 'H√≤a v·ªën (1x)',
        data: budgetRange.map(() => 1),
        borderColor: 'rgba(239,68,68,.5)',
        borderDash: [5, 5],
        pointRadius: 0
      }]
    },
    options: { ...chartDefaults, responsive: true, maintainAspectRatio: false }
  });

  // 4. Doughnut: Chi ph√≠ breakdown
  destroyChart('chartCost');
  const adSpend = totalBudget;
  const cogsTotal = (parseFloat(document.getElementById('cogs').value) || 0) * conversions;
  const profitVal = Math.max(0, revenue - adSpend - cogsTotal);
  charts.chartCost = new Chart(document.getElementById('chartCost'), {
    type: 'doughnut',
    data: {
      labels: ['Chi ph√≠ QC', 'COGS', 'L·ª£i nhu·∫≠n'],
      datasets: [{
        data: [adSpend / 1e6, cogsTotal / 1e6, profitVal / 1e6].map(v => +v.toFixed(2)),
        backgroundColor: ['rgba(248,113,113,.8)', 'rgba(251,191,36,.8)', 'rgba(34,197,94,.8)'],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { position: 'bottom', labels: { color: 'rgba(255,255,255,.6)', font: { size: 11 }, padding: 12 } } }
    }
  });

  // 5. Line: D·ª± b√°o t√≠ch l≈©y theo ng√†y
  destroyChart('chartTrend');
  const trendDays = Math.min(days, 30);
  const dayLabels = Array.from({ length: trendDays }, (_, i) => `Ng√†y ${i + 1}`);
  charts.chartTrend = new Chart(document.getElementById('chartTrend'), {
    type: 'line',
    data: {
      labels: dayLabels,
      datasets: [
        {
          label: 'Chi ph√≠ t√≠ch l≈©y (tri·ªáu VNƒê)',
          data: dayLabels.map((_, i) => +((i + 1) * daily / 1e6).toFixed(2)),
          borderColor: '#f87171',
          backgroundColor: 'rgba(248,113,113,.08)',
          fill: true, tension: 0.3, pointRadius: 0
        },
        {
          label: 'Doanh thu t√≠ch l≈©y (tri·ªáu VNƒê)',
          data: dayLabels.map((_, i) => {
            const spend = (i + 1) * daily;
            const imp = (spend / cpm) * 1000;
            return +(imp * ctr * cvr * aov / 1e6).toFixed(2);
          }),
          borderColor: '#4ade80',
          backgroundColor: 'rgba(34,197,94,.08)',
          fill: true, tension: 0.3, pointRadius: 0
        }
      ]
    },
    options: { ...chartDefaults, responsive: true, maintainAspectRatio: false }
  });
}

// ‚îÄ‚îÄ K·ªãch b·∫£n ‚îÄ‚îÄ
function renderScenarios(daily, days, cpm, ctr, cvr, aov, cogs) {
  const scenarios = [
    { name: '‚¨á Gi·∫£m 50%', mult: 0.5, color: '#60a5fa' },
    { name: '‚úÖ Hi·ªán t·∫°i', mult: 1, color: '#4ade80', selected: true },
    { name: '‚¨Ü TƒÉng 50%', mult: 1.5, color: '#fbbf24' },
    { name: '‚¨Ü TƒÉng 2x', mult: 2, color: '#fb923c' },
    { name: 'üöÄ TƒÉng 3x', mult: 3, color: '#f87171' }
  ];

  document.getElementById('scenarioCards').innerHTML = scenarios.map(s => {
    const budget = daily * s.mult;
    const total = budget * days;
    const imp = (total / cpm) * 1000;
    const clicks = imp * ctr;
    const conv = clicks * cvr;
    const rev = conv * aov;
    const roas = total > 0 ? rev / total : 0;
    const profit = rev - total - cogs * conv;
    return `
      <div class="scenario-card ${s.selected ? 'selected' : ''}">
        <div class="scenario-name" style="color:${s.color}">${s.name}</div>
        <div class="scenario-row"><span>Ng√¢n s√°ch/ng√†y</span><strong>${vnd(budget)}</strong></div>
        <div class="scenario-row"><span>T·ªïng ng√¢n s√°ch</span><strong>${vnd(total)}</strong></div>
        <div class="scenario-row"><span>Hi·ªÉn th·ªã</span><strong>${num(imp)}</strong></div>
        <div class="scenario-row"><span>Chuy·ªÉn ƒë·ªïi</span><strong>${num(conv)}</strong></div>
        <div class="scenario-row"><span>Doanh thu</span><strong style="color:${s.color}">${vnd(rev)}</strong></div>
        <div class="scenario-row"><span>ROAS</span><strong style="color:${roas>=3?'#4ade80':roas>=1.5?'#fbbf24':'#f87171'}">${x(roas)}</strong></div>
        <div class="scenario-row"><span>L·ª£i nhu·∫≠n</span><strong style="color:${profit>=0?'#4ade80':'#f87171'}">${vnd(profit)}</strong></div>
      </div>`;
  }).join('');
}

// ‚îÄ‚îÄ Ph√¢n t√≠ch AI ‚îÄ‚îÄ
async function analyzeWithAI() {
  if (!lastMetrics) { toast('Vui l√≤ng t√≠nh to√°n tr∆∞·ªõc', 'error'); return; }

  const btn = document.getElementById('aiBtn');
  btn.innerHTML = '<span class="spinner"></span> ƒêang ph√¢n t√≠ch...';
  btn.disabled = true;

  switchTab('ai');
  document.getElementById('aiEmpty').style.display = 'none';
  document.getElementById('aiResult').style.display = 'none';
  document.getElementById('aiLoading').style.display = 'block';

  const industry = document.getElementById('industry').options[document.getElementById('industry').selectedIndex].text;
  const objective = document.getElementById('objective').options[document.getElementById('objective').selectedIndex].text;
  const note = document.getElementById('campaignNote').value;

  const metrics = {
    ngay_chay: lastMetrics.days,
    ngan_sach_ngay: lastMetrics.daily,
    tong_ngan_sach: lastMetrics.totalBudget,
    CPM: lastMetrics.cpm,
    CTR: lastMetrics.ctr,
    ty_le_chuyen_doi: lastMetrics.cvr,
    gia_tri_don_hang_trung_binh_AOV: lastMetrics.aov,
    tan_suat_frequency: lastMetrics.freq,
    luot_hien_thi_du_kien: Math.round(lastMetrics.impressions),
    luot_nhap_du_kien: Math.round(lastMetrics.clicks),
    chuyen_doi_du_kien: Math.round(lastMetrics.conversions),
    CPC: Math.round(lastMetrics.cpc),
    CPA: Math.round(lastMetrics.cpa),
    doanh_thu_du_kien: Math.round(lastMetrics.revenue),
    ROAS: +lastMetrics.roas.toFixed(2),
    loi_nhuan_du_kien: Math.round(lastMetrics.profit),
    ghi_chu: note || 'Kh√¥ng c√≥'
  };

  try {
    const r = await fetch(`${API_BASE}/api/ai/analyze-budget`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ metrics, industry, objective, currency: 'VNƒê' })
    });
    const d = await r.json();
    if (!r.ok) throw new Error(d.error || 'L·ªói server');

    renderAIResult(d.analysis);
    toast('Ph√¢n t√≠ch AI ho√†n th√†nh!', 'success');
  } catch (e) {
    document.getElementById('aiEmpty').style.display = 'block';
    toast('L·ªói AI: ' + e.message, 'error');
  } finally {
    document.getElementById('aiLoading').style.display = 'none';
    btn.innerHTML = '<i class="bi bi-stars"></i> Ph√¢n T√≠ch AI';
    btn.disabled = false;
  }
}

function renderAIResult(a) {
  if (!a || !a.overview) { toast('D·ªØ li·ªáu AI kh√¥ng h·ª£p l·ªá', 'error'); return; }

  // Overview
  const statusMap = { 'T·ªët': 'good', 'Trung b√¨nh': 'warn', 'Y·∫øu k√©m': 'bad' };
  const statusColor = { 'T·ªët': '#4ade80', 'Trung b√¨nh': '#fbbf24', 'Y·∫øu k√©m': '#f87171' };
  const s = a.overview.status;
  document.getElementById('aiStatusBadge').innerHTML = `<span class="ai-status-badge ${statusMap[s]||'warn'}"><i class="bi bi-circle-fill" style="font-size:8px"></i> ${s}</span>`;
  document.getElementById('aiSummary').textContent = a.overview.summary || '‚Äî';

  // Score ring
  const score = Math.min(100, Math.max(0, a.overview.score || 50));
  document.getElementById('aiScoreNum').textContent = score;
  const color = score >= 70 ? '#22c55e' : score >= 40 ? '#fbbf24' : '#ef4444';
  document.getElementById('aiScoreNum').style.color = color;
  document.getElementById('aiScoreCircle').style.stroke = color;
  const circumference = 213.6;
  document.getElementById('aiScoreCircle').style.strokeDashoffset = circumference - (score / 100) * circumference;

  // KPI Analysis
  const kpiStatusColor = { 'T·ªët': '#4ade80', 'Trung b√¨nh': '#fbbf24', 'C·∫ßn c·∫£i thi·ªán': '#f87171' };
  const kpiStatusClass = { 'T·ªët': 'good', 'Trung b√¨nh': 'warn', 'C·∫ßn c·∫£i thi·ªán': 'bad' };
  document.getElementById('aiKPIBody').innerHTML = (a.kpi_analysis || []).map(k => `
    <div class="kpi-row">
      <div style="flex:1">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:3px">
          <span class="status-dot ${kpiStatusClass[k.status]||'warn'}"></span>
          <span class="kpi-row-name">${k.kpi}</span>
          <span class="kpi-row-val" style="color:${kpiStatusColor[k.status]||'#fbbf24'}">${k.value}</span>
        </div>
        <div class="kpi-row-bench">Benchmark: ${k.benchmark || '‚Äî'}</div>
        <div class="kpi-row-comment">${k.comment || ''}</div>
      </div>
    </div>`).join('');

  // Strengths
  document.getElementById('aiStrengths').innerHTML = (a.strengths || []).map(s => `
    <div style="display:flex;align-items:flex-start;gap:8px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.05)">
      <i class="bi bi-check-circle-fill" style="color:#4ade80;margin-top:1px;flex-shrink:0"></i>
      <span style="font-size:12.5px;color:rgba(255,255,255,.7)">${s}</span>
    </div>`).join('') || '<div style="color:rgba(255,255,255,.3);font-size:12.5px">Kh√¥ng c√≥ ƒëi·ªÉm m·∫°nh n·ªïi b·∫≠t</div>';

  // Weaknesses
  document.getElementById('aiWeaknesses').innerHTML = (a.weaknesses || []).map(w => `
    <div style="display:flex;align-items:flex-start;gap:8px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.05)">
      <i class="bi bi-x-circle-fill" style="color:#f87171;margin-top:1px;flex-shrink:0"></i>
      <span style="font-size:12.5px;color:rgba(255,255,255,.7)">${w}</span>
    </div>`).join('') || '<div style="color:rgba(255,255,255,.3);font-size:12.5px">Kh√¥ng c√≥ ƒëi·ªÉm y·∫øu ƒë√°ng k·ªÉ</div>';

  // Recommendations
  const recPriorityMap = { 'Cao': 'high', 'Trung b√¨nh': 'medium', 'Th·∫•p': 'low' };
  const recPriorityColor = { 'Cao': '#f87171', 'Trung b√¨nh': '#fbbf24', 'Th·∫•p': '#4ade80' };
  document.getElementById('aiRecommendations').innerHTML = (a.recommendations || []).map(r => `
    <div class="rec-card ${recPriorityMap[r.priority]||'medium'}">
      <div class="rec-priority" style="color:${recPriorityColor[r.priority]||'#fbbf24'}">
        <i class="bi bi-flag-fill"></i> ∆Øu ti√™n ${r.priority}
      </div>
      <div class="rec-title">${r.title}</div>
      <div class="rec-desc">${r.description}</div>
      ${r.expected_impact ? `<div class="rec-impact"><i class="bi bi-arrow-up-right"></i> ${r.expected_impact}</div>` : ''}
    </div>`).join('');

  document.getElementById('aiResult').style.display = 'block';
}

// ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ
function switchTab(tab) {
  ['charts','ai','scenario'].forEach(t => {
    const cap = t.charAt(0).toUpperCase() + t.slice(1);
    document.getElementById('pane' + cap).classList.toggle('active', t === tab);
    document.getElementById('tab' + cap).classList.toggle('active', t === tab);
  });
}

// ‚îÄ‚îÄ Reset & Export ‚îÄ‚îÄ
function resetForm() {
  document.getElementById('dailyBudget').value = 500000;
  document.getElementById('numDays').value = 30;
  document.getElementById('cpmInput').value = 50000;
  document.getElementById('cpmRange').value = 50000;
  document.getElementById('cpmVal').textContent = '50,000';
  document.getElementById('ctrRange').value = 1.5;
  document.getElementById('ctrVal').textContent = '1.5%';
  document.getElementById('convRange').value = 2;
  document.getElementById('convVal').textContent = '2.0%';
  document.getElementById('aov').value = 350000;
  document.getElementById('cogs').value = 0;
  document.getElementById('frequency').value = 1.5;
  document.getElementById('campaignNote').value = '';
  calculate();
  toast('ƒê√£ ƒë·∫∑t l·∫°i th√¥ng s·ªë', 'info');
}

function exportCSV() {
  if (!lastMetrics) { toast('Ch∆∞a c√≥ d·ªØ li·ªáu', 'error'); return; }
  const m = lastMetrics;
  const rows = [
    ['Ch·ªâ s·ªë', 'Gi√° tr·ªã'],
    ['Ng√¢n s√°ch ng√†y', m.daily],
    ['S·ªë ng√†y', m.days],
    ['T·ªïng ng√¢n s√°ch', m.totalBudget],
    ['CPM', m.cpm],
    ['CTR (%)', m.ctr],
    ['T·ª∑ l·ªá chuy·ªÉn ƒë·ªïi (%)', m.cvr],
    ['AOV', m.aov],
    ['L∆∞·ª£t hi·ªÉn th·ªã', Math.round(m.impressions)],
    ['L∆∞·ª£t nh·∫•p', Math.round(m.clicks)],
    ['Chuy·ªÉn ƒë·ªïi', Math.round(m.conversions)],
    ['CPC', Math.round(m.cpc)],
    ['CPA', Math.round(m.cpa)],
    ['Doanh thu', Math.round(m.revenue)],
    ['ROAS', m.roas.toFixed(2)],
    ['L·ª£i nhu·∫≠n', Math.round(m.profit)]
  ];
  const csv = rows.map(r => r.join(',')).join('\n');
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `budget_analysis_${Date.now()}.csv`;
  a.click();
  toast('ƒê√£ xu·∫•t CSV!', 'success');
}

function toggleSubNav(e, id) {
  e.preventDefault();
  const el = document.getElementById(id);
  const arrow = document.getElementById(id + 'Arrow');
  const isOpen = el.style.display !== 'none';
  el.style.display = isOpen ? 'none' : 'block';
  if (arrow) arrow.style.transform = isOpen ? '' : 'rotate(180deg)';
}

document.addEventListener('DOMContentLoaded', calculate);
</script>

<!-- Background + cursor -->
<script>
(function(){
  const c = document.getElementById('bgCanvas');
  if (!c) return;
  const ctx = c.getContext('2d');
  function resize() { c.width = window.innerWidth; c.height = window.innerHeight; }
  resize(); window.addEventListener('resize', resize);
  const stars = Array.from({length:150}, () => ({
    x: Math.random()*c.width, y: Math.random()*c.height,
    r: Math.random()*1.5+0.3, o: Math.random()*0.5+0.1,
    vx: (Math.random()-0.5)*0.1, vy: (Math.random()-0.5)*0.1, p: Math.random()*Math.PI*2
  }));
  function draw() {
    ctx.clearRect(0,0,c.width,c.height);
    stars.forEach(s => {
      s.x+=s.vx; s.y+=s.vy; s.p+=0.015;
      if(s.x<0)s.x=c.width; if(s.x>c.width)s.x=0;
      if(s.y<0)s.y=c.height; if(s.y>c.height)s.y=0;
      const o=s.o*(0.7+Math.sin(s.p)*0.3);
      const g=ctx.createRadialGradient(s.x,s.y,0,s.x,s.y,s.r*2.5);
      g.addColorStop(0,`rgba(34,197,94,${o})`); g.addColorStop(1,'rgba(34,197,94,0)');
      ctx.fillStyle=g; ctx.beginPath(); ctx.arc(s.x,s.y,s.r*2.5,0,Math.PI*2); ctx.fill();
    });
    requestAnimationFrame(draw);
  }
  draw();
})();
(function(){
  const cur=document.getElementById('custom-cursor');
  if(!cur||'ontouchstart' in window) return;
  let shown=false;
  document.addEventListener('mousemove',e=>{
    cur.style.left=e.clientX+'px'; cur.style.top=e.clientY+'px';
    if(!shown){cur.style.opacity='1';shown=true;}
  });
  document.addEventListener('mouseleave',()=>{cur.style.opacity='0';shown=false;});
})();
</script>
</body>
</html>
