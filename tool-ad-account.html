<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ki·ªÉm Tra TKQC ‚Äî GenZTech</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <style>
    html,body{scrollbar-width:none;-ms-overflow-style:none;cursor:none;-webkit-user-select:none;user-select:none;margin:0;padding:0;font-family:'Inter',sans-serif;background:#080c1e;color:#fff}
    html::-webkit-scrollbar,body::-webkit-scrollbar{display:none;width:0}
    canvas.bg-canvas{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0}
    #custom-cursor{position:fixed;width:20px;height:20px;border-radius:50%;border:2px solid rgba(0,212,255,.8);pointer-events:none;z-index:9999;transform:translate(-50%,-50%);transition:opacity .3s;opacity:0;mix-blend-mode:screen}
    .app-layout{display:flex;min-height:100vh;position:relative;z-index:1}
    /* Sidebar */
    .sidebar{width:240px;flex-shrink:0;background:rgba(10,14,39,.92);backdrop-filter:blur(20px);border-right:1px solid rgba(255,255,255,.06);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:40}
    .sidebar-logo{padding:18px 18px 14px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;gap:10px;text-decoration:none}
    .sidebar-logo img{width:34px;height:34px;border-radius:50%}
    .sidebar-logo span{font-size:14px;font-weight:700;letter-spacing:.5px;color:#fff}
    .sidebar-logo span em{color:#00d4ff;font-style:normal}
    .sidebar-nav{flex:1;padding:10px 0;overflow-y:auto}
    .nav-group-label{font-size:10px;font-weight:600;letter-spacing:1.2px;color:rgba(255,255,255,.3);text-transform:uppercase;padding:10px 18px 4px}
    .nav-item{display:flex;align-items:center;gap:10px;padding:9px 18px;font-size:13px;color:rgba(255,255,255,.6);text-decoration:none;transition:all .2s;border-left:2px solid transparent}
    .nav-item:hover{color:#fff;background:rgba(255,255,255,.04)}
    .nav-item.active{color:#00d4ff;background:rgba(0,212,255,.08);border-left-color:#00d4ff}
    .nav-item i{width:17px;text-align:center;font-size:14px}
    .nav-sub-item{display:flex;align-items:center;gap:10px;padding:7px 18px 7px 34px;font-size:12px;color:rgba(255,255,255,.5);text-decoration:none;transition:all .2s;border-left:2px solid transparent}
    .nav-sub-item:hover{color:#fff;background:rgba(255,255,255,.04)}
    .nav-sub-item.active{color:#00d4ff;background:rgba(0,212,255,.06);border-left-color:#00d4ff}
    .sidebar-footer{padding:14px 18px;border-top:1px solid rgba(255,255,255,.06)}
    .conn-status{display:flex;align-items:center;gap:8px;font-size:12px;color:rgba(255,255,255,.5)}
    .conn-dot{width:7px;height:7px;border-radius:50%;background:#ef4444;flex-shrink:0}
    .conn-dot.online{background:#22c55e;box-shadow:0 0 6px #22c55e}
    /* Main */
    .main-content{margin-left:240px;flex:1;display:flex;flex-direction:column;min-height:100vh}
    .topbar{position:sticky;top:0;z-index:30;background:rgba(10,14,39,.9);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,.06);padding:0 24px;height:58px;display:flex;align-items:center;justify-content:space-between}
    .topbar-left{display:flex;align-items:center;gap:10px}
    .breadcrumb{font-size:12.5px;color:rgba(255,255,255,.4);display:flex;align-items:center;gap:6px}
    .breadcrumb span{color:#fff;font-weight:600}
    .topbar-right{display:flex;align-items:center;gap:8px}
    .btn{padding:7px 14px;border-radius:8px;font-size:12.5px;font-weight:600;border:none;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
    .btn-primary{background:#1877f2;color:#fff}.btn-primary:hover{background:#1565d8}
    .btn-outline{background:transparent;color:rgba(255,255,255,.7);border:1px solid rgba(255,255,255,.15)}.btn-outline:hover{border-color:#00d4ff;color:#00d4ff}
    .btn-sm{padding:5px 12px;font-size:12px}
    .btn-icon{padding:6px 10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);color:rgba(255,255,255,.6);border-radius:8px;cursor:pointer;font-size:13px;display:inline-flex;align-items:center;gap:5px;transition:all .2s}.btn-icon:hover{background:rgba(255,255,255,.1);color:#fff}
    /* Page */
    .page-body{padding:20px 24px;flex:1}
    /* Token banner */
    .token-banner{background:rgba(251,191,36,.06);border:1px solid rgba(251,191,36,.15);border-radius:10px;padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;gap:12px;font-size:12.5px}
    .token-banner.success{background:rgba(34,197,94,.06);border-color:rgba(34,197,94,.15)}
    /* Tabs */
    .tabs-bar{display:flex;gap:0;border-bottom:1px solid rgba(255,255,255,.08);margin-bottom:0;background:rgba(255,255,255,.02);border-radius:12px 12px 0 0;overflow:hidden}
    .tab-btn{padding:12px 20px;font-size:13px;font-weight:600;color:rgba(255,255,255,.5);background:none;border:none;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:7px;border-bottom:2px solid transparent;white-space:nowrap}
    .tab-btn:hover{color:#fff;background:rgba(255,255,255,.04)}
    .tab-btn.active{color:#00d4ff;border-bottom-color:#00d4ff;background:rgba(0,212,255,.06)}
    .tab-btn .tab-count{background:rgba(0,212,255,.15);color:#00d4ff;font-size:10px;font-weight:700;padding:1px 7px;border-radius:20px}
    /* Table */
    .table-wrap{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:0 0 12px 12px;overflow:hidden}
    .table-toolbar{padding:12px 16px;display:flex;align-items:center;gap:10px;border-bottom:1px solid rgba(255,255,255,.06)}
    .search-box{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:6px 12px;flex:1;max-width:320px}
    .search-box input{background:none;border:none;outline:none;color:#fff;font-size:12.5px;width:100%}
    .search-box input::placeholder{color:rgba(255,255,255,.3)}
    .search-box i{color:rgba(255,255,255,.3);font-size:13px}
    table{width:100%;border-collapse:collapse}
    thead tr{border-bottom:1px solid rgba(255,255,255,.07)}
    thead th{padding:10px 14px;font-size:11px;font-weight:600;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.7px;text-align:left;white-space:nowrap;cursor:pointer;user-select:none}
    thead th:hover{color:rgba(255,255,255,.7)}
    thead th i{font-size:10px;margin-left:4px}
    tbody tr{border-bottom:1px solid rgba(255,255,255,.04);transition:background .15s;cursor:pointer}
    tbody tr:hover{background:rgba(255,255,255,.04)}
    tbody tr:last-child{border-bottom:none}
    tbody td{padding:11px 14px;font-size:13px;color:rgba(255,255,255,.85)}
    .td-name{font-weight:600;color:#fff}
    .td-id{font-size:11px;color:rgba(255,255,255,.35);margin-top:2px}
    .badge{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:600}
    .badge-green{background:rgba(34,197,94,.12);color:#4ade80}
    .badge-red{background:rgba(239,68,68,.12);color:#f87171}
    .badge-yellow{background:rgba(251,191,36,.12);color:#fbbf24}
    .badge-gray{background:rgba(255,255,255,.08);color:rgba(255,255,255,.5)}
    .badge-blue{background:rgba(24,119,242,.15);color:#60a5fa}
    .badge::before{content:'';width:5px;height:5px;border-radius:50%;background:currentColor}
    /* Checkbox */
    input[type=checkbox]{accent-color:#00d4ff;width:14px;height:14px;cursor:pointer}
    /* Empty / loading */
    .empty-state{text-align:center;padding:60px 20px;color:rgba(255,255,255,.3)}
    .empty-state i{font-size:48px;margin-bottom:12px;display:block;opacity:.3}
    .empty-state p{font-size:13.5px}
    .loading-row td{text-align:center;padding:40px;color:rgba(255,255,255,.3)}
    .spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.2);border-top-color:#00d4ff;border-radius:50%;animation:spin .7s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* Detail panel */
    .detail-panel{background:rgba(10,14,39,.95);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:20px;margin-top:16px;display:none}
    .detail-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px}
    .detail-item{background:rgba(255,255,255,.04);border-radius:8px;padding:12px 14px}
    .detail-label{font-size:11px;color:rgba(255,255,255,.4);margin-bottom:4px;text-transform:uppercase;letter-spacing:.6px}
    .detail-value{font-size:14px;font-weight:700}
    /* Stats row */
    .stats-row{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:16px}
    .stat-mini{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);border-radius:10px;padding:12px 14px}
    .stat-mini .lbl{font-size:10.5px;color:rgba(255,255,255,.4);margin-bottom:4px;text-transform:uppercase;letter-spacing:.6px}
    .stat-mini .val{font-size:18px;font-weight:700}
    /* Token modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;display:none;align-items:center;justify-content:center}
    .modal-overlay.open{display:flex}
    .modal-box{background:#0f1535;border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:28px;width:500px;max-width:95vw}
    .modal-title{font-size:16px;font-weight:700;margin-bottom:6px}
    .modal-sub{font-size:12.5px;color:rgba(255,255,255,.4);margin-bottom:20px}
    .form-group{margin-bottom:14px}
    .form-label{font-size:12px;color:rgba(255,255,255,.5);margin-bottom:6px;display:block;font-weight:600}
    .form-control{width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:9px 12px;color:#fff;font-size:13px;outline:none;box-sizing:border-box;transition:border-color .2s}
    .form-control:focus{border-color:#00d4ff}
    /* Toast */
    #toast{position:fixed;bottom:24px;right:24px;z-index:9999;display:flex;flex-direction:column;gap:8px}
    .toast-item{background:#1e2a4a;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:12px 18px;font-size:13px;display:flex;align-items:center;gap:10px;animation:slideIn .3s ease;min-width:260px}
    .toast-item.success{border-left:3px solid #22c55e}
    .toast-item.error{border-left:3px solid #ef4444}
    .toast-item.info{border-left:3px solid #00d4ff}
    @keyframes slideIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
    /* Pagination */
    .pagination{display:flex;align-items:center;gap:6px;padding:12px 16px;border-top:1px solid rgba(255,255,255,.06)}
    .page-btn{padding:5px 10px;border-radius:6px;font-size:12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);color:rgba(255,255,255,.6);cursor:pointer;transition:all .2s}
    .page-btn:hover,.page-btn.active{background:rgba(0,212,255,.15);border-color:#00d4ff;color:#00d4ff}
    .page-btn:disabled{opacity:.3;cursor:not-allowed}
    /* Responsive */
    @media(max-width:768px){.sidebar{display:none}.main-content{margin-left:0}.stats-row{grid-template-columns:repeat(2,1fr)}.detail-grid{grid-template-columns:repeat(2,1fr)}}
  </style>
</head>
<body>
  <canvas class="bg-canvas" id="stars-canvas"></canvas>
  <canvas class="bg-canvas" id="data-particles"></canvas>
  <div id="custom-cursor"></div>
  <div id="toast"></div>

  <!-- Token Modal -->
  <div class="modal-overlay" id="tokenModal">
    <div class="modal-box">
      <div class="modal-title"><i class="bi bi-key" style="color:#fbbf24"></i> Nh·∫≠p Access Token Th·ªß C√¥ng</div>
      <div class="modal-sub">D√πng khi Facebook c·∫•m OAuth. L·∫•y token t·∫°i <a href="https://developers.facebook.com/tools/explorer/" target="_blank" style="color:#1877f2">Graph API Explorer</a> ‚Üí ch·ªçn quy·ªÅn <code style="background:rgba(255,255,255,.08);padding:1px 6px;border-radius:4px;font-size:11px">ads_read, ads_management</code></div>
      <div class="form-group">
        <label class="form-label">Facebook Access Token</label>
        <input type="password" class="form-control" id="tokenInput" placeholder="EAAxxxxxxxxxxxxxxx..." autocomplete="off">
        <div style="font-size:11px;color:rgba(255,255,255,.3);margin-top:5px">Token s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o tr√¨nh duy·ªát, kh√¥ng g·ª≠i l√™n server</div>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
        <button class="btn btn-outline" onclick="closeTokenModal()">H·ªßy</button>
        <button class="btn btn-primary" onclick="saveToken()"><i class="bi bi-save"></i> L∆∞u Token</button>
      </div>
    </div>
  </div>

  <div class="app-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <a href="index.html" class="sidebar-logo">
        <img src="https://ui-avatars.com/api/?name=GZ&background=1877f2&color=fff&bold=true" alt="logo">
        <span>GENZ<em>TECH</em></span>
      </a>
      <nav class="sidebar-nav">
        <div class="nav-group-label">T·ªïng Quan</div>
        <a href="maindashboard.html" class="nav-item"><i class="bi bi-grid-1x2-fill"></i> Dashboard</a>
        <div class="nav-group-label">C√¥ng C·ª•</div>
        <a href="auto-post.html" class="nav-item"><i class="bi bi-send"></i> T·ª± ƒê·ªông ƒêƒÉng B√†i</a>
        <a href="ads-assistant.html" class="nav-item" onclick="toggleSubNav(event,'subNavAds')">
          <i class="bi bi-megaphone"></i> Tr·ª£ L√Ω Qu·∫£ng C√°o
          <i class="bi bi-chevron-down" id="subNavAdsArrow" style="margin-left:auto;font-size:11px;transition:transform .2s"></i>
        </a>
        <div id="subNavAds" style="display:block">
          <a href="tool-ad-account.html" class="nav-sub-item active"><i class="bi bi-shield-check"></i> Ki·ªÉm Tra TKQC</a>
          <a href="tool-fb-id.html" class="nav-sub-item"><i class="bi bi-person-badge"></i> T√¨m Facebook ID</a>
          <a href="tool-budget.html" class="nav-sub-item"><i class="bi bi-graph-up-arrow"></i> Ph√¢n T√≠ch Ng√¢n S√°ch</a>
          <a href="tool-translate.html" class="nav-sub-item"><i class="bi bi-translate"></i> D·ªãch Thu·∫≠t</a>
          <a href="tool-ads-finder.html" class="nav-sub-item"><i class="bi bi-binoculars"></i> Ads Finder</a>
          <a href="tool-policy.html" class="nav-sub-item"><i class="bi bi-journal-text"></i> Ch√≠nh S√°ch FB</a>
          <a href="tool-cookie.html" class="nav-sub-item"><i class="bi bi-cookie"></i> Qu·∫£n L√Ω Cookie</a>
        </div>
        <a href="#" class="nav-item" onclick="openSettings()"><i class="bi bi-gear"></i> C√†i ƒê·∫∑t</a>
      </nav>
      <div class="sidebar-footer">
        <div class="conn-status" id="connStatus">
          <div class="conn-dot" id="connDot"></div>
          <span id="connText">Ch∆∞a k·∫øt n·ªëi</span>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <div class="main-content">
      <div class="topbar">
        <div class="topbar-left">
          <div class="breadcrumb">
            <a href="ads-assistant.html" style="color:rgba(255,255,255,.4);text-decoration:none">Tr·ª£ L√Ω QC</a>
            <i class="bi bi-chevron-right" style="font-size:10px"></i>
            <span>Ki·ªÉm Tra TKQC</span>
          </div>
        </div>
        <div class="topbar-right">
          <button class="btn-icon" onclick="refreshData()" title="L√†m m·ªõi"><i class="bi bi-arrow-clockwise"></i></button>
          <button class="btn-icon" onclick="openTokenModal()" title="C√†i ƒë·∫∑t token"><i class="bi bi-key"></i> <span id="tokenIndicator" style="font-size:11px;display:none;color:#4ade80">‚óè</span></button>

          <div id="userBadge" style="display:none;align-items:center;gap:8px;font-size:12.5px">
            <div style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#1877f2,#00d4ff);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px" id="userAvatar">?</div>
            <span id="userName" style="color:rgba(255,255,255,.8)"></span>
          </div>
        </div>
      </div>

      <div class="page-body">

        <div id="tokenBanner" class="token-banner success" style="display:none">
          <i class="bi bi-key-fill" style="color:#4ade80;font-size:16px"></i>
          <div style="flex:1;font-size:12px">
            <strong style="color:#4ade80">Token th·ªß c√¥ng ƒëang d√πng</strong> ‚Äî ƒêang g·ªçi th·∫≥ng Facebook Graph API.
          </div>
          <button class="btn btn-outline btn-sm" onclick="openTokenModal()">ƒê·ªïi token</button>
          <button class="btn btn-sm" onclick="clearToken()" style="background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.2);color:#f87171">X√≥a</button>
        </div>

        <!-- Stats row -->
        <div class="stats-row" id="statsRow" style="display:none">
          <div class="stat-mini"><div class="lbl">T·ªïng TKQC</div><div class="val" id="sTotalAcc">‚Äî</div></div>
          <div class="stat-mini"><div class="lbl">ƒêang ho·∫°t ƒë·ªông</div><div class="val" style="color:#4ade80" id="sActiveAcc">‚Äî</div></div>
          <div class="stat-mini"><div class="lbl">B·ªã kh√≥a / V√¥ hi·ªáu</div><div class="val" style="color:#f87171" id="sLockedAcc">‚Äî</div></div>
          <div class="stat-mini"><div class="lbl">T·ªïng chi ti√™u</div><div class="val" style="color:#60a5fa;font-size:14px" id="sTotalSpend">‚Äî</div></div>
          <div class="stat-mini"><div class="lbl">S·ªë d∆∞ kh·∫£ d·ª•ng</div><div class="val" style="color:#4ade80;font-size:14px" id="sTotalBalance">‚Äî</div></div>
        </div>

        <!-- Tabs + Table -->
        <div>
          <div class="tabs-bar">
            <button class="tab-btn active" id="tab-accounts" onclick="switchTab('accounts')">
              <i class="bi bi-credit-card"></i> T√†i kho·∫£n qu·∫£ng c√°o
              <span class="tab-count" id="countAccounts">0</span>
            </button>
            <button class="tab-btn" id="tab-campaigns" onclick="switchTab('campaigns')">
              <i class="bi bi-flag"></i> Chi·∫øn d·ªãch
              <span class="tab-count" id="countCampaigns">0</span>
            </button>
            <button class="tab-btn" id="tab-adsets" onclick="switchTab('adsets')">
              <i class="bi bi-collection"></i> Nh√≥m qu·∫£ng c√°o
              <span class="tab-count" id="countAdsets">0</span>
            </button>
            <button class="tab-btn" id="tab-ads" onclick="switchTab('ads')">
              <i class="bi bi-megaphone"></i> Qu·∫£ng c√°o
              <span class="tab-count" id="countAds">0</span>
            </button>
            <button class="tab-btn" id="tab-rules" onclick="switchTab('rules')">
              <i class="bi bi-robot"></i> Quy T·∫Øc T·ª± ƒê·ªông
              <span class="tab-count" id="countRules" style="background:rgba(168,85,247,.2);color:#c084fc">0</span>
            </button>
          </div>

          <div class="table-wrap">
            <!-- Context breadcrumb -->
          <div id="contextBar" style="display:none;align-items:center;gap:8px;padding:8px 16px;background:rgba(0,212,255,.04);border-bottom:1px solid rgba(0,212,255,.08);font-size:12px;flex-wrap:wrap"></div>

          <div class="table-toolbar">
              <div class="search-box">
                <i class="bi bi-search"></i>
                <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm..." oninput="filterTable()">
              </div>
              <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
                <span id="selectedCount" style="font-size:12px;color:rgba(255,255,255,.4);display:none"></span>
                <select class="form-control" id="datePreset" onchange="loadCurrentTab()" style="width:auto;font-size:12px;padding:5px 10px">
                  <option value="today">H√¥m nay</option>
                  <option value="yesterday">H√¥m qua</option>
                  <option value="last_7d" selected>7 ng√†y qua</option>
                  <option value="last_30d">30 ng√†y qua</option>
                  <option value="this_month">Th√°ng n√†y</option>
                  <option value="last_month">Th√°ng tr∆∞·ªõc</option>
                </select>
                <button class="btn-icon btn-sm" onclick="exportCSV()"><i class="bi bi-download"></i> Xu·∫•t CSV</button>
              </div>
            </div>

            <!-- Tab: Accounts -->
            <div id="panel-accounts">
              <table>
                <thead>
                  <tr>
                    <th style="width:36px"><input type="checkbox" id="checkAll" onchange="toggleCheckAll(this)"></th>
                    <th onclick="sortTable('accounts','name')">T√†i kho·∫£n qu·∫£ng c√°o <i class="bi bi-arrow-down-up"></i></th>
                    <th onclick="sortTable('accounts','account_status')">Tr·∫°ng th√°i <i class="bi bi-arrow-down-up"></i></th>
                    <th>Qu·ªëc gia</th>
                    <th>M√∫i gi·ªù</th>
                    <th onclick="sortTable('accounts','currency')">Ti·ªÅn t·ªá <i class="bi bi-arrow-down-up"></i></th>
                    <th onclick="sortTable('accounts','balance')">S·ªë d∆∞ <i class="bi bi-arrow-down-up"></i></th>
                    <th onclick="sortTable('accounts','amount_spent')">Chi ti√™u <i class="bi bi-arrow-down-up"></i></th>
                    <th style="width:80px">Thao t√°c</th>
                  </tr>
                </thead>
                <tbody id="tbody-accounts">
                  <tr class="loading-row"><td colspan="9"><span class="spinner"></span> ƒêang t·∫£i...</td></tr>
                </tbody>
              </table>
            </div>

            <!-- Tab: Campaigns -->
            <div id="panel-campaigns" style="display:none">
              <table>
                <thead>
                  <tr>
                    <th style="width:36px"><input type="checkbox"></th>
                    <th>Chi·∫øn d·ªãch</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>M·ª•c ti√™u</th>
                    <th>Ng√¢n s√°ch ng√†y</th>
                    <th>Chi ti√™u</th>
                    <th>L∆∞·ª£t hi·ªÉn th·ªã</th>
                    <th>L∆∞·ª£t click</th>
                    <th>CTR</th>
                    <th>CPC</th>
                  </tr>
                </thead>
                <tbody id="tbody-campaigns">
                  <tr class="loading-row"><td colspan="10"><span class="spinner"></span> Ch·ªçn TKQC ƒë·ªÉ xem chi·∫øn d·ªãch</td></tr>
                </tbody>
              </table>
            </div>

            <!-- Tab: Ad Sets -->
            <div id="panel-adsets" style="display:none">
              <table>
                <thead>
                  <tr>
                    <th style="width:36px"><input type="checkbox"></th>
                    <th>Nh√≥m qu·∫£ng c√°o</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>Chi·∫øn d·ªãch</th>
                    <th>Ng√¢n s√°ch ng√†y</th>
                    <th>Chi ti√™u</th>
                    <th>L∆∞·ª£t hi·ªÉn th·ªã</th>
                    <th>L∆∞·ª£t click</th>
                    <th>CPM</th>
                    <th>CPC</th>
                  </tr>
                </thead>
                <tbody id="tbody-adsets">
                  <tr class="loading-row"><td colspan="10"><span class="spinner"></span> Ch·ªçn TKQC ƒë·ªÉ xem nh√≥m qu·∫£ng c√°o</td></tr>
                </tbody>
              </table>
            </div>

            <!-- Tab: Ads -->
            <div id="panel-ads" style="display:none">
              <table>
                <thead>
                  <tr>
                    <th style="width:36px"><input type="checkbox"></th>
                    <th>Qu·∫£ng c√°o</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>Nh√≥m QC</th>
                    <th>Chi ti√™u</th>
                    <th>L∆∞·ª£t hi·ªÉn th·ªã</th>
                    <th>L∆∞·ª£t click</th>
                    <th>CTR</th>
                    <th>CPC</th>
                    <th>CPM</th>
                  </tr>
                </thead>
                <tbody id="tbody-ads">
                  <tr class="loading-row"><td colspan="10"><span class="spinner"></span> Ch·ªçn TKQC ƒë·ªÉ xem qu·∫£ng c√°o</td></tr>
                </tbody>
              </table>
            </div>

            <!-- Tab: Rules -->
            <div id="panel-rules" style="display:none">
              <div style="padding:20px">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
                  <div>
                    <div style="font-size:15px;font-weight:700"><i class="bi bi-robot" style="color:#c084fc"></i> Quy T·∫Øc T·ª± ƒê·ªông</div>
                    <div style="font-size:12px;color:rgba(255,255,255,.4);margin-top:3px">Ki·ªÉm tra m·ªói 15 ph√∫t. T·ª± ƒë·ªông t·∫Øt/c·∫£nh b√°o khi ƒëi·ªÅu ki·ªán x·∫£y ra.</div>
                  </div>
                  <button class="btn btn-primary" onclick="openRuleModal()" style="background:linear-gradient(135deg,#7c3aed,#a855f7)">
                    <i class="bi bi-plus-lg"></i> T·∫°o Quy T·∫Øc
                  </button>
                </div>
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:20px" id="presetCards">
                  <div class="preset-card" onclick="applyPreset('spend_spike')">
                    <div class="preset-icon" style="background:rgba(239,68,68,.1);color:#f87171"><i class="bi bi-lightning-charge-fill"></i></div>
                    <div class="preset-info"><div class="preset-title">T·∫Øt khi th·ªëc ti·ªÅn ƒë·ªôt ng·ªôt</div><div class="preset-desc">Chi ti√™u tƒÉng &gt;50% so v·ªõi trung b√¨nh 3 ng√†y tr∆∞·ªõc</div></div>
                    <span class="preset-badge" style="background:rgba(239,68,68,.15);color:#f87171">Nhanh</span>
                  </div>
                  <div class="preset-card" onclick="applyPreset('high_cpc')">
                    <div class="preset-icon" style="background:rgba(251,191,36,.1);color:#fbbf24"><i class="bi bi-currency-dollar"></i></div>
                    <div class="preset-info"><div class="preset-title">T·∫Øt khi CPC qu√° ƒë·∫Øt</div><div class="preset-desc">CPC v∆∞·ª£t ng∆∞·ª°ng t·ª± ƒë·∫∑t, hi·ªáu qu·∫£ k√©m</div></div>
                    <span class="preset-badge" style="background:rgba(251,191,36,.15);color:#fbbf24">Ph·ªï bi·∫øn</span>
                  </div>
                  <div class="preset-card" onclick="applyPreset('low_balance')">
                    <div class="preset-icon" style="background:rgba(34,197,94,.1);color:#4ade80"><i class="bi bi-wallet2"></i></div>
                    <div class="preset-info"><div class="preset-title">C·∫£nh b√°o s·∫Øp h·∫øt ti·ªÅn</div><div class="preset-desc">S·ªë d∆∞ TKQC xu·ªëng d∆∞·ªõi ng∆∞·ª°ng ƒë·∫∑t</div></div>
                    <span class="preset-badge" style="background:rgba(34,197,94,.15);color:#4ade80">Quan tr·ªçng</span>
                  </div>
                  <div class="preset-card" onclick="applyPreset('account_disabled')">
                    <div class="preset-icon" style="background:rgba(168,85,247,.1);color:#c084fc"><i class="bi bi-shield-x"></i></div>
                    <div class="preset-info"><div class="preset-title">T√†i kho·∫£n b·ªã v√¥ hi·ªáu h√≥a</div><div class="preset-desc">D·ª´ng t·∫•t c·∫£ chi·∫øn d·ªãch khi TKQC b·ªã kh√≥a</div></div>
                    <span class="preset-badge" style="background:rgba(168,85,247,.15);color:#c084fc">T·ª± ƒë·ªông</span>
                  </div>
                </div>
                <div id="rulesList"></div>
              </div>
            </div>

            <div class="pagination" id="pagination" style="display:none"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Rule Modal -->
  <div class="modal-overlay" id="ruleModal">
    <div class="modal-box" style="width:560px">
      <div class="modal-title"><i class="bi bi-robot" style="color:#c084fc"></i> T·∫°o Quy T·∫Øc T·ª± ƒê·ªông</div>
      <div class="modal-sub">H·ªá th·ªëng ki·ªÉm tra m·ªói 15 ph√∫t v√† th·ª±c hi·ªán h√†nh ƒë·ªông khi ƒëi·ªÅu ki·ªán ƒë∆∞·ª£c th·ªèa m√£n.</div>
      <div class="form-group">
        <label class="form-label">T√™n quy t·∫Øc</label>
        <input type="text" class="form-control" id="ruleName" placeholder="V√≠ d·ª•: T·∫Øt ads khi th·ªëc ti·ªÅn">
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="form-group">
          <label class="form-label">Lo·∫°i ƒëi·ªÅu ki·ªán</label>
          <select class="form-control" id="ruleCondType" onchange="updateCondUnit()">
            <option value="spend_spike">Chi ti√™u tƒÉng ƒë·ªôt ng·ªôt (%)</option>
            <option value="cpc_above">CPC v∆∞·ª£t ng∆∞·ª°ng (VND)</option>
            <option value="cpm_above">CPM v∆∞·ª£t ng∆∞·ª°ng (VND)</option>
            <option value="ctr_below">CTR d∆∞·ªõi ng∆∞·ª°ng (%)</option>
            <option value="balance_below">S·ªë d∆∞ d∆∞·ªõi ng∆∞·ª°ng (VND)</option>
            <option value="spend_above">T·ªïng chi ti√™u v∆∞·ª£t gi·ªõi h·∫°n (VND)</option>
            <option value="account_disabled">T√†i kho·∫£n b·ªã v√¥ hi·ªáu h√≥a</option>
            <option value="no_conversion">Kh√¥ng c√≥ chuy·ªÉn ƒë·ªïi sau X gi·ªù</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label" id="condValueLabel">Gi√° tr·ªã ng∆∞·ª°ng</label>
          <div style="display:flex;align-items:center;gap:6px">
            <input type="number" class="form-control" id="ruleCondValue" placeholder="50" style="flex:1">
            <span id="condUnit" style="font-size:12px;color:rgba(255,255,255,.4);white-space:nowrap">%</span>
          </div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="form-group">
          <label class="form-label">H√†nh ƒë·ªông</label>
          <select class="form-control" id="ruleAction">
            <option value="pause_campaign">T·∫°m d·ª´ng chi·∫øn d·ªãch</option>
            <option value="pause_adset">T·∫°m d·ª´ng nh√≥m QC</option>
            <option value="pause_ad">T·∫°m d·ª´ng qu·∫£ng c√°o</option>
            <option value="notify_only">Ch·ªâ c·∫£nh b√°o (kh√¥ng t·∫Øt)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">√Åp d·ª•ng cho</label>
          <select class="form-control" id="ruleScope">
            <option value="all">T·∫•t c·∫£ TKQC</option>
            <option value="selected">TKQC ƒëang ch·ªçn</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Th√¥ng b√°o khi k√≠ch ho·∫°t</label>
        <div style="display:flex;gap:16px;align-items:center">
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer">
            <input type="checkbox" id="ruleNotifyBrowser" checked style="accent-color:#c084fc"> Th√¥ng b√°o tr√¨nh duy·ªát
          </label>
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer">
            <input type="checkbox" id="ruleNotifyLog" checked style="accent-color:#c084fc"> Ghi log
          </label>
        </div>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
        <button class="btn btn-outline" onclick="closeRuleModal()">H·ªßy</button>
        <button class="btn" onclick="saveRule()" style="background:linear-gradient(135deg,#7c3aed,#a855f7);color:#fff"><i class="bi bi-check-lg"></i> L∆∞u Quy T·∫Øc</button>
      </div>
    </div>
  </div>

  <!-- Edit Timezone / Country Modal -->
  <div class="modal-overlay" id="editTzModal">
    <div class="modal-box" style="width:540px">
      <div class="modal-title"><i class="bi bi-globe" style="color:#00d4ff"></i> S·ª≠a M√∫i Gi·ªù / Qu·ªëc Gia</div>
      <div class="modal-sub" id="editTzAccName" style="color:#00d4ff;font-size:13px;margin-bottom:16px"></div>
      <div style="background:rgba(251,191,36,.06);border:1px solid rgba(251,191,36,.15);border-radius:8px;padding:10px 14px;margin-bottom:16px;font-size:12px;color:#fbbf24">
        <i class="bi bi-exclamation-triangle"></i> <strong>L∆∞u √Ω:</strong> Facebook ch·ªâ cho ph√©p s·ª≠a m√∫i gi·ªù v√† qu·ªëc gia qua <strong>Business Manager</strong> ho·∫∑c API v·ªõi quy·ªÅn <code>ads_management</code>. Thay ƒë·ªïi c√≥ th·ªÉ ·∫£nh h∆∞·ªüng ƒë·∫øn b√°o c√°o v√† m√∫i gi·ªù hi·ªÉn th·ªã c·ªßa chi·∫øn d·ªãch.
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
        <div class="form-group">
          <label class="form-label"><i class="bi bi-globe2" style="color:#60a5fa"></i> Qu·ªëc gia</label>
          <select class="form-control" id="editCountry">
            <option value="VN">üáªüá≥ Vi·ªát Nam (VN)</option>
            <option value="US">üá∫üá∏ United States (US)</option>
            <option value="GB">üá¨üáß United Kingdom (GB)</option>
            <option value="SG">üá∏üá¨ Singapore (SG)</option>
            <option value="TH">üáπüá≠ Thailand (TH)</option>
            <option value="ID">üáÆüá© Indonesia (ID)</option>
            <option value="MY">üá≤üáæ Malaysia (MY)</option>
            <option value="PH">üáµüá≠ Philippines (PH)</option>
            <option value="AU">üá¶üá∫ Australia (AU)</option>
            <option value="JP">üáØüáµ Japan (JP)</option>
            <option value="KR">üá∞üá∑ South Korea (KR)</option>
            <option value="CN">üá®üá≥ China (CN)</option>
            <option value="IN">üáÆüá≥ India (IN)</option>
            <option value="DE">üá©üá™ Germany (DE)</option>
            <option value="FR">üá´üá∑ France (FR)</option>
            <option value="CA">üá®üá¶ Canada (CA)</option>
            <option value="BR">üáßüá∑ Brazil (BR)</option>
            <option value="MX">üá≤üáΩ Mexico (MX)</option>
            <option value="AE">üá¶üá™ UAE (AE)</option>
            <option value="SA">üá∏üá¶ Saudi Arabia (SA)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label"><i class="bi bi-clock" style="color:#c084fc"></i> M√∫i gi·ªù</label>
          <select class="form-control" id="editTimezone">
            <optgroup label="ƒê√¥ng Nam √Å">
              <option value="Asia/Ho_Chi_Minh">Asia/Ho_Chi_Minh (UTC+7)</option>
              <option value="Asia/Bangkok">Asia/Bangkok (UTC+7)</option>
              <option value="Asia/Jakarta">Asia/Jakarta (UTC+7)</option>
              <option value="Asia/Singapore">Asia/Singapore (UTC+8)</option>
              <option value="Asia/Kuala_Lumpur">Asia/Kuala_Lumpur (UTC+8)</option>
              <option value="Asia/Manila">Asia/Manila (UTC+8)</option>
            </optgroup>
            <optgroup label="ƒê√¥ng √Å">
              <option value="Asia/Shanghai">Asia/Shanghai (UTC+8)</option>
              <option value="Asia/Tokyo">Asia/Tokyo (UTC+9)</option>
              <option value="Asia/Seoul">Asia/Seoul (UTC+9)</option>
              <option value="Asia/Kolkata">Asia/Kolkata (UTC+5:30)</option>
            </optgroup>
            <optgroup label="Trung ƒê√¥ng">
              <option value="Asia/Dubai">Asia/Dubai (UTC+4)</option>
              <option value="Asia/Riyadh">Asia/Riyadh (UTC+3)</option>
            </optgroup>
            <optgroup label="Ch√¢u √Çu">
              <option value="Europe/London">Europe/London (UTC+0/+1)</option>
              <option value="Europe/Paris">Europe/Paris (UTC+1/+2)</option>
              <option value="Europe/Berlin">Europe/Berlin (UTC+1/+2)</option>
            </optgroup>
            <optgroup label="Ch√¢u M·ªπ">
              <option value="America/New_York">America/New_York (UTC-5/-4)</option>
              <option value="America/Chicago">America/Chicago (UTC-6/-5)</option>
              <option value="America/Los_Angeles">America/Los_Angeles (UTC-8/-7)</option>
              <option value="America/Toronto">America/Toronto (UTC-5/-4)</option>
              <option value="America/Sao_Paulo">America/Sao_Paulo (UTC-3)</option>
            </optgroup>
            <optgroup label="Ch√¢u √ö c">
              <option value="Australia/Sydney">Australia/Sydney (UTC+10/+11)</option>
            </optgroup>
            <optgroup label="UTC">
              <option value="UTC">UTC (UTC+0)</option>
            </optgroup>
          </select>
        </div>
      </div>
      <div style="background:rgba(0,212,255,.04);border:1px solid rgba(0,212,255,.1);border-radius:8px;padding:10px 14px;margin-bottom:16px">
        <div style="font-size:11.5px;color:rgba(255,255,255,.5);margin-bottom:6px">Th√¥ng tin hi·ªán t·∫°i</div>
        <div style="display:flex;gap:20px;font-size:12.5px">
          <div><span style="color:rgba(255,255,255,.4)">Qu·ªëc gia: </span><span id="currentCountryDisplay" style="color:#60a5fa;font-weight:600"></span></div>
          <div><span style="color:rgba(255,255,255,.4)">M√∫i gi·ªù: </span><span id="currentTzDisplay" style="color:#c084fc;font-weight:600"></span></div>
        </div>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:4px">
        <button class="btn btn-outline" onclick="closeEditTzModal()">H·ªßy</button>
        <button class="btn" onclick="saveTimezone()" style="background:linear-gradient(135deg,#1877f2,#00d4ff);color:#fff"><i class="bi bi-check-lg"></i> C·∫≠p nh·∫≠t</button>
      </div>
    </div>
  </div>

  <script src="js/ads-shared.js"></script>
  <script>
  // ‚îÄ‚îÄ Constants ‚îÄ‚îÄ
  const API_BASE = 'https://genztech-production.up.railway.app';
  const FB_GRAPH = 'https://graph.facebook.com/v25.0';
  const STATUS_MAP = {1:['Ho·∫°t ƒë·ªông','badge-green'],2:['V√¥ hi·ªáu h√≥a','badge-red'],3:['Ch∆∞a x√°c nh·∫≠n','badge-yellow'],7:['B·ªã kh√≥a','badge-red'],9:['ƒê√≥ng c·ª≠a','badge-gray'],100:['ƒêang xem x√©t','badge-yellow']};
  const CAMPAIGN_STATUS = {ACTIVE:['ƒêang ch·∫°y','badge-green'],PAUSED:['T·∫°m d·ª´ng','badge-yellow'],DELETED:['ƒê√£ x√≥a','badge-red'],ARCHIVED:['L∆∞u tr·ªØ','badge-gray']};
  const OBJECTIVE_MAP = {OUTCOME_TRAFFIC:'L∆∞u l∆∞·ª£ng',OUTCOME_AWARENESS:'Nh·∫≠n th·ª©c',OUTCOME_ENGAGEMENT:'T∆∞∆°ng t√°c',OUTCOME_LEADS:'Kh√°ch h√†ng ti·ªÅm nƒÉng',OUTCOME_SALES:'Doanh s·ªë',OUTCOME_APP_PROMOTION:'·ª®ng d·ª•ng',LINK_CLICKS:'L∆∞·ª£t click',CONVERSIONS:'Chuy·ªÉn ƒë·ªïi',BRAND_AWARENESS:'Nh·∫≠n th·ª©c th∆∞∆°ng hi·ªáu',REACH:'Ti·∫øp c·∫≠n',VIDEO_VIEWS:'Xem video',MESSAGES:'Tin nh·∫Øn'};

  // ‚îÄ‚îÄ CSS Rules ‚îÄ‚îÄ
  (function(){
    const s=document.createElement('style');
    s.textContent=`
      .preset-card{display:flex;align-items:center;gap:12px;padding:14px 16px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:10px;cursor:pointer;transition:all .2s}
      .preset-card:hover{background:rgba(168,85,247,.06);border-color:rgba(168,85,247,.3);transform:translateY(-1px)}
      .preset-icon{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
      .preset-info{flex:1}
      .preset-title{font-size:13px;font-weight:600;color:#fff}
      .preset-desc{font-size:11.5px;color:rgba(255,255,255,.4);margin-top:2px}
      .preset-badge{font-size:10px;font-weight:700;padding:3px 8px;border-radius:20px;white-space:nowrap}
      .rule-card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:14px 16px;margin-bottom:10px;display:flex;align-items:center;gap:14px;transition:all .2s}
      .rule-card:hover{border-color:rgba(168,85,247,.3)}
      .rule-card.active-rule{border-color:rgba(168,85,247,.4);background:rgba(168,85,247,.04)}
      .rule-card.triggered{border-color:rgba(239,68,68,.4);background:rgba(239,68,68,.04)}
      .rule-toggle{position:relative;width:36px;height:20px;flex-shrink:0}
      .rule-toggle input{opacity:0;width:0;height:0}
      .rule-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,.15);border-radius:20px;transition:.3s}
      .rule-slider:before{content:'';position:absolute;height:14px;width:14px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s}
      .rule-toggle input:checked+.rule-slider{background:#7c3aed}
      .rule-toggle input:checked+.rule-slider:before{transform:translateX(16px)}
      .rule-info{flex:1}
      .rule-name{font-size:13px;font-weight:600;color:#fff}
      .rule-meta{font-size:11.5px;color:rgba(255,255,255,.4);margin-top:3px}
      .rule-log{font-size:11px;color:#c084fc;margin-top:4px}
      .rule-actions{display:flex;gap:6px}
      .log-section{margin-top:16px;background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.06);border-radius:8px;padding:12px}
      .log-title{font-size:12px;font-weight:600;color:rgba(255,255,255,.5);margin-bottom:8px;display:flex;align-items:center;gap:6px}
      .log-item{font-size:11.5px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.04);display:flex;gap:10px;align-items:flex-start}
      .log-item:last-child{border-bottom:none}
      .log-time{color:rgba(255,255,255,.3);white-space:nowrap;flex-shrink:0}
      .log-msg{color:rgba(255,255,255,.7)}
      .log-msg.triggered{color:#f87171}
      .log-msg.ok{color:#4ade80}
    `;
    document.head.appendChild(s);
  })();

  // ‚îÄ‚îÄ State ‚îÄ‚îÄ
  var S = {
    accounts: [], campaigns: [], adsets: [], ads: [],
    selectedAccountId: null, selectedAccountName: null,
    selectedCampaignId: null, selectedCampaignName: null,
    selectedAdsetId: null, selectedAdsetName: null,
    currentTab: 'accounts', sortField: null, sortAsc: true,
    page: 1, perPage: 20, searchQ: '',
    token: localStorage.getItem('gz_manual_fb_token') || null,
    jwt: localStorage.getItem('gz_jwt') || null,
    user: null
  };

  // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
  function vnd(n) {
    if (!n && n !== 0) return '‚Äî';
    n = parseFloat(n);
    if (n >= 1e9) return (n/1e9).toFixed(1) + 'B';
    if (n >= 1e6) return (n/1e6).toFixed(1) + 'M';
    if (n >= 1e3) return (n/1e3).toFixed(0) + 'K';
    return n.toLocaleString('vi-VN');
  }
  function pct(n) { return n ? parseFloat(n).toFixed(2) + '%' : '‚Äî'; }
  function toast(msg, type='info') {
    const el = document.createElement('div');
    el.className = `toast-item ${type}`;
    const icons = {success:'check-circle-fill',error:'x-circle-fill',info:'info-circle-fill'};
    el.innerHTML = `<i class="bi bi-${icons[type]||'info-circle-fill'}" style="color:${type==='success'?'#4ade80':type==='error'?'#f87171':'#00d4ff'}"></i> ${msg}`;
    document.getElementById('toast').appendChild(el);
    setTimeout(() => el.remove(), 3500);
  }

  // ‚îÄ‚îÄ Auth ‚îÄ‚îÄ
  function goLogin() { window.location.href = 'auto-post.html'; }

  async function initAuth() {
    // Token indicator - show first so token users don't need to wait for JWT check
    if (S.token) {
      document.getElementById('tokenIndicator').style.display = 'inline';
      document.getElementById('tokenBanner').style.display = 'flex';
    }
    // JWT auth check - wrapped in try/catch so failure never blocks the page
    if (S.jwt) {
      try {
        const r = await fetch(`${API_BASE}/api/auth/me`, {
          headers: { Authorization: `Bearer ${S.jwt}` },
          signal: AbortSignal.timeout(5000) // 5s timeout
        });
        if (r.ok) {
          const data = await r.json();
          // Only use data if it has user info (not an error object)
          if (data && (data.username || data.email || data.id)) {
            S.user = data;
            document.getElementById('userBadge').style.display = 'flex';
            document.getElementById('userAvatar').textContent = (data.username || data.email || 'U')[0].toUpperCase();
            document.getElementById('userName').textContent = data.username || data.email || '';
            document.getElementById('connDot').classList.add('online');
            document.getElementById('connText').textContent = data.username || 'ƒê√£ ƒëƒÉng nh·∫≠p';
          } else {
            // Route not found or invalid response - silently ignore
            S.jwt = null;
          }
        } else {
          // 404 or other error - silently clear JWT, don't block
          S.jwt = null;
        }
      } catch(e) {
        // Network error or timeout - silently ignore, don't block
        S.jwt = null;
      }
    }
    if (!S.token && !S.jwt) {
      showLoginBanner();
    }
  }

  function showLoginBanner() {
    // No login banner UI ‚Äî user is redirected to auto-post.html if needed
    if (!S.token && !S.jwt) {
      toast('Vui l√≤ng ƒëƒÉng nh·∫≠p t·∫°i trang T·ª± ƒê·ªông ƒêƒÉng B√†i ho·∫∑c nh·∫≠p token th·ªß c√¥ng', 'info');
    }
  }

  // ‚îÄ‚îÄ Token Modal ‚îÄ‚îÄ
  function openTokenModal() {
    document.getElementById('tokenInput').value = S.token || '';
    document.getElementById('tokenModal').classList.add('open');
  }
  function closeTokenModal() { document.getElementById('tokenModal').classList.remove('open'); }
  function saveToken() {
    const t = document.getElementById('tokenInput').value.trim();
    if (!t) { toast('Vui l√≤ng nh·∫≠p token', 'error'); return; }
    if (!t.startsWith('EAA') && !t.startsWith('EAB') && !t.startsWith('EAAG')) {
      toast('Token kh√¥ng h·ª£p l·ªá ‚Äî ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng EAA', 'error'); return;
    }
    S.token = t;
    localStorage.setItem('gz_manual_fb_token', t);
    document.getElementById('tokenIndicator').style.display = 'inline';
    document.getElementById('tokenBanner').style.display = 'flex';
    closeTokenModal();
    toast('L∆∞u token th√†nh c√¥ng! ƒêang t·∫£i d·ªØ li·ªáu...', 'success');
    loadAccounts();
  }
  function clearToken() {
    S.token = null;
    localStorage.removeItem('gz_manual_fb_token');
    document.getElementById('tokenIndicator').style.display = 'none';
    document.getElementById('tokenBanner').style.display = 'none';
    toast('ƒê√£ x√≥a token th·ªß c√¥ng', 'info');
    if (!S.jwt && !S.token) toast('Nh·∫≠p token ƒë·ªÉ ti·∫øp t·ª•c s·ª≠ d·ª•ng', 'info');
  }

  // ‚îÄ‚îÄ API calls ‚îÄ‚îÄ
  async function fbGet(path) {
    if (S.token) {
      const sep = path.includes('?') ? '&' : '?';
      const r = await fetch(`${FB_GRAPH}/${path}${sep}access_token=${S.token}`);
      const d = await r.json();
      if (d.error) throw new Error(d.error.message);
      return d;
    } else if (S.jwt) {
      const r = await fetch(`${API_BASE}/api/facebook/proxy/${path}`, {
        headers: { Authorization: `Bearer ${S.jwt}` }
      });
      const d = await r.json();
      if (!r.ok) throw new Error(d.error || 'L·ªói server');
      return d;
    } else {
      throw new Error('Ch∆∞a ƒëƒÉng nh·∫≠p ho·∫∑c ch∆∞a c√≥ token');
    }
  }

  // ‚îÄ‚îÄ Load Accounts ‚îÄ‚îÄ
  async function loadAccounts() {
    const tbody = document.getElementById('tbody-accounts');
    tbody.innerHTML = '<tr class="loading-row"><td colspan="8"><span class="spinner"></span> ƒêang t·∫£i danh s√°ch TKQC...</td></tr>';
    document.getElementById('statsRow').style.display = 'none';

    try {
      let accounts = [];
      if (S.token) {
        const datePreset = document.getElementById('datePreset').value;
        // Step 1: Get all ad accounts
        const r = await fetch(`${FB_GRAPH}/me/adaccounts?fields=id,name,account_status,balance,currency,amount_spent,spend_cap,account_id,timezone_id,timezone_name,country&limit=50&access_token=${S.token}`);
        const d = await r.json();
        if (d.error) throw new Error(d.error.message);
        accounts = d.data || [];
        // Step 2: Batch API - get insights for ALL accounts in 1 single request
        if (accounts.length > 0) {
          try {
            const batchRequests = accounts.map(acc => ({
              method: 'GET',
              relative_url: `${acc.id}/insights?fields=spend,impressions,clicks,reach&date_preset=${datePreset}`
            }));
            const batchResp = await fetch(`${FB_GRAPH}/?batch=${encodeURIComponent(JSON.stringify(batchRequests))}&access_token=${S.token}&include_headers=false`, { method: 'POST' });
            const batchData = await batchResp.json();
            if (Array.isArray(batchData)) {
              batchData.forEach((item, i) => {
                try {
                  if (item && item.code === 200) {
                    const body = JSON.parse(item.body);
                    accounts[i]._insights = body.data?.[0] || {};
                  } else {
                    accounts[i]._insights = {};
                  }
                } catch(e) { accounts[i]._insights = {}; }
              });
            }
          } catch(e) {
            // Batch failed - use amount_spent as fallback, no extra requests
            accounts.forEach(acc => { acc._insights = {}; });
          }
        }
      } else if (S.jwt) {
        const r = await fetch(`${API_BASE}/api/facebook/proxy/my-ad-accounts`, {
          headers: { Authorization: `Bearer ${S.jwt}` }
        });
        const d = await r.json();
        if (!r.ok) throw new Error(d.error || 'L·ªói server');
        accounts = d.accounts || [];
      }

      S.accounts = accounts;
      document.getElementById('countAccounts').textContent = accounts.length;

      // Stats
      const active = accounts.filter(a => a.account_status === 1).length;
      const locked = accounts.filter(a => [2,7,9].includes(a.account_status)).length;
      const totalSpend = accounts.reduce((s, a) => s + parseFloat(a._insights?.spend || a.amount_spent || 0), 0);
      const totalBalance = accounts.reduce((s, a) => s + parseFloat(a.balance || 0), 0);
      document.getElementById('sTotalAcc').textContent = accounts.length;
      document.getElementById('sActiveAcc').textContent = active;
      document.getElementById('sLockedAcc').textContent = locked;
      document.getElementById('sTotalSpend').textContent = vnd(totalSpend);
      document.getElementById('sTotalBalance').textContent = vnd(totalBalance);
      document.getElementById('statsRow').style.display = 'grid';

      renderAccounts(accounts);
    } catch(e) {
      tbody.innerHTML = `<tr class="loading-row"><td colspan="8" style="color:#f87171"><i class="bi bi-x-circle"></i> ${e.message}</td></tr>`;
      toast(e.message, 'error');
    }
  }

  function renderAccounts(list) {
    const tbody = document.getElementById('tbody-accounts');
    if (!list.length) {
      tbody.innerHTML = '<tr><td colspan="8"><div class="empty-state"><i class="bi bi-inbox"></i><p>Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n qu·∫£ng c√°o n√†o</p></div></td></tr>';
      return;
    }
    // Apply search
    const q = S.searchQ.toLowerCase();
    const filtered = q ? list.filter(a => (a.name||'').toLowerCase().includes(q) || (a.id||'').includes(q)) : list;

    tbody.innerHTML = filtered.map((acc, idx) => {
      const [statusText, statusClass] = STATUS_MAP[acc.account_status] || ['Kh√¥ng r√µ','badge-gray'];
      const spend = acc._insights?.spend || acc.amount_spent || 0;
      const country = acc.country || '‚Äî';
      const tzName = acc.timezone_name || (acc.timezone_id ? 'TZ #'+acc.timezone_id : '‚Äî');
      const tzShort = tzName.replace('Asia/','').replace('America/','').replace('Europe/','').replace(/_/g,' ');
      // Store account data in a global map to avoid HTML escaping issues
      window._accMap = window._accMap || {};
      window._accMap[acc.id] = acc;
      const safeId = acc.id;
      const safeName = JSON.stringify(acc.name || acc.id);
      return `<tr data-accid="${acc.id}" class="acc-row" style="cursor:pointer" onclick="selectAccount('${acc.id}', ${safeName})">
        <td onclick="event.stopPropagation()"><input type="checkbox" class="row-check" value="${acc.id}"></td>
        <td>
          <div class="td-name">${acc.name || acc.id}</div>
          <div class="td-id">${acc.id}</div>
        </td>
        <td><span class="badge ${statusClass}">${statusText}</span></td>
        <td style="font-size:12px">
          <div style="display:flex;align-items:center;gap:5px">
            <img src="https://flagcdn.com/16x12/${(country||'').toLowerCase()}.png" onerror="this.style.display='none'" style="border-radius:2px">
            <span style="color:rgba(255,255,255,.7)">${country}</span>
          </div>
        </td>
        <td style="font-size:12px;color:rgba(255,255,255,.6)">
          <div title="${tzName}"><i class="bi bi-clock" style="color:#c084fc;margin-right:4px"></i>${tzShort}</div>
        </td>
        <td>
          <div style="font-size:13px;font-weight:600">${acc.currency || 'VND'}</div>
        </td>
        <td style="color:#4ade80;font-weight:600">${vnd(parseFloat(acc.balance||0))}</td>
        <td style="color:#60a5fa;font-weight:600">${vnd(parseFloat(spend))}</td>
        <td onclick="event.stopPropagation()">
          <button class="btn-icon btn-sm edit-tz-btn" data-id="${acc.id}" data-tz="${(acc.timezone_name||'').replace(/"/g,'&quot;')}" data-country="${acc.country||''}" title="S·ª≠a m√∫i gi·ªù / qu·ªëc gia" style="font-size:11px" onclick="event.stopPropagation();(function(b){openEditTzModal(b.dataset.id,b.dataset.id,b.dataset.tz,b.dataset.country)})(this)">
            <i class="bi bi-pencil-square"></i>
          </button>
        </td>
      </tr>`;
    }).join('');
    // Click events handled by event delegation in init()
  }

  // ‚îÄ‚îÄ Select Account ‚Üí Load Campaigns ‚îÄ‚îÄ
  async function selectAccount(id, name) {
    S.selectedAccountId = id;
    S.selectedAccountName = name;
    S.selectedCampaignId = null;
    S.selectedCampaignName = null;
    S.selectedAdsetId = null;
    S.selectedAdsetName = null;
    S.campaigns = []; S.adsets = []; S.ads = [];
    document.getElementById('countCampaigns').textContent = '0';
    document.getElementById('countAdsets').textContent = '0';
    document.getElementById('countAds').textContent = '0';
    toast(`ƒê√£ ch·ªçn: ${name}`, 'info');
    updateContextBar();
    // Switch tab first (without auto-loading since we call loadCampaigns below)
    S.currentTab = 'campaigns';
    ['accounts','campaigns','adsets','ads','rules'].forEach(t => {
      document.getElementById(`tab-${t}`).classList.toggle('active', t === 'campaigns');
      document.getElementById(`panel-${t}`).style.display = t === 'campaigns' ? 'block' : 'none';
    });
    await loadCampaigns(id);
  }

  async function loadCampaigns(accountId) {
    const tbody = document.getElementById('tbody-campaigns');
    tbody.innerHTML = '<tr class="loading-row"><td colspan="10"><span class="spinner"></span> ƒêang t·∫£i chi·∫øn d·ªãch...</td></tr>';
    const datePreset = document.getElementById('datePreset').value;

    try {
      let campaigns = [];
      if (S.token) {
        const url = `${FB_GRAPH}/${accountId}/campaigns?fields=id,name,status,objective,daily_budget,lifetime_budget,start_time,stop_time&limit=100&access_token=${S.token}`;
        console.log('[GenZTech] Load campaigns URL:', url.replace(S.token, 'TOKEN_HIDDEN'));
        const r = await fetch(url);
        const d = await r.json();
        console.log('[GenZTech] Campaigns response:', JSON.stringify(d).substring(0, 300));
        if (d.error) throw new Error(`FB API l·ªói ${d.error.code}: ${d.error.message}`);
        if (!r.ok) throw new Error(`HTTP ${r.status}: ${r.statusText}`);
        campaigns = d.data || [];
        // Get insights
        await Promise.all(campaigns.map(async c => {
          try {
            const ins = await fetch(`${FB_GRAPH}/${c.id}/insights?fields=spend,impressions,clicks,ctr,cpc,reach&date_preset=${datePreset}&access_token=${S.token}`).then(r=>r.json());
            c._ins = ins.data?.[0] || {};
          } catch(e) { c._ins = {}; }
        }));
      } else if (S.jwt) {
        const r = await fetch(`${API_BASE}/api/facebook/proxy/ad-account/${accountId}?date_preset=${datePreset}`, {
          headers: { Authorization: `Bearer ${S.jwt}` }
        });
        const d = await r.json();
        if (!r.ok) throw new Error(d.error || 'L·ªói server');
        campaigns = d.campaigns || [];
      }

      S.campaigns = campaigns;
      document.getElementById('countCampaigns').textContent = campaigns.length;

      if (!campaigns.length) {
        tbody.innerHTML = '<tr><td colspan="10"><div class="empty-state"><i class="bi bi-flag"></i><p>Kh√¥ng c√≥ chi·∫øn d·ªãch n√†o</p></div></td></tr>';
        return;
      }

      tbody.innerHTML = campaigns.map(c => {
        const [st, sc] = CAMPAIGN_STATUS[c.status] || ['Kh√¥ng r√µ','badge-gray'];
        const obj = OBJECTIVE_MAP[c.objective] || c.objective || '‚Äî';
        const ins = c._ins || c.insights?.data?.[0] || {};
        return `<tr onclick="selectCampaign('${c.id}','${c.name}')">
          <td onclick="event.stopPropagation()"><input type="checkbox" class="row-check" value="${c.id}"></td>
          <td><div class="td-name">${c.name}</div><div class="td-id">${c.id}</div></td>
          <td><span class="badge ${sc}">${st}</span></td>
          <td style="font-size:12px;color:rgba(255,255,255,.6)">${obj}</td>
          <td style="color:#fbbf24">${c.daily_budget ? vnd(parseInt(c.daily_budget)/100) : '‚Äî'}</td>
          <td style="color:#60a5fa;font-weight:600">${vnd(parseFloat(ins.spend||0))}</td>
          <td>${vnd(parseInt(ins.impressions||0))}</td>
          <td>${vnd(parseInt(ins.clicks||0))}</td>
          <td>${pct(ins.ctr)}</td>
          <td>${ins.cpc ? vnd(parseFloat(ins.cpc)) : '‚Äî'}</td>
        </tr>`;
      }).join('');
    } catch(e) {
      tbody.innerHTML = `<tr class="loading-row"><td colspan="10" style="color:#f87171"><i class="bi bi-x-circle"></i> ${e.message}</td></tr>`;
      toast(e.message, 'error');
    }
  }

  async function selectCampaign(id, name) {
    S.selectedCampaignId = id;
    S.selectedCampaignName = name;
    S.selectedAdsetId = null;
    S.selectedAdsetName = null;
    S.adsets = []; S.ads = [];
    document.getElementById('countAdsets').textContent = '0';
    document.getElementById('countAds').textContent = '0';
    updateContextBar();
    switchTab('adsets');
    await loadAdsets(id, name);
  }

  async function loadAdsets(campaignId, campaignName) {
    const tbody = document.getElementById('tbody-adsets');
    tbody.innerHTML = '<tr class="loading-row"><td colspan="10"><span class="spinner"></span> ƒêang t·∫£i nh√≥m qu·∫£ng c√°o...</td></tr>';
    const datePreset = document.getElementById('datePreset').value;
    // Fallback campaign name from state
    const campLabel = campaignName || S.selectedCampaignName || '‚Äî';

    try {
      if (!S.token && !S.jwt) throw new Error('Ch∆∞a ƒëƒÉng nh·∫≠p ho·∫∑c ch∆∞a c√≥ token');
      let adsets = [];
      if (S.token) {
        // Include campaign{name} so we always have the campaign name even if passed incorrectly
        const r = await fetch(`${FB_GRAPH}/${campaignId}/adsets?fields=id,name,status,daily_budget,lifetime_budget,campaign_id,campaign{name},optimization_goal&limit=100&access_token=${S.token}`);
        const d = await r.json();
        if (d.error) throw new Error(d.error.message);
        adsets = d.data || [];
        await Promise.all(adsets.map(async a => {
          try {
            const ins = await fetch(`${FB_GRAPH}/${a.id}/insights?fields=spend,impressions,clicks,ctr,cpc,cpm&date_preset=${datePreset}&access_token=${S.token}`).then(r=>r.json());
            a._ins = ins.data?.[0] || {};
          } catch(e) { a._ins = {}; }
        }));
      } else if (S.jwt) {
        const r = await fetch(`${API_BASE}/api/facebook/proxy/ad-account/${S.selectedAccountId}?date_preset=${datePreset}`, {
          headers: { Authorization: `Bearer ${S.jwt}` }
        });
        const d = await r.json();
        if (!r.ok) throw new Error(d.error || 'L·ªói server');
        // Filter adsets by campaign
        adsets = (d.adsets || []).filter(a => a.campaign_id === campaignId);
      }

      S.adsets = adsets;
      document.getElementById('countAdsets').textContent = adsets.length;

      if (!adsets.length) {
        tbody.innerHTML = `<tr><td colspan="10"><div class="empty-state"><i class="bi bi-collection"></i><p>Kh√¥ng c√≥ nh√≥m qu·∫£ng c√°o n√†o trong chi·∫øn d·ªãch "${campLabel}"</p></div></td></tr>`;
        return;
      }

      tbody.innerHTML = adsets.map(a => {
        const [st, sc] = CAMPAIGN_STATUS[a.status] || ['Kh√¥ng r√µ','badge-gray'];
        const ins = a._ins || {};
        // Use campaign name from API response first, then fallback
        const cName = a.campaign?.name || campLabel;
        return `<tr onclick="selectAdset('${a.id}','${(a.name||'').replace(/'/g,"\\'")}')"
          style="cursor:pointer">
          <td onclick="event.stopPropagation()"><input type="checkbox" class="row-check" value="${a.id}"></td>
          <td><div class="td-name">${a.name}</div><div class="td-id">${a.id}</div></td>
          <td><span class="badge ${sc}">${st}</span></td>
          <td style="font-size:12px;color:rgba(255,255,255,.5)">${cName}</td>
          <td style="color:#fbbf24">${a.daily_budget ? vnd(parseInt(a.daily_budget)/100) : '‚Äî'}</td>
          <td style="color:#60a5fa;font-weight:600">${vnd(parseFloat(ins.spend||0))}</td>
          <td>${vnd(parseInt(ins.impressions||0))}</td>
          <td>${vnd(parseInt(ins.clicks||0))}</td>
          <td>${ins.cpm ? vnd(parseFloat(ins.cpm)) : '‚Äî'}</td>
          <td>${ins.cpc ? vnd(parseFloat(ins.cpc)) : '‚Äî'}</td>
        </tr>`;
      }).join('');
    } catch(e) {
      tbody.innerHTML = `<tr class="loading-row"><td colspan="10" style="color:#f87171"><i class="bi bi-x-circle"></i> ${e.message}</td></tr>`;
    }
  }

  async function selectAdset(id, name) {
    S.selectedAdsetId = id;
    S.selectedAdsetName = name;
    updateContextBar();
    switchTab('ads');
    await loadAds(id, name);
  }

  async function loadAds(adsetId, adsetName) {
    const tbody = document.getElementById('tbody-ads');
    tbody.innerHTML = '<tr class="loading-row"><td colspan="10"><span class="spinner"></span> ƒêang t·∫£i qu·∫£ng c√°o...</td></tr>';
    const datePreset = document.getElementById('datePreset').value;

    try {
      if (!S.token) throw new Error('C·∫ßn token th·ªß c√¥ng ƒë·ªÉ xem qu·∫£ng c√°o chi ti·∫øt');
      const r = await fetch(`${FB_GRAPH}/${adsetId}/ads?fields=id,name,status,creative{title,body,thumbnail_url}&limit=50&access_token=${S.token}`);
      const d = await r.json();
      if (d.error) throw new Error(d.error.message);
      const ads = d.data || [];

      await Promise.all(ads.map(async a => {
        try {
          const ins = await fetch(`${FB_GRAPH}/${a.id}/insights?fields=spend,impressions,clicks,ctr,cpc,cpm&date_preset=${datePreset}&access_token=${S.token}`).then(r=>r.json());
          a._ins = ins.data?.[0] || {};
        } catch(e) { a._ins = {}; }
      }));

      S.ads = ads;
      document.getElementById('countAds').textContent = ads.length;

      if (!ads.length) {
        tbody.innerHTML = `<tr><td colspan="10"><div class="empty-state"><i class="bi bi-megaphone"></i><p>Kh√¥ng c√≥ qu·∫£ng c√°o n√†o trong nh√≥m "${adsetName}"</p></div></td></tr>`;
        return;
      }

      tbody.innerHTML = ads.map(a => {
        const [st, sc] = CAMPAIGN_STATUS[a.status] || ['Kh√¥ng r√µ','badge-gray'];
        const ins = a._ins || {};
        const thumb = a.creative?.thumbnail_url;
        return `<tr>
          <td onclick="event.stopPropagation()"><input type="checkbox" class="row-check" value="${a.id}"></td>
          <td>
            <div style="display:flex;align-items:center;gap:10px">
              ${thumb ? `<img src="${thumb}" style="width:40px;height:40px;border-radius:6px;object-fit:cover">` : '<div style="width:40px;height:40px;border-radius:6px;background:rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center"><i class="bi bi-image" style="color:rgba(255,255,255,.3)"></i></div>'}
              <div><div class="td-name">${a.name}</div><div class="td-id">${a.id}</div></div>
            </div>
          </td>
          <td><span class="badge ${sc}">${st}</span></td>
          <td style="font-size:12px;color:rgba(255,255,255,.5)">${adsetName || '‚Äî'}</td>
          <td style="color:#60a5fa;font-weight:600">${vnd(parseFloat(ins.spend||0))}</td>
          <td>${vnd(parseInt(ins.impressions||0))}</td>
          <td>${vnd(parseInt(ins.clicks||0))}</td>
          <td>${pct(ins.ctr)}</td>
          <td>${ins.cpc ? vnd(parseFloat(ins.cpc)) : '‚Äî'}</td>
          <td>${ins.cpm ? vnd(parseFloat(ins.cpm)) : '‚Äî'}</td>
        </tr>`;
      }).join('');
    } catch(e) {
      tbody.innerHTML = `<tr class="loading-row"><td colspan="10" style="color:#f87171"><i class="bi bi-x-circle"></i> ${e.message}</td></tr>`;
    }
  }

  // ‚îÄ‚îÄ Context bar ‚îÄ‚îÄ
  function updateContextBar() {
    const bar = document.getElementById('contextBar');
    if (!bar) return;
    const parts = [];
    if (S.selectedAccountName) parts.push(`<i class="bi bi-credit-card" style="color:#00d4ff"></i> <span style="color:#00d4ff">${S.selectedAccountName}</span>`);
    if (S.selectedCampaignName) parts.push(`<i class="bi bi-chevron-right" style="font-size:10px;color:rgba(255,255,255,.3)"></i> <i class="bi bi-flag" style="color:#fbbf24"></i> <span style="color:#fbbf24">${S.selectedCampaignName}</span>`);
    if (S.selectedAdsetName) parts.push(`<i class="bi bi-chevron-right" style="font-size:10px;color:rgba(255,255,255,.3)"></i> <i class="bi bi-collection" style="color:#4ade80"></i> <span style="color:#4ade80">${S.selectedAdsetName}</span>`);
    if (parts.length) {
      bar.innerHTML = parts.join(' ');
      bar.style.display = 'flex';
    } else {
      bar.style.display = 'none';
    }
  }

  // ‚îÄ‚îÄ Tab switching ‚îÄ‚îÄ
  function switchTab(tab) {
    S.currentTab = tab;
    ['accounts','campaigns','adsets','ads','rules'].forEach(t => {
      document.getElementById(`tab-${t}`).classList.toggle('active', t === tab);
      document.getElementById(`panel-${t}`).style.display = t === tab ? 'block' : 'none';
    });
    // Auto-load data when switching tabs
    if (tab === 'campaigns') {
      if (S.selectedAccountId) {
        loadCampaigns(S.selectedAccountId); // always reload
      } else {
        document.getElementById('tbody-campaigns').innerHTML = '<tr><td colspan="10"><div class="empty-state"><i class="bi bi-credit-card"></i><p>H√£y quay l·∫°i tab <strong>T√†i kho·∫£n qu·∫£ng c√°o</strong> v√† click v√†o m·ªôt t√†i kho·∫£n ƒë·ªÉ xem chi·∫øn d·ªãch</p></div></td></tr>';
      }
    } else if (tab === 'adsets') {
      if (S.selectedCampaignId) {
        loadAdsets(S.selectedCampaignId, S.selectedCampaignName);
      } else if (S.selectedAccountId) {
        loadAllAdsets(S.selectedAccountId);
      } else {
        document.getElementById('tbody-adsets').innerHTML = '<tr><td colspan="10"><div class="empty-state"><i class="bi bi-credit-card"></i><p>H√£y quay l·∫°i tab <strong>T√†i kho·∫£n qu·∫£ng c√°o</strong> v√† click v√†o m·ªôt t√†i kho·∫£n</p></div></td></tr>';
      }
    } else if (tab === 'ads') {
      if (S.selectedAdsetId) {
        loadAds(S.selectedAdsetId, S.selectedAdsetName);
      } else if (S.selectedAccountId) {
        loadAllAds(S.selectedAccountId);
      } else {
        document.getElementById('tbody-ads').innerHTML = '<tr><td colspan="10"><div class="empty-state"><i class="bi bi-megaphone"></i><p>H√£y quay l·∫°i tab <strong>T√†i kho·∫£n qu·∫£ng c√°o</strong> v√† click v√†o m·ªôt t√†i kho·∫£n</p></div></td></tr>';
      }
    } else if (tab === 'rules') {
      renderRules();
    }
  }

  // Load all adsets directly from account (bypass campaign selection)
  async function loadAllAdsets(accountId) {
    const tbody = document.getElementById('tbody-adsets');
    tbody.innerHTML = '<tr class="loading-row"><td colspan="10"><span class="spinner"></span> ƒêang t·∫£i t·∫•t c·∫£ nh√≥m qu·∫£ng c√°o...</td></tr>';
    const datePreset = document.getElementById('datePreset').value;
    try {
      if (!S.token) throw new Error('C·∫ßn token ƒë·ªÉ xem nh√≥m qu·∫£ng c√°o');
      const r = await fetch(`${FB_GRAPH}/${accountId}/adsets?fields=id,name,status,daily_budget,campaign_id,campaign{name},optimization_goal&limit=100&access_token=${S.token}`);
      const d = await r.json();
      if (d.error) throw new Error(d.error.message);
      const adsets = d.data || [];
      await Promise.all(adsets.map(async a => {
        try {
          const ins = await fetch(`${FB_GRAPH}/${a.id}/insights?fields=spend,impressions,clicks,ctr,cpc,cpm&date_preset=${datePreset}&access_token=${S.token}`).then(r=>r.json());
          a._ins = ins.data?.[0] || {};
        } catch(e) { a._ins = {}; }
      }));
      S.adsets = adsets;
      document.getElementById('countAdsets').textContent = adsets.length;
      if (!adsets.length) {
        tbody.innerHTML = '<tr><td colspan="10"><div class="empty-state"><i class="bi bi-collection"></i><p>Kh√¥ng c√≥ nh√≥m qu·∫£ng c√°o n√†o</p></div></td></tr>';
        return;
      }
      tbody.innerHTML = adsets.map(a => {
        const [st, sc] = CAMPAIGN_STATUS[a.status] || ['Kh√¥ng r√µ','badge-gray'];
        const ins = a._ins || {};
        const campName = a.campaign?.name || '‚Äî';
        return `<tr onclick="selectAdset('${a.id}','${a.name}')">
          <td onclick="event.stopPropagation()"><input type="checkbox" class="row-check" value="${a.id}"></td>
          <td><div class="td-name">${a.name}</div><div class="td-id">${a.id}</div></td>
          <td><span class="badge ${sc}">${st}</span></td>
          <td style="font-size:12px;color:rgba(255,255,255,.5)">${campName}</td>
          <td style="color:#fbbf24">${a.daily_budget ? vnd(parseInt(a.daily_budget)/100) : '‚Äî'}</td>
          <td style="color:#60a5fa;font-weight:600">${vnd(parseFloat(ins.spend||0))}</td>
          <td>${vnd(parseInt(ins.impressions||0))}</td>
          <td>${vnd(parseInt(ins.clicks||0))}</td>
          <td>${ins.cpm ? vnd(parseFloat(ins.cpm)) : '‚Äî'}</td>
          <td>${ins.cpc ? vnd(parseFloat(ins.cpc)) : '‚Äî'}</td>
        </tr>`;
      }).join('');
    } catch(e) {
      tbody.innerHTML = `<tr class="loading-row"><td colspan="10" style="color:#f87171"><i class="bi bi-x-circle"></i> ${e.message}</td></tr>`;
    }
  }

  // Load all ads directly from account
  async function loadAllAds(accountId) {
    const tbody = document.getElementById('tbody-ads');
    tbody.innerHTML = '<tr class="loading-row"><td colspan="10"><span class="spinner"></span> ƒêang t·∫£i t·∫•t c·∫£ qu·∫£ng c√°o...</td></tr>';
    const datePreset = document.getElementById('datePreset').value;
    try {
      if (!S.token) throw new Error('C·∫ßn token ƒë·ªÉ xem qu·∫£ng c√°o');
      const r = await fetch(`${FB_GRAPH}/${accountId}/ads?fields=id,name,status,adset_id,adset{name},creative{title,thumbnail_url}&limit=100&access_token=${S.token}`);
      const d = await r.json();
      if (d.error) throw new Error(d.error.message);
      const ads = d.data || [];
      await Promise.all(ads.map(async a => {
        try {
          const ins = await fetch(`${FB_GRAPH}/${a.id}/insights?fields=spend,impressions,clicks,ctr,cpc,cpm&date_preset=${datePreset}&access_token=${S.token}`).then(r=>r.json());
          a._ins = ins.data?.[0] || {};
        } catch(e) { a._ins = {}; }
      }));
      S.ads = ads;
      document.getElementById('countAds').textContent = ads.length;
      if (!ads.length) {
        tbody.innerHTML = '<tr><td colspan="10"><div class="empty-state"><i class="bi bi-megaphone"></i><p>Kh√¥ng c√≥ qu·∫£ng c√°o n√†o</p></div></td></tr>';
        return;
      }
      tbody.innerHTML = ads.map(a => {
        const [st, sc] = CAMPAIGN_STATUS[a.status] || ['Kh√¥ng r√µ','badge-gray'];
        const ins = a._ins || {};
        const thumb = a.creative?.thumbnail_url;
        const adsetName = a.adset?.name || '‚Äî';
        return `<tr>
          <td onclick="event.stopPropagation()"><input type="checkbox" class="row-check" value="${a.id}"></td>
          <td>
            <div style="display:flex;align-items:center;gap:10px">
              ${thumb ? `<img src="${thumb}" style="width:40px;height:40px;border-radius:6px;object-fit:cover">` : '<div style="width:40px;height:40px;border-radius:6px;background:rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center"><i class="bi bi-image" style="color:rgba(255,255,255,.3)"></i></div>'}
              <div><div class="td-name">${a.name}</div><div class="td-id">${a.id}</div></div>
            </div>
          </td>
          <td><span class="badge ${sc}">${st}</span></td>
          <td style="font-size:12px;color:rgba(255,255,255,.5)">${adsetName}</td>
          <td style="color:#60a5fa;font-weight:600">${vnd(parseFloat(ins.spend||0))}</td>
          <td>${vnd(parseInt(ins.impressions||0))}</td>
          <td>${vnd(parseInt(ins.clicks||0))}</td>
          <td>${pct(ins.ctr)}</td>
          <td>${ins.cpc ? vnd(parseFloat(ins.cpc)) : '‚Äî'}</td>
          <td>${ins.cpm ? vnd(parseFloat(ins.cpm)) : '‚Äî'}</td>
        </tr>`;
      }).join('');
    } catch(e) {
      tbody.innerHTML = `<tr class="loading-row"><td colspan="10" style="color:#f87171"><i class="bi bi-x-circle"></i> ${e.message}</td></tr>`;
    }
  }

  function loadCurrentTab() {
    if (S.currentTab === 'accounts') loadAccounts();
    else if (S.currentTab === 'campaigns' && S.selectedAccountId) loadCampaigns(S.selectedAccountId);
    else if (S.currentTab === 'adsets') {
      if (S.selectedCampaignId) loadAdsets(S.selectedCampaignId, S.selectedCampaignName);
      else if (S.selectedAccountId) loadAllAdsets(S.selectedAccountId);
    } else if (S.currentTab === 'ads') {
      if (S.selectedAdsetId) loadAds(S.selectedAdsetId, S.selectedAdsetName);
      else if (S.selectedAccountId) loadAllAds(S.selectedAccountId);
    }
  }

  // ‚îÄ‚îÄ Search & Sort ‚îÄ‚îÄ
  function filterTable() {
    S.searchQ = document.getElementById('searchInput').value;
    if (S.currentTab === 'accounts') renderAccounts(S.accounts);
  }

  function sortTable(tab, field) {
    if (S.sortField === field) S.sortAsc = !S.sortAsc;
    else { S.sortField = field; S.sortAsc = true; }
    if (tab === 'accounts') {
      S.accounts.sort((a,b) => {
        let va = a[field] || 0, vb = b[field] || 0;
        if (typeof va === 'string') va = va.toLowerCase();
        if (typeof vb === 'string') vb = vb.toLowerCase();
        return S.sortAsc ? (va > vb ? 1 : -1) : (va < vb ? 1 : -1);
      });
      renderAccounts(S.accounts);
    }
  }

  // ‚îÄ‚îÄ Checkbox ‚îÄ‚îÄ
  function toggleCheckAll(el) {
    document.querySelectorAll('.row-check').forEach(c => c.checked = el.checked);
    updateSelectedCount();
  }
  function updateSelectedCount() {
    const n = document.querySelectorAll('.row-check:checked').length;
    const el = document.getElementById('selectedCount');
    el.style.display = n ? 'block' : 'none';
    el.textContent = `ƒê√£ ch·ªçn ${n} m·ª•c`;
  }
  document.addEventListener('change', e => { if (e.target.classList.contains('row-check')) updateSelectedCount(); });

  // ‚îÄ‚îÄ Export CSV ‚îÄ‚îÄ
  function exportCSV() {
    const tab = S.currentTab;
    const data = S[tab] || [];
    if (!data.length) { toast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t', 'error'); return; }
    const headers = Object.keys(data[0]).filter(k => !k.startsWith('_'));
    const rows = data.map(r => headers.map(h => `"${(r[h]||'').toString().replace(/"/g,'""')}"`).join(','));
    const csv = [headers.join(','), ...rows].join('\n');
    const a = document.createElement('a');
    a.href = 'data:text/csv;charset=utf-8,\uFEFF' + encodeURIComponent(csv);
    a.download = `genztech_${tab}_${Date.now()}.csv`;
    a.click();
    toast('Xu·∫•t CSV th√†nh c√¥ng!', 'success');
  }

  // ‚îÄ‚îÄ Refresh ‚îÄ‚îÄ
  function refreshData() { loadCurrentTab(); toast('ƒêang l√†m m·ªõi d·ªØ li·ªáu...', 'info'); }

  // ‚îÄ‚îÄ Sidebar toggle ‚îÄ‚îÄ
  function toggleSubNav(e, id) {
    e.preventDefault();
    const el = document.getElementById(id);
    const arrow = document.getElementById(id + 'Arrow');
    const open = el.style.display === 'none';
    el.style.display = open ? 'block' : 'none';
    if (arrow) arrow.style.transform = open ? 'rotate(180deg)' : '';
  }

  function openSettings() { toast('C√†i ƒë·∫∑t ƒëang ph√°t tri·ªÉn', 'info'); }

  // ‚îÄ‚îÄ Edit Timezone / Country ‚îÄ‚îÄ
  let _editTzAccId = null;

  function openEditTzModal(accId, accName, currentTz, currentCountry) {
    _editTzAccId = accId;
    document.getElementById('editTzAccName').textContent = accName;
    document.getElementById('currentCountryDisplay').textContent = currentCountry || '‚Äî';
    document.getElementById('currentTzDisplay').textContent = currentTz || '‚Äî';
    // Pre-select current values
    const tzSel = document.getElementById('editTimezone');
    const ctrSel = document.getElementById('editCountry');
    if (currentTz) {
      const opt = [...tzSel.options].find(o => o.value === currentTz);
      if (opt) tzSel.value = currentTz;
    }
    if (currentCountry) {
      const opt = [...ctrSel.options].find(o => o.value === currentCountry.toUpperCase());
      if (opt) ctrSel.value = currentCountry.toUpperCase();
    }
    document.getElementById('editTzModal').classList.add('open');
  }

  function closeEditTzModal() {
    document.getElementById('editTzModal').classList.remove('open');
    _editTzAccId = null;
  }

  async function saveTimezone() {
    if (!_editTzAccId) return;
    const timezone = document.getElementById('editTimezone').value;
    const country = document.getElementById('editCountry').value;
    if (!S.token) {
      toast('C·∫ßn Access Token ƒë·ªÉ c·∫≠p nh·∫≠t th√¥ng tin TKQC', 'error');
      return;
    }
    const btn = document.querySelector('#editTzModal .btn:last-child');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> ƒêang c·∫≠p nh·∫≠t...';
    try {
      // Facebook Marketing API: POST /{ad-account-id}
      // Use timezone_name (string) - Facebook accepts this directly
      const params = new URLSearchParams();
      params.append('access_token', S.token);
      if (timezone) params.append('timezone_name', timezone);
      if (country) params.append('country', country);
      const r = await fetch(`${FB_GRAPH}/${_editTzAccId}`, {
        method: 'POST',
        body: params
      });
      const d = await r.json();
      if (d.error) throw new Error(`${d.error.message} (code: ${d.error.code})`);
      // Facebook returns {success: true} or {id: "act_xxx"} on success
      if (d.success || d.id || d === true) {
        toast('C·∫≠p nh·∫≠t th√†nh c√¥ng!', 'success');
        // Update local state
        const acc = S.accounts.find(a => a.id === _editTzAccId);
        if (acc) { acc.timezone_name = timezone; acc.country = country; }
        closeEditTzModal();
        renderAccounts(S.accounts);
      } else {
        // Log response for debugging
        console.warn('[GenZTech] saveTimezone response:', d);
        throw new Error('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t. Ph·∫£n h·ªìi: ' + JSON.stringify(d).substring(0, 100));
      }
    } catch(e) {
      toast(e.message, 'error');
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-check-lg"></i> C·∫≠p nh·∫≠t';
    }
  }

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
  async function init() {
    try {
      await initAuth();
    } catch(e) {
      console.warn('[GenZTech] initAuth error (non-fatal):', e.message);
    }
    // Auto load if has token or jwt
    if (S.token || S.jwt) {
      loadAccounts();
    }
    // Event delegation for account rows (survives re-renders)
    document.getElementById('tbody-accounts').addEventListener('click', function(e) {
      const btn = e.target.closest('.edit-tz-btn');
      if (btn) {
        e.stopPropagation();
        const id = btn.dataset.accid;
        const acc = (window._accMap && window._accMap[id]) || {};
        openEditTzModal(id, acc.name || id, acc.timezone_name || '', acc.country || '');
        return;
      }
      const row = e.target.closest('.acc-row');
      if (row) {
        const id = row.dataset.accid;
        const name = row.dataset.accname || id;
        selectAccount(id, name);
      }
    });
  }

  // ‚îÄ‚îÄ Background ‚îÄ‚îÄ
  (function() {
    const isMobile = window.innerWidth < 768;
    const isTouchDevice = 'ontouchstart' in window;
    const canvas = document.getElementById('stars-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    const stars = [];
    for (let i = 0; i < (isMobile ? 80 : 180); i++) {
      stars.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*1.5+0.3, a: Math.random(), da: (Math.random()-0.5)*0.005, vx: (Math.random()-0.5)*0.08, vy: (Math.random()-0.5)*0.08 });
    }
    function animStars() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      stars.forEach(s => {
        s.x += s.vx; s.y += s.vy; s.a += s.da;
        if (s.a < 0.1) s.da = Math.abs(s.da);
        if (s.a > 1) s.da = -Math.abs(s.da);
        if (s.x < 0) s.x = canvas.width; if (s.x > canvas.width) s.x = 0;
        if (s.y < 0) s.y = canvas.height; if (s.y > canvas.height) s.y = 0;
        ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
        ctx.fillStyle = `rgba(255,255,255,${s.a * 0.7})`; ctx.fill();
      });
      requestAnimationFrame(animStars);
    }
    animStars();
    // Data particles
    const canvasData = document.getElementById('data-particles');
    const ctxData = canvasData.getContext('2d');
    canvasData.width = window.innerWidth; canvasData.height = window.innerHeight;
    const particles = [];
    for (let i = 0; i < (isMobile ? 10 : 20); i++) {
      particles.push({ x:0, y:0, r: Math.random()*2+1, path:{ cx:Math.random()*canvasData.width, cy:Math.random()*canvasData.height, rx:Math.random()*100+50, ry:Math.random()*100+50, angle:Math.random()*Math.PI*2, speed:Math.random()*0.01+0.005 }, pulse:Math.random()*Math.PI*2, ps:Math.random()*0.02+0.01 });
    }
    function animPart() {
      ctxData.clearRect(0,0,canvasData.width,canvasData.height);
      particles.forEach(p => {
        p.path.angle += p.path.speed; p.x = p.path.cx + Math.cos(p.path.angle)*p.path.rx; p.y = p.path.cy + Math.sin(p.path.angle)*p.path.ry;
        p.pulse += p.ps; const ps = 1 + Math.sin(p.pulse)*0.5;
        const g = ctxData.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r*ps*3);
        g.addColorStop(0,'rgba(24,119,242,'+(0.7*ps)+')'); g.addColorStop(0.5,'rgba(0,212,255,'+(0.3*ps)+')'); g.addColorStop(1,'rgba(0,212,255,0)');
        ctxData.fillStyle = g; ctxData.beginPath(); ctxData.arc(p.x,p.y,p.r*ps*3,0,Math.PI*2); ctxData.fill();
      });
      requestAnimationFrame(animPart);
    }
    animPart();
    // Cursor
    const cursor = document.getElementById('custom-cursor');
    if (cursor && !isTouchDevice) {
      let mx=0,my=0,cx=0,cy=0,mv=false;
      document.body.style.cursor='none';
      document.addEventListener('mousemove', e => { mx=e.clientX; my=e.clientY; if(!mv){mv=true;cursor.style.opacity='1';} });
      document.addEventListener('mouseleave', () => { mv=false; cursor.style.opacity='0'; });
      function animCursor() { if(mv){ cx+=(mx-cx)*0.15; cy+=(my-cy)*0.15; cursor.style.left=cx+'px'; cursor.style.top=cy+'px'; } requestAnimationFrame(animCursor); }
      animCursor();
    }
    window.addEventListener('resize', () => { canvas.width=window.innerWidth; canvas.height=window.innerHeight; canvasData.width=window.innerWidth; canvasData.height=window.innerHeight; });
  })();

  // ‚îÄ‚îÄ RULE ENGINE ‚îÄ‚îÄ
  let rules = JSON.parse(localStorage.getItem('gz_ad_rules') || '[]');
  let ruleEditId = null;
  let ruleCheckInterval = null;
  let ruleLogs = JSON.parse(localStorage.getItem('gz_rule_logs') || '[]');

  const COND_UNITS = {
    spend_spike: '%', cpc_above: 'VND', cpm_above: 'VND', ctr_below: '%',
    balance_below: 'VND', spend_above: 'VND', account_disabled: '', no_conversion: 'gi·ªù'
  };
  const COND_LABELS = {
    spend_spike: 'TƒÉng % so v·ªõi trung b√¨nh', cpc_above: 'CPC t·ªëi ƒëa (VND)',
    cpm_above: 'CPM t·ªëi ƒëa (VND)', ctr_below: 'CTR t·ªëi thi·ªÉu (%)',
    balance_below: 'S·ªë d∆∞ t·ªëi thi·ªÉu (VND)', spend_above: 'Gi·ªõi h·∫°n chi ti√™u (VND)',
    account_disabled: 'Kh√¥ng c·∫ßn gi√° tr·ªã', no_conversion: 'Sau bao nhi√™u gi·ªù'
  };
  const ACTION_LABELS = {
    pause_campaign: 'T·∫°m d·ª´ng chi·∫øn d·ªãch', pause_adset: 'T·∫°m d·ª´ng nh√≥m QC',
    pause_ad: 'T·∫°m d·ª´ng qu·∫£ng c√°o', notify_only: 'Ch·ªâ c·∫£nh b√°o'
  };

  function saveRules() {
    localStorage.setItem('gz_ad_rules', JSON.stringify(rules));
    document.getElementById('countRules').textContent = rules.filter(r=>r.enabled).length;
  }

  function addRuleLog(ruleId, msg, type='ok') {
    const log = { id: Date.now(), ruleId, msg, type, time: new Date().toLocaleString('vi-VN') };
    ruleLogs.unshift(log);
    if (ruleLogs.length > 100) ruleLogs = ruleLogs.slice(0, 100);
    localStorage.setItem('gz_rule_logs', JSON.stringify(ruleLogs));
  }

  function openRuleModal(editId) {
    ruleEditId = editId || null;
    if (editId) {
      const r = rules.find(x=>x.id===editId);
      if (!r) return;
      document.getElementById('ruleName').value = r.name;
      document.getElementById('ruleCondType').value = r.condType;
      document.getElementById('ruleCondValue').value = r.condValue || '';
      document.getElementById('ruleAction').value = r.action;
      document.getElementById('ruleScope').value = r.scope;
      document.getElementById('ruleNotifyBrowser').checked = r.notifyBrowser !== false;
      document.getElementById('ruleNotifyLog').checked = r.notifyLog !== false;
    } else {
      document.getElementById('ruleName').value = '';
      document.getElementById('ruleCondType').value = 'spend_spike';
      document.getElementById('ruleCondValue').value = '';
      document.getElementById('ruleAction').value = 'pause_campaign';
      document.getElementById('ruleScope').value = 'all';
      document.getElementById('ruleNotifyBrowser').checked = true;
      document.getElementById('ruleNotifyLog').checked = true;
    }
    updateCondUnit();
    document.getElementById('ruleModal').style.display = 'flex';
  }
  function closeRuleModal() { document.getElementById('ruleModal').style.display = 'none'; }

  function updateCondUnit() {
    const t = document.getElementById('ruleCondType').value;
    document.getElementById('condUnit').textContent = COND_UNITS[t] || '';
    document.getElementById('condValueLabel').textContent = COND_LABELS[t] || 'Gi√° tr·ªã ng∆∞·ª°ng';
    const noVal = t === 'account_disabled';
    document.getElementById('ruleCondValue').disabled = noVal;
    document.getElementById('ruleCondValue').placeholder = noVal ? 'Kh√¥ng c·∫ßn' : '50';
  }

  function saveRule() {
    const name = document.getElementById('ruleName').value.trim();
    if (!name) { toast('Vui l√≤ng nh·∫≠p t√™n quy t·∫Øc', 'error'); return; }
    const condType = document.getElementById('ruleCondType').value;
    const condValue = parseFloat(document.getElementById('ruleCondValue').value) || 0;
    const action = document.getElementById('ruleAction').value;
    const scope = document.getElementById('ruleScope').value;
    const notifyBrowser = document.getElementById('ruleNotifyBrowser').checked;
    const notifyLog = document.getElementById('ruleNotifyLog').checked;

    if (ruleEditId) {
      const idx = rules.findIndex(r=>r.id===ruleEditId);
      if (idx >= 0) rules[idx] = { ...rules[idx], name, condType, condValue, action, scope, notifyBrowser, notifyLog };
    } else {
      rules.push({ id: Date.now(), name, condType, condValue, action, scope, notifyBrowser, notifyLog, enabled: true, createdAt: new Date().toISOString(), lastTriggered: null, triggerCount: 0 });
    }
    saveRules();
    closeRuleModal();
    renderRules();
    toast('L∆∞u quy t·∫Øc th√†nh c√¥ng!', 'success');
  }

  function toggleRule(id) {
    const r = rules.find(x=>x.id===id);
    if (r) { r.enabled = !r.enabled; saveRules(); renderRules(); }
  }

  function deleteRule(id) {
    if (!confirm('X√≥a quy t·∫Øc n√†y?')) return;
    rules = rules.filter(r=>r.id!==id);
    saveRules(); renderRules();
    toast('D·∫° x√≥a r·ªìi!', 'info');
  }

  function applyPreset(type) {
    const presets = {
      spend_spike: { name: 'T·∫Øt khi th·ªëc ti·ªÅn ƒë·ªôt ng·ªôt', condType: 'spend_spike', condValue: 50, action: 'pause_campaign', scope: 'all' },
      high_cpc: { name: 'T·∫Øt khi CPC qu√° ƒë·∫Øt', condType: 'cpc_above', condValue: 50000, action: 'pause_campaign', scope: 'all' },
      low_balance: { name: 'C·∫£nh b√°o s·∫Øp h·∫øt ti·ªÅn', condType: 'balance_below', condValue: 500000, action: 'notify_only', scope: 'all' },
      account_disabled: { name: 'T√†i kho·∫£n b·ªã v√¥ hi·ªáu h√≥a', condType: 'account_disabled', condValue: 0, action: 'pause_campaign', scope: 'all' }
    };
    const p = presets[type];
    if (!p) return;
    rules.push({ id: Date.now(), ...p, notifyBrowser: true, notifyLog: true, enabled: true, createdAt: new Date().toISOString(), lastTriggered: null, triggerCount: 0 });
    saveRules(); renderRules();
    toast(`ƒê√£ th√™m quy t·∫Øc: ${p.name}`, 'success');
  }

  function renderRules() {
    const el = document.getElementById('rulesList');
    if (!rules.length) {
      el.innerHTML = `<div style="text-align:center;padding:40px;color:rgba(255,255,255,.3)">
        <i class="bi bi-robot" style="font-size:40px;display:block;margin-bottom:12px;opacity:.3"></i>
        Ch∆∞a c√≥ quy t·∫Øc n√†o. Ch·ªçn m·∫´u c√≥ s·∫µn ho·∫∑c t·∫°o m·ªõi.
      </div>`;
      return;
    }
    const logsHtml = ruleLogs.length ? `
      <div class="log-section">
        <div class="log-title"><i class="bi bi-journal-text"></i> L·ªãch s·ª≠ k√≠ch ho·∫°t (${ruleLogs.length})</div>
        ${ruleLogs.slice(0,10).map(l=>`<div class="log-item"><span class="log-time">${l.time}</span><span class="log-msg ${l.type}">${l.msg}</span></div>`).join('')}
      </div>` : '';

    el.innerHTML = rules.map(r => {
      const lastT = r.lastTriggered ? `K√≠ch ho·∫°t l·∫ßn cu·ªëi: ${new Date(r.lastTriggered).toLocaleString('vi-VN')}` : 'Ch∆∞a k√≠ch ho·∫°t';
      const condText = COND_LABELS[r.condType] + (r.condValue ? ` ‚â• ${r.condValue.toLocaleString('vi-VN')} ${COND_UNITS[r.condType]}` : '');
      return `<div class="rule-card ${r.enabled ? 'active-rule' : ''}" id="rule-${r.id}">
        <label class="rule-toggle"><input type="checkbox" ${r.enabled?'checked':''} onchange="toggleRule(${r.id})"><span class="rule-slider"></span></label>
        <div class="rule-info">
          <div class="rule-name">${r.name}</div>
          <div class="rule-meta"><i class="bi bi-funnel" style="color:#c084fc"></i> ${condText} &nbsp;‚Ä¢&nbsp; <i class="bi bi-lightning" style="color:#fbbf24"></i> ${ACTION_LABELS[r.action]} &nbsp;‚Ä¢&nbsp; <i class="bi bi-people"></i> ${r.scope==='all'?'T·∫•t c·∫£ TKQC':'TKQC ƒëang ch·ªçn'}</div>
          <div class="rule-log">‚ö° ${lastT} &nbsp;‚Ä¢&nbsp; K√≠ch ho·∫°t ${r.triggerCount||0} l·∫ßn</div>
        </div>
        <div class="rule-actions">
          <button class="btn-icon btn-sm" onclick="openRuleModal(${r.id})" title="S·ª≠a"><i class="bi bi-pencil"></i></button>
          <button class="btn-icon btn-sm" onclick="deleteRule(${r.id})" title="X√≥a" style="color:#f87171"><i class="bi bi-trash"></i></button>
        </div>
      </div>`;
    }).join('') + logsHtml;
  }

  // Rule checker - runs every 15 minutes
  async function checkRules() {
    const enabledRules = rules.filter(r => r.enabled);
    if (!enabledRules.length) return;
    if (!S.token && !S.jwt) return;

    try {
      let accounts = S.accounts;
      if (!accounts.length) {
        // Load minimal account data for rule checking
        if (S.token) {
          const r = await fetch(`${FB_GRAPH}/me/adaccounts?fields=id,name,account_status,balance,amount_spent&limit=50&access_token=${S.token}`);
          const d = await r.json();
          accounts = d.data || [];
        }
      }

      for (const rule of enabledRules) {
        for (const acc of accounts) {
          let triggered = false;
          let triggerMsg = '';

          if (rule.condType === 'account_disabled') {
            if ([2,7,9].includes(acc.account_status)) {
              triggered = true;
              triggerMsg = `TKQC "${acc.name}" b·ªã v√¥ hi·ªáu h√≥a (tr·∫°ng th√°i: ${acc.account_status})`;
            }
          } else if (rule.condType === 'balance_below') {
            const bal = parseFloat(acc.balance || 0);
            if (bal < rule.condValue) {
              triggered = true;
              triggerMsg = `TKQC "${acc.name}" s·ªë d∆∞ ${bal.toLocaleString('vi-VN')} VND d∆∞·ªõi ng∆∞·ª°ng ${rule.condValue.toLocaleString('vi-VN')} VND`;
            }
          } else if (rule.condType === 'spend_above') {
            const spent = parseFloat(acc.amount_spent || 0);
            if (spent > rule.condValue) {
              triggered = true;
              triggerMsg = `TKQC "${acc.name}" chi ti√™u ${spent.toLocaleString('vi-VN')} VND v∆∞·ª£t gi·ªõi h·∫°n ${rule.condValue.toLocaleString('vi-VN')} VND`;
            }
          }
          // CPC/CPM/CTR checks require insights data (loaded separately)
          else if (rule.condType === 'cpc_above' && acc._insights) {
            const cpc = parseFloat(acc._insights.cpc || 0);
            if (cpc > rule.condValue) {
              triggered = true;
              triggerMsg = `TKQC "${acc.name}" CPC ${cpc.toLocaleString('vi-VN')} VND v∆∞·ª£t ng∆∞·ª°ng ${rule.condValue.toLocaleString('vi-VN')} VND`;
            }
          }

          if (triggered) {
            rule.lastTriggered = new Date().toISOString();
            rule.triggerCount = (rule.triggerCount || 0) + 1;
            if (rule.notifyLog) addRuleLog(rule.id, `[${rule.name}] ${triggerMsg}`, 'triggered');
            if (rule.notifyBrowser && 'Notification' in window) {
              Notification.requestPermission().then(p => {
                if (p === 'granted') new Notification('GenZTech Alert ‚ö°', { body: triggerMsg, icon: 'https://ui-avatars.com/api/?name=GZ&background=1877f2&color=fff' });
              });
            }
            toast(`‚ö° Quy t·∫Øc k√≠ch ho·∫°t: ${triggerMsg}`, 'error');
            // Execute action
            if (rule.action !== 'notify_only' && S.jwt) {
              try {
                await fetch(`${API_BASE}/api/facebook/proxy/pause-campaigns`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${S.jwt}` },
                  body: JSON.stringify({ accountId: acc.id, level: rule.action.replace('pause_',''), reason: rule.name })
                });
                addRuleLog(rule.id, `‚Üí ƒê√£ th·ª±c hi·ªán: ${ACTION_LABELS[rule.action]} cho ${acc.name}`, 'ok');
              } catch(e) { addRuleLog(rule.id, `L·ªói th·ª±c hi·ªán: ${e.message}`, 'triggered'); }
            }
          }
        }
      }
      saveRules();
      if (S.currentTab === 'rules') renderRules();
    } catch(e) { console.warn('Rule check error:', e); }
  }

  // Start rule checker
  function startRuleChecker() {
    if (ruleCheckInterval) clearInterval(ruleCheckInterval);
    ruleCheckInterval = setInterval(checkRules, 15 * 60 * 1000); // 15 min
    document.getElementById('countRules').textContent = rules.filter(r=>r.enabled).length;
  }

  init();
  startRuleChecker();
  </script>
</body>
</html>
