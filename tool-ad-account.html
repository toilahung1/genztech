<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Kiểm Tra TKQC — GenZTech</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <style>
    html,body{scrollbar-width:none;-ms-overflow-style:none;cursor:none;-webkit-user-select:none;user-select:none;margin:0;padding:0;font-family:'Inter',sans-serif;background:#080c1e;color:#fff}
    html::-webkit-scrollbar,body::-webkit-scrollbar{display:none;width:0}
    canvas.bg-canvas{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0}
    #custom-cursor{position:fixed;width:20px;height:20px;border-radius:50%;border:2px solid rgba(0,212,255,.8);pointer-events:none;z-index:9999;transform:translate(-50%,-50%);transition:opacity .3s;opacity:0;mix-blend-mode:screen}
    .app-layout{display:flex;min-height:100vh;position:relative;z-index:1}
    /* Sidebar */
    .sidebar{width:240px;flex-shrink:0;background:rgba(10,14,39,.92);backdrop-filter:blur(20px);border-right:1px solid rgba(255,255,255,.06);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:40}
    .sidebar-logo{padding:18px 18px 14px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;gap:10px;text-decoration:none}
    .sidebar-logo img{width:34px;height:34px;border-radius:50%}
    .sidebar-logo span{font-size:14px;font-weight:700;letter-spacing:.5px;color:#fff}
    .sidebar-logo span em{color:#00d4ff;font-style:normal}
    .sidebar-nav{flex:1;padding:10px 0;overflow-y:auto}
    .nav-group-label{font-size:10px;font-weight:600;letter-spacing:1.2px;color:rgba(255,255,255,.3);text-transform:uppercase;padding:10px 18px 4px}
    .nav-item{display:flex;align-items:center;gap:10px;padding:9px 18px;font-size:13px;color:rgba(255,255,255,.6);text-decoration:none;transition:all .2s;border-left:2px solid transparent}
    .nav-item:hover{color:#fff;background:rgba(255,255,255,.04)}
    .nav-item.active{color:#00d4ff;background:rgba(0,212,255,.08);border-left-color:#00d4ff}
    .nav-item i{width:17px;text-align:center;font-size:14px}
    .nav-sub-item{display:flex;align-items:center;gap:10px;padding:7px 18px 7px 34px;font-size:12px;color:rgba(255,255,255,.5);text-decoration:none;transition:all .2s;border-left:2px solid transparent}
    .nav-sub-item:hover{color:#fff;background:rgba(255,255,255,.04)}
    .nav-sub-item.active{color:#00d4ff;background:rgba(0,212,255,.06);border-left-color:#00d4ff}
    .sidebar-footer{padding:14px 18px;border-top:1px solid rgba(255,255,255,.06)}
    .conn-status{display:flex;align-items:center;gap:8px;font-size:12px;color:rgba(255,255,255,.5)}
    .conn-dot{width:7px;height:7px;border-radius:50%;background:#ef4444;flex-shrink:0}
    .conn-dot.online{background:#22c55e;box-shadow:0 0 6px #22c55e}
    /* Main */
    .main-content{margin-left:240px;flex:1;display:flex;flex-direction:column;min-height:100vh}
    .topbar{position:sticky;top:0;z-index:30;background:rgba(10,14,39,.9);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,.06);padding:0 24px;height:58px;display:flex;align-items:center;justify-content:space-between}
    .topbar-left{display:flex;align-items:center;gap:10px}
    .breadcrumb{font-size:12.5px;color:rgba(255,255,255,.4);display:flex;align-items:center;gap:6px}
    .breadcrumb span{color:#fff;font-weight:600}
    .topbar-right{display:flex;align-items:center;gap:8px}
    .btn{padding:7px 14px;border-radius:8px;font-size:12.5px;font-weight:600;border:none;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
    .btn-primary{background:#1877f2;color:#fff}.btn-primary:hover{background:#1565d8}
    .btn-outline{background:transparent;color:rgba(255,255,255,.7);border:1px solid rgba(255,255,255,.15)}.btn-outline:hover{border-color:#00d4ff;color:#00d4ff}
    .btn-sm{padding:5px 12px;font-size:12px}
    .btn-icon{padding:6px 10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);color:rgba(255,255,255,.6);border-radius:8px;cursor:pointer;font-size:13px;display:inline-flex;align-items:center;gap:5px;transition:all .2s}.btn-icon:hover{background:rgba(255,255,255,.1);color:#fff}
    /* Page */
    .page-body{padding:20px 24px;flex:1}
    /* Token banner */
    .token-banner{background:rgba(251,191,36,.06);border:1px solid rgba(251,191,36,.15);border-radius:10px;padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;gap:12px;font-size:12.5px}
    .token-banner.success{background:rgba(34,197,94,.06);border-color:rgba(34,197,94,.15)}
    /* Tabs */
    .tabs-bar{display:flex;gap:0;border-bottom:1px solid rgba(255,255,255,.08);margin-bottom:0;background:rgba(255,255,255,.02);border-radius:12px 12px 0 0;overflow:hidden}
    .tab-btn{padding:12px 20px;font-size:13px;font-weight:600;color:rgba(255,255,255,.5);background:none;border:none;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:7px;border-bottom:2px solid transparent;white-space:nowrap}
    .tab-btn:hover{color:#fff;background:rgba(255,255,255,.04)}
    .tab-btn.active{color:#00d4ff;border-bottom-color:#00d4ff;background:rgba(0,212,255,.06)}
    .tab-btn .tab-count{background:rgba(0,212,255,.15);color:#00d4ff;font-size:10px;font-weight:700;padding:1px 7px;border-radius:20px}
    /* Table */
    .table-wrap{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:0 0 12px 12px;overflow:hidden}
    .table-toolbar{padding:12px 16px;display:flex;align-items:center;gap:10px;border-bottom:1px solid rgba(255,255,255,.06)}
    .search-box{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:6px 12px;flex:1;max-width:320px}
    .search-box input{background:none;border:none;outline:none;color:#fff;font-size:12.5px;width:100%}
    .search-box input::placeholder{color:rgba(255,255,255,.3)}
    .search-box i{color:rgba(255,255,255,.3);font-size:13px}
    table{width:100%;border-collapse:collapse}
    thead tr{border-bottom:1px solid rgba(255,255,255,.07)}
    thead th{padding:10px 14px;font-size:11px;font-weight:600;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.7px;text-align:left;white-space:nowrap;cursor:pointer;user-select:none}
    thead th:hover{color:rgba(255,255,255,.7)}
    thead th i{font-size:10px;margin-left:4px}
    tbody tr{border-bottom:1px solid rgba(255,255,255,.04);transition:background .15s;cursor:pointer}
    tbody tr:hover{background:rgba(255,255,255,.04)}
    tbody tr:last-child{border-bottom:none}
    tbody td{padding:11px 14px;font-size:13px;color:rgba(255,255,255,.85)}
    .td-name{font-weight:600;color:#fff}
    .td-id{font-size:11px;color:rgba(255,255,255,.35);margin-top:2px}
    .badge{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:600}
    .badge-green{background:rgba(34,197,94,.12);color:#4ade80}
    .badge-red{background:rgba(239,68,68,.12);color:#f87171}
    .badge-yellow{background:rgba(251,191,36,.12);color:#fbbf24}
    .badge-gray{background:rgba(255,255,255,.08);color:rgba(255,255,255,.5)}
    .badge-blue{background:rgba(24,119,242,.15);color:#60a5fa}
    .badge::before{content:'';width:5px;height:5px;border-radius:50%;background:currentColor}
    /* Checkbox */
    input[type=checkbox]{accent-color:#00d4ff;width:14px;height:14px;cursor:pointer}
    /* Empty / loading */
    .empty-state{text-align:center;padding:60px 20px;color:rgba(255,255,255,.3)}
    .empty-state i{font-size:48px;margin-bottom:12px;display:block;opacity:.3}
    .empty-state p{font-size:13.5px}
    .loading-row td{text-align:center;padding:40px;color:rgba(255,255,255,.3)}
    .spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.2);border-top-color:#00d4ff;border-radius:50%;animation:spin .7s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* Detail panel */
    .detail-panel{background:rgba(10,14,39,.95);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:20px;margin-top:16px;display:none}
    .detail-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px}
    .detail-item{background:rgba(255,255,255,.04);border-radius:8px;padding:12px 14px}
    .detail-label{font-size:11px;color:rgba(255,255,255,.4);margin-bottom:4px;text-transform:uppercase;letter-spacing:.6px}
    .detail-value{font-size:14px;font-weight:700}
    /* Stats row */
    .stats-row{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:16px}
    .stat-mini{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);border-radius:10px;padding:12px 14px}
    .stat-mini .lbl{font-size:10.5px;color:rgba(255,255,255,.4);margin-bottom:4px;text-transform:uppercase;letter-spacing:.6px}
    .stat-mini .val{font-size:18px;font-weight:700}
    /* Token modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;display:none;align-items:center;justify-content:center}
    .modal-overlay.open{display:flex}
    .modal-box{background:#0f1535;border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:28px;width:500px;max-width:95vw}
    .modal-title{font-size:16px;font-weight:700;margin-bottom:6px}
    .modal-sub{font-size:12.5px;color:rgba(255,255,255,.4);margin-bottom:20px}
    .form-group{margin-bottom:14px}
    .form-label{font-size:12px;color:rgba(255,255,255,.5);margin-bottom:6px;display:block;font-weight:600}
    .form-control{width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:9px 12px;color:#fff;font-size:13px;outline:none;box-sizing:border-box;transition:border-color .2s}
    .form-control:focus{border-color:#00d4ff}
    /* Toast */
    #toast{position:fixed;bottom:24px;right:24px;z-index:9999;display:flex;flex-direction:column;gap:8px}
    .toast-item{background:#1e2a4a;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:12px 18px;font-size:13px;display:flex;align-items:center;gap:10px;animation:slideIn .3s ease;min-width:260px}
    .toast-item.success{border-left:3px solid #22c55e}
    .toast-item.error{border-left:3px solid #ef4444}
    .toast-item.info{border-left:3px solid #00d4ff}
    @keyframes slideIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
    /* Pagination */
    .pagination{display:flex;align-items:center;gap:6px;padding:12px 16px;border-top:1px solid rgba(255,255,255,.06)}
    .page-btn{padding:5px 10px;border-radius:6px;font-size:12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);color:rgba(255,255,255,.6);cursor:pointer;transition:all .2s}
    .page-btn:hover,.page-btn.active{background:rgba(0,212,255,.15);border-color:#00d4ff;color:#00d4ff}
    .page-btn:disabled{opacity:.3;cursor:not-allowed}
    /* Responsive */
    @media(max-width:768px){.sidebar{display:none}.main-content{margin-left:0}.stats-row{grid-template-columns:repeat(2,1fr)}.detail-grid{grid-template-columns:repeat(2,1fr)}}
  </style>
</head>
<body>
  <canvas class="bg-canvas" id="stars-canvas"></canvas>
  <canvas class="bg-canvas" id="data-particles"></canvas>
  <div id="custom-cursor"></div>
  <div id="toast"></div>

  <!-- Token Modal -->
  <div class="modal-overlay" id="tokenModal">
    <div class="modal-box">
      <div class="modal-title"><i class="bi bi-key" style="color:#fbbf24"></i> Nhập Access Token Thủ Công</div>
      <div class="modal-sub">Dùng khi Facebook cấm OAuth. Lấy token tại <a href="https://developers.facebook.com/tools/explorer/" target="_blank" style="color:#1877f2">Graph API Explorer</a> → chọn quyền <code style="background:rgba(255,255,255,.08);padding:1px 6px;border-radius:4px;font-size:11px">ads_read, ads_management</code></div>
      <div class="form-group">
        <label class="form-label">Facebook Access Token</label>
        <input type="password" class="form-control" id="tokenInput" placeholder="EAAxxxxxxxxxxxxxxx..." autocomplete="off">
        <div style="font-size:11px;color:rgba(255,255,255,.3);margin-top:5px">Token sẽ được lưu vào trình duyệt, không gửi lên server</div>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
        <button class="btn btn-outline" onclick="closeTokenModal()">Hủy</button>
        <button class="btn btn-primary" onclick="saveToken()"><i class="bi bi-save"></i> Lưu Token</button>
      </div>
    </div>
  </div>

  <div class="app-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <a href="index.html" class="sidebar-logo">
        <img src="https://ui-avatars.com/api/?name=GZ&background=1877f2&color=fff&bold=true" alt="logo">
        <span>GENZ<em>TECH</em></span>
      </a>
      <nav class="sidebar-nav">
        <div class="nav-group-label">Công Cụ</div>
        <a href="index.html" class="nav-item"><i class="bi bi-grid-1x2"></i> Dashboard</a>
        <a href="auto-post.html" class="nav-item"><i class="bi bi-send"></i> Tự Động Đăng Bài</a>
        <a href="ads-assistant.html" class="nav-item" onclick="toggleSubNav(event,'subNavAds')">
          <i class="bi bi-megaphone"></i> Trợ Lý Quảng Cáo
          <i class="bi bi-chevron-down" id="subNavAdsArrow" style="margin-left:auto;font-size:11px;transition:transform .2s"></i>
        </a>
        <div id="subNavAds" style="display:block">
          <a href="tool-ad-account.html" class="nav-sub-item active"><i class="bi bi-shield-check"></i> Kiểm Tra TKQC</a>
          <a href="tool-fb-id.html" class="nav-sub-item"><i class="bi bi-person-badge"></i> Tìm Facebook ID</a>
          <a href="tool-budget.html" class="nav-sub-item"><i class="bi bi-graph-up-arrow"></i> Phân Tích Ngân Sách</a>
          <a href="tool-translate.html" class="nav-sub-item"><i class="bi bi-translate"></i> Dịch Thuật</a>
          <a href="tool-ads-finder.html" class="nav-sub-item"><i class="bi bi-binoculars"></i> Ads Finder</a>
          <a href="tool-policy.html" class="nav-sub-item"><i class="bi bi-journal-text"></i> Chính Sách FB</a>
          <a href="tool-cookie.html" class="nav-sub-item"><i class="bi bi-cookie"></i> Quản Lý Cookie</a>
        </div>
        <a href="#" class="nav-item" onclick="openSettings()"><i class="bi bi-gear"></i> Cài Đặt</a>
      </nav>
      <div class="sidebar-footer">
        <div class="conn-status" id="connStatus">
          <div class="conn-dot" id="connDot"></div>
          <span id="connText">Chưa kết nối</span>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <div class="main-content">
      <div class="topbar">
        <div class="topbar-left">
          <div class="breadcrumb">
            <a href="ads-assistant.html" style="color:rgba(255,255,255,.4);text-decoration:none">Trợ Lý QC</a>
            <i class="bi bi-chevron-right" style="font-size:10px"></i>
            <span>Kiểm Tra TKQC</span>
          </div>
        </div>
        <div class="topbar-right">
          <button class="btn-icon" onclick="refreshData()" title="Làm mới"><i class="bi bi-arrow-clockwise"></i></button>
          <button class="btn-icon" onclick="openTokenModal()" title="Cài đặt token"><i class="bi bi-key"></i> <span id="tokenIndicator" style="font-size:11px;display:none;color:#4ade80">●</span></button>

          <div id="userBadge" style="display:none;align-items:center;gap:8px;font-size:12.5px">
            <div style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#1877f2,#00d4ff);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px" id="userAvatar">?</div>
            <span id="userName" style="color:rgba(255,255,255,.8)"></span>
          </div>
        </div>
      </div>

      <div class="page-body">

        <div id="tokenBanner" class="token-banner success" style="display:none">
          <i class="bi bi-key-fill" style="color:#4ade80;font-size:16px"></i>
          <div style="flex:1;font-size:12px">
            <strong style="color:#4ade80">Token thủ công đang dùng</strong> — Đang gọi thẳng Facebook Graph API.
          </div>
          <button class="btn btn-outline btn-sm" onclick="openTokenModal()">Đổi token</button>
          <button class="btn btn-sm" onclick="clearToken()" style="background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.2);color:#f87171">Xóa</button>
        </div>

        <!-- Stats row -->
        <div class="stats-row" id="statsRow" style="display:none">
          <div class="stat-mini"><div class="lbl">Tổng TKQC</div><div class="val" id="sTotalAcc">—</div></div>
          <div class="stat-mini"><div class="lbl">Đang hoạt động</div><div class="val" style="color:#4ade80" id="sActiveAcc">—</div></div>
          <div class="stat-mini"><div class="lbl">Bị khóa / Vô hiệu</div><div class="val" style="color:#f87171" id="sLockedAcc">—</div></div>
          <div class="stat-mini"><div class="lbl">Tổng chi tiêu</div><div class="val" style="color:#60a5fa;font-size:14px" id="sTotalSpend">—</div></div>
          <div class="stat-mini"><div class="lbl">Số dư khả dụng</div><div class="val" style="color:#4ade80;font-size:14px" id="sTotalBalance">—</div></div>
        </div>

        <!-- Tabs + Table -->
        <div>
          <div class="tabs-bar">
            <button class="tab-btn active" id="tab-accounts" onclick="switchTab('accounts')">
              <i class="bi bi-credit-card"></i> Tài khoản quảng cáo
              <span class="tab-count" id="countAccounts">0</span>
            </button>
            <button class="tab-btn" id="tab-campaigns" onclick="switchTab('campaigns')">
              <i class="bi bi-flag"></i> Chiến dịch
              <span class="tab-count" id="countCampaigns">0</span>
            </button>
            <button class="tab-btn" id="tab-adsets" onclick="switchTab('adsets')">
              <i class="bi bi-collection"></i> Nhóm quảng cáo
              <span class="tab-count" id="countAdsets">0</span>
            </button>
            <button class="tab-btn" id="tab-ads" onclick="switchTab('ads')">
              <i class="bi bi-megaphone"></i> Quảng cáo
              <span class="tab-count" id="countAds">0</span>
            </button>
            <button class="tab-btn" id="tab-rules" onclick="switchTab('rules')">
              <i class="bi bi-robot"></i> Quy Tắc Tự Động
              <span class="tab-count" id="countRules" style="background:rgba(168,85,247,.2);color:#c084fc">0</span>
            </button>
          </div>

          <div class="table-wrap">
            <div class="table-toolbar">
              <div class="search-box">
                <i class="bi bi-search"></i>
                <input type="text" id="searchInput" placeholder="Tìm kiếm..." oninput="filterTable()">
              </div>
              <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
                <span id="selectedCount" style="font-size:12px;color:rgba(255,255,255,.4);display:none"></span>
                <select class="form-control" id="datePreset" onchange="loadCurrentTab()" style="width:auto;font-size:12px;padding:5px 10px">
                  <option value="today">Hôm nay</option>
                  <option value="yesterday">Hôm qua</option>
                  <option value="last_7d" selected>7 ngày qua</option>
                  <option value="last_30d">30 ngày qua</option>
                  <option value="this_month">Tháng này</option>
                  <option value="last_month">Tháng trước</option>
                </select>
                <button class="btn-icon btn-sm" onclick="exportCSV()"><i class="bi bi-download"></i> Xuất CSV</button>
              </div>
            </div>

            <!-- Tab: Accounts -->
            <div id="panel-accounts">
              <table>
                <thead>
                  <tr>
                    <th style="width:36px"><input type="checkbox" id="checkAll" onchange="toggleCheckAll(this)"></th>
                    <th onclick="sortTable('accounts','name')">Tài khoản quảng cáo <i class="bi bi-arrow-down-up"></i></th>
                    <th onclick="sortTable('accounts','account_status')">Trạng thái tài khoản <i class="bi bi-arrow-down-up"></i></th>
                    <th>Quyền sở hữu</th>
                    <th>Loại tài khoản</th>
                    <th onclick="sortTable('accounts','currency')">Tiền tệ <i class="bi bi-arrow-down-up"></i></th>
                    <th onclick="sortTable('accounts','balance')">Số dư <i class="bi bi-arrow-down-up"></i></th>
                    <th onclick="sortTable('accounts','amount_spent')">Chi tiêu <i class="bi bi-arrow-down-up"></i></th>
                  </tr>
                </thead>
                <tbody id="tbody-accounts">
                  <tr class="loading-row"><td colspan="8"><span class="spinner"></span> Đang tải...</td></tr>
                </tbody>
              </table>
            </div>

            <!-- Tab: Campaigns -->
            <div id="panel-campaigns" style="display:none">
              <table>
                <thead>
                  <tr>
                    <th style="width:36px"><input type="checkbox"></th>
                    <th>Chiến dịch</th>
                    <th>Trạng thái</th>
                    <th>Mục tiêu</th>
                    <th>Ngân sách ngày</th>
                    <th>Chi tiêu</th>
                    <th>Lượt hiển thị</th>
                    <th>Lượt click</th>
                    <th>CTR</th>
                    <th>CPC</th>
                  </tr>
                </thead>
                <tbody id="tbody-campaigns">
                  <tr class="loading-row"><td colspan="10"><span class="spinner"></span> Chọn TKQC để xem chiến dịch</td></tr>
                </tbody>
              </table>
            </div>

            <!-- Tab: Ad Sets -->
            <div id="panel-adsets" style="display:none">
              <table>
                <thead>
                  <tr>
                    <th style="width:36px"><input type="checkbox"></th>
                    <th>Nhóm quảng cáo</th>
                    <th>Trạng thái</th>
                    <th>Chiến dịch</th>
                    <th>Ngân sách ngày</th>
                    <th>Chi tiêu</th>
                    <th>Lượt hiển thị</th>
                    <th>Lượt click</th>
                    <th>CPM</th>
                    <th>CPC</th>
                  </tr>
                </thead>
                <tbody id="tbody-adsets">
                  <tr class="loading-row"><td colspan="10"><span class="spinner"></span> Chọn TKQC để xem nhóm quảng cáo</td></tr>
                </tbody>
              </table>
            </div>

            <!-- Tab: Ads -->
            <div id="panel-ads" style="display:none">
              <table>
                <thead>
                  <tr>
                    <th style="width:36px"><input type="checkbox"></th>
                    <th>Quảng cáo</th>
                    <th>Trạng thái</th>
                    <th>Nhóm QC</th>
                    <th>Chi tiêu</th>
                    <th>Lượt hiển thị</th>
                    <th>Lượt click</th>
                    <th>CTR</th>
                    <th>CPC</th>
                    <th>CPM</th>
                  </tr>
                </thead>
                <tbody id="tbody-ads">
                  <tr class="loading-row"><td colspan="10"><span class="spinner"></span> Chọn TKQC để xem quảng cáo</td></tr>
                </tbody>
              </table>
            </div>

            <!-- Tab: Rules -->
            <div id="panel-rules" style="display:none">
              <div style="padding:20px">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
                  <div>
                    <div style="font-size:15px;font-weight:700"><i class="bi bi-robot" style="color:#c084fc"></i> Quy Tắc Tự Động</div>
                    <div style="font-size:12px;color:rgba(255,255,255,.4);margin-top:3px">Kiểm tra mỗi 15 phút. Tự động tắt/cảnh báo khi điều kiện xảy ra.</div>
                  </div>
                  <button class="btn btn-primary" onclick="openRuleModal()" style="background:linear-gradient(135deg,#7c3aed,#a855f7)">
                    <i class="bi bi-plus-lg"></i> Tạo Quy Tắc
                  </button>
                </div>
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:20px" id="presetCards">
                  <div class="preset-card" onclick="applyPreset('spend_spike')">
                    <div class="preset-icon" style="background:rgba(239,68,68,.1);color:#f87171"><i class="bi bi-lightning-charge-fill"></i></div>
                    <div class="preset-info"><div class="preset-title">Tắt khi thốc tiền đột ngột</div><div class="preset-desc">Chi tiêu tăng &gt;50% so với trung bình 3 ngày trước</div></div>
                    <span class="preset-badge" style="background:rgba(239,68,68,.15);color:#f87171">Nhanh</span>
                  </div>
                  <div class="preset-card" onclick="applyPreset('high_cpc')">
                    <div class="preset-icon" style="background:rgba(251,191,36,.1);color:#fbbf24"><i class="bi bi-currency-dollar"></i></div>
                    <div class="preset-info"><div class="preset-title">Tắt khi CPC quá đắt</div><div class="preset-desc">CPC vượt ngưỡng tự đặt, hiệu quả kém</div></div>
                    <span class="preset-badge" style="background:rgba(251,191,36,.15);color:#fbbf24">Phổ biến</span>
                  </div>
                  <div class="preset-card" onclick="applyPreset('low_balance')">
                    <div class="preset-icon" style="background:rgba(34,197,94,.1);color:#4ade80"><i class="bi bi-wallet2"></i></div>
                    <div class="preset-info"><div class="preset-title">Cảnh báo sắp hết tiền</div><div class="preset-desc">Số dư TKQC xuống dưới ngưỡng đặt</div></div>
                    <span class="preset-badge" style="background:rgba(34,197,94,.15);color:#4ade80">Quan trọng</span>
                  </div>
                  <div class="preset-card" onclick="applyPreset('account_disabled')">
                    <div class="preset-icon" style="background:rgba(168,85,247,.1);color:#c084fc"><i class="bi bi-shield-x"></i></div>
                    <div class="preset-info"><div class="preset-title">Tài khoản bị vô hiệu hóa</div><div class="preset-desc">Dừng tất cả chiến dịch khi TKQC bị khóa</div></div>
                    <span class="preset-badge" style="background:rgba(168,85,247,.15);color:#c084fc">Tự động</span>
                  </div>
                </div>
                <div id="rulesList"></div>
              </div>
            </div>

            <div class="pagination" id="pagination" style="display:none"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Rule Modal -->
  <div class="modal-overlay" id="ruleModal">
    <div class="modal-box" style="width:560px">
      <div class="modal-title"><i class="bi bi-robot" style="color:#c084fc"></i> Tạo Quy Tắc Tự Động</div>
      <div class="modal-sub">Hệ thống kiểm tra mỗi 15 phút và thực hiện hành động khi điều kiện được thỏa mãn.</div>
      <div class="form-group">
        <label class="form-label">Tên quy tắc</label>
        <input type="text" class="form-control" id="ruleName" placeholder="Ví dụ: Tắt ads khi thốc tiền">
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="form-group">
          <label class="form-label">Loại điều kiện</label>
          <select class="form-control" id="ruleCondType" onchange="updateCondUnit()">
            <option value="spend_spike">Chi tiêu tăng đột ngột (%)</option>
            <option value="cpc_above">CPC vượt ngưỡng (VND)</option>
            <option value="cpm_above">CPM vượt ngưỡng (VND)</option>
            <option value="ctr_below">CTR dưới ngưỡng (%)</option>
            <option value="balance_below">Số dư dưới ngưỡng (VND)</option>
            <option value="spend_above">Tổng chi tiêu vượt giới hạn (VND)</option>
            <option value="account_disabled">Tài khoản bị vô hiệu hóa</option>
            <option value="no_conversion">Không có chuyển đổi sau X giờ</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label" id="condValueLabel">Giá trị ngưỡng</label>
          <div style="display:flex;align-items:center;gap:6px">
            <input type="number" class="form-control" id="ruleCondValue" placeholder="50" style="flex:1">
            <span id="condUnit" style="font-size:12px;color:rgba(255,255,255,.4);white-space:nowrap">%</span>
          </div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="form-group">
          <label class="form-label">Hành động</label>
          <select class="form-control" id="ruleAction">
            <option value="pause_campaign">Tạm dừng chiến dịch</option>
            <option value="pause_adset">Tạm dừng nhóm QC</option>
            <option value="pause_ad">Tạm dừng quảng cáo</option>
            <option value="notify_only">Chỉ cảnh báo (không tắt)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Áp dụng cho</label>
          <select class="form-control" id="ruleScope">
            <option value="all">Tất cả TKQC</option>
            <option value="selected">TKQC đang chọn</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Thông báo khi kích hoạt</label>
        <div style="display:flex;gap:16px;align-items:center">
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer">
            <input type="checkbox" id="ruleNotifyBrowser" checked style="accent-color:#c084fc"> Thông báo trình duyệt
          </label>
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer">
            <input type="checkbox" id="ruleNotifyLog" checked style="accent-color:#c084fc"> Ghi log
          </label>
        </div>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
        <button class="btn btn-outline" onclick="closeRuleModal()">Hủy</button>
        <button class="btn" onclick="saveRule()" style="background:linear-gradient(135deg,#7c3aed,#a855f7);color:#fff"><i class="bi bi-check-lg"></i> Lưu Quy Tắc</button>
      </div>
    </div>
  </div>

  <script src="js/ads-shared.js"></script>
  <script>
  // ── Constants ──
  const API_BASE = 'https://genztech-production.up.railway.app';
  const FB_GRAPH = 'https://graph.facebook.com/v19.0';
  const STATUS_MAP = {1:['Hoạt động','badge-green'],2:['Vô hiệu hóa','badge-red'],3:['Chưa xác nhận','badge-yellow'],7:['Bị khóa','badge-red'],9:['Đóng cửa','badge-gray'],100:['Đang xem xét','badge-yellow']};
  const CAMPAIGN_STATUS = {ACTIVE:['Đang chạy','badge-green'],PAUSED:['Tạm dừng','badge-yellow'],DELETED:['Đã xóa','badge-red'],ARCHIVED:['Lưu trữ','badge-gray']};
  const OBJECTIVE_MAP = {OUTCOME_TRAFFIC:'Lưu lượng',OUTCOME_AWARENESS:'Nhận thức',OUTCOME_ENGAGEMENT:'Tương tác',OUTCOME_LEADS:'Khách hàng tiềm năng',OUTCOME_SALES:'Doanh số',OUTCOME_APP_PROMOTION:'Ứng dụng',LINK_CLICKS:'Lượt click',CONVERSIONS:'Chuyển đổi',BRAND_AWARENESS:'Nhận thức thương hiệu',REACH:'Tiếp cận',VIDEO_VIEWS:'Xem video',MESSAGES:'Tin nhắn'};

  // ── CSS Rules ──
  (function(){
    const s=document.createElement('style');
    s.textContent=`
      .preset-card{display:flex;align-items:center;gap:12px;padding:14px 16px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:10px;cursor:pointer;transition:all .2s}
      .preset-card:hover{background:rgba(168,85,247,.06);border-color:rgba(168,85,247,.3);transform:translateY(-1px)}
      .preset-icon{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
      .preset-info{flex:1}
      .preset-title{font-size:13px;font-weight:600;color:#fff}
      .preset-desc{font-size:11.5px;color:rgba(255,255,255,.4);margin-top:2px}
      .preset-badge{font-size:10px;font-weight:700;padding:3px 8px;border-radius:20px;white-space:nowrap}
      .rule-card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:14px 16px;margin-bottom:10px;display:flex;align-items:center;gap:14px;transition:all .2s}
      .rule-card:hover{border-color:rgba(168,85,247,.3)}
      .rule-card.active-rule{border-color:rgba(168,85,247,.4);background:rgba(168,85,247,.04)}
      .rule-card.triggered{border-color:rgba(239,68,68,.4);background:rgba(239,68,68,.04)}
      .rule-toggle{position:relative;width:36px;height:20px;flex-shrink:0}
      .rule-toggle input{opacity:0;width:0;height:0}
      .rule-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,.15);border-radius:20px;transition:.3s}
      .rule-slider:before{content:'';position:absolute;height:14px;width:14px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s}
      .rule-toggle input:checked+.rule-slider{background:#7c3aed}
      .rule-toggle input:checked+.rule-slider:before{transform:translateX(16px)}
      .rule-info{flex:1}
      .rule-name{font-size:13px;font-weight:600;color:#fff}
      .rule-meta{font-size:11.5px;color:rgba(255,255,255,.4);margin-top:3px}
      .rule-log{font-size:11px;color:#c084fc;margin-top:4px}
      .rule-actions{display:flex;gap:6px}
      .log-section{margin-top:16px;background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.06);border-radius:8px;padding:12px}
      .log-title{font-size:12px;font-weight:600;color:rgba(255,255,255,.5);margin-bottom:8px;display:flex;align-items:center;gap:6px}
      .log-item{font-size:11.5px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.04);display:flex;gap:10px;align-items:flex-start}
      .log-item:last-child{border-bottom:none}
      .log-time{color:rgba(255,255,255,.3);white-space:nowrap;flex-shrink:0}
      .log-msg{color:rgba(255,255,255,.7)}
      .log-msg.triggered{color:#f87171}
      .log-msg.ok{color:#4ade80}
    `;
    document.head.appendChild(s);
  })();

  // ── State ──
  let S = {
    accounts: [], campaigns: [], adsets: [], ads: [],
    selectedAccountId: null, selectedAccountName: null,
    currentTab: 'accounts', sortField: null, sortAsc: true,
    page: 1, perPage: 20, searchQ: '',
    token: localStorage.getItem('gz_manual_fb_token') || null,
    jwt: localStorage.getItem('gz_jwt') || null,
    user: null
  };

  // ── Helpers ──
  function vnd(n) {
    if (!n && n !== 0) return '—';
    n = parseFloat(n);
    if (n >= 1e9) return (n/1e9).toFixed(1) + 'B';
    if (n >= 1e6) return (n/1e6).toFixed(1) + 'M';
    if (n >= 1e3) return (n/1e3).toFixed(0) + 'K';
    return n.toLocaleString('vi-VN');
  }
  function pct(n) { return n ? parseFloat(n).toFixed(2) + '%' : '—'; }
  function toast(msg, type='info') {
    const el = document.createElement('div');
    el.className = `toast-item ${type}`;
    const icons = {success:'check-circle-fill',error:'x-circle-fill',info:'info-circle-fill'};
    el.innerHTML = `<i class="bi bi-${icons[type]||'info-circle-fill'}" style="color:${type==='success'?'#4ade80':type==='error'?'#f87171':'#00d4ff'}"></i> ${msg}`;
    document.getElementById('toast').appendChild(el);
    setTimeout(() => el.remove(), 3500);
  }

  // ── Auth ──
  function goLogin() { window.location.href = 'auto-post.html'; }

  async function initAuth() {
    if (S.jwt) {
      try {
        const r = await fetch(`${API_BASE}/api/auth/me`, { headers: { Authorization: `Bearer ${S.jwt}` } });
        if (r.ok) {
          S.user = await r.json();
          document.getElementById('userBadge').style.display = 'flex';
          document.getElementById('userAvatar').textContent = (S.user.username || S.user.email || 'U')[0].toUpperCase();
          document.getElementById('userName').textContent = S.user.username || S.user.email || '';
          // loginBtn/loginBanner removed
          // Update sidebar conn status
          document.getElementById('connDot').classList.add('online');
          document.getElementById('connText').textContent = S.user.username || 'Đã đăng nhập';
        } else {
          showLoginBanner();
        }
      } catch(e) { showLoginBanner(); }
    } else {
      showLoginBanner();
    }
    // Token indicator
    if (S.token) {
      document.getElementById('tokenIndicator').style.display = 'inline';
      document.getElementById('tokenBanner').style.display = 'flex';
    }
  }

  function showLoginBanner() {
    // No login banner UI — user is redirected to auto-post.html if needed
    if (!S.token && !S.jwt) {
      toast('Vui lòng đăng nhập tại trang Tự Động Đăng Bài hoặc nhập token thủ công', 'info');
    }
  }

  // ── Token Modal ──
  function openTokenModal() {
    document.getElementById('tokenInput').value = S.token || '';
    document.getElementById('tokenModal').classList.add('open');
  }
  function closeTokenModal() { document.getElementById('tokenModal').classList.remove('open'); }
  function saveToken() {
    const t = document.getElementById('tokenInput').value.trim();
    if (!t) { toast('Vui lòng nhập token', 'error'); return; }
    if (!t.startsWith('EAA') && !t.startsWith('EAB') && !t.startsWith('EAAG')) {
      toast('Token không hợp lệ — phải bắt đầu bằng EAA', 'error'); return;
    }
    S.token = t;
    localStorage.setItem('gz_manual_fb_token', t);
    document.getElementById('tokenIndicator').style.display = 'inline';
    document.getElementById('tokenBanner').style.display = 'flex';
    closeTokenModal();
    toast('Lưu token thành công! Đang tải dữ liệu...', 'success');
    loadAccounts();
  }
  function clearToken() {
    S.token = null;
    localStorage.removeItem('gz_manual_fb_token');
    document.getElementById('tokenIndicator').style.display = 'none';
    document.getElementById('tokenBanner').style.display = 'none';
    toast('Đã xóa token thủ công', 'info');
    if (!S.jwt && !S.token) toast('Nhập token để tiếp tục sử dụng', 'info');
  }

  // ── API calls ──
  async function fbGet(path) {
    if (S.token) {
      const sep = path.includes('?') ? '&' : '?';
      const r = await fetch(`${FB_GRAPH}/${path}${sep}access_token=${S.token}`);
      const d = await r.json();
      if (d.error) throw new Error(d.error.message);
      return d;
    } else if (S.jwt) {
      const r = await fetch(`${API_BASE}/api/facebook/proxy/${path}`, {
        headers: { Authorization: `Bearer ${S.jwt}` }
      });
      const d = await r.json();
      if (!r.ok) throw new Error(d.error || 'Lỗi server');
      return d;
    } else {
      throw new Error('Chưa đăng nhập hoặc chưa có token');
    }
  }

  // ── Load Accounts ──
  async function loadAccounts() {
    const tbody = document.getElementById('tbody-accounts');
    tbody.innerHTML = '<tr class="loading-row"><td colspan="8"><span class="spinner"></span> Đang tải danh sách TKQC...</td></tr>';
    document.getElementById('statsRow').style.display = 'none';

    try {
      let accounts = [];
      if (S.token) {
        const datePreset = document.getElementById('datePreset').value;
        const r = await fetch(`${FB_GRAPH}/me/adaccounts?fields=id,name,account_status,balance,currency,amount_spent,spend_cap,account_id,owner,business,account_type&limit=50&access_token=${S.token}`);
        const d = await r.json();
        if (d.error) throw new Error(d.error.message);
        accounts = d.data || [];
        // Get insights for each account
        await Promise.all(accounts.map(async acc => {
          try {
            const ins = await fetch(`${FB_GRAPH}/${acc.id}/insights?fields=spend,impressions,clicks,reach&date_preset=${datePreset}&access_token=${S.token}`).then(r=>r.json());
            acc._insights = ins.data?.[0] || {};
          } catch(e) { acc._insights = {}; }
        }));
      } else if (S.jwt) {
        const r = await fetch(`${API_BASE}/api/facebook/proxy/my-ad-accounts`, {
          headers: { Authorization: `Bearer ${S.jwt}` }
        });
        const d = await r.json();
        if (!r.ok) throw new Error(d.error || 'Lỗi server');
        accounts = d.accounts || [];
      }

      S.accounts = accounts;
      document.getElementById('countAccounts').textContent = accounts.length;

      // Stats
      const active = accounts.filter(a => a.account_status === 1).length;
      const locked = accounts.filter(a => [2,7,9].includes(a.account_status)).length;
      const totalSpend = accounts.reduce((s, a) => s + parseFloat(a._insights?.spend || a.amount_spent || 0), 0);
      const totalBalance = accounts.reduce((s, a) => s + parseFloat(a.balance || 0), 0);
      document.getElementById('sTotalAcc').textContent = accounts.length;
      document.getElementById('sActiveAcc').textContent = active;
      document.getElementById('sLockedAcc').textContent = locked;
      document.getElementById('sTotalSpend').textContent = vnd(totalSpend);
      document.getElementById('sTotalBalance').textContent = vnd(totalBalance);
      document.getElementById('statsRow').style.display = 'grid';

      renderAccounts(accounts);
    } catch(e) {
      tbody.innerHTML = `<tr class="loading-row"><td colspan="8" style="color:#f87171"><i class="bi bi-x-circle"></i> ${e.message}</td></tr>`;
      toast(e.message, 'error');
    }
  }

  function renderAccounts(list) {
    const tbody = document.getElementById('tbody-accounts');
    if (!list.length) {
      tbody.innerHTML = '<tr><td colspan="8"><div class="empty-state"><i class="bi bi-inbox"></i><p>Không tìm thấy tài khoản quảng cáo nào</p></div></td></tr>';
      return;
    }
    // Apply search
    const q = S.searchQ.toLowerCase();
    const filtered = q ? list.filter(a => (a.name||'').toLowerCase().includes(q) || (a.id||'').includes(q)) : list;

    tbody.innerHTML = filtered.map(acc => {
      const [statusText, statusClass] = STATUS_MAP[acc.account_status] || ['Không rõ','badge-gray'];
      const isAdmin = acc.account_type === 1 || acc.owner ? 'ADMIN' : 'GENERAL_USER';
      const spend = acc._insights?.spend || acc.amount_spent || 0;
      return `<tr onclick="selectAccount('${acc.id}','${acc.name||acc.id}')">
        <td onclick="event.stopPropagation()"><input type="checkbox" class="row-check" value="${acc.id}"></td>
        <td>
          <div class="td-name">${acc.name || acc.id}</div>
          <div class="td-id">${acc.id}</div>
        </td>
        <td><span class="badge ${statusClass}">${statusText}</span></td>
        <td style="font-size:12px;color:rgba(255,255,255,.5)">${isAdmin}</td>
        <td style="font-size:12px;color:rgba(255,255,255,.5)">Doanh nghiệp</td>
        <td>
          <div style="font-size:13px;font-weight:600">${acc.currency || 'VND'}</div>
          <div style="font-size:11px;color:rgba(255,255,255,.35)">Trả sau</div>
        </td>
        <td style="color:#4ade80;font-weight:600">${vnd(parseFloat(acc.balance||0))}</td>
        <td style="color:#60a5fa;font-weight:600">${vnd(parseFloat(spend))}</td>
      </tr>`;
    }).join('');
  }

  // ── Select Account → Load Campaigns ──
  async function selectAccount(id, name) {
    S.selectedAccountId = id;
    S.selectedAccountName = name;
    toast(`Đã chọn: ${name}`, 'info');
    // Auto switch to campaigns tab
    switchTab('campaigns');
    await loadCampaigns(id);
  }

  async function loadCampaigns(accountId) {
    const tbody = document.getElementById('tbody-campaigns');
    tbody.innerHTML = '<tr class="loading-row"><td colspan="10"><span class="spinner"></span> Đang tải chiến dịch...</td></tr>';
    const datePreset = document.getElementById('datePreset').value;

    try {
      let campaigns = [];
      if (S.token) {
        const r = await fetch(`${FB_GRAPH}/${accountId}/campaigns?fields=id,name,status,objective,daily_budget,lifetime_budget,start_time,stop_time&limit=50&access_token=${S.token}`);
        const d = await r.json();
        if (d.error) throw new Error(d.error.message);
        campaigns = d.data || [];
        // Get insights
        await Promise.all(campaigns.map(async c => {
          try {
            const ins = await fetch(`${FB_GRAPH}/${c.id}/insights?fields=spend,impressions,clicks,ctr,cpc,reach&date_preset=${datePreset}&access_token=${S.token}`).then(r=>r.json());
            c._ins = ins.data?.[0] || {};
          } catch(e) { c._ins = {}; }
        }));
      } else if (S.jwt) {
        const r = await fetch(`${API_BASE}/api/facebook/proxy/ad-account/${accountId}?date_preset=${datePreset}`, {
          headers: { Authorization: `Bearer ${S.jwt}` }
        });
        const d = await r.json();
        if (!r.ok) throw new Error(d.error || 'Lỗi server');
        campaigns = d.campaigns || [];
      }

      S.campaigns = campaigns;
      document.getElementById('countCampaigns').textContent = campaigns.length;

      if (!campaigns.length) {
        tbody.innerHTML = '<tr><td colspan="10"><div class="empty-state"><i class="bi bi-flag"></i><p>Không có chiến dịch nào</p></div></td></tr>';
        return;
      }

      tbody.innerHTML = campaigns.map(c => {
        const [st, sc] = CAMPAIGN_STATUS[c.status] || ['Không rõ','badge-gray'];
        const obj = OBJECTIVE_MAP[c.objective] || c.objective || '—';
        const ins = c._ins || c.insights?.data?.[0] || {};
        return `<tr onclick="selectCampaign('${c.id}','${c.name}')">
          <td onclick="event.stopPropagation()"><input type="checkbox" class="row-check" value="${c.id}"></td>
          <td><div class="td-name">${c.name}</div><div class="td-id">${c.id}</div></td>
          <td><span class="badge ${sc}">${st}</span></td>
          <td style="font-size:12px;color:rgba(255,255,255,.6)">${obj}</td>
          <td style="color:#fbbf24">${c.daily_budget ? vnd(parseInt(c.daily_budget)/100) : '—'}</td>
          <td style="color:#60a5fa;font-weight:600">${vnd(parseFloat(ins.spend||0))}</td>
          <td>${vnd(parseInt(ins.impressions||0))}</td>
          <td>${vnd(parseInt(ins.clicks||0))}</td>
          <td>${pct(ins.ctr)}</td>
          <td>${ins.cpc ? vnd(parseFloat(ins.cpc)) : '—'}</td>
        </tr>`;
      }).join('');
    } catch(e) {
      tbody.innerHTML = `<tr class="loading-row"><td colspan="10" style="color:#f87171"><i class="bi bi-x-circle"></i> ${e.message}</td></tr>`;
      toast(e.message, 'error');
    }
  }

  async function selectCampaign(id, name) {
    switchTab('adsets');
    await loadAdsets(id, name);
  }

  async function loadAdsets(campaignId, campaignName) {
    const tbody = document.getElementById('tbody-adsets');
    tbody.innerHTML = '<tr class="loading-row"><td colspan="10"><span class="spinner"></span> Đang tải nhóm quảng cáo...</td></tr>';
    const datePreset = document.getElementById('datePreset').value;

    try {
      if (!S.token && !S.jwt) throw new Error('Chưa đăng nhập hoặc chưa có token');
      let adsets = [];
      if (S.token) {
        const r = await fetch(`${FB_GRAPH}/${campaignId}/adsets?fields=id,name,status,daily_budget,lifetime_budget,targeting,optimization_goal&limit=50&access_token=${S.token}`);
        const d = await r.json();
        if (d.error) throw new Error(d.error.message);
        adsets = d.data || [];
        await Promise.all(adsets.map(async a => {
          try {
            const ins = await fetch(`${FB_GRAPH}/${a.id}/insights?fields=spend,impressions,clicks,ctr,cpc,cpm&date_preset=${datePreset}&access_token=${S.token}`).then(r=>r.json());
            a._ins = ins.data?.[0] || {};
          } catch(e) { a._ins = {}; }
        }));
      }

      S.adsets = adsets;
      document.getElementById('countAdsets').textContent = adsets.length;

      if (!adsets.length) {
        tbody.innerHTML = `<tr><td colspan="10"><div class="empty-state"><i class="bi bi-collection"></i><p>Không có nhóm quảng cáo nào trong chiến dịch "${campaignName}"</p></div></td></tr>`;
        return;
      }

      tbody.innerHTML = adsets.map(a => {
        const [st, sc] = CAMPAIGN_STATUS[a.status] || ['Không rõ','badge-gray'];
        const ins = a._ins || {};
        return `<tr onclick="selectAdset('${a.id}','${a.name}')">
          <td onclick="event.stopPropagation()"><input type="checkbox" class="row-check" value="${a.id}"></td>
          <td><div class="td-name">${a.name}</div><div class="td-id">${a.id}</div></td>
          <td><span class="badge ${sc}">${st}</span></td>
          <td style="font-size:12px;color:rgba(255,255,255,.5)">${campaignName || '—'}</td>
          <td style="color:#fbbf24">${a.daily_budget ? vnd(parseInt(a.daily_budget)/100) : '—'}</td>
          <td style="color:#60a5fa;font-weight:600">${vnd(parseFloat(ins.spend||0))}</td>
          <td>${vnd(parseInt(ins.impressions||0))}</td>
          <td>${vnd(parseInt(ins.clicks||0))}</td>
          <td>${ins.cpm ? vnd(parseFloat(ins.cpm)) : '—'}</td>
          <td>${ins.cpc ? vnd(parseFloat(ins.cpc)) : '—'}</td>
        </tr>`;
      }).join('');
    } catch(e) {
      tbody.innerHTML = `<tr class="loading-row"><td colspan="10" style="color:#f87171"><i class="bi bi-x-circle"></i> ${e.message}</td></tr>`;
    }
  }

  async function selectAdset(id, name) {
    switchTab('ads');
    await loadAds(id, name);
  }

  async function loadAds(adsetId, adsetName) {
    const tbody = document.getElementById('tbody-ads');
    tbody.innerHTML = '<tr class="loading-row"><td colspan="10"><span class="spinner"></span> Đang tải quảng cáo...</td></tr>';
    const datePreset = document.getElementById('datePreset').value;

    try {
      if (!S.token) throw new Error('Cần token thủ công để xem quảng cáo chi tiết');
      const r = await fetch(`${FB_GRAPH}/${adsetId}/ads?fields=id,name,status,creative{title,body,thumbnail_url}&limit=50&access_token=${S.token}`);
      const d = await r.json();
      if (d.error) throw new Error(d.error.message);
      const ads = d.data || [];

      await Promise.all(ads.map(async a => {
        try {
          const ins = await fetch(`${FB_GRAPH}/${a.id}/insights?fields=spend,impressions,clicks,ctr,cpc,cpm&date_preset=${datePreset}&access_token=${S.token}`).then(r=>r.json());
          a._ins = ins.data?.[0] || {};
        } catch(e) { a._ins = {}; }
      }));

      S.ads = ads;
      document.getElementById('countAds').textContent = ads.length;

      if (!ads.length) {
        tbody.innerHTML = `<tr><td colspan="10"><div class="empty-state"><i class="bi bi-megaphone"></i><p>Không có quảng cáo nào trong nhóm "${adsetName}"</p></div></td></tr>`;
        return;
      }

      tbody.innerHTML = ads.map(a => {
        const [st, sc] = CAMPAIGN_STATUS[a.status] || ['Không rõ','badge-gray'];
        const ins = a._ins || {};
        const thumb = a.creative?.thumbnail_url;
        return `<tr>
          <td onclick="event.stopPropagation()"><input type="checkbox" class="row-check" value="${a.id}"></td>
          <td>
            <div style="display:flex;align-items:center;gap:10px">
              ${thumb ? `<img src="${thumb}" style="width:40px;height:40px;border-radius:6px;object-fit:cover">` : '<div style="width:40px;height:40px;border-radius:6px;background:rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center"><i class="bi bi-image" style="color:rgba(255,255,255,.3)"></i></div>'}
              <div><div class="td-name">${a.name}</div><div class="td-id">${a.id}</div></div>
            </div>
          </td>
          <td><span class="badge ${sc}">${st}</span></td>
          <td style="font-size:12px;color:rgba(255,255,255,.5)">${adsetName || '—'}</td>
          <td style="color:#60a5fa;font-weight:600">${vnd(parseFloat(ins.spend||0))}</td>
          <td>${vnd(parseInt(ins.impressions||0))}</td>
          <td>${vnd(parseInt(ins.clicks||0))}</td>
          <td>${pct(ins.ctr)}</td>
          <td>${ins.cpc ? vnd(parseFloat(ins.cpc)) : '—'}</td>
          <td>${ins.cpm ? vnd(parseFloat(ins.cpm)) : '—'}</td>
        </tr>`;
      }).join('');
    } catch(e) {
      tbody.innerHTML = `<tr class="loading-row"><td colspan="10" style="color:#f87171"><i class="bi bi-x-circle"></i> ${e.message}</td></tr>`;
    }
  }

  // ── Tab switching ──
  function switchTab(tab) {
    S.currentTab = tab;
    ['accounts','campaigns','adsets','ads','rules'].forEach(t => {
      document.getElementById(`tab-${t}`).classList.toggle('active', t === tab);
      document.getElementById(`panel-${t}`).style.display = t === tab ? 'block' : 'none';
    });
    if (tab === 'rules') renderRules();
  }

  function loadCurrentTab() {
    if (S.currentTab === 'accounts') loadAccounts();
    else if (S.currentTab === 'campaigns' && S.selectedAccountId) loadCampaigns(S.selectedAccountId);
  }

  // ── Search & Sort ──
  function filterTable() {
    S.searchQ = document.getElementById('searchInput').value;
    if (S.currentTab === 'accounts') renderAccounts(S.accounts);
  }

  function sortTable(tab, field) {
    if (S.sortField === field) S.sortAsc = !S.sortAsc;
    else { S.sortField = field; S.sortAsc = true; }
    if (tab === 'accounts') {
      S.accounts.sort((a,b) => {
        let va = a[field] || 0, vb = b[field] || 0;
        if (typeof va === 'string') va = va.toLowerCase();
        if (typeof vb === 'string') vb = vb.toLowerCase();
        return S.sortAsc ? (va > vb ? 1 : -1) : (va < vb ? 1 : -1);
      });
      renderAccounts(S.accounts);
    }
  }

  // ── Checkbox ──
  function toggleCheckAll(el) {
    document.querySelectorAll('.row-check').forEach(c => c.checked = el.checked);
    updateSelectedCount();
  }
  function updateSelectedCount() {
    const n = document.querySelectorAll('.row-check:checked').length;
    const el = document.getElementById('selectedCount');
    el.style.display = n ? 'block' : 'none';
    el.textContent = `Đã chọn ${n} mục`;
  }
  document.addEventListener('change', e => { if (e.target.classList.contains('row-check')) updateSelectedCount(); });

  // ── Export CSV ──
  function exportCSV() {
    const tab = S.currentTab;
    const data = S[tab] || [];
    if (!data.length) { toast('Không có dữ liệu để xuất', 'error'); return; }
    const headers = Object.keys(data[0]).filter(k => !k.startsWith('_'));
    const rows = data.map(r => headers.map(h => `"${(r[h]||'').toString().replace(/"/g,'""')}"`).join(','));
    const csv = [headers.join(','), ...rows].join('\n');
    const a = document.createElement('a');
    a.href = 'data:text/csv;charset=utf-8,\uFEFF' + encodeURIComponent(csv);
    a.download = `genztech_${tab}_${Date.now()}.csv`;
    a.click();
    toast('Xuất CSV thành công!', 'success');
  }

  // ── Refresh ──
  function refreshData() { loadCurrentTab(); toast('Đang làm mới dữ liệu...', 'info'); }

  // ── Sidebar toggle ──
  function toggleSubNav(e, id) {
    e.preventDefault();
    const el = document.getElementById(id);
    const arrow = document.getElementById(id + 'Arrow');
    const open = el.style.display === 'none';
    el.style.display = open ? 'block' : 'none';
    if (arrow) arrow.style.transform = open ? 'rotate(180deg)' : '';
  }

  function openSettings() { toast('Cài đặt đang phát triển', 'info'); }

  // ── Init ──
  async function init() {
    await initAuth();
    // Auto load if has token or jwt
    if (S.token || S.jwt) {
      loadAccounts();
    }
  }

  // ── Background ──
  (function() {
    const isMobile = window.innerWidth < 768;
    const isTouchDevice = 'ontouchstart' in window;
    const canvas = document.getElementById('stars-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    const stars = [];
    for (let i = 0; i < (isMobile ? 80 : 180); i++) {
      stars.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*1.5+0.3, a: Math.random(), da: (Math.random()-0.5)*0.005, vx: (Math.random()-0.5)*0.08, vy: (Math.random()-0.5)*0.08 });
    }
    function animStars() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      stars.forEach(s => {
        s.x += s.vx; s.y += s.vy; s.a += s.da;
        if (s.a < 0.1) s.da = Math.abs(s.da);
        if (s.a > 1) s.da = -Math.abs(s.da);
        if (s.x < 0) s.x = canvas.width; if (s.x > canvas.width) s.x = 0;
        if (s.y < 0) s.y = canvas.height; if (s.y > canvas.height) s.y = 0;
        ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
        ctx.fillStyle = `rgba(255,255,255,${s.a * 0.7})`; ctx.fill();
      });
      requestAnimationFrame(animStars);
    }
    animStars();
    // Data particles
    const canvasData = document.getElementById('data-particles');
    const ctxData = canvasData.getContext('2d');
    canvasData.width = window.innerWidth; canvasData.height = window.innerHeight;
    const particles = [];
    for (let i = 0; i < (isMobile ? 10 : 20); i++) {
      particles.push({ x:0, y:0, r: Math.random()*2+1, path:{ cx:Math.random()*canvasData.width, cy:Math.random()*canvasData.height, rx:Math.random()*100+50, ry:Math.random()*100+50, angle:Math.random()*Math.PI*2, speed:Math.random()*0.01+0.005 }, pulse:Math.random()*Math.PI*2, ps:Math.random()*0.02+0.01 });
    }
    function animPart() {
      ctxData.clearRect(0,0,canvasData.width,canvasData.height);
      particles.forEach(p => {
        p.path.angle += p.path.speed; p.x = p.path.cx + Math.cos(p.path.angle)*p.path.rx; p.y = p.path.cy + Math.sin(p.path.angle)*p.path.ry;
        p.pulse += p.ps; const ps = 1 + Math.sin(p.pulse)*0.5;
        const g = ctxData.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r*ps*3);
        g.addColorStop(0,'rgba(24,119,242,'+(0.7*ps)+')'); g.addColorStop(0.5,'rgba(0,212,255,'+(0.3*ps)+')'); g.addColorStop(1,'rgba(0,212,255,0)');
        ctxData.fillStyle = g; ctxData.beginPath(); ctxData.arc(p.x,p.y,p.r*ps*3,0,Math.PI*2); ctxData.fill();
      });
      requestAnimationFrame(animPart);
    }
    animPart();
    // Cursor
    const cursor = document.getElementById('custom-cursor');
    if (cursor && !isTouchDevice) {
      let mx=0,my=0,cx=0,cy=0,mv=false;
      document.body.style.cursor='none';
      document.addEventListener('mousemove', e => { mx=e.clientX; my=e.clientY; if(!mv){mv=true;cursor.style.opacity='1';} });
      document.addEventListener('mouseleave', () => { mv=false; cursor.style.opacity='0'; });
      function animCursor() { if(mv){ cx+=(mx-cx)*0.15; cy+=(my-cy)*0.15; cursor.style.left=cx+'px'; cursor.style.top=cy+'px'; } requestAnimationFrame(animCursor); }
      animCursor();
    }
    window.addEventListener('resize', () => { canvas.width=window.innerWidth; canvas.height=window.innerHeight; canvasData.width=window.innerWidth; canvasData.height=window.innerHeight; });
  })();

  // ── RULE ENGINE ──
  let rules = JSON.parse(localStorage.getItem('gz_ad_rules') || '[]');
  let ruleEditId = null;
  let ruleCheckInterval = null;
  let ruleLogs = JSON.parse(localStorage.getItem('gz_rule_logs') || '[]');

  const COND_UNITS = {
    spend_spike: '%', cpc_above: 'VND', cpm_above: 'VND', ctr_below: '%',
    balance_below: 'VND', spend_above: 'VND', account_disabled: '', no_conversion: 'giờ'
  };
  const COND_LABELS = {
    spend_spike: 'Tăng % so với trung bình', cpc_above: 'CPC tối đa (VND)',
    cpm_above: 'CPM tối đa (VND)', ctr_below: 'CTR tối thiểu (%)',
    balance_below: 'Số dư tối thiểu (VND)', spend_above: 'Giới hạn chi tiêu (VND)',
    account_disabled: 'Không cần giá trị', no_conversion: 'Sau bao nhiêu giờ'
  };
  const ACTION_LABELS = {
    pause_campaign: 'Tạm dừng chiến dịch', pause_adset: 'Tạm dừng nhóm QC',
    pause_ad: 'Tạm dừng quảng cáo', notify_only: 'Chỉ cảnh báo'
  };

  function saveRules() {
    localStorage.setItem('gz_ad_rules', JSON.stringify(rules));
    document.getElementById('countRules').textContent = rules.filter(r=>r.enabled).length;
  }

  function addRuleLog(ruleId, msg, type='ok') {
    const log = { id: Date.now(), ruleId, msg, type, time: new Date().toLocaleString('vi-VN') };
    ruleLogs.unshift(log);
    if (ruleLogs.length > 100) ruleLogs = ruleLogs.slice(0, 100);
    localStorage.setItem('gz_rule_logs', JSON.stringify(ruleLogs));
  }

  function openRuleModal(editId) {
    ruleEditId = editId || null;
    if (editId) {
      const r = rules.find(x=>x.id===editId);
      if (!r) return;
      document.getElementById('ruleName').value = r.name;
      document.getElementById('ruleCondType').value = r.condType;
      document.getElementById('ruleCondValue').value = r.condValue || '';
      document.getElementById('ruleAction').value = r.action;
      document.getElementById('ruleScope').value = r.scope;
      document.getElementById('ruleNotifyBrowser').checked = r.notifyBrowser !== false;
      document.getElementById('ruleNotifyLog').checked = r.notifyLog !== false;
    } else {
      document.getElementById('ruleName').value = '';
      document.getElementById('ruleCondType').value = 'spend_spike';
      document.getElementById('ruleCondValue').value = '';
      document.getElementById('ruleAction').value = 'pause_campaign';
      document.getElementById('ruleScope').value = 'all';
      document.getElementById('ruleNotifyBrowser').checked = true;
      document.getElementById('ruleNotifyLog').checked = true;
    }
    updateCondUnit();
    document.getElementById('ruleModal').style.display = 'flex';
  }
  function closeRuleModal() { document.getElementById('ruleModal').style.display = 'none'; }

  function updateCondUnit() {
    const t = document.getElementById('ruleCondType').value;
    document.getElementById('condUnit').textContent = COND_UNITS[t] || '';
    document.getElementById('condValueLabel').textContent = COND_LABELS[t] || 'Giá trị ngưỡng';
    const noVal = t === 'account_disabled';
    document.getElementById('ruleCondValue').disabled = noVal;
    document.getElementById('ruleCondValue').placeholder = noVal ? 'Không cần' : '50';
  }

  function saveRule() {
    const name = document.getElementById('ruleName').value.trim();
    if (!name) { toast('Vui lòng nhập tên quy tắc', 'error'); return; }
    const condType = document.getElementById('ruleCondType').value;
    const condValue = parseFloat(document.getElementById('ruleCondValue').value) || 0;
    const action = document.getElementById('ruleAction').value;
    const scope = document.getElementById('ruleScope').value;
    const notifyBrowser = document.getElementById('ruleNotifyBrowser').checked;
    const notifyLog = document.getElementById('ruleNotifyLog').checked;

    if (ruleEditId) {
      const idx = rules.findIndex(r=>r.id===ruleEditId);
      if (idx >= 0) rules[idx] = { ...rules[idx], name, condType, condValue, action, scope, notifyBrowser, notifyLog };
    } else {
      rules.push({ id: Date.now(), name, condType, condValue, action, scope, notifyBrowser, notifyLog, enabled: true, createdAt: new Date().toISOString(), lastTriggered: null, triggerCount: 0 });
    }
    saveRules();
    closeRuleModal();
    renderRules();
    toast('Lưu quy tắc thành công!', 'success');
  }

  function toggleRule(id) {
    const r = rules.find(x=>x.id===id);
    if (r) { r.enabled = !r.enabled; saveRules(); renderRules(); }
  }

  function deleteRule(id) {
    if (!confirm('Xóa quy tắc này?')) return;
    rules = rules.filter(r=>r.id!==id);
    saveRules(); renderRules();
    toast('Dạ xóa rồi!', 'info');
  }

  function applyPreset(type) {
    const presets = {
      spend_spike: { name: 'Tắt khi thốc tiền đột ngột', condType: 'spend_spike', condValue: 50, action: 'pause_campaign', scope: 'all' },
      high_cpc: { name: 'Tắt khi CPC quá đắt', condType: 'cpc_above', condValue: 50000, action: 'pause_campaign', scope: 'all' },
      low_balance: { name: 'Cảnh báo sắp hết tiền', condType: 'balance_below', condValue: 500000, action: 'notify_only', scope: 'all' },
      account_disabled: { name: 'Tài khoản bị vô hiệu hóa', condType: 'account_disabled', condValue: 0, action: 'pause_campaign', scope: 'all' }
    };
    const p = presets[type];
    if (!p) return;
    rules.push({ id: Date.now(), ...p, notifyBrowser: true, notifyLog: true, enabled: true, createdAt: new Date().toISOString(), lastTriggered: null, triggerCount: 0 });
    saveRules(); renderRules();
    toast(`Đã thêm quy tắc: ${p.name}`, 'success');
  }

  function renderRules() {
    const el = document.getElementById('rulesList');
    if (!rules.length) {
      el.innerHTML = `<div style="text-align:center;padding:40px;color:rgba(255,255,255,.3)">
        <i class="bi bi-robot" style="font-size:40px;display:block;margin-bottom:12px;opacity:.3"></i>
        Chưa có quy tắc nào. Chọn mẫu có sẵn hoặc tạo mới.
      </div>`;
      return;
    }
    const logsHtml = ruleLogs.length ? `
      <div class="log-section">
        <div class="log-title"><i class="bi bi-journal-text"></i> Lịch sử kích hoạt (${ruleLogs.length})</div>
        ${ruleLogs.slice(0,10).map(l=>`<div class="log-item"><span class="log-time">${l.time}</span><span class="log-msg ${l.type}">${l.msg}</span></div>`).join('')}
      </div>` : '';

    el.innerHTML = rules.map(r => {
      const lastT = r.lastTriggered ? `Kích hoạt lần cuối: ${new Date(r.lastTriggered).toLocaleString('vi-VN')}` : 'Chưa kích hoạt';
      const condText = COND_LABELS[r.condType] + (r.condValue ? ` ≥ ${r.condValue.toLocaleString('vi-VN')} ${COND_UNITS[r.condType]}` : '');
      return `<div class="rule-card ${r.enabled ? 'active-rule' : ''}" id="rule-${r.id}">
        <label class="rule-toggle"><input type="checkbox" ${r.enabled?'checked':''} onchange="toggleRule(${r.id})"><span class="rule-slider"></span></label>
        <div class="rule-info">
          <div class="rule-name">${r.name}</div>
          <div class="rule-meta"><i class="bi bi-funnel" style="color:#c084fc"></i> ${condText} &nbsp;•&nbsp; <i class="bi bi-lightning" style="color:#fbbf24"></i> ${ACTION_LABELS[r.action]} &nbsp;•&nbsp; <i class="bi bi-people"></i> ${r.scope==='all'?'Tất cả TKQC':'TKQC đang chọn'}</div>
          <div class="rule-log">⚡ ${lastT} &nbsp;•&nbsp; Kích hoạt ${r.triggerCount||0} lần</div>
        </div>
        <div class="rule-actions">
          <button class="btn-icon btn-sm" onclick="openRuleModal(${r.id})" title="Sửa"><i class="bi bi-pencil"></i></button>
          <button class="btn-icon btn-sm" onclick="deleteRule(${r.id})" title="Xóa" style="color:#f87171"><i class="bi bi-trash"></i></button>
        </div>
      </div>`;
    }).join('') + logsHtml;
  }

  // Rule checker - runs every 15 minutes
  async function checkRules() {
    const enabledRules = rules.filter(r => r.enabled);
    if (!enabledRules.length) return;
    if (!S.token && !S.jwt) return;

    try {
      let accounts = S.accounts;
      if (!accounts.length) {
        // Load minimal account data for rule checking
        if (S.token) {
          const r = await fetch(`${FB_GRAPH}/me/adaccounts?fields=id,name,account_status,balance,amount_spent&limit=50&access_token=${S.token}`);
          const d = await r.json();
          accounts = d.data || [];
        }
      }

      for (const rule of enabledRules) {
        for (const acc of accounts) {
          let triggered = false;
          let triggerMsg = '';

          if (rule.condType === 'account_disabled') {
            if ([2,7,9].includes(acc.account_status)) {
              triggered = true;
              triggerMsg = `TKQC "${acc.name}" bị vô hiệu hóa (trạng thái: ${acc.account_status})`;
            }
          } else if (rule.condType === 'balance_below') {
            const bal = parseFloat(acc.balance || 0);
            if (bal < rule.condValue) {
              triggered = true;
              triggerMsg = `TKQC "${acc.name}" số dư ${bal.toLocaleString('vi-VN')} VND dưới ngưỡng ${rule.condValue.toLocaleString('vi-VN')} VND`;
            }
          } else if (rule.condType === 'spend_above') {
            const spent = parseFloat(acc.amount_spent || 0);
            if (spent > rule.condValue) {
              triggered = true;
              triggerMsg = `TKQC "${acc.name}" chi tiêu ${spent.toLocaleString('vi-VN')} VND vượt giới hạn ${rule.condValue.toLocaleString('vi-VN')} VND`;
            }
          }
          // CPC/CPM/CTR checks require insights data (loaded separately)
          else if (rule.condType === 'cpc_above' && acc._insights) {
            const cpc = parseFloat(acc._insights.cpc || 0);
            if (cpc > rule.condValue) {
              triggered = true;
              triggerMsg = `TKQC "${acc.name}" CPC ${cpc.toLocaleString('vi-VN')} VND vượt ngưỡng ${rule.condValue.toLocaleString('vi-VN')} VND`;
            }
          }

          if (triggered) {
            rule.lastTriggered = new Date().toISOString();
            rule.triggerCount = (rule.triggerCount || 0) + 1;
            if (rule.notifyLog) addRuleLog(rule.id, `[${rule.name}] ${triggerMsg}`, 'triggered');
            if (rule.notifyBrowser && 'Notification' in window) {
              Notification.requestPermission().then(p => {
                if (p === 'granted') new Notification('GenZTech Alert ⚡', { body: triggerMsg, icon: 'https://ui-avatars.com/api/?name=GZ&background=1877f2&color=fff' });
              });
            }
            toast(`⚡ Quy tắc kích hoạt: ${triggerMsg}`, 'error');
            // Execute action
            if (rule.action !== 'notify_only' && S.jwt) {
              try {
                await fetch(`${API_BASE}/api/facebook/proxy/pause-campaigns`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${S.jwt}` },
                  body: JSON.stringify({ accountId: acc.id, level: rule.action.replace('pause_',''), reason: rule.name })
                });
                addRuleLog(rule.id, `→ Đã thực hiện: ${ACTION_LABELS[rule.action]} cho ${acc.name}`, 'ok');
              } catch(e) { addRuleLog(rule.id, `Lỗi thực hiện: ${e.message}`, 'triggered'); }
            }
          }
        }
      }
      saveRules();
      if (S.currentTab === 'rules') renderRules();
    } catch(e) { console.warn('Rule check error:', e); }
  }

  // Start rule checker
  function startRuleChecker() {
    if (ruleCheckInterval) clearInterval(ruleCheckInterval);
    ruleCheckInterval = setInterval(checkRules, 15 * 60 * 1000); // 15 min
    document.getElementById('countRules').textContent = rules.filter(r=>r.enabled).length;
  }

  init();
  startRuleChecker();
  </script>
</body>
</html>
