<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Kiá»ƒm Tra TKQC â€” GenZTech</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <style>
    html,body{scrollbar-width:none;-ms-overflow-style:none;cursor:none;-webkit-user-select:none;user-select:none;margin:0;padding:0;font-family:'Inter',sans-serif;background:#080c1e;color:#fff}
    html::-webkit-scrollbar,body::-webkit-scrollbar{display:none;width:0}
    .app-layout{display:flex;min-height:100vh;position:relative;z-index:1}
    /* Sidebar */
    .sidebar{width:240px;flex-shrink:0;background:rgba(10,14,39,.92);backdrop-filter:blur(20px);border-right:1px solid rgba(255,255,255,.06);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:40}
    .sidebar-logo{padding:18px 18px 14px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;gap:10px;text-decoration:none}
    .sidebar-logo img{width:34px;height:34px;border-radius:50%}
    .sidebar-logo span{font-size:14px;font-weight:700;letter-spacing:.5px;color:#fff}
    .sidebar-logo span em{color:#00d4ff;font-style:normal}
    .sidebar-nav{flex:1;padding:10px 0;overflow-y:auto}
    .nav-group-label{font-size:10px;font-weight:600;letter-spacing:1.2px;color:rgba(255,255,255,.3);text-transform:uppercase;padding:10px 18px 4px}
    .nav-item{display:flex;align-items:center;gap:10px;padding:9px 18px;font-size:13px;color:rgba(255,255,255,.6);text-decoration:none;transition:all .2s;border-left:2px solid transparent}
    .nav-item:hover{color:#fff;background:rgba(255,255,255,.04)}
    .nav-item.active{color:#00d4ff;background:rgba(0,212,255,.08);border-left-color:#00d4ff}
    .nav-item i{width:17px;text-align:center;font-size:14px}
    .nav-sub-item{display:flex;align-items:center;gap:10px;padding:7px 18px 7px 34px;font-size:12px;color:rgba(255,255,255,.5);text-decoration:none;transition:all .2s;border-left:2px solid transparent}
    .nav-sub-item:hover{color:#fff;background:rgba(255,255,255,.04)}
    .nav-sub-item.active{color:#00d4ff;background:rgba(0,212,255,.06);border-left-color:#00d4ff}
    .sidebar-footer{padding:14px 18px;border-top:1px solid rgba(255,255,255,.06)}
    .conn-status{display:flex;align-items:center;gap:8px;font-size:12px;color:rgba(255,255,255,.5)}
    .conn-dot{width:7px;height:7px;border-radius:50%;background:#ef4444;flex-shrink:0}
    .conn-dot.online{background:#22c55e;box-shadow:0 0 6px #22c55e}
    /* Main */
    .main-content{margin-left:240px;flex:1;display:flex;flex-direction:column;min-height:100vh}
    .topbar{position:sticky;top:0;z-index:30;background:rgba(10,14,39,.9);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,.06);padding:0 24px;height:58px;display:flex;align-items:center;justify-content:space-between}
    .topbar-left{display:flex;align-items:center;gap:10px}
    .breadcrumb{font-size:12.5px;color:rgba(255,255,255,.4);display:flex;align-items:center;gap:6px}
    .breadcrumb span{color:#fff;font-weight:600}
    .topbar-right{display:flex;align-items:center;gap:8px}
    .btn{padding:7px 14px;border-radius:8px;font-size:12.5px;font-weight:600;border:none;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
    .btn-primary{background:#1877f2;color:#fff}.btn-primary:hover{background:#1565d8}
    .btn-outline{background:transparent;color:rgba(255,255,255,.7);border:1px solid rgba(255,255,255,.15)}.btn-outline:hover{border-color:#00d4ff;color:#00d4ff}
    .btn-sm{padding:5px 12px;font-size:12px}
    .btn-icon{padding:6px 10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);color:rgba(255,255,255,.6);border-radius:8px;cursor:pointer;font-size:13px;display:inline-flex;align-items:center;gap:5px;transition:all .2s}.btn-icon:hover{background:rgba(255,255,255,.1);color:#fff}
    /* Page */
    .page-body{padding:20px 24px;flex:1}
    /* Token banner */
    .token-banner{background:rgba(251,191,36,.06);border:1px solid rgba(251,191,36,.15);border-radius:10px;padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;gap:12px;font-size:12.5px}
    .token-banner.success{background:rgba(34,197,94,.06);border-color:rgba(34,197,94,.15)}
    /* Tabs */
    .tabs-bar{display:flex;gap:0;border-bottom:1px solid rgba(255,255,255,.08);margin-bottom:0;background:rgba(255,255,255,.02);border-radius:12px 12px 0 0;overflow:hidden}
    .tab-btn{padding:12px 20px;font-size:13px;font-weight:600;color:rgba(255,255,255,.5);background:none;border:none;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:7px;border-bottom:2px solid transparent;white-space:nowrap}
    .tab-btn:hover{color:#fff;background:rgba(255,255,255,.04)}
    .tab-btn.active{color:#00d4ff;border-bottom-color:#00d4ff;background:rgba(0,212,255,.06)}
    .tab-btn .tab-count{background:rgba(0,212,255,.15);color:#00d4ff;font-size:10px;font-weight:700;padding:1px 7px;border-radius:20px}
    /* Table */
    .table-wrap{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:0 0 12px 12px;overflow:hidden}
    .table-toolbar{padding:12px 16px;display:flex;align-items:center;gap:10px;border-bottom:1px solid rgba(255,255,255,.06)}
    .search-box{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:6px 12px;flex:1;max-width:320px}
    .search-box input{background:none;border:none;outline:none;color:#fff;font-size:12.5px;width:100%}
    .search-box input::placeholder{color:rgba(255,255,255,.3)}
    .search-box i{color:rgba(255,255,255,.3);font-size:13px}
    table{width:100%;border-collapse:collapse}
    thead tr{border-bottom:1px solid rgba(255,255,255,.07)}
    thead th{padding:10px 14px;font-size:11px;font-weight:600;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.7px;text-align:left;white-space:nowrap;cursor:pointer;user-select:none}
    thead th:hover{color:rgba(255,255,255,.7)}
    thead th i{font-size:10px;margin-left:4px}
    tbody tr{border-bottom:1px solid rgba(255,255,255,.04);transition:background .15s;cursor:pointer}
    tbody tr:hover{background:rgba(255,255,255,.04)}
    tbody tr:last-child{border-bottom:none}
    tbody td{padding:11px 14px;font-size:13px;color:rgba(255,255,255,.85)}
    .td-name{font-weight:600;color:#fff}
    .td-id{font-size:11px;color:rgba(255,255,255,.35);margin-top:2px}
    .badge{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:600}
    .badge-green{background:rgba(34,197,94,.12);color:#4ade80}
    .badge-red{background:rgba(239,68,68,.12);color:#f87171}
    .badge-yellow{background:rgba(251,191,36,.12);color:#fbbf24}
    .badge-gray{background:rgba(255,255,255,.08);color:rgba(255,255,255,.5)}
    .badge-blue{background:rgba(24,119,242,.15);color:#60a5fa}
    .badge::before{content:'';width:5px;height:5px;border-radius:50%;background:currentColor}
    /* Checkbox */
    input[type=checkbox]{accent-color:#00d4ff;width:14px;height:14px;cursor:pointer}
    /* Empty / loading */
    .empty-state{text-align:center;padding:60px 20px;color:rgba(255,255,255,.3)}
    .empty-state i{font-size:48px;margin-bottom:12px;display:block;opacity:.3}
    .empty-state p{font-size:13.5px}
    .loading-row td{text-align:center;padding:40px;color:rgba(255,255,255,.3)}
    .spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.2);border-top-color:#00d4ff;border-radius:50%;animation:spin .7s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* Detail panel */
    .detail-panel{background:rgba(10,14,39,.95);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:20px;margin-top:16px;display:none}
    .detail-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px}
    .detail-item{background:rgba(255,255,255,.04);border-radius:8px;padding:12px 14px}
    .detail-label{font-size:11px;color:rgba(255,255,255,.4);margin-bottom:4px;text-transform:uppercase;letter-spacing:.6px}
    .detail-value{font-size:14px;font-weight:700}
    /* Stats row */
    .stats-row{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:16px}
    .stat-mini{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);border-radius:10px;padding:12px 14px}
    .stat-mini .lbl{font-size:10.5px;color:rgba(255,255,255,.4);margin-bottom:4px;text-transform:uppercase;letter-spacing:.05em}
    .stat-mini .val{font-size:18px;font-weight:700;color:#fff}
    .sparkline-wrap{display:flex;align-items:flex-end;gap:2px;height:28px;padding:2px 0}
    .spark-bar{width:8px;border-radius:2px 2px 0 0;background:linear-gradient(180deg,#60a5fa,#3b82f6);min-height:2px;cursor:pointer;transition:opacity .15s;position:relative}
    .spark-bar:hover{opacity:.75}
    .spark-bar.current-hour{background:linear-gradient(180deg,#fbbf24,#f59e0b)}
    .spark-tooltip{position:absolute;bottom:calc(100% + 4px);left:50%;transform:translateX(-50%);background:#1e293b;border:1px solid rgba(255,255,255,.15);border-radius:6px;padding:4px 8px;font-size:10px;color:#fff;white-space:nowrap;pointer-events:none;z-index:100;display:none}
    .spark-bar:hover .spark-tooltip{display:block}
    .today-spend{font-weight:700;color:#fbbf24;font-size:13px}
    .today-spend.zero{color:rgba(255,255,255,.3);font-weight:400} /* Token modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;display:none;align-items:center;justify-content:center}
    .modal-overlay.open{display:flex}
    .modal-box{background:#0f1535;border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:28px;width:500px;max-width:95vw}
    .modal-title{font-size:16px;font-weight:700;margin-bottom:6px}
    .modal-sub{font-size:12.5px;color:rgba(255,255,255,.4);margin-bottom:20px}
    .form-group{margin-bottom:14px}
    .form-label{font-size:12px;color:rgba(255,255,255,.5);margin-bottom:6px;display:block;font-weight:600}
    .form-control{width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:9px 12px;color:#fff;font-size:13px;outline:none;box-sizing:border-box;transition:border-color .2s}
    .form-control:focus{border-color:#00d4ff}
    /* Toast */
    #toast{position:fixed;bottom:24px;right:24px;z-index:9999;display:flex;flex-direction:column;gap:8px}
    .toast-item{background:#1e2a4a;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:12px 18px;font-size:13px;display:flex;align-items:center;gap:10px;animation:slideIn .3s ease;min-width:260px}
    .toast-item.success{border-left:3px solid #22c55e}
    .toast-item.error{border-left:3px solid #ef4444}
    .toast-item.info{border-left:3px solid #00d4ff}
    @keyframes slideIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
    /* Pagination */
    .pagination{display:flex;align-items:center;gap:6px;padding:12px 16px;border-top:1px solid rgba(255,255,255,.06)}
    .page-btn{padding:5px 10px;border-radius:6px;font-size:12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);color:rgba(255,255,255,.6);cursor:pointer;transition:all .2s}
    .page-btn:hover,.page-btn.active{background:rgba(0,212,255,.15);border-color:#00d4ff;color:#00d4ff}
    .page-btn:disabled{opacity:.3;cursor:not-allowed}
    /* Responsive */
    @media(max-width:768px){.sidebar{display:none}.main-content{margin-left:0}.stats-row{grid-template-columns:repeat(2,1fr)}.detail-grid{grid-template-columns:repeat(2,1fr)}}
  
    /* â”€â”€ Universe Background â”€â”€ */
    canvas.bg-canvas{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0}
    #custom-cursor{position:fixed;width:20px;height:20px;border-radius:50%;border:2px solid rgba(0,212,255,.8);pointer-events:none;z-index:9999;transform:translate(-50%,-50%);transition:opacity .3s;opacity:0;mix-blend-mode:screen}
    .nebula-overlay{position:fixed;inset:0;pointer-events:none;z-index:0;background:radial-gradient(ellipse 80% 60% at 20% 30%,rgba(24,119,242,.07) 0%,transparent 60%),radial-gradient(ellipse 60% 50% at 80% 70%,rgba(0,212,255,.06) 0%,transparent 55%),radial-gradient(ellipse 50% 40% at 50% 10%,rgba(139,92,246,.05) 0%,transparent 50%)}
  </style>
</head>
<body>
  <!-- Universe Background -->
  <canvas class="bg-canvas" id="gz-stars"></canvas>
  <canvas class="bg-canvas" id="gz-particles"></canvas>
  <div class="nebula-overlay"></div>
  <div id="custom-cursor"></div>
  <div id="toastContainer"></div>

  <!-- Token Modal -->
  <div class="modal-overlay" id="tokenModal">
    <div class="modal-box">
      <div class="modal-title"><i class="bi bi-key" style="color:#fbbf24"></i> Nháº­p Access Token Thá»§ CÃ´ng</div>
      <div class="modal-sub">DÃ¹ng khi Facebook cáº¥m OAuth. Láº¥y token táº¡i <a href="https://developers.facebook.com/tools/explorer/" target="_blank" style="color:#1877f2">Graph API Explorer</a> â†’ chá»n quyá»n <code style="background:rgba(255,255,255,.08);padding:1px 6px;border-radius:4px;font-size:11px">ads_read, ads_management</code></div>
      <div class="form-group">
        <label class="form-label">Facebook Access Token</label>
        <input type="password" class="form-control" id="tokenInput" placeholder="EAAxxxxxxxxxxxxxxx..." autocomplete="off">
        <div style="font-size:11px;color:rgba(255,255,255,.3);margin-top:5px">Token sáº½ Ä‘Æ°á»£c lÆ°u vÃ o trÃ¬nh duyá»‡t, khÃ´ng gá»­i lÃªn server</div>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
        <button class="btn btn-outline" onclick="closeTokenModal()">Há»§y</button>
        <button class="btn btn-primary" onclick="saveToken()"><i class="bi bi-save"></i> LÆ°u Token</button>
      </div>
    </div>
  </div>

  <div class="app-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <a href="index.html" class="sidebar-logo">
        <img src="https://ui-avatars.com/api/?name=GZ&background=1877f2&color=fff&bold=true" alt="logo">
        <span>GENZ<em>TECH</em></span>
      </a>
      <nav class="sidebar-nav">
        <div class="nav-group-label">Tá»•ng Quan</div>
        <a href="maindashboard.html" class="nav-item"><i class="bi bi-grid-1x2-fill"></i> Dashboard</a>
        <div class="nav-group-label">CÃ´ng Cá»¥</div>
        <a href="auto-post.html" class="nav-item"><i class="bi bi-send"></i> Tá»± Äá»™ng ÄÄƒng BÃ i</a>
        <a href="ads-assistant.html" class="nav-item" onclick="toggleSubNav(event,'subNavAds')">
          <i class="bi bi-megaphone"></i> Trá»£ LÃ½ Quáº£ng CÃ¡o
          <i class="bi bi-chevron-down" id="subNavAdsArrow" style="margin-left:auto;font-size:11px;transition:transform .2s"></i>
        </a>
        <div id="subNavAds" style="display:flex;flex-direction:column">
          <a href="tool-ad-account.html" class="nav-sub-item active"><i class="bi bi-shield-check"></i> Kiá»ƒm Tra TKQC</a>
          <a href="tool-fb-id.html" class="nav-sub-item"><i class="bi bi-person-badge"></i> TÃ¬m Facebook ID</a>
          <a href="tool-budget.html" class="nav-sub-item"><i class="bi bi-graph-up-arrow"></i> PhÃ¢n TÃ­ch NgÃ¢n SÃ¡ch</a>
          <a href="tool-translate.html" class="nav-sub-item"><i class="bi bi-translate"></i> Dá»‹ch Thuáº­t</a>
          <a href="tool-ads-finder.html" class="nav-sub-item"><i class="bi bi-binoculars"></i> Ads Finder</a>
          <a href="tool-policy.html" class="nav-sub-item"><i class="bi bi-journal-text"></i> ChÃ­nh SÃ¡ch FB</a>
          <a href="tool-cookie.html" class="nav-sub-item"><i class="bi bi-cookie"></i> Quáº£n LÃ½ Cookie</a>
        </div>
        <a href="#" class="nav-item" onclick="openSettings()"><i class="bi bi-gear"></i> CÃ i Äáº·t</a>
      </nav>
      <div class="sidebar-footer">
        <div class="conn-status" id="connStatus">
          <div class="conn-dot" id="connDot"></div>
          <span id="connText">ChÆ°a káº¿t ná»‘i</span>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <div class="main-content">
      <div class="topbar">
        <div class="topbar-left">
          <div class="breadcrumb">
            <a href="ads-assistant.html" style="color:rgba(255,255,255,.4);text-decoration:none">Trá»£ LÃ½ QC</a>
            <i class="bi bi-chevron-right" style="font-size:10px"></i>
            <span>Kiá»ƒm Tra TKQC</span>
          </div>
        </div>
        <div class="topbar-right">
          <button class="btn-icon" onclick="refreshData()" title="LÃ m má»›i"><i class="bi bi-arrow-clockwise"></i></button>
          <button class="btn-icon" onclick="openTokenModal()" title="CÃ i Ä‘áº·t token"><i class="bi bi-key"></i> <span id="tokenIndicator" style="font-size:11px;display:none;color:#4ade80">â—</span></button>

          <div id="userBadge" style="display:none;align-items:center;gap:8px;font-size:12.5px">
            <div style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#1877f2,#00d4ff);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px" id="userAvatar">?</div>
            <span id="userName" style="color:rgba(255,255,255,.8)"></span>
          </div>
        </div>
      </div>

      <div class="page-body">

        <div id="tokenBanner" class="token-banner success" style="display:none">
          <i class="bi bi-key-fill" style="color:#4ade80;font-size:16px"></i>
          <div style="flex:1;font-size:12px">
            <strong style="color:#4ade80">Token thá»§ cÃ´ng Ä‘ang dÃ¹ng</strong> â€” Äang gá»i tháº³ng Facebook Graph API.
          </div>
          <button class="btn btn-outline btn-sm" onclick="openTokenModal()">Äá»•i token</button>
          <button class="btn btn-sm" onclick="clearToken()" style="background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.2);color:#f87171">XÃ³a</button>
        </div>

        <!-- Stats row -->
        <div class="stats-row" id="statsRow" style="display:none">
          <div class="stat-mini"><div class="lbl">Tá»•ng TKQC</div><div class="val" id="sTotalAcc">â€”</div></div>
          <div class="stat-mini"><div class="lbl">Äang hoáº¡t Ä‘á»™ng</div><div class="val" style="color:#4ade80" id="sActiveAcc">â€”</div></div>
          <div class="stat-mini"><div class="lbl">Bá»‹ khÃ³a / VÃ´ hiá»‡u</div><div class="val" style="color:#f87171" id="sLockedAcc">â€”</div></div>
          <div class="stat-mini"><div class="lbl">Tá»•ng chi tiÃªu</div><div class="val" style="color:#60a5fa;font-size:14px" id="sTotalSpend">â€”</div></div>
          <div class="stat-mini"><div class="lbl">Sá»‘ dÆ° kháº£ dá»¥ng</div><div class="val" style="color:#4ade80;font-size:14px" id="sTotalBalance">â€”</div></div>
        </div>

        <!-- Tabs + Table -->
        <div>
          <div class="tabs-bar">
            <button class="tab-btn active" id="tab-accounts" onclick="switchTab('accounts')">
              <i class="bi bi-credit-card"></i> TÃ i khoáº£n quáº£ng cÃ¡o
              <span class="tab-count" id="countAccounts">0</span>
            </button>
            <button class="tab-btn" id="tab-campaigns" onclick="switchTab('campaigns')">
              <i class="bi bi-flag"></i> Chiáº¿n dá»‹ch
              <span class="tab-count" id="countCampaigns">0</span>
            </button>
            <button class="tab-btn" id="tab-adsets" onclick="switchTab('adsets')">
              <i class="bi bi-collection"></i> NhÃ³m quáº£ng cÃ¡o
              <span class="tab-count" id="countAdsets">0</span>
            </button>
            <button class="tab-btn" id="tab-ads" onclick="switchTab('ads')">
              <i class="bi bi-megaphone"></i> Quáº£ng cÃ¡o
              <span class="tab-count" id="countAds">0</span>
            </button>
            <button class="tab-btn" id="tab-rules" onclick="switchTab('rules')">
              <i class="bi bi-robot"></i> Quy Táº¯c Tá»± Äá»™ng
              <span class="tab-count" id="countRules" style="background:rgba(168,85,247,.2);color:#c084fc">0</span>
            </button>
          </div>

          <div class="table-wrap">
            <!-- Context breadcrumb -->
          <div id="contextBar" style="display:none;align-items:center;gap:8px;padding:8px 16px;background:rgba(0,212,255,.04);border-bottom:1px solid rgba(0,212,255,.08);font-size:12px;flex-wrap:wrap"></div>

          <div class="table-toolbar">
              <div class="search-box">
                <i class="bi bi-search"></i>
                <input type="text" id="searchInput" placeholder="TÃ¬m kiáº¿m..." oninput="filterTable()">
              </div>
              <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
                <span id="selectedCount" style="font-size:12px;color:rgba(255,255,255,.4);display:none"></span>
                <select class="form-control" id="datePreset" onchange="loadCurrentTab()" style="width:auto;font-size:12px;padding:5px 10px">
                  <option value="today">HÃ´m nay</option>
                  <option value="yesterday">HÃ´m qua</option>
                  <option value="last_7d" selected>7 ngÃ y qua</option>
                  <option value="last_30d">30 ngÃ y qua</option>
                  <option value="this_month">ThÃ¡ng nÃ y</option>
                  <option value="last_month">ThÃ¡ng trÆ°á»›c</option>
                </select>
                <div id="rateLimitIndicator" style="display:none;align-items:center;gap:5px;font-size:11px;color:#fbbf24;background:rgba(251,191,36,.1);border:1px solid rgba(251,191,36,.3);border-radius:8px;padding:4px 10px"></div>
                <button class="btn-icon btn-sm" onclick="clearAllCache()" title="XÃ³a cache, táº£i láº¡i dá»¯ liá»‡u má»›i"><i class="bi bi-arrow-clockwise"></i> LÃ m má»›i</button>
                <button class="btn-icon btn-sm" onclick="exportCSV()"><i class="bi bi-download"></i> Xuáº¥t CSV</button>
              </div>
            </div>

            <!-- Tab: Accounts -->
            <div id="panel-accounts">
              <table>
                <thead>
                  <tr>
                    <th style="width:36px"><input type="checkbox" id="checkAll" onchange="toggleCheckAll(this)"></th>
                    <th onclick="sortTable('accounts','name')">TÃ i khoáº£n quáº£ng cÃ¡o <i class="bi bi-arrow-down-up"></i></th>
                    <th onclick="sortTable('accounts','account_status')">Tráº¡ng thÃ¡i <i class="bi bi-arrow-down-up"></i></th>
                    <th>Quá»‘c gia</th>
                    <th>MÃºi giá»</th>
                    <th onclick="sortTable('accounts','currency')">Tiá»n tá»‡ <i class="bi bi-arrow-down-up"></i></th>
                    <th onclick="sortTable('accounts','balance')">Sá»‘ dÆ° <i class="bi bi-arrow-down-up"></i></th>
                    <th onclick="sortTable('accounts','amount_spent')">Chi tiÃªu (ká»³) <i class="bi bi-arrow-down-up"></i></th>
                    <th>Chi tiÃªu hÃ´m nay</th>
                    <th style="min-width:160px">7 ngÃ y gáº§n Ä‘Ã¢y</th>
                    <th style="width:80px">Thao tÃ¡c</th>
                  </tr>
                </thead>
                <tbody id="tbody-accounts">
                  <tr class="loading-row"><td colspan="11"><span class="spinner"></span> Äang táº£i...</td></tr>
                </tbody>
              </table>
            </div>

            <!-- Tab: Campaigns -->
            <div id="panel-campaigns" style="display:none">
              <table>
                <thead>
                  <tr>
                    <th style="width:36px"><input type="checkbox"></th>
                    <th>Chiáº¿n dá»‹ch</th>
                    <th>Tráº¡ng thÃ¡i</th>
                    <th>Má»¥c tiÃªu</th>
                    <th>NgÃ¢n sÃ¡ch ngÃ y</th>
                    <th>Chi tiÃªu</th>
                    <th>LÆ°á»£t hiá»ƒn thá»‹</th>
                    <th>LÆ°á»£t click</th>
                    <th>CTR</th>
                    <th>CPC</th>
                  </tr>
                </thead>
                <tbody id="tbody-campaigns">
                  <tr class="loading-row"><td colspan="10"><span class="spinner"></span> Chá»n TKQC Ä‘á»ƒ xem chiáº¿n dá»‹ch</td></tr>
                </tbody>
              </table>
            </div>

            <!-- Tab: Ad Sets -->
            <div id="panel-adsets" style="display:none">
              <table>
                <thead>
                  <tr>
                    <th style="width:36px"><input type="checkbox"></th>
                    <th>NhÃ³m quáº£ng cÃ¡o</th>
                    <th>Tráº¡ng thÃ¡i</th>
                    <th>Chiáº¿n dá»‹ch</th>
                    <th>NgÃ¢n sÃ¡ch ngÃ y</th>
                    <th>Chi tiÃªu</th>
                    <th>LÆ°á»£t hiá»ƒn thá»‹</th>
                    <th>LÆ°á»£t click</th>
                    <th>CPM</th>
                    <th>CPC</th>
                  </tr>
                </thead>
                <tbody id="tbody-adsets">
                  <tr class="loading-row"><td colspan="10"><span class="spinner"></span> Chá»n TKQC Ä‘á»ƒ xem nhÃ³m quáº£ng cÃ¡o</td></tr>
                </tbody>
              </table>
            </div>

            <!-- Tab: Ads -->
            <div id="panel-ads" style="display:none">
              <table>
                <thead>
                  <tr>
                    <th style="width:36px"><input type="checkbox"></th>
                    <th>Quáº£ng cÃ¡o</th>
                    <th>Tráº¡ng thÃ¡i</th>
                    <th>NhÃ³m QC</th>
                    <th>Chi tiÃªu</th>
                    <th>LÆ°á»£t hiá»ƒn thá»‹</th>
                    <th>LÆ°á»£t click</th>
                    <th>CTR</th>
                    <th>CPC</th>
                    <th>CPM</th>
                  </tr>
                </thead>
                <tbody id="tbody-ads">
                  <tr class="loading-row"><td colspan="10"><span class="spinner"></span> Chá»n TKQC Ä‘á»ƒ xem quáº£ng cÃ¡o</td></tr>
                </tbody>
              </table>
            </div>

            <!-- Tab: Rules -->
            <div id="panel-rules" style="display:none">
              <div style="padding:20px">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
                  <div>
                    <div style="font-size:15px;font-weight:700"><i class="bi bi-robot" style="color:#c084fc"></i> Quy Táº¯c Tá»± Äá»™ng</div>
                    <div style="font-size:12px;color:rgba(255,255,255,.4);margin-top:3px">Kiá»ƒm tra má»—i 15 phÃºt. Tá»± Ä‘á»™ng táº¯t/cáº£nh bÃ¡o khi Ä‘iá»u kiá»‡n xáº£y ra.</div>
                  </div>
                  <button class="btn btn-primary" onclick="openRuleModal()" style="background:linear-gradient(135deg,#7c3aed,#a855f7)">
                    <i class="bi bi-plus-lg"></i> Táº¡o Quy Táº¯c
                  </button>
                </div>
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:20px" id="presetCards">
                  <div class="preset-card" onclick="applyPreset('spend_spike')">
                    <div class="preset-icon" style="background:rgba(239,68,68,.1);color:#f87171"><i class="bi bi-lightning-charge-fill"></i></div>
                    <div class="preset-info"><div class="preset-title">Táº¯t khi thá»‘c tiá»n Ä‘á»™t ngá»™t</div><div class="preset-desc">Chi tiÃªu tÄƒng &gt;50% so vá»›i trung bÃ¬nh 3 ngÃ y trÆ°á»›c</div></div>
                    <span class="preset-badge" style="background:rgba(239,68,68,.15);color:#f87171">Nhanh</span>
                  </div>
                  <div class="preset-card" onclick="applyPreset('high_cpc')">
                    <div class="preset-icon" style="background:rgba(251,191,36,.1);color:#fbbf24"><i class="bi bi-currency-dollar"></i></div>
                    <div class="preset-info"><div class="preset-title">Táº¯t khi CPC quÃ¡ Ä‘áº¯t</div><div class="preset-desc">CPC vÆ°á»£t ngÆ°á»¡ng tá»± Ä‘áº·t, hiá»‡u quáº£ kÃ©m</div></div>
                    <span class="preset-badge" style="background:rgba(251,191,36,.15);color:#fbbf24">Phá»• biáº¿n</span>
                  </div>
                  <div class="preset-card" onclick="applyPreset('low_balance')">
                    <div class="preset-icon" style="background:rgba(34,197,94,.1);color:#4ade80"><i class="bi bi-wallet2"></i></div>
                    <div class="preset-info"><div class="preset-title">Cáº£nh bÃ¡o sáº¯p háº¿t tiá»n</div><div class="preset-desc">Sá»‘ dÆ° TKQC xuá»‘ng dÆ°á»›i ngÆ°á»¡ng Ä‘áº·t</div></div>
                    <span class="preset-badge" style="background:rgba(34,197,94,.15);color:#4ade80">Quan trá»ng</span>
                  </div>
                  <div class="preset-card" onclick="applyPreset('account_disabled')">
                    <div class="preset-icon" style="background:rgba(168,85,247,.1);color:#c084fc"><i class="bi bi-shield-x"></i></div>
                    <div class="preset-info"><div class="preset-title">TÃ i khoáº£n bá»‹ vÃ´ hiá»‡u hÃ³a</div><div class="preset-desc">Dá»«ng táº¥t cáº£ chiáº¿n dá»‹ch khi TKQC bá»‹ khÃ³a</div></div>
                    <span class="preset-badge" style="background:rgba(168,85,247,.15);color:#c084fc">Tá»± Ä‘á»™ng</span>
                  </div>
                </div>
                <div id="rulesList"></div>
              </div>
            </div>

            <div class="pagination" id="pagination" style="display:none"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Rule Modal -->
  <div class="modal-overlay" id="ruleModal">
    <div class="modal-box" style="width:560px">
      <div class="modal-title"><i class="bi bi-robot" style="color:#c084fc"></i> Táº¡o Quy Táº¯c Tá»± Äá»™ng</div>
      <div class="modal-sub">Há»‡ thá»‘ng kiá»ƒm tra má»—i 15 phÃºt vÃ  thá»±c hiá»‡n hÃ nh Ä‘á»™ng khi Ä‘iá»u kiá»‡n Ä‘Æ°á»£c thá»a mÃ£n.</div>
      <div class="form-group">
        <label class="form-label">TÃªn quy táº¯c</label>
        <input type="text" class="form-control" id="ruleName" placeholder="VÃ­ dá»¥: Táº¯t ads khi thá»‘c tiá»n">
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="form-group">
          <label class="form-label">Loáº¡i Ä‘iá»u kiá»‡n</label>
          <select class="form-control" id="ruleCondType" onchange="updateCondUnit()">
            <option value="spend_spike">Chi tiÃªu tÄƒng Ä‘á»™t ngá»™t (%)</option>
            <option value="cpc_above">CPC vÆ°á»£t ngÆ°á»¡ng (VND)</option>
            <option value="cpm_above">CPM vÆ°á»£t ngÆ°á»¡ng (VND)</option>
            <option value="ctr_below">CTR dÆ°á»›i ngÆ°á»¡ng (%)</option>
            <option value="balance_below">Sá»‘ dÆ° dÆ°á»›i ngÆ°á»¡ng (VND)</option>
            <option value="spend_above">Tá»•ng chi tiÃªu vÆ°á»£t giá»›i háº¡n (VND)</option>
            <option value="account_disabled">TÃ i khoáº£n bá»‹ vÃ´ hiá»‡u hÃ³a</option>
            <option value="no_conversion">KhÃ´ng cÃ³ chuyá»ƒn Ä‘á»•i sau X giá»</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label" id="condValueLabel">GiÃ¡ trá»‹ ngÆ°á»¡ng</label>
          <div style="display:flex;align-items:center;gap:6px">
            <input type="number" class="form-control" id="ruleCondValue" placeholder="50" style="flex:1">
            <span id="condUnit" style="font-size:12px;color:rgba(255,255,255,.4);white-space:nowrap">%</span>
          </div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="form-group">
          <label class="form-label">HÃ nh Ä‘á»™ng</label>
          <select class="form-control" id="ruleAction">
            <option value="pause_campaign">Táº¡m dá»«ng chiáº¿n dá»‹ch</option>
            <option value="pause_adset">Táº¡m dá»«ng nhÃ³m QC</option>
            <option value="pause_ad">Táº¡m dá»«ng quáº£ng cÃ¡o</option>
            <option value="notify_only">Chá»‰ cáº£nh bÃ¡o (khÃ´ng táº¯t)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Ãp dá»¥ng cho</label>
          <select class="form-control" id="ruleScope">
            <option value="all">Táº¥t cáº£ TKQC</option>
            <option value="selected">TKQC Ä‘ang chá»n</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">ThÃ´ng bÃ¡o khi kÃ­ch hoáº¡t</label>
        <div style="display:flex;gap:16px;align-items:center">
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer">
            <input type="checkbox" id="ruleNotifyBrowser" checked style="accent-color:#c084fc"> ThÃ´ng bÃ¡o trÃ¬nh duyá»‡t
          </label>
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer">
            <input type="checkbox" id="ruleNotifyLog" checked style="accent-color:#c084fc"> Ghi log
          </label>
        </div>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
        <button class="btn btn-outline" onclick="closeRuleModal()">Há»§y</button>
        <button class="btn" onclick="saveRule()" style="background:linear-gradient(135deg,#7c3aed,#a855f7);color:#fff"><i class="bi bi-check-lg"></i> LÆ°u Quy Táº¯c</button>
      </div>
    </div>
  </div>

  <!-- Edit Timezone / Country Modal -->
  <div class="modal-overlay" id="editTzModal">
    <div class="modal-box" style="width:540px">
      <div class="modal-title"><i class="bi bi-globe" style="color:#00d4ff"></i> Sá»­a MÃºi Giá» / Quá»‘c Gia</div>
      <div class="modal-sub" id="editTzAccName" style="color:#00d4ff;font-size:13px;margin-bottom:16px"></div>
      <div style="background:rgba(251,191,36,.06);border:1px solid rgba(251,191,36,.15);border-radius:8px;padding:10px 14px;margin-bottom:16px;font-size:12px;color:#fbbf24">
        <i class="bi bi-exclamation-triangle"></i> <strong>LÆ°u Ã½:</strong> Facebook chá»‰ cho phÃ©p sá»­a mÃºi giá» vÃ  quá»‘c gia qua <strong>Business Manager</strong> hoáº·c API vá»›i quyá»n <code>ads_management</code>. Thay Ä‘á»•i cÃ³ thá»ƒ áº£nh hÆ°á»Ÿng Ä‘áº¿n bÃ¡o cÃ¡o vÃ  mÃºi giá» hiá»ƒn thá»‹ cá»§a chiáº¿n dá»‹ch.
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
        <div class="form-group">
          <label class="form-label"><i class="bi bi-globe2" style="color:#60a5fa"></i> Quá»‘c gia</label>
          <select class="form-control" id="editCountry">
            <option value="VN">ğŸ‡»ğŸ‡³ Viá»‡t Nam (VN)</option>
            <option value="US">ğŸ‡ºğŸ‡¸ United States (US)</option>
            <option value="GB">ğŸ‡¬ğŸ‡§ United Kingdom (GB)</option>
            <option value="SG">ğŸ‡¸ğŸ‡¬ Singapore (SG)</option>
            <option value="TH">ğŸ‡¹ğŸ‡­ Thailand (TH)</option>
            <option value="ID">ğŸ‡®ğŸ‡© Indonesia (ID)</option>
            <option value="MY">ğŸ‡²ğŸ‡¾ Malaysia (MY)</option>
            <option value="PH">ğŸ‡µğŸ‡­ Philippines (PH)</option>
            <option value="AU">ğŸ‡¦ğŸ‡º Australia (AU)</option>
            <option value="JP">ğŸ‡¯ğŸ‡µ Japan (JP)</option>
            <option value="KR">ğŸ‡°ğŸ‡· South Korea (KR)</option>
            <option value="CN">ğŸ‡¨ğŸ‡³ China (CN)</option>
            <option value="IN">ğŸ‡®ğŸ‡³ India (IN)</option>
            <option value="DE">ğŸ‡©ğŸ‡ª Germany (DE)</option>
            <option value="FR">ğŸ‡«ğŸ‡· France (FR)</option>
            <option value="CA">ğŸ‡¨ğŸ‡¦ Canada (CA)</option>
            <option value="BR">ğŸ‡§ğŸ‡· Brazil (BR)</option>
            <option value="MX">ğŸ‡²ğŸ‡½ Mexico (MX)</option>
            <option value="AE">ğŸ‡¦ğŸ‡ª UAE (AE)</option>
            <option value="SA">ğŸ‡¸ğŸ‡¦ Saudi Arabia (SA)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label"><i class="bi bi-clock" style="color:#c084fc"></i> MÃºi giá»</label>
          <select class="form-control" id="editTimezone">
            <optgroup label="ÄÃ´ng Nam Ã">
              <option value="Asia/Ho_Chi_Minh">Asia/Ho_Chi_Minh (UTC+7)</option>
              <option value="Asia/Bangkok">Asia/Bangkok (UTC+7)</option>
              <option value="Asia/Jakarta">Asia/Jakarta (UTC+7)</option>
              <option value="Asia/Singapore">Asia/Singapore (UTC+8)</option>
              <option value="Asia/Kuala_Lumpur">Asia/Kuala_Lumpur (UTC+8)</option>
              <option value="Asia/Manila">Asia/Manila (UTC+8)</option>
            </optgroup>
            <optgroup label="ÄÃ´ng Ã">
              <option value="Asia/Shanghai">Asia/Shanghai (UTC+8)</option>
              <option value="Asia/Tokyo">Asia/Tokyo (UTC+9)</option>
              <option value="Asia/Seoul">Asia/Seoul (UTC+9)</option>
              <option value="Asia/Kolkata">Asia/Kolkata (UTC+5:30)</option>
            </optgroup>
            <optgroup label="Trung ÄÃ´ng">
              <option value="Asia/Dubai">Asia/Dubai (UTC+4)</option>
              <option value="Asia/Riyadh">Asia/Riyadh (UTC+3)</option>
            </optgroup>
            <optgroup label="ChÃ¢u Ã‚u">
              <option value="Europe/London">Europe/London (UTC+0/+1)</option>
              <option value="Europe/Paris">Europe/Paris (UTC+1/+2)</option>
              <option value="Europe/Berlin">Europe/Berlin (UTC+1/+2)</option>
            </optgroup>
            <optgroup label="ChÃ¢u Má»¹">
              <option value="America/New_York">America/New_York (UTC-5/-4)</option>
              <option value="America/Chicago">America/Chicago (UTC-6/-5)</option>
              <option value="America/Los_Angeles">America/Los_Angeles (UTC-8/-7)</option>
              <option value="America/Toronto">America/Toronto (UTC-5/-4)</option>
              <option value="America/Sao_Paulo">America/Sao_Paulo (UTC-3)</option>
            </optgroup>
            <optgroup label="ChÃ¢u Ãš c">
              <option value="Australia/Sydney">Australia/Sydney (UTC+10/+11)</option>
            </optgroup>
            <optgroup label="UTC">
              <option value="UTC">UTC (UTC+0)</option>
            </optgroup>
          </select>
        </div>
      </div>
      <div style="background:rgba(0,212,255,.04);border:1px solid rgba(0,212,255,.1);border-radius:8px;padding:10px 14px;margin-bottom:16px">
        <div style="font-size:11.5px;color:rgba(255,255,255,.5);margin-bottom:6px">ThÃ´ng tin hiá»‡n táº¡i</div>
        <div style="display:flex;gap:20px;font-size:12.5px">
          <div><span style="color:rgba(255,255,255,.4)">Quá»‘c gia: </span><span id="currentCountryDisplay" style="color:#60a5fa;font-weight:600"></span></div>
          <div><span style="color:rgba(255,255,255,.4)">MÃºi giá»: </span><span id="currentTzDisplay" style="color:#c084fc;font-weight:600"></span></div>
        </div>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:4px">
        <button class="btn btn-outline" onclick="closeEditTzModal()">Há»§y</button>
        <button class="btn" onclick="saveTimezone()" style="background:linear-gradient(135deg,#1877f2,#00d4ff);color:#fff"><i class="bi bi-check-lg"></i> Cáº­p nháº­t</button>
      </div>
    </div>
  </div>

  <script src="js/ads-shared.js"></script>

<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FB_GRAPH = 'https://graph.facebook.com/v25.0';
const TOKEN_KEY = 'gz_manual_fb_token';
let currentTab = 'accounts';
let allAccounts = [];
let allCampaigns = [];
let allAdsets = [];
let allAds = [];
let selectedAccountId = null;
let selectedAccountName = '';
let selectedCampaignId = null;
let selectedCampaignName = '';
let selectedAdsetId = null;
let selectedAdsetName = '';
let rules = JSON.parse(localStorage.getItem('gz_auto_rules') || '[]');
let sortState = {};

// â”€â”€ Token helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getToken() {
  return localStorage.getItem(TOKEN_KEY) || GZ.getFbToken() || '';
}

function openTokenModal() {
  const t = getToken();
  if (t) document.getElementById('tokenInput').value = t;
  document.getElementById('tokenModal').classList.add('open');
}

function closeTokenModal() {
  document.getElementById('tokenModal').classList.remove('open');
}

function saveToken() {
  const t = document.getElementById('tokenInput').value.trim();
  if (!t) { GZ.toast('Vui lÃ²ng nháº­p token', 'error'); return; }
  if (!t.startsWith('EAA') && !t.startsWith('EAB')) {
    GZ.toast('Token khÃ´ng há»£p lá»‡ (pháº£i báº¯t Ä‘áº§u báº±ng EAA...)', 'error'); return;
  }
  localStorage.setItem(TOKEN_KEY, t);
  closeTokenModal();
  updateTokenUI();
  loadAccounts();
  GZ.toast('ÄÃ£ lÆ°u token! Äang táº£i dá»¯ liá»‡u...', 'success');
}

function clearToken() {
  localStorage.removeItem(TOKEN_KEY);
  updateTokenUI();
  setTableMsg('accounts', 'ChÆ°a cÃ³ token â€” nháº¥n nÃºt <strong style="color:#fbbf24">ğŸ”‘ Token</strong> á»Ÿ gÃ³c trÃªn pháº£i Ä‘á»ƒ nháº­p');
  document.getElementById('statsRow').style.display = 'none';
  allAccounts = [];
  GZ.toast('ÄÃ£ xÃ³a token', 'info');
}

function updateTokenUI() {
  const t = getToken();
  const banner = document.getElementById('tokenBanner');
  const indicator = document.getElementById('tokenIndicator');
  const connDot = document.getElementById('connDot');
  const connText = document.getElementById('connText');
  if (t) {
    if (banner) { banner.style.display = 'flex'; }
    if (indicator) indicator.style.display = 'inline';
    if (connDot) { connDot.style.background = '#4ade80'; connDot.style.boxShadow = '0 0 6px #4ade80'; }
    if (connText) connText.textContent = 'ÄÃ£ káº¿t ná»‘i token';
  } else {
    if (banner) { banner.style.display = 'none'; }
    if (indicator) indicator.style.display = 'none';
    if (connDot) { connDot.style.background = '#f87171'; connDot.style.boxShadow = 'none'; }
    if (connText) connText.textContent = 'ChÆ°a káº¿t ná»‘i';
  }
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setTableMsg(tab, msg) {
  const el = document.getElementById('tbody-' + tab);
  const cols = { accounts: 9, campaigns: 10, adsets: 10, ads: 10 };
  if (el) el.innerHTML = `<tr class="loading-row"><td colspan="${cols[tab] || 9}">${msg}</td></tr>`;
}

function setLoading(tab) {
  setTableMsg(tab, '<span class="spinner"></span> Äang táº£i...');
}

function fmtMoney(val, currency) {
  if (!val && val !== 0) return 'â€”';
  const n = parseFloat(val);
  if (isNaN(n)) return 'â€”';
  if (currency === 'VND' || currency === 'VNÄ') return n.toLocaleString('vi-VN') + 'Ä‘';
  return n.toLocaleString('en-US', { style: 'currency', currency: currency || 'USD', maximumFractionDigits: 2 });
}

function fmtNum(val) {
  if (!val && val !== 0) return 'â€”';
  return parseFloat(val).toLocaleString('vi-VN');
}

function fmtPct(val) {
  if (!val && val !== 0) return 'â€”';
  return parseFloat(val).toFixed(2) + '%';
}

function statusBadge(status) {
  const map = {
    1: ['Hoáº¡t Ä‘á»™ng', '#4ade80', 'rgba(34,197,94,.1)'],
    2: ['VÃ´ hiá»‡u hÃ³a', '#f87171', 'rgba(239,68,68,.1)'],
    3: ['ChÆ°a xÃ¡c nháº­n', '#fbbf24', 'rgba(251,191,36,.1)'],
    7: ['Äang xem xÃ©t', '#60a5fa', 'rgba(96,165,250,.1)'],
    8: ['Äang xem xÃ©t', '#60a5fa', 'rgba(96,165,250,.1)'],
    9: ['Bá»‹ Ä‘Ã³ng', '#9ca3af', 'rgba(156,163,175,.1)'],
    100: ['Äang cháº¡y', '#4ade80', 'rgba(34,197,94,.1)'],
    ACTIVE: ['Äang cháº¡y', '#4ade80', 'rgba(34,197,94,.1)'],
    PAUSED: ['Táº¡m dá»«ng', '#fbbf24', 'rgba(251,191,36,.1)'],
    DELETED: ['ÄÃ£ xÃ³a', '#9ca3af', 'rgba(156,163,175,.1)'],
    ARCHIVED: ['LÆ°u trá»¯', '#6b7280', 'rgba(107,114,128,.1)'],
    PENDING_REVIEW: ['Äang xem xÃ©t', '#60a5fa', 'rgba(96,165,250,.1)'],
    DISAPPROVED: ['Bá»‹ tá»« chá»‘i', '#f87171', 'rgba(239,68,68,.1)'],
    PREAPPROVED: ['Tiá»n duyá»‡t', '#a78bfa', 'rgba(167,139,250,.1)'],
    PENDING_BILLING_INFO: ['Chá» thanh toÃ¡n', '#fb923c', 'rgba(251,146,60,.1)'],
    CAMPAIGN_PAUSED: ['Chiáº¿n dá»‹ch dá»«ng', '#fbbf24', 'rgba(251,191,36,.1)'],
    ADSET_PAUSED: ['NhÃ³m dá»«ng', '#fbbf24', 'rgba(251,191,36,.1)'],
    IN_PROCESS: ['Äang xá»­ lÃ½', '#60a5fa', 'rgba(96,165,250,.1)'],
    WITH_ISSUES: ['CÃ³ váº¥n Ä‘á»', '#f87171', 'rgba(239,68,68,.1)'],
  };
  const [label, color, bg] = map[status] || ['KhÃ´ng rÃµ', '#9ca3af', 'rgba(156,163,175,.1)'];
  return `<span style="background:${bg};color:${color};border:1px solid ${color}33;border-radius:12px;padding:2px 9px;font-size:11px;font-weight:600;white-space:nowrap;display:inline-block">${label}</span>`;
}

// â”€â”€ Rate Limit & Cache System â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API_CACHE = {};
const CACHE_TTL = 5 * 60 * 1000; // 5 phÃºt
const RATE_LIMIT_CODES = [4, 17, 32, 613, 80004];
let rateLimitUntil = 0;
let pendingRequests = 0;

function getCacheKey(path, params) {
  return path + '|' + JSON.stringify(params);
}

function getCache(key) {
  const c = API_CACHE[key];
  if (c && Date.now() - c.ts < CACHE_TTL) return c.data;
  return null;
}

function setCache(key, data) {
  API_CACHE[key] = { data, ts: Date.now() };
}

function clearCacheFor(prefix) {
  Object.keys(API_CACHE).forEach(k => { if (k.startsWith(prefix)) delete API_CACHE[k]; });
}

function updateRateLimitUI() {
  const indicator = document.getElementById('rateLimitIndicator');
  if (!indicator) return;
  if (Date.now() < rateLimitUntil) {
    const secs = Math.ceil((rateLimitUntil - Date.now()) / 1000);
    indicator.style.display = 'flex';
    indicator.innerHTML = `<i class="bi bi-hourglass-split" style="color:#fbbf24"></i> Rate limit: chá» ${secs}s`;
  } else {
    indicator.style.display = 'none';
  }
}

async function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// â”€â”€ Facebook API vá»›i retry + cache â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fbGet(path, params = {}, opts = {}) {
  const token = getToken();
  if (!token) throw new Error('ChÆ°a cÃ³ token');
  const cacheKey = getCacheKey(path, params);
  if (!opts.noCache) {
    const cached = getCache(cacheKey);
    if (cached) return cached;
  }
  // Chá» náº¿u Ä‘ang bá»‹ rate limit
  if (Date.now() < rateLimitUntil) {
    await sleep(rateLimitUntil - Date.now());
  }
  const qs = new URLSearchParams({ ...params, access_token: token }).toString();
  let retries = 0;
  while (retries <= 3) {
    try {
      pendingRequests++;
      const resp = await fetch(`${FB_GRAPH}${path}?${qs}`);
      pendingRequests--;
      const data = await resp.json();
      if (data.error) {
        const code = data.error.code;
        if (RATE_LIMIT_CODES.includes(code)) {
          // Exponential backoff: 5s, 15s, 45s
          const wait = Math.pow(3, retries + 1) * 5000;
          rateLimitUntil = Date.now() + wait;
          updateRateLimitUI();
          GZ.toast(`Rate limit FB API â€” Ä‘á»£i ${wait/1000}s rá»“i thá»­ láº¡i...`, 'warn');
          await sleep(wait);
          retries++;
          continue;
        }
        throw new Error(`[${code}] ${data.error.message}`);
      }
      if (!opts.noCache) setCache(cacheKey, data);
      return data;
    } catch(e) {
      pendingRequests--;
      if (retries >= 3) throw e;
      await sleep(2000 * (retries + 1));
      retries++;
    }
  }
}

// fbGetAll: phÃ¢n trang nhÆ°ng giá»›i háº¡n tá»‘i Ä‘a 3 trang (150 items) trÃ¡nh quÃ¡ nhiá»u request
async function fbGetAll(path, params = {}, maxPages = 3) {
  const cacheKey = 'all:' + getCacheKey(path, params);
  const cached = getCache(cacheKey);
  if (cached) return cached;

  let results = [];
  let url = `${FB_GRAPH}${path}?${new URLSearchParams({ ...params, access_token: getToken() })}`;
  let page = 0;
  while (url && page < maxPages) {
    // Delay nhá» giá»¯a cÃ¡c trang Ä‘á»ƒ trÃ¡nh burst
    if (page > 0) await sleep(300);
    const resp = await fetch(url);
    const data = await resp.json();
    if (data.error) {
      const code = data.error.code;
      if (RATE_LIMIT_CODES.includes(code)) {
        const wait = 10000;
        rateLimitUntil = Date.now() + wait;
        updateRateLimitUI();
        GZ.toast(`Rate limit â€” Ä‘á»£i 10s...`, 'warn');
        await sleep(wait);
        continue; // thá»­ láº¡i trang nÃ y
      }
      throw new Error(`[${code}] ${data.error.message}`);
    }
    results = results.concat(data.data || []);
    url = data.paging?.next || null;
    page++;
  }
  setCache(cacheKey, results);
  return results;
}

// fbBatch: gá»™p nhiá»u request thÃ nh 1 láº§n gá»i (Facebook Batch API)
async function fbBatch(requests) {
  const token = getToken();
  if (!token) throw new Error('ChÆ°a cÃ³ token');
  // Tá»‘i Ä‘a 50 request/batch
  const chunks = [];
  for (let i = 0; i < requests.length; i += 50) chunks.push(requests.slice(i, i + 50));
  let allResults = [];
  for (const chunk of chunks) {
    if (chunks.indexOf(chunk) > 0) await sleep(500);
    const body = new URLSearchParams({
      access_token: token,
      batch: JSON.stringify(chunk.map(r => ({ method: 'GET', relative_url: r })))
    });
    const resp = await fetch('https://graph.facebook.com/v25.0', { method: 'POST', body });
    const results = await resp.json();
    allResults = allResults.concat(results);
  }
  return allResults.map(r => {
    if (!r || r.code !== 200) return null;
    try { return JSON.parse(r.body); } catch { return null; }
  });
}

// â”€â”€ Load Accounts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAccounts() {
  const token = getToken();
  if (!token) {
    setTableMsg('accounts', 'ğŸ”‘ ChÆ°a cÃ³ token â€” nháº¥n nÃºt <strong style="color:#fbbf24">ğŸ”‘ Token</strong> á»Ÿ gÃ³c trÃªn pháº£i Ä‘á»ƒ nháº­p Access Token');
    return;
  }
  setLoading('accounts');
  try {
    const datePreset = document.getElementById('datePreset')?.value || 'last_7d';
    const data = await fbGetAll('/me/adaccounts', {
      fields: 'id,name,account_status,currency,timezone_name,country,balance,amount_spent',
      date_preset: datePreset,
      limit: 50
    });
    allAccounts = data;
    renderAccounts(data);
    updateStats(data);
    document.getElementById('countAccounts').textContent = data.length;
    // Load insights hÃ´m nay + theo giá» (báº¥t Ä‘á»“ng bá»™, khÃ´ng block UI)
    loadAccountsInsights(data);
  } catch(e) {
    setTableMsg('accounts', `<span style="color:#f87171"><i class="bi bi-exclamation-triangle"></i> Lá»—i: ${e.message}</span>`);
    GZ.toast('Lá»—i táº£i TKQC: ' + e.message, 'error');
  }
}

function renderAccounts(data) {
  const tbody = document.getElementById('tbody-accounts');
  if (!data.length) {
    tbody.innerHTML = '<tr class="loading-row"><td colspan="9">KhÃ´ng tÃ¬m tháº¥y tÃ i khoáº£n quáº£ng cÃ¡o nÃ o</td></tr>';
    return;
  }
  tbody.innerHTML = data.map(a => {
    const id = a.id.replace('act_', '');
    return `<tr style="cursor:pointer" onclick="selectAccount('${a.id}','${(a.name||'').replace(/'/g,"\\'")}')">  
      <td><input type="checkbox" class="row-check" value="${a.id}" onclick="event.stopPropagation()"></td>
      <td>
        <div style="font-weight:600;font-size:13px">${a.name || 'KhÃ´ng tÃªn'}</div>
        <div style="font-size:11px;color:rgba(255,255,255,.35)">act_${id}</div>
      </td>
      <td>${statusBadge(a.account_status)}</td>
      <td style="font-size:12px">${a.country || 'â€”'}</td>
      <td style="font-size:11.5px;color:rgba(255,255,255,.5)">${a.timezone_name || 'â€”'}</td>
      <td style="font-size:12px">${a.currency || 'â€”'}</td>
      <td style="color:#4ade80;font-weight:600">${fmtMoney(a.balance, a.currency)}</td>
      <td style="color:#60a5fa">${fmtMoney(a.amount_spent, a.currency)}</td>
      <td id="today-${a.id}" style="color:#fbbf24"><span style="color:rgba(255,255,255,.2);font-size:11px"><span class="spinner" style="width:10px;height:10px"></span></span></td>
      <td id="spark-${a.id}"><span style="color:rgba(255,255,255,.2);font-size:10px">â€”</span></td>
      <td>
        <button class="btn-icon" style="font-size:11px;padding:3px 8px" onclick="event.stopPropagation();openEditTzModal('${a.id}','${(a.name||'').replace(/'/g,"\\'")}')"
          title="Sá»­a mÃºi giá»"><i class="bi bi-globe"></i></button>
      </td>
    </tr>`;
  }).join('');
}

function updateStats(data) {
  const statsRow = document.getElementById('statsRow');
  if (!data.length) { statsRow.style.display = 'none'; return; }
  statsRow.style.display = 'flex';
  document.getElementById('sTotalAcc').textContent = data.length;
  document.getElementById('sActiveAcc').textContent = data.filter(a => a.account_status === 1).length;
  document.getElementById('sLockedAcc').textContent = data.filter(a => a.account_status === 2 || a.account_status === 9).length;
  // Tá»•ng chi tiÃªu (chá»‰ tÃ­nh VND hoáº·c cÃ¹ng currency)
  const currencies = [...new Set(data.map(a => a.currency).filter(Boolean))];
  if (currencies.length === 1) {
    const cur = currencies[0];
    const totalSpend = data.reduce((s, a) => s + (parseFloat(a.amount_spent) || 0), 0);
    const totalBalance = data.reduce((s, a) => s + (parseFloat(a.balance) || 0), 0);
    document.getElementById('sTotalSpend').textContent = fmtMoney(totalSpend, cur);
    document.getElementById('sTotalBalance').textContent = fmtMoney(totalBalance, cur);
  } else {
    document.getElementById('sTotalSpend').textContent = 'Äa tiá»n tá»‡';
    document.getElementById('sTotalBalance').textContent = 'Äa tiá»n tá»‡';
  }
}// â”€â”€ Insights theo giá» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAccountsInsights(accounts) {
  // Láº¥y giá» hiá»‡n táº¡i (0-23)
  const nowHour = new Date().getHours();
  // Gá»i insights tá»«ng TKQC tuáº§n tá»± (trÃ¡nh burst rate limit)
  for (const acc of accounts) {
    try {
      // Láº¥y chi tiÃªu hÃ´m nay (1 call Ä‘Æ¡n giáº£n, cháº¯c cháº¯n hoáº¡t Ä‘á»™ng)
      const todayStr = new Date().toISOString().slice(0, 10);
      const [todayIns, weekIns] = await Promise.all([
        fbGet(`/${acc.id}/insights`, {
          fields: 'spend',
          date_preset: 'today',
          limit: 1
        }, { noCache: false }),
        fbGet(`/${acc.id}/insights`, {
          fields: 'spend,date_start',
          date_preset: 'last_7d',
          time_increment: 1,
          limit: 7
        }, { noCache: false })
      ]);
      // Tá»•ng chi tiÃªu hÃ´m nay
      const todaySpend = parseFloat(todayIns?.data?.[0]?.spend || 0);
      // Dá»¯ liá»‡u 7 ngÃ y cho sparkline (thay cho hourly)
      const weekData = weekIns?.data || [];
      // hourArr giá» â†’ dÃ¹ng dayArr 7 ngÃ y thay tháº¿
      const hourArr = Array(7).fill(0);
      weekData.forEach((d, i) => { hourArr[i] = parseFloat(d.spend || 0); });
      // Cáº­p nháº­t cell chi tiÃªu hÃ´m nay
      const todayCell = document.getElementById(`today-${acc.id}`);
      if (todayCell) {
        if (todaySpend > 0) {
          todayCell.innerHTML = `<span class="today-spend">${fmtMoney(todaySpend, acc.currency)}</span>`;
        } else {
          todayCell.innerHTML = `<span class="today-spend zero">â€” 0</span>`;
        }
      }
      // Cáº­p nháº­t sparkline
      const sparkCell = document.getElementById(`spark-${acc.id}`);
      if (sparkCell) {
        sparkCell.innerHTML = renderSparkline(hourArr, nowHour, acc.currency);
      }
    } catch(e) {
      // KhÃ´ng hiá»ƒn thá»‹ lá»—i â€” chá»‰ Ä‘á»ƒ trá»‘ng
      const todayCell = document.getElementById(`today-${acc.id}`);
      const sparkCell = document.getElementById(`spark-${acc.id}`);
      if (todayCell) todayCell.innerHTML = `<span style="color:rgba(255,255,255,.2);font-size:10px" title="${e.message}">âš </span>`;
      if (sparkCell) sparkCell.innerHTML = `<span style="color:rgba(255,255,255,.2);font-size:10px">â€”</span>`;
    }
    // Delay 400ms giá»¯a cÃ¡c TKQC Ä‘á»ƒ trÃ¡nh rate limit
    await sleep(400);
  }
}

function renderSparkline(dayArr, nowHour, currency) {
  const maxVal = Math.max(...dayArr, 1);
  const days = ['âˆ’6', 'âˆ’5', 'âˆ’â€“4', 'âˆ’â€“3', 'âˆ’â€“2', 'HÃ´m qua', 'HÃ´m nay'];
  if (dayArr.every(v => v === 0)) {
    return `<span style="color:rgba(255,255,255,.2);font-size:10px">ChÆ°a cÃ³ chi tiÃªu</span>`;
  }
  const bars = dayArr.map((val, i) => {
    const pct = Math.round((val / maxVal) * 26);
    const h = Math.max(pct, 2);
    const isToday = i === dayArr.length - 1;
    const label = `${days[i] || ('NgÃ y ' + (i+1))} â€” ${fmtMoney(val, currency)}`;
    return `<div class="spark-bar${isToday ? ' current-hour' : ''}" style="height:${h}px" title="${label}">
      <div class="spark-tooltip">${label}</div>
    </div>`;
  }).join('');
  const total = dayArr.reduce((s, v) => s + v, 0);
  return `<div style="display:flex;flex-direction:column;gap:2px">
    <div class="sparkline-wrap">${bars}</div>
    <div style="font-size:9.5px;color:rgba(255,255,255,.3)">7 ngÃ y â€¢ tá»•ng ${fmtMoney(total, currency)}</div>
  </div>`;
}

// â”€â”€ Select Account â†’ load campaigns â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectAccount(accountId, accountName) {
  selectedAccountId = accountId;
  selectedAccountName = accountName;
  switchTab('campaigns');
  loadCampaigns(accountId);
}

async function loadCampaigns(accountId) {
  setLoading('campaigns');
  try {
    const datePreset = document.getElementById('datePreset')?.value || 'last_7d';
    // Láº¥y danh sÃ¡ch campaign + effective_status
    const data = await fbGetAll(`/${accountId}/campaigns`, {
      fields: 'id,name,status,effective_status,objective,daily_budget,lifetime_budget',
      limit: 50
    });
    // Láº¥y insights riÃªng vá»›i date_preset Ä‘Ãºng
    if (data.length > 0) {
      try {
        const insResp = await fbGet(`/${accountId}/insights`, {
          fields: 'campaign_id,spend,impressions,clicks,ctr,cpc',
          date_preset: datePreset,
          level: 'campaign',
          limit: 200
        });
        const insMap = {};
        (insResp?.data || []).forEach(r => { insMap[r.campaign_id] = r; });
        data.forEach(c => { c._ins = insMap[c.id] || {}; });
      } catch(e2) {
        data.forEach(c => { c._ins = {}; });
      }
    }
    allCampaigns = data;
    renderCampaigns(data);
    document.getElementById('countCampaigns').textContent = data.length;
    updateContextBar();
  } catch(e) {
    setTableMsg('campaigns', `<span style="color:#f87171">Lá»—i: ${e.message}</span>`);
  }
}

function renderCampaigns(data) {
  const tbody = document.getElementById('tbody-campaigns');
  if (!data.length) {
    tbody.innerHTML = '<tr class="loading-row"><td colspan="10">KhÃ´ng cÃ³ chiáº¿n dá»‹ch nÃ o</td></tr>';
    return;
  }
  tbody.innerHTML = data.map(c => {
    const ins = c._ins || {};
    const budget = c.daily_budget ? fmtMoney(c.daily_budget/100, 'VND') : (c.lifetime_budget ? fmtMoney(c.lifetime_budget/100, 'VND') + ' (trá»n Ä‘á»i)' : 'â€”');
    const effStatus = c.effective_status || c.status;
    return `<tr style="cursor:pointer" onclick="selectCampaign('${c.id}','${(c.name||'').replace(/'/g,"\\'")}')">  
      <td><input type="checkbox" onclick="event.stopPropagation()"></td>
      <td><div style="font-weight:600;font-size:13px">${c.name||'â€”'}</div><div style="font-size:11px;color:rgba(255,255,255,.3)">${c.id}</div></td>
      <td>${statusBadge(effStatus)}</td>
      <td style="font-size:12px;color:rgba(255,255,255,.6)">${c.objective||'â€”'}</td>
      <td style="font-size:12px">${budget}</td>
      <td style="color:#60a5fa">${ins.spend ? fmtMoney(ins.spend,'VND') : 'â€”'}</td>
      <td>${fmtNum(ins.impressions)}</td>
      <td>${fmtNum(ins.clicks)}</td>
      <td>${fmtPct(ins.ctr)}</td>
      <td>${ins.cpc ? fmtMoney(ins.cpc,'VND') : 'â€”'}</td>
    </tr>`;
  }).join('');
}

function selectCampaign(campaignId, campaignName) {
  selectedCampaignId = campaignId;
  selectedCampaignName = campaignName;
  switchTab('adsets');
  loadAdsets(campaignId);
}

async function loadAdsets(campaignId) {
  setLoading('adsets');
  try {
    const datePreset = document.getElementById('datePreset')?.value || 'last_7d';
    // BÆ°á»›c 1: Láº¥y danh sÃ¡ch adsets
    const data = await fbGetAll(`/${campaignId}/adsets`, {
      fields: 'id,name,status,effective_status,campaign_id,daily_budget',
      limit: 50
    });
    // BÆ°á»›c 2: Láº¥y insights tá»«ng adset song song (batch)
    if (data.length > 0) {
      try {
        const insPromises = data.map(s =>
          fbGet(`/${s.id}/insights`, {
            fields: 'spend,impressions,clicks,cpm,cpc',
            date_preset: datePreset
          }, { noCache: false }).catch(() => null)
        );
        const insResults = await Promise.all(insPromises);
        data.forEach((s, i) => {
          s._ins = insResults[i]?.data?.[0] || {};
        });
      } catch(e2) { data.forEach(s => { s._ins = {}; }); }
    }
    allAdsets = data;
    renderAdsets(data);
    document.getElementById('countAdsets').textContent = data.length;
    updateContextBar();
  } catch(e) {
    setTableMsg('adsets', `<span style="color:#f87171">Lá»—i: ${e.message}</span>`);
  }
}

function renderAdsets(data) {
  const tbody = document.getElementById('tbody-adsets');
  if (!data.length) {
    tbody.innerHTML = '<tr class="loading-row"><td colspan="10">KhÃ´ng cÃ³ nhÃ³m quáº£ng cÃ¡o nÃ o</td></tr>';
    return;
  }
  tbody.innerHTML = data.map(s => {
    const ins = s._ins || {};
    const budget = s.daily_budget ? fmtMoney(s.daily_budget/100, 'VND') : 'â€”';
    const effStatus = s.effective_status || s.status;
    return `<tr style="cursor:pointer" onclick="selectAdset('${s.id}','${(s.name||'').replace(/'/g,"\\'")}')">  
      <td><input type="checkbox" onclick="event.stopPropagation()"></td>
      <td><div style="font-weight:600;font-size:13px">${s.name||'â€”'}</div><div style="font-size:11px;color:rgba(255,255,255,.3)">${s.id}</div></td>
      <td>${statusBadge(effStatus)}</td>
      <td style="font-size:12px;color:rgba(255,255,255,.5)">${s.campaign_id||'â€”'}</td>
      <td style="font-size:12px">${budget}</td>
      <td style="color:#60a5fa">${ins.spend ? fmtMoney(ins.spend,'VND') : 'â€”'}</td>
      <td>${fmtNum(ins.impressions)}</td>
      <td>${fmtNum(ins.clicks)}</td>
      <td>${ins.cpm ? fmtMoney(ins.cpm,'VND') : 'â€”'}</td>
      <td>${ins.cpc ? fmtMoney(ins.cpc,'VND') : 'â€”'}</td>
    </tr>`;
  }).join('');
}

function selectAdset(adsetId, adsetName) {
  selectedAdsetId = adsetId;
  selectedAdsetName = adsetName;
  switchTab('ads');
  loadAds(adsetId);
}

async function loadAds(adsetId) {
  setLoading('ads');
  try {
    const datePreset = document.getElementById('datePreset')?.value || 'last_7d';
    // BÆ°á»›c 1: Láº¥y danh sÃ¡ch ads
    const data = await fbGetAll(`/${adsetId}/ads`, {
      fields: 'id,name,status,effective_status,adset_id',
      limit: 50
    });
    // BÆ°á»›c 2: Láº¥y insights tá»«ng ad song song
    if (data.length > 0) {
      try {
        const insPromises = data.map(ad =>
          fbGet(`/${ad.id}/insights`, {
            fields: 'spend,impressions,clicks,ctr,cpc,cpm',
            date_preset: datePreset
          }, { noCache: false }).catch(() => null)
        );
        const insResults = await Promise.all(insPromises);
        data.forEach((ad, i) => {
          ad._ins = insResults[i]?.data?.[0] || {};
        });
      } catch(e2) { data.forEach(ad => { ad._ins = {}; }); }
    }
    allAds = data;
    renderAds(data);
    document.getElementById('countAds').textContent = data.length;
    updateContextBar();
  } catch(e) {
    setTableMsg('ads', `<span style="color:#f87171">Lá»—i: ${e.message}</span>`);
  }
}

function renderAds(data) {
  const tbody = document.getElementById('tbody-ads');
  if (!data.length) {
    tbody.innerHTML = '<tr class="loading-row"><td colspan="10">KhÃ´ng cÃ³ quáº£ng cÃ¡o nÃ o</td></tr>';
    return;
  }
  tbody.innerHTML = data.map(ad => {
    const ins = ad._ins || {};
    const effStatus = ad.effective_status || ad.status;
    return `<tr>  
      <td><input type="checkbox"></td>
      <td><div style="font-weight:600;font-size:13px">${ad.name||'â€”'}</div><div style="font-size:11px;color:rgba(255,255,255,.3)">${ad.id}</div></td>
      <td>${statusBadge(effStatus)}</td>
      <td style="font-size:12px;color:rgba(255,255,255,.5)">${ad.adset_id||'â€”'}</td>
      <td style="color:#60a5fa">${ins.spend ? fmtMoney(ins.spend,'VND') : 'â€”'}</td>
      <td>${fmtNum(ins.impressions)}</td>
      <td>${fmtNum(ins.clicks)}</td>
      <td>${fmtPct(ins.ctr)}</td>
      <td>${ins.cpc ? fmtMoney(ins.cpc,'VND') : 'â€”'}</td>
      <td>${ins.cpm ? fmtMoney(ins.cpm,'VND') : 'â€”'}</td>
    </tr>`;
  }).join('');
}

// â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  currentTab = tab;
  ['accounts','campaigns','adsets','ads','rules'].forEach(t => {
    document.getElementById('panel-' + t).style.display = t === tab ? 'block' : 'none';
    document.getElementById('tab-' + t).classList.toggle('active', t === tab);
  });
  if (tab === 'rules') renderRules();
  updateContextBar();
}

function updateContextBar() {
  const bar = document.getElementById('contextBar');
  if (!bar) return;
  if (selectedAccountName && currentTab !== 'accounts') {
    bar.style.display = 'flex';
    bar.innerHTML = `<i class="bi bi-credit-card" style="color:#00d4ff"></i> <span style="color:rgba(255,255,255,.5)">TKQC:</span> <strong style="color:#00d4ff">${selectedAccountName}</strong>`;
  } else {
    bar.style.display = 'none';
  }
}

function loadCurrentTab() {
  if (currentTab === 'accounts') loadAccounts();
  else if (currentTab === 'campaigns' && selectedAccountId) loadCampaigns(selectedAccountId);
}

function refreshData() {
  loadCurrentTab();
  GZ.toast('Äang lÃ m má»›i...', 'info');
}

function clearAllCache() {
  Object.keys(API_CACHE).forEach(k => delete API_CACHE[k]);
  rateLimitUntil = 0;
  updateRateLimitUI();
  loadCurrentTab();
  GZ.toast('XoÃ¡ cache â€” Ä‘ang táº£i láº¡i dá»¯ liá»‡u má»›i...', 'success');
}

// â”€â”€ Search & filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function filterTable() {
  const q = document.getElementById('searchInput').value.toLowerCase();
  const tbody = document.getElementById('tbody-' + currentTab);
  if (!tbody) return;
  tbody.querySelectorAll('tr').forEach(row => {
    row.style.display = row.textContent.toLowerCase().includes(q) ? '' : 'none';
  });
}

function sortTable(tab, field) {
  // Simple sort toggle
  const asc = sortState[tab + field] !== 'asc';
  sortState[tab + field] = asc ? 'asc' : 'desc';
  let arr = tab === 'accounts' ? allAccounts : tab === 'campaigns' ? allCampaigns : tab === 'adsets' ? allAdsets : allAds;
  arr.sort((a, b) => {
    const va = a[field] ?? '';
    const vb = b[field] ?? '';
    if (typeof va === 'number') return asc ? va - vb : vb - va;
    return asc ? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
  });
  if (tab === 'accounts') renderAccounts(arr);
  else if (tab === 'campaigns') renderCampaigns(arr);
  else if (tab === 'adsets') renderAdsets(arr);
  else renderAds(arr);
}

function toggleCheckAll(cb) {
  document.querySelectorAll('.row-check').forEach(c => c.checked = cb.checked);
}

// â”€â”€ Export CSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportCSV() {
  let rows = [], headers = [];
  if (currentTab === 'accounts') {
    headers = ['ID','TÃªn','Tráº¡ng thÃ¡i','Quá»‘c gia','MÃºi giá»','Tiá»n tá»‡','Sá»‘ dÆ°','Chi tiÃªu'];
    rows = allAccounts.map(a => [a.id, a.name, a.account_status, a.country, a.timezone_name, a.currency, a.balance, a.amount_spent]);
  } else if (currentTab === 'campaigns') {
    headers = ['ID','TÃªn','Tráº¡ng thÃ¡i','Má»¥c tiÃªu','NgÃ¢n sÃ¡ch ngÃ y'];
    rows = allCampaigns.map(c => [c.id, c.name, c.status, c.objective, c.daily_budget]);
  }
  if (!rows.length) { GZ.toast('KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»ƒ xuáº¥t', 'error'); return; }
  let csv = headers.join(',') + '\n' + rows.map(r => r.map(v => `"${String(v||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob(['\ufeff'+csv], {type:'text/csv;charset=utf-8'}));
  a.download = `tkqc_${currentTab}_${Date.now()}.csv`;
  a.click();
  GZ.toast('ÄÃ£ xuáº¥t CSV!', 'success');
}

// â”€â”€ Rules â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openRuleModal() { document.getElementById('ruleModal').classList.add('open'); }
function closeRuleModal() { document.getElementById('ruleModal').classList.remove('open'); }

function saveRule() {
  const name = document.getElementById('ruleName').value.trim();
  if (!name) { GZ.toast('Vui lÃ²ng nháº­p tÃªn quy táº¯c', 'error'); return; }
  const rule = {
    id: Date.now(),
    name,
    condType: document.getElementById('ruleCondType').value,
    condValue: document.getElementById('ruleCondValue').value,
    action: document.getElementById('ruleAction').value,
    scope: document.getElementById('ruleScope').value,
    notifyBrowser: document.getElementById('ruleNotifyBrowser').checked,
    notifyLog: document.getElementById('ruleNotifyLog').checked,
    enabled: true,
    createdAt: Date.now()
  };
  rules.unshift(rule);
  localStorage.setItem('gz_auto_rules', JSON.stringify(rules));
  closeRuleModal();
  renderRules();
  document.getElementById('countRules').textContent = rules.length;
  GZ.toast('ÄÃ£ lÆ°u quy táº¯c!', 'success');
}

function deleteRule(id) {
  rules = rules.filter(r => r.id !== id);
  localStorage.setItem('gz_auto_rules', JSON.stringify(rules));
  renderRules();
  document.getElementById('countRules').textContent = rules.length;
  GZ.toast('ÄÃ£ xÃ³a quy táº¯c', 'info');
}

function toggleRule(id) {
  const r = rules.find(r => r.id === id);
  if (r) { r.enabled = !r.enabled; localStorage.setItem('gz_auto_rules', JSON.stringify(rules)); renderRules(); }
}

function applyPreset(type) {
  const presets = {
    spend_spike: { name: 'Táº¯t khi thá»‘c tiá»n Ä‘á»™t ngá»™t', condType: 'spend_spike', condValue: '50', action: 'pause_campaign' },
    high_cpc: { name: 'Táº¯t khi CPC quÃ¡ Ä‘áº¯t', condType: 'cpc_above', condValue: '50000', action: 'pause_ad' },
    low_balance: { name: 'Cáº£nh bÃ¡o sáº¯p háº¿t tiá»n', condType: 'balance_below', condValue: '500000', action: 'notify_only' },
    account_disabled: { name: 'TÃ i khoáº£n bá»‹ vÃ´ hiá»‡u hÃ³a', condType: 'account_disabled', condValue: '0', action: 'pause_campaign' }
  };
  const p = presets[type];
  if (!p) return;
  document.getElementById('ruleName').value = p.name;
  document.getElementById('ruleCondType').value = p.condType;
  document.getElementById('ruleCondValue').value = p.condValue;
  document.getElementById('ruleAction').value = p.action;
  openRuleModal();
}

function updateCondUnit() {
  const type = document.getElementById('ruleCondType').value;
  const units = { spend_spike: '%', cpc_above: 'VND', cpm_above: 'VND', ctr_below: '%', balance_below: 'VND', spend_above: 'VND', account_disabled: '', no_conversion: 'giá»' };
  document.getElementById('condUnit').textContent = units[type] || '';
}

function renderRules() {
  const el = document.getElementById('rulesList');
  document.getElementById('countRules').textContent = rules.length;
  if (!rules.length) {
    el.innerHTML = '<div style="text-align:center;padding:30px;color:rgba(255,255,255,.3);font-size:13px">ChÆ°a cÃ³ quy táº¯c nÃ o. Táº¡o quy táº¯c hoáº·c chá»n preset bÃªn trÃªn.</div>';
    return;
  }
  el.innerHTML = rules.map(r => `
    <div style="background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.07);border-radius:10px;padding:12px 16px;margin-bottom:8px;display:flex;align-items:center;gap:12px">
      <div style="flex:1">
        <div style="font-weight:600;font-size:13px">${r.name}</div>
        <div style="font-size:11.5px;color:rgba(255,255,255,.4);margin-top:3px">${r.condType} > ${r.condValue} â†’ ${r.action}</div>
      </div>
      <label style="display:flex;align-items:center;gap:5px;cursor:pointer;font-size:12px;color:${r.enabled ? '#4ade80' : 'rgba(255,255,255,.3)'}">
        <input type="checkbox" ${r.enabled ? 'checked' : ''} onchange="toggleRule(${r.id})" style="accent-color:#4ade80"> ${r.enabled ? 'Báº­t' : 'Táº¯t'}
      </label>
      <button onclick="deleteRule(${r.id})" style="background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.2);border-radius:6px;padding:4px 10px;color:#f87171;cursor:pointer;font-size:12px"><i class="bi bi-trash"></i></button>
    </div>`).join('');
}

// â”€â”€ Edit Timezone Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openEditTzModal(accountId, accountName) {
  document.getElementById('editTzModal').classList.add('open');
  document.getElementById('editTzAccName').textContent = accountName;
  const acc = allAccounts.find(a => a.id === accountId);
  if (acc) {
    document.getElementById('currentCountryDisplay').textContent = acc.country || 'â€”';
    document.getElementById('currentTzDisplay').textContent = acc.timezone_name || 'â€”';
    if (acc.country) document.getElementById('editCountry').value = acc.country;
    if (acc.timezone_name) document.getElementById('editTimezone').value = acc.timezone_name;
  }
  document.getElementById('editTzModal').dataset.accountId = accountId;
}

function closeEditTzModal() {
  document.getElementById('editTzModal').classList.remove('open');
}

async function saveTimezone() {
  const accountId = document.getElementById('editTzModal').dataset.accountId;
  const country = document.getElementById('editCountry').value;
  const tz = document.getElementById('editTimezone').value;
  const token = getToken();
  if (!token) { GZ.toast('Cáº§n token Ä‘á»ƒ cáº­p nháº­t', 'error'); return; }
  try {
    const resp = await fetch(`${FB_GRAPH}/${accountId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ access_token: token, timezone_id: tz, country: country })
    });
    const data = await resp.json();
    if (data.error) throw new Error(data.error.message);
    closeEditTzModal();
    loadAccounts();
    GZ.toast('ÄÃ£ cáº­p nháº­t mÃºi giá»!', 'success');
  } catch(e) {
    GZ.toast('Lá»—i: ' + e.message, 'error');
  }
}

// â”€â”€ Misc â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSubNav(e, id) {
  e.preventDefault();
  const el = document.getElementById(id);
  const arrow = document.getElementById(id + 'Arrow');
  if (el) { const open = el.style.display !== 'none'; el.style.display = open ? 'none' : 'flex'; if(arrow) arrow.style.transform = open ? '' : 'rotate(180deg)'; }
}

function openSettings() { if(window.GZ?.openSettings) window.GZ.openSettings(); }

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  updateTokenUI();
  const token = getToken();
  if (token) {
    loadAccounts();
  } else {
    setTableMsg('accounts', 'ğŸ”‘ ChÆ°a cÃ³ token â€” nháº¥n nÃºt <strong style="color:#fbbf24"><i class="bi bi-key"></i> Token</strong> á»Ÿ gÃ³c trÃªn pháº£i Ä‘á»ƒ nháº­p Facebook Access Token');
  }
  renderRules();
  // ÄÃ³ng modal khi click ngoÃ i
  ['tokenModal','ruleModal','editTzModal'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('click', e => { if (e.target === el) el.classList.remove('open'); });
  });
});
</script>

<script id="gz-universe-bg">
(function(){
  'use strict';
  const isMobile = /Mobi|Android/i.test(navigator.userAgent);

  // â”€â”€ Stars Canvas â”€â”€
  const cs = document.getElementById('gz-stars');
  if (!cs) return;
  const ctxS = cs.getContext('2d');
  function resizeS(){ cs.width=window.innerWidth; cs.height=window.innerHeight; }
  resizeS();
  const stars = [];
  const N = isMobile ? 80 : 180;
  for(let i=0;i<N;i++){
    stars.push({
      x: Math.random()*cs.width, y: Math.random()*cs.height,
      r: Math.random()*1.6+0.2,
      a: Math.random(), da: (Math.random()-0.5)*0.004,
      vx: (Math.random()-0.5)*0.07, vy: (Math.random()-0.5)*0.07,
      hue: [210,195,270,180][Math.floor(Math.random()*4)] // xanh dÆ°Æ¡ng, cyan, tÃ­m, xanh lÃ¡
    });
  }
  function animStars(){
    ctxS.clearRect(0,0,cs.width,cs.height);
    stars.forEach(s=>{
      s.x+=s.vx; s.y+=s.vy; s.a+=s.da;
      if(s.a<0.08) s.da=Math.abs(s.da);
      if(s.a>0.95) s.da=-Math.abs(s.da);
      if(s.x<0) s.x=cs.width; if(s.x>cs.width) s.x=0;
      if(s.y<0) s.y=cs.height; if(s.y>cs.height) s.y=0;
      const g=ctxS.createRadialGradient(s.x,s.y,0,s.x,s.y,s.r*2.5);
      g.addColorStop(0,`hsla(${s.hue},100%,90%,${s.a*0.9})`);
      g.addColorStop(0.5,`hsla(${s.hue},100%,70%,${s.a*0.4})`);
      g.addColorStop(1,`hsla(${s.hue},100%,60%,0)`);
      ctxS.fillStyle=g;
      ctxS.beginPath(); ctxS.arc(s.x,s.y,s.r*2.5,0,Math.PI*2); ctxS.fill();
    });
    requestAnimationFrame(animStars);
  }
  animStars();

  // â”€â”€ Data Particles Canvas â”€â”€
  const cp = document.getElementById('gz-particles');
  if(!cp) return;
  const ctxP = cp.getContext('2d');
  function resizeP(){ cp.width=window.innerWidth; cp.height=window.innerHeight; }
  resizeP();
  const parts = [];
  const NP = isMobile ? 8 : 18;
  for(let i=0;i<NP;i++){
    parts.push({
      x:0, y:0,
      r: Math.random()*2.5+1,
      cx: Math.random()*cp.width, cy: Math.random()*cp.height,
      rx: Math.random()*120+40, ry: Math.random()*120+40,
      angle: Math.random()*Math.PI*2,
      speed: Math.random()*0.008+0.004,
      pulse: Math.random()*Math.PI*2, ps: Math.random()*0.02+0.01,
      color: [[24,119,242],[0,212,255],[139,92,246],[6,182,212]][Math.floor(Math.random()*4)]
    });
  }
  function animParts(){
    ctxP.clearRect(0,0,cp.width,cp.height);
    parts.forEach(p=>{
      p.angle+=p.speed;
      p.x=p.cx+Math.cos(p.angle)*p.rx;
      p.y=p.cy+Math.sin(p.angle)*p.ry;
      p.pulse+=p.ps;
      const ps=1+Math.sin(p.pulse)*0.5;
      const [r,g,b]=p.color;
      const grd=ctxP.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r*ps*4);
      grd.addColorStop(0,`rgba(${r},${g},${b},${0.75*ps})`);
      grd.addColorStop(0.4,`rgba(${r},${g},${b},${0.3*ps})`);
      grd.addColorStop(1,`rgba(${r},${g},${b},0)`);
      ctxP.fillStyle=grd;
      ctxP.beginPath(); ctxP.arc(p.x,p.y,p.r*ps*4,0,Math.PI*2); ctxP.fill();
    });
    requestAnimationFrame(animParts);
  }
  animParts();

  // â”€â”€ Custom Cursor â”€â”€
  const cur=document.getElementById('custom-cursor');
  if(cur && !('ontouchstart' in window)){
    let mx=0,my=0,cx=0,cy=0,shown=false;
    document.body.style.cursor='none';
    document.addEventListener('mousemove',e=>{
      mx=e.clientX; my=e.clientY;
      if(!shown){ shown=true; cur.style.opacity='1'; }
    });
    document.addEventListener('mouseleave',()=>{ shown=false; cur.style.opacity='0'; });
    function animCur(){ if(shown){ cx+=(mx-cx)*0.15; cy+=(my-cy)*0.15; cur.style.left=cx+'px'; cur.style.top=cy+'px'; } requestAnimationFrame(animCur); }
    animCur();
  }

  // â”€â”€ Resize handler â”€â”€
  window.addEventListener('resize',()=>{ resizeS(); resizeP(); });
})();
</script>
</body>
</html>
