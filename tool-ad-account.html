<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ki·ªÉm Tra TKQC ‚Äî GenZTech</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <style>
    html,body{scrollbar-width:none;-ms-overflow-style:none;cursor:none;-webkit-user-select:none;user-select:none;margin:0;padding:0;font-family:'Inter',sans-serif;background:#080c1e;color:#fff}
    html::-webkit-scrollbar,body::-webkit-scrollbar{display:none;width:0}
    .app-layout{display:flex;min-height:100vh;position:relative;z-index:1}
    /* Sidebar */
    .sidebar{width:240px;flex-shrink:0;background:rgba(10,14,39,.92);backdrop-filter:blur(20px);border-right:1px solid rgba(255,255,255,.06);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:40}
    .sidebar-logo{padding:18px 18px 14px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;gap:10px;text-decoration:none}
    .sidebar-logo img{width:34px;height:34px;border-radius:50%}
    .sidebar-logo span{font-size:14px;font-weight:700;letter-spacing:.5px;color:#fff}
    .sidebar-logo span em{color:#00d4ff;font-style:normal}
    .sidebar-nav{flex:1;padding:10px 0;overflow-y:auto}
    .nav-group-label{font-size:10px;font-weight:600;letter-spacing:1.2px;color:rgba(255,255,255,.3);text-transform:uppercase;padding:10px 18px 4px}
    .nav-item{display:flex;align-items:center;gap:10px;padding:9px 18px;font-size:13px;color:rgba(255,255,255,.6);text-decoration:none;transition:all .2s;border-left:2px solid transparent}
    .nav-item:hover{color:#fff;background:rgba(255,255,255,.04)}
    .nav-item.active{color:#00d4ff;background:rgba(0,212,255,.08);border-left-color:#00d4ff}
    .nav-item i{width:17px;text-align:center;font-size:14px}
    .nav-sub-item{display:flex;align-items:center;gap:10px;padding:7px 18px 7px 34px;font-size:12px;color:rgba(255,255,255,.5);text-decoration:none;transition:all .2s;border-left:2px solid transparent}
    .nav-sub-item:hover{color:#fff;background:rgba(255,255,255,.04)}
    .nav-sub-item.active{color:#00d4ff;background:rgba(0,212,255,.06);border-left-color:#00d4ff}
    .sidebar-footer{padding:14px 18px;border-top:1px solid rgba(255,255,255,.06)}
    .conn-status{display:flex;align-items:center;gap:8px;font-size:12px;color:rgba(255,255,255,.5)}
    .conn-dot{width:7px;height:7px;border-radius:50%;background:#ef4444;flex-shrink:0}
    .conn-dot.online{background:#22c55e;box-shadow:0 0 6px #22c55e}
    /* Main */
    .main-content{margin-left:240px;flex:1;display:flex;flex-direction:column;min-height:100vh}
    .topbar{position:sticky;top:0;z-index:30;background:rgba(10,14,39,.9);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,.06);padding:0 24px;height:58px;display:flex;align-items:center;justify-content:space-between}
    .topbar-left{display:flex;align-items:center;gap:10px}
    .breadcrumb{font-size:12.5px;color:rgba(255,255,255,.4);display:flex;align-items:center;gap:6px}
    .breadcrumb span{color:#fff;font-weight:600}
    .topbar-right{display:flex;align-items:center;gap:8px}
    .btn{padding:7px 14px;border-radius:8px;font-size:12.5px;font-weight:600;border:none;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
    .btn-primary{background:#1877f2;color:#fff}.btn-primary:hover{background:#1565d8}
    .btn-outline{background:transparent;color:rgba(255,255,255,.7);border:1px solid rgba(255,255,255,.15)}.btn-outline:hover{border-color:#00d4ff;color:#00d4ff}
    .btn-sm{padding:5px 12px;font-size:12px}
    .btn-icon{padding:6px 10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);color:rgba(255,255,255,.6);border-radius:8px;cursor:pointer;font-size:13px;display:inline-flex;align-items:center;gap:5px;transition:all .2s}.btn-icon:hover{background:rgba(255,255,255,.1);color:#fff}
    /* Page */
    .page-body{padding:20px 24px;flex:1}
    /* Token banner */
    .token-banner{background:rgba(251,191,36,.06);border:1px solid rgba(251,191,36,.15);border-radius:10px;padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;gap:12px;font-size:12.5px}
    .token-banner.success{background:rgba(34,197,94,.06);border-color:rgba(34,197,94,.15)}
    /* Tabs */
    .tabs-bar{display:flex;gap:0;border-bottom:1px solid rgba(255,255,255,.08);margin-bottom:0;background:rgba(255,255,255,.02);border-radius:12px 12px 0 0;overflow:hidden}
    .tab-btn{padding:12px 20px;font-size:13px;font-weight:600;color:rgba(255,255,255,.5);background:none;border:none;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:7px;border-bottom:2px solid transparent;white-space:nowrap}
    .tab-btn:hover{color:#fff;background:rgba(255,255,255,.04)}
    .tab-btn.active{color:#00d4ff;border-bottom-color:#00d4ff;background:rgba(0,212,255,.06)}
    .tab-btn .tab-count{background:rgba(0,212,255,.15);color:#00d4ff;font-size:10px;font-weight:700;padding:1px 7px;border-radius:20px}
    /* Table */
    .table-wrap{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:0 0 12px 12px;overflow:hidden}
    .table-toolbar{padding:12px 16px;display:flex;align-items:center;gap:10px;border-bottom:1px solid rgba(255,255,255,.06)}
    .search-box{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:6px 12px;flex:1;max-width:320px}
    .search-box input{background:none;border:none;outline:none;color:#fff;font-size:12.5px;width:100%}
    .search-box input::placeholder{color:rgba(255,255,255,.3)}
    .search-box i{color:rgba(255,255,255,.3);font-size:13px}
    table{width:100%;border-collapse:collapse}
    thead tr{border-bottom:1px solid rgba(255,255,255,.07)}
    thead th{padding:10px 14px;font-size:11px;font-weight:600;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.7px;text-align:left;white-space:nowrap;cursor:pointer;user-select:none}
    thead th:hover{color:rgba(255,255,255,.7)}
    thead th i{font-size:10px;margin-left:4px}
    tbody tr{border-bottom:1px solid rgba(255,255,255,.04);transition:background .15s;cursor:pointer}
    tbody tr:hover{background:rgba(255,255,255,.04)}
    tbody tr:last-child{border-bottom:none}
    tbody td{padding:11px 14px;font-size:13px;color:rgba(255,255,255,.85)}
    .td-name{font-weight:600;color:#fff}
    .td-id{font-size:11px;color:rgba(255,255,255,.35);margin-top:2px}
    .badge{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:600}
    .badge-green{background:rgba(34,197,94,.12);color:#4ade80}
    .badge-red{background:rgba(239,68,68,.12);color:#f87171}
    .badge-yellow{background:rgba(251,191,36,.12);color:#fbbf24}
    .badge-gray{background:rgba(255,255,255,.08);color:rgba(255,255,255,.5)}
    .badge-blue{background:rgba(24,119,242,.15);color:#60a5fa}
    .badge::before{content:'';width:5px;height:5px;border-radius:50%;background:currentColor}
    /* Checkbox */
    input[type=checkbox]{accent-color:#00d4ff;width:14px;height:14px;cursor:pointer}
    /* Empty / loading */
    .empty-state{text-align:center;padding:60px 20px;color:rgba(255,255,255,.3)}
    .empty-state i{font-size:48px;margin-bottom:12px;display:block;opacity:.3}
    .empty-state p{font-size:13.5px}
    .loading-row td{text-align:center;padding:40px;color:rgba(255,255,255,.3)}
    .spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.2);border-top-color:#00d4ff;border-radius:50%;animation:spin .7s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* Detail panel */
    .detail-panel{background:rgba(10,14,39,.95);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:20px;margin-top:16px;display:none}
    .detail-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px}
    .detail-item{background:rgba(255,255,255,.04);border-radius:8px;padding:12px 14px}
    .detail-label{font-size:11px;color:rgba(255,255,255,.4);margin-bottom:4px;text-transform:uppercase;letter-spacing:.6px}
    .detail-value{font-size:14px;font-weight:700}
    /* Stats row */
    .stats-row{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:16px}
    .stat-mini{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);border-radius:10px;padding:12px 14px}
    .stat-mini .lbl{font-size:10.5px;color:rgba(255,255,255,.4);margin-bottom:4px;text-transform:uppercase;letter-spacing:.05em}
    .stat-mini .val{font-size:18px;font-weight:700;color:#fff}
    .sparkline-wrap{display:flex;align-items:flex-end;gap:2px;height:28px;padding:2px 0}
    .spark-bar{width:8px;border-radius:2px 2px 0 0;background:linear-gradient(180deg,#60a5fa,#3b82f6);min-height:2px;cursor:pointer;transition:opacity .15s;position:relative}
    .spark-bar:hover{opacity:.75}
    .spark-bar.current-hour{background:linear-gradient(180deg,#fbbf24,#f59e0b)}
    .spark-tooltip{position:absolute;bottom:calc(100% + 4px);left:50%;transform:translateX(-50%);background:#1e293b;border:1px solid rgba(255,255,255,.15);border-radius:6px;padding:4px 8px;font-size:10px;color:#fff;white-space:nowrap;pointer-events:none;z-index:100;display:none}
    .spark-bar:hover .spark-tooltip{display:block}
    .today-spend{font-weight:700;color:#fbbf24;font-size:13px}
    .today-spend.zero{color:rgba(255,255,255,.3);font-weight:400}
    /* Preset Cards (Rules tab) */
    .preset-card{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px 14px;cursor:pointer;transition:all .2s}
    .preset-card:hover{background:rgba(255,255,255,.08);border-color:rgba(0,212,255,.3);transform:translateY(-1px)}
    .preset-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
    .preset-info{flex:1;min-width:0}
    .preset-title{font-size:13px;font-weight:600;color:#fff}
    .preset-desc{font-size:11px;color:rgba(255,255,255,.4);margin-top:2px;line-height:1.4}
    .preset-badge{font-size:10px;font-weight:700;padding:3px 8px;border-radius:20px;white-space:nowrap;flex-shrink:0}
    /* Token modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;display:none;align-items:center;justify-content:center}
    .modal-overlay.open{display:flex}
    .modal-box{background:#0f1535;border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:28px;width:500px;max-width:95vw}
    .modal-title{font-size:16px;font-weight:700;margin-bottom:6px}
    .modal-sub{font-size:12.5px;color:rgba(255,255,255,.4);margin-bottom:20px}
    .form-group{margin-bottom:14px}
    .form-label{font-size:12px;color:rgba(255,255,255,.5);margin-bottom:6px;display:block;font-weight:600}
    .form-control{width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:9px 12px;color:#fff;font-size:13px;outline:none;box-sizing:border-box;transition:border-color .2s}
    .form-control:focus{border-color:#00d4ff}
    /* Toast */
    #toast{position:fixed;bottom:24px;right:24px;z-index:9999;display:flex;flex-direction:column;gap:8px}
    .toast-item{background:#1e2a4a;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:12px 18px;font-size:13px;display:flex;align-items:center;gap:10px;animation:slideIn .3s ease;min-width:260px}
    .toast-item.success{border-left:3px solid #22c55e}
    .toast-item.error{border-left:3px solid #ef4444}
    .toast-item.info{border-left:3px solid #00d4ff}
    @keyframes slideIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
    /* Pagination */
    .pagination{display:flex;align-items:center;gap:6px;padding:12px 16px;border-top:1px solid rgba(255,255,255,.06)}
    .page-btn{padding:5px 10px;border-radius:6px;font-size:12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);color:rgba(255,255,255,.6);cursor:pointer;transition:all .2s}
    .page-btn:hover,.page-btn.active{background:rgba(0,212,255,.15);border-color:#00d4ff;color:#00d4ff}
    .page-btn:disabled{opacity:.3;cursor:not-allowed}
    /* Responsive */
    @media(max-width:768px){.sidebar{display:none}.main-content{margin-left:0}.stats-row{grid-template-columns:repeat(2,1fr)}.detail-grid{grid-template-columns:repeat(2,1fr)}}
  
    /* -- Universe Background -- */
    canvas.bg-canvas{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0}
    #custom-cursor{position:fixed;width:20px;height:20px;border-radius:50%;border:2px solid rgba(0,212,255,.8);pointer-events:none;z-index:9999;transform:translate(-50%,-50%);transition:opacity .3s;opacity:0;mix-blend-mode:screen}
    .nebula-overlay{position:fixed;inset:0;pointer-events:none;z-index:0;background:radial-gradient(ellipse 80% 60% at 20% 30%,rgba(24,119,242,.07) 0%,transparent 60%),radial-gradient(ellipse 60% 50% at 80% 70%,rgba(0,212,255,.06) 0%,transparent 55%),radial-gradient(ellipse 50% 40% at 50% 10%,rgba(139,92,246,.05) 0%,transparent 50%)}
  </style>
</head>
<body>
  <!-- Universe Background -->
  <canvas class="bg-canvas" id="gz-stars"></canvas>
  <canvas class="bg-canvas" id="gz-particles"></canvas>
  <div class="nebula-overlay"></div>
  <div id="custom-cursor"></div>
  <div id="toastContainer"></div>

  <!-- Token Modal -->
  <div class="modal-overlay" id="tokenModal">
    <div class="modal-box">
      <div class="modal-title"><i class="bi bi-key" style="color:#fbbf24"></i> Nh·∫≠p Access Token Th·ªß C√¥ng</div>
      <div class="modal-sub">D√πng khi Facebook c·∫•m OAuth. L·∫•y token t·∫°i <a href="https://developers.facebook.com/tools/explorer/" target="_blank" style="color:#1877f2">Graph API Explorer</a> ‚Üí ch·ªçn quy·ªÅn <code style="background:rgba(255,255,255,.08);padding:1px 6px;border-radius:4px;font-size:11px">ads_read, ads_management</code></div>
      <div class="form-group">
        <label class="form-label">Facebook Access Token</label>
        <input type="password" class="form-control" id="tokenInput" placeholder="EAAxxxxxxxxxxxxxxx..." autocomplete="off">
        <div style="font-size:11px;color:rgba(255,255,255,.3);margin-top:5px">Token s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o tr√¨nh duy·ªát, kh√¥ng g·ª≠i l√™n server</div>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
        <button class="btn btn-outline" onclick="closeTokenModal()">H·ªßy</button>
        <button class="btn btn-primary" onclick="saveToken()"><i class="bi bi-save"></i> L∆∞u Token</button>
      </div>
    </div>
  </div>

  <div class="app-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <a href="index.html" class="sidebar-logo">
        <img src="https://ui-avatars.com/api/?name=GZ&background=1877f2&color=fff&bold=true" alt="logo">
        <span>GENZ<em>TECH</em></span>
      </a>
      <nav class="sidebar-nav">
        <div class="nav-group-label">T·ªïng Quan</div>
        <a href="maindashboard.html" class="nav-item"><i class="bi bi-grid-1x2-fill"></i> Dashboard</a>
        <div class="nav-group-label">C√¥ng C·ª•</div>
        <a href="auto-post.html" class="nav-item"><i class="bi bi-send"></i> T·ª± ƒê·ªông ƒêƒÉng B√†i</a>
        <a href="ads-assistant.html" class="nav-item" onclick="toggleSubNav(event,'subNavAds')">
          <i class="bi bi-megaphone"></i> Tr·ª£ L√Ω Qu·∫£ng C√°o
          <i class="bi bi-chevron-down" id="subNavAdsArrow" style="margin-left:auto;font-size:11px;transition:transform .2s"></i>
        </a>
        <div id="subNavAds" style="display:flex;flex-direction:column">
          <a href="tool-ad-account.html" class="nav-sub-item active"><i class="bi bi-shield-check"></i> Ki·ªÉm Tra TKQC</a>
          <a href="tool-fb-id.html" class="nav-sub-item"><i class="bi bi-person-badge"></i> T√¨m Facebook ID</a>
          <a href="tool-budget.html" class="nav-sub-item"><i class="bi bi-graph-up-arrow"></i> Ph√¢n T√≠ch Ng√¢n S√°ch</a>
          <a href="tool-translate.html" class="nav-sub-item"><i class="bi bi-translate"></i> D·ªãch Thu·∫≠t</a>
          <a href="tool-ads-finder.html" class="nav-sub-item"><i class="bi bi-binoculars"></i> Ads Finder</a>
          <a href="tool-policy.html" class="nav-sub-item"><i class="bi bi-journal-text"></i> Ch√≠nh S√°ch FB</a>
          <a href="tool-cookie.html" class="nav-sub-item"><i class="bi bi-cookie"></i> Qu·∫£n L√Ω Cookie</a>
        </div>
        <a href="#" class="nav-item" onclick="openSettings()"><i class="bi bi-gear"></i> C√†i ƒê·∫∑t</a>
      </nav>
      <div class="sidebar-footer">
        <div class="conn-status" id="connStatus">
          <div class="conn-dot" id="connDot"></div>
          <span id="connText">Ch∆∞a k·∫øt n·ªëi</span>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <div class="main-content">
      <div class="topbar">
        <div class="topbar-left">
          <div class="breadcrumb">
            <a href="ads-assistant.html" style="color:rgba(255,255,255,.4);text-decoration:none">Tr·ª£ L√Ω QC</a>
            <i class="bi bi-chevron-right" style="font-size:10px"></i>
            <span>Ki·ªÉm Tra TKQC</span>
          </div>
        </div>
        <div class="topbar-right">
          <button class="btn-icon" onclick="refreshData()" title="L√†m m·ªõi"><i class="bi bi-arrow-clockwise"></i></button>
          <button class="btn-icon" onclick="openTokenModal()" title="C√†i ƒë·∫∑t token"><i class="bi bi-key"></i> <span id="tokenIndicator" style="font-size:11px;display:none;color:#4ade80">‚óè</span></button>

          <div id="userBadge" style="display:none;align-items:center;gap:8px;font-size:12.5px">
            <div style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#1877f2,#00d4ff);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px" id="userAvatar">?</div>
            <span id="userName" style="color:rgba(255,255,255,.8)"></span>
          </div>
        </div>
      </div>

      <div class="page-body">

        <div id="tokenBanner" class="token-banner success" style="display:none">
          <i class="bi bi-key-fill" style="color:#4ade80;font-size:16px"></i>
          <div style="flex:1;font-size:12px">
            <strong style="color:#4ade80">Token th·ªß c√¥ng ƒëang d√πng</strong> ‚Äî ƒêang g·ªçi th·∫≥ng Facebook Graph API.
          </div>
          <button class="btn btn-outline btn-sm" onclick="openTokenModal()">ƒê·ªïi token</button>
          <button class="btn btn-sm" onclick="clearToken()" style="background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.2);color:#f87171">X√≥a</button>
        </div>

        <!-- Stats row -->
        <div class="stats-row" id="statsRow" style="display:none">
          <div class="stat-mini"><div class="lbl">T·ªïng TKQC</div><div class="val" id="sTotalAcc">‚Äî</div></div>
          <div class="stat-mini"><div class="lbl">ƒêang ho·∫°t ƒë·ªông</div><div class="val" style="color:#4ade80" id="sActiveAcc">‚Äî</div></div>
          <div class="stat-mini"><div class="lbl">B·ªã kh√≥a / V√¥ hi·ªáu</div><div class="val" style="color:#f87171" id="sLockedAcc">‚Äî</div></div>
          <div class="stat-mini"><div class="lbl">T·ªïng chi ti√™u</div><div class="val" style="color:#60a5fa;font-size:14px" id="sTotalSpend">‚Äî</div></div>
          <div class="stat-mini"><div class="lbl">S·ªë d∆∞ kh·∫£ d·ª•ng</div><div class="val" style="color:#4ade80;font-size:14px" id="sTotalBalance">‚Äî</div></div>
        </div>

        <!-- Tabs + Table -->
        <div>
          <div class="tabs-bar">
            <button class="tab-btn active" id="tab-accounts" onclick="switchTab('accounts')">
              <i class="bi bi-credit-card"></i> T√†i kho·∫£n qu·∫£ng c√°o
              <span class="tab-count" id="countAccounts">0</span>
            </button>
            <button class="tab-btn" id="tab-campaigns" onclick="switchTab('campaigns')">
              <i class="bi bi-flag"></i> Chi·∫øn d·ªãch
              <span class="tab-count" id="countCampaigns">0</span>
            </button>
            <button class="tab-btn" id="tab-adsets" onclick="switchTab('adsets')">
              <i class="bi bi-collection"></i> Nh√≥m qu·∫£ng c√°o
              <span class="tab-count" id="countAdsets">0</span>
            </button>
            <button class="tab-btn" id="tab-ads" onclick="switchTab('ads')">
              <i class="bi bi-megaphone"></i> Qu·∫£ng c√°o
              <span class="tab-count" id="countAds">0</span>
            </button>
            <button class="tab-btn" id="tab-rules" onclick="switchTab('rules')">
              <i class="bi bi-robot"></i> Quy T·∫Øc T·ª± ƒê·ªông
              <span class="tab-count" id="countRules" style="background:rgba(168,85,247,.2);color:#c084fc">0</span>
            </button>
          </div>

          <div class="table-wrap">
            <!-- Context breadcrumb -->
          <div id="contextBar" style="display:none;align-items:center;gap:8px;padding:8px 16px;background:rgba(0,212,255,.04);border-bottom:1px solid rgba(0,212,255,.08);font-size:12px;flex-wrap:wrap"></div>

          <div class="table-toolbar">
              <div class="search-box">
                <i class="bi bi-search"></i>
                <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm..." oninput="filterTable()">
              </div>
              <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
                <span id="selectedCount" style="font-size:12px;color:rgba(255,255,255,.4);display:none"></span>
                <select class="form-control" id="datePreset" onchange="loadCurrentTab()" style="width:auto;font-size:12px;padding:5px 10px">
                  <option value="today">H√¥m nay</option>
                  <option value="yesterday">H√¥m qua</option>
                  <option value="last_7d" selected>7 ng√†y qua</option>
                  <option value="last_30d">30 ng√†y qua</option>
                  <option value="this_month">Th√°ng n√†y</option>
                  <option value="last_month">Th√°ng tr∆∞·ªõc</option>
                </select>
                <div id="rateLimitIndicator" style="display:none;align-items:center;gap:5px;font-size:11px;color:#fbbf24;background:rgba(251,191,36,.1);border:1px solid rgba(251,191,36,.3);border-radius:8px;padding:4px 10px"></div>
                <button class="btn-icon btn-sm" onclick="clearAllCache()" title="X√≥a cache, t·∫£i l·∫°i d·ªØ li·ªáu m·ªõi"><i class="bi bi-arrow-clockwise"></i> L√†m m·ªõi</button>
                <button class="btn-icon btn-sm" onclick="exportCSV()"><i class="bi bi-download"></i> Xu·∫•t CSV</button>
              </div>
            </div>

            <!-- Tab: Accounts -->
            <div id="panel-accounts">
              <table>
                <thead>
                  <tr>
                    <th style="width:36px"><input type="checkbox" id="checkAll" onchange="toggleCheckAll(this)"></th>
                    <th onclick="sortTable('accounts','name')">T√†i kho·∫£n qu·∫£ng c√°o <i class="bi bi-arrow-down-up"></i></th>
                    <th onclick="sortTable('accounts','account_status')">Tr·∫°ng th√°i <i class="bi bi-arrow-down-up"></i></th>
                    <th>Qu·ªëc gia</th>
                    <th>M√∫i gi·ªù</th>
                    <th onclick="sortTable('accounts','currency')">Ti·ªÅn t·ªá <i class="bi bi-arrow-down-up"></i></th>
                    <th onclick="sortTable('accounts','balance')">S·ªë d∆∞ <i class="bi bi-arrow-down-up"></i></th>
                    <th onclick="sortTable('accounts','amount_spent')">Chi ti√™u (k·ª≥) <i class="bi bi-arrow-down-up"></i></th>
                    <th>Chi ti√™u h√¥m nay</th>
                    <th style="min-width:160px">7 ng√†y g·∫ßn ƒë√¢y</th>
                    <th style="width:80px">Thao t√°c</th>
                  </tr>
                </thead>
                <tbody id="tbody-accounts">
                  <tr class="loading-row"><td colspan="11"><span class="spinner"></span> ƒêang t·∫£i...</td></tr>
                </tbody>
              </table>
            </div>

            <!-- Tab: Campaigns -->
            <div id="panel-campaigns" style="display:none">
              <table>
                <thead>
                  <tr>
                    <th style="width:36px"><input type="checkbox"></th>
                    <th>Chi·∫øn d·ªãch</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>M·ª•c ti√™u</th>
                    <th>Ng√¢n s√°ch ng√†y</th>
                    <th>Chi ti√™u</th>
                    <th>L∆∞·ª£t hi·ªÉn th·ªã</th>
                    <th>L∆∞·ª£t click</th>
                    <th>CTR</th>
                    <th>CPC</th>
                  </tr>
                </thead>
                <tbody id="tbody-campaigns">
                  <tr class="loading-row"><td colspan="10"><span class="spinner"></span> Ch·ªçn TKQC ƒë·ªÉ xem chi·∫øn d·ªãch</td></tr>
                </tbody>
              </table>
            </div>

            <!-- Tab: Ad Sets -->
            <div id="panel-adsets" style="display:none">
              <table>
                <thead>
                  <tr>
                    <th style="width:36px"><input type="checkbox"></th>
                    <th>Nh√≥m qu·∫£ng c√°o</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>Chi·∫øn d·ªãch</th>
                    <th>Ng√¢n s√°ch ng√†y</th>
                    <th>Chi ti√™u</th>
                    <th>L∆∞·ª£t hi·ªÉn th·ªã</th>
                    <th>L∆∞·ª£t click</th>
                    <th>CPM</th>
                    <th>CPC</th>
                  </tr>
                </thead>
                <tbody id="tbody-adsets">
                  <tr class="loading-row"><td colspan="10"><span class="spinner"></span> Ch·ªçn TKQC ƒë·ªÉ xem nh√≥m qu·∫£ng c√°o</td></tr>
                </tbody>
              </table>
            </div>

            <!-- Tab: Ads -->
            <div id="panel-ads" style="display:none">
              <table>
                <thead>
                  <tr>
                    <th style="width:36px"><input type="checkbox"></th>
                    <th>Qu·∫£ng c√°o</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>Nh√≥m QC</th>
                    <th>Chi ti√™u</th>
                    <th>L∆∞·ª£t hi·ªÉn th·ªã</th>
                    <th>L∆∞·ª£t click</th>
                    <th>CTR</th>
                    <th>CPC</th>
                    <th>CPM</th>
                  </tr>
                </thead>
                <tbody id="tbody-ads">
                  <tr class="loading-row"><td colspan="10"><span class="spinner"></span> Ch·ªçn TKQC ƒë·ªÉ xem qu·∫£ng c√°o</td></tr>
                </tbody>
              </table>
            </div>

            <!-- Tab: Rules -->
            <div id="panel-rules" style="display:none">
              <div style="padding:20px">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
                  <div>
                    <div style="font-size:15px;font-weight:700"><i class="bi bi-robot" style="color:#c084fc"></i> Quy T·∫Øc T·ª± ƒê·ªông</div>
                    <div style="font-size:12px;color:rgba(255,255,255,.4);margin-top:3px">Ki·ªÉm tra m·ªói 15 ph√∫t. T·ª± ƒë·ªông t·∫Øt/c·∫£nh b√°o khi ƒëi·ªÅu ki·ªán x·∫£y ra.</div>
                  </div>
                  <button class="btn btn-primary" onclick="openRuleModal()" style="background:linear-gradient(135deg,#7c3aed,#a855f7)">
                    <i class="bi bi-plus-lg"></i> T·∫°o Quy T·∫Øc
                  </button>
                </div>
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:20px" id="presetCards">
                  <div class="preset-card" onclick="applyPreset('spend_spike')">
                    <div class="preset-icon" style="background:rgba(239,68,68,.1);color:#f87171"><i class="bi bi-lightning-charge-fill"></i></div>
                    <div class="preset-info"><div class="preset-title">T·∫Øt khi th·ªëc ti·ªÅn ƒë·ªôt ng·ªôt</div><div class="preset-desc">Chi ti√™u tƒÉng &gt;50% so v·ªõi trung b√¨nh 3 ng√†y tr∆∞·ªõc</div></div>
                    <span class="preset-badge" style="background:rgba(239,68,68,.15);color:#f87171">Nhanh</span>
                  </div>
                  <div class="preset-card" onclick="applyPreset('high_cpc')">
                    <div class="preset-icon" style="background:rgba(251,191,36,.1);color:#fbbf24"><i class="bi bi-currency-dollar"></i></div>
                    <div class="preset-info"><div class="preset-title">T·∫Øt khi CPC qu√° ƒë·∫Øt</div><div class="preset-desc">CPC v∆∞·ª£t ng∆∞·ª°ng t·ª± ƒë·∫∑t, hi·ªáu qu·∫£ k√©m</div></div>
                    <span class="preset-badge" style="background:rgba(251,191,36,.15);color:#fbbf24">Ph·ªï bi·∫øn</span>
                  </div>
                  <div class="preset-card" onclick="applyPreset('low_balance')">
                    <div class="preset-icon" style="background:rgba(34,197,94,.1);color:#4ade80"><i class="bi bi-wallet2"></i></div>
                    <div class="preset-info"><div class="preset-title">C·∫£nh b√°o s·∫Øp h·∫øt ti·ªÅn</div><div class="preset-desc">S·ªë d∆∞ TKQC xu·ªëng d∆∞·ªõi ng∆∞·ª°ng ƒë·∫∑t</div></div>
                    <span class="preset-badge" style="background:rgba(34,197,94,.15);color:#4ade80">Quan tr·ªçng</span>
                  </div>
                  <div class="preset-card" onclick="applyPreset('account_disabled')">
                    <div class="preset-icon" style="background:rgba(168,85,247,.1);color:#c084fc"><i class="bi bi-shield-x"></i></div>
                    <div class="preset-info"><div class="preset-title">T√†i kho·∫£n b·ªã v√¥ hi·ªáu h√≥a</div><div class="preset-desc">D·ª´ng t·∫•t c·∫£ chi·∫øn d·ªãch khi TKQC b·ªã kh√≥a</div></div>
                    <span class="preset-badge" style="background:rgba(168,85,247,.15);color:#c084fc">T·ª± ƒë·ªông</span>
                  </div>
                </div>
                <div id="rulesList"></div>
              </div>
            </div>

            <div class="pagination" id="pagination" style="display:none"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Rule Modal -->
  <div class="modal-overlay" id="ruleModal">
    <div class="modal-box" style="width:560px">
      <div class="modal-title"><i class="bi bi-robot" style="color:#c084fc"></i> T·∫°o Quy T·∫Øc T·ª± ƒê·ªông</div>
      <div class="modal-sub">H·ªá th·ªëng ki·ªÉm tra m·ªói 15 ph√∫t v√† th·ª±c hi·ªán h√†nh ƒë·ªông khi ƒëi·ªÅu ki·ªán ƒë∆∞·ª£c th·ªèa m√£n.</div>
      <div class="form-group">
        <label class="form-label">T√™n quy t·∫Øc</label>
        <input type="text" class="form-control" id="ruleName" placeholder="V√≠ d·ª•: T·∫Øt ads khi th·ªëc ti·ªÅn">
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="form-group">
          <label class="form-label">Lo·∫°i ƒëi·ªÅu ki·ªán</label>
          <select class="form-control" id="ruleCondType" onchange="updateCondUnit()">
            <option value="spend_spike">Chi ti√™u tƒÉng ƒë·ªôt ng·ªôt (%)</option>
            <option value="cpc_above">CPC v∆∞·ª£t ng∆∞·ª°ng (VND)</option>
            <option value="cpm_above">CPM v∆∞·ª£t ng∆∞·ª°ng (VND)</option>
            <option value="ctr_below">CTR d∆∞·ªõi ng∆∞·ª°ng (%)</option>
            <option value="balance_below">S·ªë d∆∞ d∆∞·ªõi ng∆∞·ª°ng (VND)</option>
            <option value="spend_above">T·ªïng chi ti√™u v∆∞·ª£t gi·ªõi h·∫°n (VND)</option>
            <option value="account_disabled">T√†i kho·∫£n b·ªã v√¥ hi·ªáu h√≥a</option>
            <option value="no_conversion">Kh√¥ng c√≥ chuy·ªÉn ƒë·ªïi sau X gi·ªù</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label" id="condValueLabel">Gi√° tr·ªã ng∆∞·ª°ng</label>
          <div style="display:flex;align-items:center;gap:6px">
            <input type="number" class="form-control" id="ruleCondValue" placeholder="50" style="flex:1">
            <span id="condUnit" style="font-size:12px;color:rgba(255,255,255,.4);white-space:nowrap">%</span>
          </div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="form-group">
          <label class="form-label">H√†nh ƒë·ªông</label>
          <select class="form-control" id="ruleAction">
            <option value="pause_campaign">T·∫°m d·ª´ng chi·∫øn d·ªãch</option>
            <option value="pause_adset">T·∫°m d·ª´ng nh√≥m QC</option>
            <option value="pause_ad">T·∫°m d·ª´ng qu·∫£ng c√°o</option>
            <option value="notify_only">Ch·ªâ c·∫£nh b√°o (kh√¥ng t·∫Øt)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">√Åp d·ª•ng cho</label>
          <select class="form-control" id="ruleScope">
            <option value="all">T·∫•t c·∫£ TKQC</option>
            <option value="selected">TKQC ƒëang ch·ªçn</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Th√¥ng b√°o khi k√≠ch ho·∫°t</label>
        <div style="display:flex;gap:16px;align-items:center">
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer">
            <input type="checkbox" id="ruleNotifyBrowser" checked style="accent-color:#c084fc"> Th√¥ng b√°o tr√¨nh duy·ªát
          </label>
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer">
            <input type="checkbox" id="ruleNotifyLog" checked style="accent-color:#c084fc"> Ghi log
          </label>
        </div>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
        <button class="btn btn-outline" onclick="closeRuleModal()">H·ªßy</button>
        <button class="btn" onclick="saveRule()" style="background:linear-gradient(135deg,#7c3aed,#a855f7);color:#fff"><i class="bi bi-check-lg"></i> L∆∞u Quy T·∫Øc</button>
      </div>
    </div>
  </div>

  <!-- Edit Timezone / Country Modal -->
  <div class="modal-overlay" id="editTzModal">
    <div class="modal-box" style="width:540px">
      <div class="modal-title"><i class="bi bi-globe" style="color:#00d4ff"></i> S·ª≠a M√∫i Gi·ªù / Qu·ªëc Gia</div>
      <div class="modal-sub" id="editTzAccName" style="color:#00d4ff;font-size:13px;margin-bottom:16px"></div>
      <div style="background:rgba(251,191,36,.06);border:1px solid rgba(251,191,36,.15);border-radius:8px;padding:10px 14px;margin-bottom:16px;font-size:12px;color:#fbbf24">
        <i class="bi bi-exclamation-triangle"></i> <strong>L∆∞u √Ω:</strong> Facebook ch·ªâ cho ph√©p s·ª≠a m√∫i gi·ªù v√† qu·ªëc gia qua <strong>Business Manager</strong> ho·∫∑c API v·ªõi quy·ªÅn <code>ads_management</code>. Thay ƒë·ªïi c√≥ th·ªÉ ·∫£nh h∆∞·ªüng ƒë·∫øn b√°o c√°o v√† m√∫i gi·ªù hi·ªÉn th·ªã c·ªßa chi·∫øn d·ªãch.
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
        <div class="form-group">
          <label class="form-label"><i class="bi bi-globe2" style="color:#60a5fa"></i> Qu·ªëc gia</label>
          <select class="form-control" id="editCountry">
            <option value="VN">üáªüá≥ Vi·ªát Nam (VN)</option>
            <option value="US">üá∫üá∏ United States (US)</option>
            <option value="GB">üá¨üáß United Kingdom (GB)</option>
            <option value="SG">üá∏üá¨ Singapore (SG)</option>
            <option value="TH">üáπüá≠ Thailand (TH)</option>
            <option value="ID">üáÆüá© Indonesia (ID)</option>
            <option value="MY">üá≤üáæ Malaysia (MY)</option>
            <option value="PH">üáµüá≠ Philippines (PH)</option>
            <option value="AU">üá¶üá∫ Australia (AU)</option>
            <option value="JP">üáØüáµ Japan (JP)</option>
            <option value="KR">üá∞üá∑ South Korea (KR)</option>
            <option value="CN">üá®üá≥ China (CN)</option>
            <option value="IN">üáÆüá≥ India (IN)</option>
            <option value="DE">üá©üá™ Germany (DE)</option>
            <option value="FR">üá´üá∑ France (FR)</option>
            <option value="CA">üá®üá¶ Canada (CA)</option>
            <option value="BR">üáßüá∑ Brazil (BR)</option>
            <option value="MX">üá≤üáΩ Mexico (MX)</option>
            <option value="AE">üá¶üá™ UAE (AE)</option>
            <option value="SA">üá∏üá¶ Saudi Arabia (SA)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label"><i class="bi bi-clock" style="color:#c084fc"></i> M√∫i gi·ªù</label>
          <select class="form-control" id="editTimezone">
            <optgroup label="ƒê√¥ng Nam √Å">
              <option value="Asia/Ho_Chi_Minh">Asia/Ho_Chi_Minh (UTC+7)</option>
              <option value="Asia/Bangkok">Asia/Bangkok (UTC+7)</option>
              <option value="Asia/Jakarta">Asia/Jakarta (UTC+7)</option>
              <option value="Asia/Singapore">Asia/Singapore (UTC+8)</option>
              <option value="Asia/Kuala_Lumpur">Asia/Kuala_Lumpur (UTC+8)</option>
              <option value="Asia/Manila">Asia/Manila (UTC+8)</option>
            </optgroup>
            <optgroup label="ƒê√¥ng √Å">
              <option value="Asia/Shanghai">Asia/Shanghai (UTC+8)</option>
              <option value="Asia/Tokyo">Asia/Tokyo (UTC+9)</option>
              <option value="Asia/Seoul">Asia/Seoul (UTC+9)</option>
              <option value="Asia/Kolkata">Asia/Kolkata (UTC+5:30)</option>
            </optgroup>
            <optgroup label="Trung ƒê√¥ng">
              <option value="Asia/Dubai">Asia/Dubai (UTC+4)</option>
              <option value="Asia/Riyadh">Asia/Riyadh (UTC+3)</option>
            </optgroup>
            <optgroup label="Ch√¢u √Çu">
              <option value="Europe/London">Europe/London (UTC+0/+1)</option>
              <option value="Europe/Paris">Europe/Paris (UTC+1/+2)</option>
              <option value="Europe/Berlin">Europe/Berlin (UTC+1/+2)</option>
            </optgroup>
            <optgroup label="Ch√¢u M·ªπ">
              <option value="America/New_York">America/New_York (UTC-5/-4)</option>
              <option value="America/Chicago">America/Chicago (UTC-6/-5)</option>
              <option value="America/Los_Angeles">America/Los_Angeles (UTC-8/-7)</option>
              <option value="America/Toronto">America/Toronto (UTC-5/-4)</option>
              <option value="America/Sao_Paulo">America/Sao_Paulo (UTC-3)</option>
            </optgroup>
            <optgroup label="Ch√¢u √ö c">
              <option value="Australia/Sydney">Australia/Sydney (UTC+10/+11)</option>
            </optgroup>
            <optgroup label="UTC">
              <option value="UTC">UTC (UTC+0)</option>
            </optgroup>
          </select>
        </div>
      </div>
      <div style="background:rgba(0,212,255,.04);border:1px solid rgba(0,212,255,.1);border-radius:8px;padding:10px 14px;margin-bottom:16px">
        <div style="font-size:11.5px;color:rgba(255,255,255,.5);margin-bottom:6px">Th√¥ng tin hi·ªán t·∫°i</div>
        <div style="display:flex;gap:20px;font-size:12.5px">
          <div><span style="color:rgba(255,255,255,.4)">Qu·ªëc gia: </span><span id="currentCountryDisplay" style="color:#60a5fa;font-weight:600"></span></div>
          <div><span style="color:rgba(255,255,255,.4)">M√∫i gi·ªù: </span><span id="currentTzDisplay" style="color:#c084fc;font-weight:600"></span></div>
        </div>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:4px">
        <button class="btn btn-outline" onclick="closeEditTzModal()">H·ªßy</button>
        <button class="btn" onclick="saveTimezone()" style="background:linear-gradient(135deg,#1877f2,#00d4ff);color:#fff"><i class="bi bi-check-lg"></i> C·∫≠p nh·∫≠t</button>
      </div>
    </div>
  </div>

  <script src="js/ads-shared.js"></script>

<script>
// -- Config ------------------------------------------------------------------
const FB_GRAPH = 'https://graph.facebook.com/v25.0';
const TOKEN_KEY = 'gz_manual_fb_token';
let currentTab = 'accounts';
let allAccounts = [];
let allCampaigns = [];
let allAdsets = [];
let allAds = [];
let selectedAccountId = null;
let selectedAccountName = '';
let selectedCampaignId = null;
let selectedCampaignName = '';
let selectedAdsetId = null;
let selectedAdsetName = '';
let rules = JSON.parse(localStorage.getItem('gz_auto_rules') || '[]');
let sortState = {};

// -- Token helpers ------------------------------------------------------------
function getToken() {
  return localStorage.getItem(TOKEN_KEY) || GZ.getFbToken() || '';
}

function openTokenModal() {
  const t = getToken();
  if (t) document.getElementById('tokenInput').value = t;
  document.getElementById('tokenModal').classList.add('open');
}

function closeTokenModal() {
  document.getElementById('tokenModal').classList.remove('open');
}

function saveToken() {
  const t = document.getElementById('tokenInput').value.trim();
  if (!t) { GZ.toast('Vui l√≤ng nh·∫≠p token', 'error'); return; }
  if (!t.startsWith('EAA') && !t.startsWith('EAB')) {
    GZ.toast('Token kh√¥ng h·ª£p l·ªá (ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng EAA...)', 'error'); return;
  }
  localStorage.setItem(TOKEN_KEY, t);
  closeTokenModal();
  updateTokenUI();
  loadAccounts();
  GZ.toast('ƒê√£ l∆∞u token! ƒêang t·∫£i d·ªØ li·ªáu...', 'success');
}

function clearToken() {
  localStorage.removeItem(TOKEN_KEY);
  updateTokenUI();
  setTableMsg('accounts', 'Ch∆∞a c√≥ token ‚Äî nh·∫•n n√∫t <strong style="color:#fbbf24">üîë Token</strong> ·ªü g√≥c tr√™n ph·∫£i ƒë·ªÉ nh·∫≠p');
  document.getElementById('statsRow').style.display = 'none';
  allAccounts = [];
  GZ.toast('ƒê√£ x√≥a token', 'info');
}

function updateTokenUI() {
  const t = getToken();
  const banner = document.getElementById('tokenBanner');
  const indicator = document.getElementById('tokenIndicator');
  const connDot = document.getElementById('connDot');
  const connText = document.getElementById('connText');
  if (t) {
    if (banner) { banner.style.display = 'flex'; }
    if (indicator) indicator.style.display = 'inline';
    if (connDot) { connDot.style.background = '#4ade80'; connDot.style.boxShadow = '0 0 6px #4ade80'; }
    if (connText) connText.textContent = 'ƒê√£ k·∫øt n·ªëi token';
  } else {
    if (banner) { banner.style.display = 'none'; }
    if (indicator) indicator.style.display = 'none';
    if (connDot) { connDot.style.background = '#f87171'; connDot.style.boxShadow = 'none'; }
    if (connText) connText.textContent = 'Ch∆∞a k·∫øt n·ªëi';
  }
}

// -- Helpers ------------------------------------------------------------------
function setTableMsg(tab, msg) {
  const el = document.getElementById('tbody-' + tab);
  const cols = { accounts: 9, campaigns: 10, adsets: 10, ads: 10 };
  if (el) el.innerHTML = `<tr class="loading-row"><td colspan="${cols[tab] || 9}">${msg}</td></tr>`;
}

function setLoading(tab) {
  setTableMsg(tab, '<span class="spinner"></span> ƒêang t·∫£i...');
}

function fmtMoney(val, currency) {
  if (!val && val !== 0) return '‚Äî';
  const n = parseFloat(val);
  if (isNaN(n)) return '‚Äî';
  if (currency === 'VND' || currency === 'VNƒê') return n.toLocaleString('vi-VN') + 'ƒë';
  return n.toLocaleString('en-US', { style: 'currency', currency: currency || 'USD', maximumFractionDigits: 2 });
}

function fmtNum(val) {
  if (!val && val !== 0) return '‚Äî';
  return parseFloat(val).toLocaleString('vi-VN');
}

function fmtPct(val) {
  if (!val && val !== 0) return '‚Äî';
  return parseFloat(val).toFixed(2) + '%';
}

function statusBadge(status) {
  const map = {
    1: ['Ho·∫°t ƒë·ªông', '#4ade80', 'rgba(34,197,94,.1)'],
    2: ['V√¥ hi·ªáu h√≥a', '#f87171', 'rgba(239,68,68,.1)'],
    3: ['Ch∆∞a x√°c nh·∫≠n', '#fbbf24', 'rgba(251,191,36,.1)'],
    7: ['ƒêang xem x√©t', '#60a5fa', 'rgba(96,165,250,.1)'],
    8: ['ƒêang xem x√©t', '#60a5fa', 'rgba(96,165,250,.1)'],
    9: ['B·ªã ƒë√≥ng', '#9ca3af', 'rgba(156,163,175,.1)'],
    100: ['ƒêang ch·∫°y', '#4ade80', 'rgba(34,197,94,.1)'],
    ACTIVE: ['ƒêang ch·∫°y', '#4ade80', 'rgba(34,197,94,.1)'],
    PAUSED: ['T·∫°m d·ª´ng', '#fbbf24', 'rgba(251,191,36,.1)'],
    DELETED: ['ƒê√£ x√≥a', '#9ca3af', 'rgba(156,163,175,.1)'],
    ARCHIVED: ['L∆∞u tr·ªØ', '#6b7280', 'rgba(107,114,128,.1)'],
    PENDING_REVIEW: ['ƒêang xem x√©t', '#60a5fa', 'rgba(96,165,250,.1)'],
    DISAPPROVED: ['B·ªã t·ª´ ch·ªëi', '#f87171', 'rgba(239,68,68,.1)'],
    PREAPPROVED: ['Ti·ªÅn duy·ªát', '#a78bfa', 'rgba(167,139,250,.1)'],
    PENDING_BILLING_INFO: ['Ch·ªù thanh to√°n', '#fb923c', 'rgba(251,146,60,.1)'],
    CAMPAIGN_PAUSED: ['Chi·∫øn d·ªãch d·ª´ng', '#fbbf24', 'rgba(251,191,36,.1)'],
    ADSET_PAUSED: ['Nh√≥m d·ª´ng', '#fbbf24', 'rgba(251,191,36,.1)'],
    IN_PROCESS: ['ƒêang x·ª≠ l√Ω', '#60a5fa', 'rgba(96,165,250,.1)'],
    WITH_ISSUES: ['C√≥ v·∫•n ƒë·ªÅ', '#f87171', 'rgba(239,68,68,.1)'],
  };
  const [label, color, bg] = map[status] || ['Kh√¥ng r√µ', '#9ca3af', 'rgba(156,163,175,.1)'];
  return `<span style="background:${bg};color:${color};border:1px solid ${color}33;border-radius:12px;padding:2px 9px;font-size:11px;font-weight:600;white-space:nowrap;display:inline-block">${label}</span>`;
}

// -- Rate Limit & Cache System ------------------------------------------------
const API_CACHE = {};
const CACHE_TTL = 5 * 60 * 1000; // 5 ph√∫t
const RATE_LIMIT_CODES = [4, 17, 32, 613, 80004];
let rateLimitUntil = 0;
let pendingRequests = 0;

function getCacheKey(path, params) {
  return path + '|' + JSON.stringify(params);
}

function getCache(key) {
  const c = API_CACHE[key];
  if (c && Date.now() - c.ts < CACHE_TTL) return c.data;
  return null;
}

function setCache(key, data) {
  API_CACHE[key] = { data, ts: Date.now() };
}

function clearCacheFor(prefix) {
  Object.keys(API_CACHE).forEach(k => { if (k.startsWith(prefix)) delete API_CACHE[k]; });
}

function updateRateLimitUI() {
  const indicator = document.getElementById('rateLimitIndicator');
  if (!indicator) return;
  if (Date.now() < rateLimitUntil) {
    const secs = Math.ceil((rateLimitUntil - Date.now()) / 1000);
    indicator.style.display = 'flex';
    indicator.innerHTML = `<i class="bi bi-hourglass-split" style="color:#fbbf24"></i> Rate limit: ch·ªù ${secs}s`;
  } else {
    indicator.style.display = 'none';
  }
}

async function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// -- Facebook API v·ªõi retry + cache -----------------------------------------
async function fbGet(path, params = {}, opts = {}) {
  const token = getToken();
  if (!token) throw new Error('Ch∆∞a c√≥ token');
  const cacheKey = getCacheKey(path, params);
  if (!opts.noCache) {
    const cached = getCache(cacheKey);
    if (cached) return cached;
  }
  // Ch·ªù n·∫øu ƒëang b·ªã rate limit
  if (Date.now() < rateLimitUntil) {
    await sleep(rateLimitUntil - Date.now());
  }
  const qs = new URLSearchParams({ ...params, access_token: token }).toString();
  let retries = 0;
  while (retries <= 3) {
    try {
      pendingRequests++;
      const resp = await fetch(`${FB_GRAPH}${path}?${qs}`);
      pendingRequests--;
      const data = await resp.json();
      if (data.error) {
        const code = data.error.code;
        if (RATE_LIMIT_CODES.includes(code)) {
          // Exponential backoff: 5s, 15s, 45s
          const wait = Math.pow(3, retries + 1) * 5000;
          rateLimitUntil = Date.now() + wait;
          updateRateLimitUI();
          GZ.toast(`Rate limit FB API ‚Äî ƒë·ª£i ${wait/1000}s r·ªìi th·ª≠ l·∫°i...`, 'warn');
          await sleep(wait);
          retries++;
          continue;
        }
        throw new Error(`[${code}] ${data.error.message}`);
      }
      if (!opts.noCache) setCache(cacheKey, data);
      return data;
    } catch(e) {
      pendingRequests--;
      if (retries >= 3) throw e;
      await sleep(2000 * (retries + 1));
      retries++;
    }
  }
}

// fbGetAll: ph√¢n trang nh∆∞ng gi·ªõi h·∫°n t·ªëi ƒëa 3 trang (150 items) tr√°nh qu√° nhi·ªÅu request
async function fbGetAll(path, params = {}, maxPages = 3) {
  const cacheKey = 'all:' + getCacheKey(path, params);
  const cached = getCache(cacheKey);
  if (cached) return cached;

  let results = [];
  let url = `${FB_GRAPH}${path}?${new URLSearchParams({ ...params, access_token: getToken() })}`;
  let page = 0;
  while (url && page < maxPages) {
    // Delay nh·ªè gi·ªØa c√°c trang ƒë·ªÉ tr√°nh burst
    if (page > 0) await sleep(300);
    const resp = await fetch(url);
    const data = await resp.json();
    if (data.error) {
      const code = data.error.code;
      if (RATE_LIMIT_CODES.includes(code)) {
        const wait = 10000;
        rateLimitUntil = Date.now() + wait;
        updateRateLimitUI();
        GZ.toast(`Rate limit ‚Äî ƒë·ª£i 10s...`, 'warn');
        await sleep(wait);
        continue; // th·ª≠ l·∫°i trang n√†y
      }
      throw new Error(`[${code}] ${data.error.message}`);
    }
    results = results.concat(data.data || []);
    url = data.paging?.next || null;
    page++;
  }
  setCache(cacheKey, results);
  return results;
}

// fbBatch: g·ªôp nhi·ªÅu request th√†nh 1 l·∫ßn g·ªçi (Facebook Batch API)
async function fbBatch(requests) {
  const token = getToken();
  if (!token) throw new Error('Ch∆∞a c√≥ token');
  // T·ªëi ƒëa 50 request/batch
  const chunks = [];
  for (let i = 0; i < requests.length; i += 50) chunks.push(requests.slice(i, i + 50));
  let allResults = [];
  for (const chunk of chunks) {
    if (chunks.indexOf(chunk) > 0) await sleep(500);
    const body = new URLSearchParams({
      access_token: token,
      batch: JSON.stringify(chunk.map(r => ({ method: 'GET', relative_url: r })))
    });
    const resp = await fetch('https://graph.facebook.com/v25.0', { method: 'POST', body });
    const results = await resp.json();
    allResults = allResults.concat(results);
  }
  return allResults.map(r => {
    if (!r || r.code !== 200) return null;
    try { return JSON.parse(r.body); } catch { return null; }
  });
}

// -- Load Accounts ------------------------------------------------------------
async function loadAccounts() {
  const token = getToken();
  if (!token) {
    setTableMsg('accounts', 'üîë Ch∆∞a c√≥ token ‚Äî nh·∫•n n√∫t <strong style="color:#fbbf24">üîë Token</strong> ·ªü g√≥c tr√™n ph·∫£i ƒë·ªÉ nh·∫≠p Access Token');
    return;
  }
  setLoading('accounts');
  try {
    const datePreset = document.getElementById('datePreset')?.value || 'last_7d';
    const data = await fbGetAll('/me/adaccounts', {
      fields: 'id,name,account_status,currency,timezone_name,country,balance,amount_spent',
      date_preset: datePreset,
      limit: 50
    });
    allAccounts = data;
    renderAccounts(data);
    updateStats(data);
    document.getElementById('countAccounts').textContent = data.length;
    // Load insights h√¥m nay + theo gi·ªù (b·∫•t ƒë·ªìng b·ªô, kh√¥ng block UI)
    loadAccountsInsights(data);
  } catch(e) {
    setTableMsg('accounts', `<span style="color:#f87171"><i class="bi bi-exclamation-triangle"></i> L·ªói: ${e.message}</span>`);
    GZ.toast('L·ªói t·∫£i TKQC: ' + e.message, 'error');
  }
}

function renderAccounts(data) {
  const tbody = document.getElementById('tbody-accounts');
  if (!data.length) {
    tbody.innerHTML = '<tr class="loading-row"><td colspan="9">Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n qu·∫£ng c√°o n√†o</td></tr>';
    return;
  }
  tbody.innerHTML = data.map(a => {
    const id = a.id.replace('act_', '');
    return `<tr style="cursor:pointer" onclick="selectAccount('${a.id}','${(a.name||'').replace(/'/g,"\\'")}')">  
      <td><input type="checkbox" class="row-check" value="${a.id}" onclick="event.stopPropagation()"></td>
      <td>
        <div style="font-weight:600;font-size:13px">${a.name || 'Kh√¥ng t√™n'}</div>
        <div style="font-size:11px;color:rgba(255,255,255,.35)">act_${id}</div>
      </td>
      <td>${statusBadge(a.account_status)}</td>
      <td style="font-size:12px">${a.country || '‚Äî'}</td>
      <td style="font-size:11.5px;color:rgba(255,255,255,.5)">${a.timezone_name || '‚Äî'}</td>
      <td style="font-size:12px">${a.currency || '‚Äî'}</td>
      <td style="color:#4ade80;font-weight:600">${fmtMoney(a.balance, a.currency)}</td>
      <td style="color:#60a5fa">${fmtMoney(a.amount_spent, a.currency)}</td>
      <td id="today-${a.id}" style="color:#fbbf24"><span style="color:rgba(255,255,255,.2);font-size:11px"><span class="spinner" style="width:10px;height:10px"></span></span></td>
      <td id="spark-${a.id}"><span style="color:rgba(255,255,255,.2);font-size:10px">‚Äî</span></td>
      <td>
        <button class="btn-icon" style="font-size:11px;padding:3px 8px" onclick="event.stopPropagation();openEditTzModal('${a.id}','${(a.name||'').replace(/'/g,"\\'")}')"
          title="S·ª≠a m√∫i gi·ªù"><i class="bi bi-globe"></i></button>
      </td>
    </tr>`;
  }).join('');
}

function updateStats(data) {
  const statsRow = document.getElementById('statsRow');
  if (!data.length) { statsRow.style.display = 'none'; return; }
  statsRow.style.display = 'flex';
  document.getElementById('sTotalAcc').textContent = data.length;
  document.getElementById('sActiveAcc').textContent = data.filter(a => a.account_status === 1).length;
  document.getElementById('sLockedAcc').textContent = data.filter(a => a.account_status === 2 || a.account_status === 9).length;
  // T·ªïng chi ti√™u (ch·ªâ t√≠nh VND ho·∫∑c c√πng currency)
  const currencies = [...new Set(data.map(a => a.currency).filter(Boolean))];
  if (currencies.length === 1) {
    const cur = currencies[0];
    const totalSpend = data.reduce((s, a) => s + (parseFloat(a.amount_spent) || 0), 0);
    const totalBalance = data.reduce((s, a) => s + (parseFloat(a.balance) || 0), 0);
    document.getElementById('sTotalSpend').textContent = fmtMoney(totalSpend, cur);
    document.getElementById('sTotalBalance').textContent = fmtMoney(totalBalance, cur);
  } else {
    document.getElementById('sTotalSpend').textContent = 'ƒêa ti·ªÅn t·ªá';
    document.getElementById('sTotalBalance').textContent = 'ƒêa ti·ªÅn t·ªá';
  }
}// -- Insights theo gi·ªù ---------------------------------------------------------
async function loadAccountsInsights(accounts) {
  // L·∫•y gi·ªù hi·ªán t·∫°i (0-23)
  const nowHour = new Date().getHours();
  // G·ªçi insights t·ª´ng TKQC tu·∫ßn t·ª± (tr√°nh burst rate limit)
  for (const acc of accounts) {
    try {
      // L·∫•y chi ti√™u h√¥m nay (1 call ƒë∆°n gi·∫£n, ch·∫Øc ch·∫Øn ho·∫°t ƒë·ªông)
      const todayStr = new Date().toISOString().slice(0, 10);
      const [todayIns, weekIns] = await Promise.all([
        fbGet(`/${acc.id}/insights`, {
          fields: 'spend',
          date_preset: 'today',
          limit: 1
        }, { noCache: false }),
        fbGet(`/${acc.id}/insights`, {
          fields: 'spend,date_start',
          date_preset: 'last_7d',
          time_increment: 1,
          limit: 7
        }, { noCache: false })
      ]);
      // T·ªïng chi ti√™u h√¥m nay
      const todaySpend = parseFloat(todayIns?.data?.[0]?.spend || 0);
      // D·ªØ li·ªáu 7 ng√†y cho sparkline (thay cho hourly)
      const weekData = weekIns?.data || [];
      // hourArr gi·ªù ‚Üí d√πng dayArr 7 ng√†y thay th·∫ø
      const hourArr = Array(7).fill(0);
      weekData.forEach((d, i) => { hourArr[i] = parseFloat(d.spend || 0); });
      // C·∫≠p nh·∫≠t cell chi ti√™u h√¥m nay
      const todayCell = document.getElementById(`today-${acc.id}`);
      if (todayCell) {
        if (todaySpend > 0) {
          todayCell.innerHTML = `<span class="today-spend">${fmtMoney(todaySpend, acc.currency)}</span>`;
        } else {
          todayCell.innerHTML = `<span class="today-spend zero">‚Äî 0</span>`;
        }
      }
      // C·∫≠p nh·∫≠t sparkline
      const sparkCell = document.getElementById(`spark-${acc.id}`);
      if (sparkCell) {
        sparkCell.innerHTML = renderSparkline(hourArr, nowHour, acc.currency);
      }
    } catch(e) {
      // Kh√¥ng hi·ªÉn th·ªã l·ªói ‚Äî ch·ªâ ƒë·ªÉ tr·ªëng
      const todayCell = document.getElementById(`today-${acc.id}`);
      const sparkCell = document.getElementById(`spark-${acc.id}`);
      if (todayCell) todayCell.innerHTML = `<span style="color:rgba(255,255,255,.2);font-size:10px" title="${e.message}">‚ö†</span>`;
      if (sparkCell) sparkCell.innerHTML = `<span style="color:rgba(255,255,255,.2);font-size:10px">‚Äî</span>`;
    }
    // Delay 400ms gi·ªØa c√°c TKQC ƒë·ªÉ tr√°nh rate limit
    await sleep(400);
  }
}

function renderSparkline(dayArr, nowHour, currency) {
  const maxVal = Math.max(...dayArr, 1);
  const days = ['‚àí6', '‚àí5', '‚àí‚Äì4', '‚àí‚Äì3', '‚àí‚Äì2', 'H√¥m qua', 'H√¥m nay'];
  if (dayArr.every(v => v === 0)) {
    return `<span style="color:rgba(255,255,255,.2);font-size:10px">Ch∆∞a c√≥ chi ti√™u</span>`;
  }
  const bars = dayArr.map((val, i) => {
    const pct = Math.round((val / maxVal) * 26);
    const h = Math.max(pct, 2);
    const isToday = i === dayArr.length - 1;
    const label = `${days[i] || ('Ng√†y ' + (i+1))} ‚Äî ${fmtMoney(val, currency)}`;
    return `<div class="spark-bar${isToday ? ' current-hour' : ''}" style="height:${h}px" title="${label}">
      <div class="spark-tooltip">${label}</div>
    </div>`;
  }).join('');
  const total = dayArr.reduce((s, v) => s + v, 0);
  return `<div style="display:flex;flex-direction:column;gap:2px">
    <div class="sparkline-wrap">${bars}</div>
    <div style="font-size:9.5px;color:rgba(255,255,255,.3)">7 ng√†y ‚Ä¢ t·ªïng ${fmtMoney(total, currency)}</div>
  </div>`;
}

// -- Select Account ‚Üí load campaigns -------------------------------------------
function selectAccount(accountId, accountName) {
  selectedAccountId = accountId;
  selectedAccountName = accountName;
  switchTab('campaigns');
  loadCampaigns(accountId);
}

async function loadCampaigns(accountId) {
  setLoading('campaigns');
  try {
    const datePreset = document.getElementById('datePreset')?.value || 'last_7d';
    // L·∫•y danh s√°ch campaign + effective_status
    const data = await fbGetAll(`/${accountId}/campaigns`, {
      fields: 'id,name,status,effective_status,objective,daily_budget,lifetime_budget',
      limit: 50
    });
    // L·∫•y insights ri√™ng v·ªõi date_preset ƒë√∫ng
    if (data.length > 0) {
      try {
        const insResp = await fbGet(`/${accountId}/insights`, {
          fields: 'campaign_id,spend,impressions,clicks,ctr,cpc',
          date_preset: datePreset,
          level: 'campaign',
          limit: 200
        });
        const insMap = {};
        (insResp?.data || []).forEach(r => { insMap[r.campaign_id] = r; });
        data.forEach(c => { c._ins = insMap[c.id] || {}; });
      } catch(e2) {
        data.forEach(c => { c._ins = {}; });
      }
    }
    allCampaigns = data;
    renderCampaigns(data);
    document.getElementById('countCampaigns').textContent = data.length;
    updateContextBar();
    // T·ª± ƒë·ªông load t·∫•t c·∫£ adsets v√† ads sau khi c√≥ campaigns
    if (data.length > 0) {
      loadAllAdsets(data);
    }
  } catch(e) {
    setTableMsg('campaigns', `<span style="color:#f87171">L·ªói: ${e.message}</span>`);
  }
}

// Load t·∫•t c·∫£ adsets t·ª´ t·∫•t c·∫£ campaigns song song
async function loadAllAdsets(campaigns) {
  setLoading('adsets');
  setLoading('ads');
  try {
    const datePreset = document.getElementById('datePreset')?.value || 'last_7d';
    // L·∫•y adsets c·ªßa t·∫•t c·∫£ campaigns song song
    const adsetPromises = campaigns.map(c =>
      fbGetAll(`/${c.id}/adsets`, {
        fields: 'id,name,status,effective_status,campaign_id,daily_budget',
        limit: 50
      }).catch(() => [])
    );
    const adsetResults = await Promise.all(adsetPromises);
    const allAdsetData = adsetResults.flat();

    // L·∫•y insights cho t·∫•t c·∫£ adsets song song
    if (allAdsetData.length > 0) {
      try {
        const insPromises = allAdsetData.map(s =>
          fbGet(`/${s.id}/insights`, {
            fields: 'spend,impressions,clicks,cpm,cpc',
            date_preset: datePreset
          }, { noCache: false }).catch(() => null)
        );
        const insResults = await Promise.all(insPromises);
        allAdsetData.forEach((s, i) => {
          s._ins = insResults[i]?.data?.[0] || {};
        });
      } catch(e2) { allAdsetData.forEach(s => { s._ins = {}; }); }
    }

    allAdsets = allAdsetData;
    renderAdsets(allAdsetData);
    document.getElementById('countAdsets').textContent = allAdsetData.length;
    updateContextBar();

    // T·ª± ƒë·ªông load t·∫•t c·∫£ ads sau khi c√≥ adsets
    if (allAdsetData.length > 0) {
      loadAllAds(allAdsetData);
    } else {
      document.getElementById('tbody-ads').innerHTML = '<tr class="loading-row"><td colspan="10">Kh√¥ng c√≥ qu·∫£ng c√°o n√†o</td></tr>';
      document.getElementById('countAds').textContent = '0';
    }
  } catch(e) {
    setTableMsg('adsets', `<span style="color:#f87171">L·ªói: ${e.message}</span>`);
  }
}

// Load t·∫•t c·∫£ ads t·ª´ t·∫•t c·∫£ adsets song song
async function loadAllAds(adsets) {
  setLoading('ads');
  try {
    const datePreset = document.getElementById('datePreset')?.value || 'last_7d';
    // L·∫•y ads c·ªßa t·∫•t c·∫£ adsets song song (gi·ªõi h·∫°n 10 adsets ƒë·∫ßu ƒë·ªÉ tr√°nh rate limit)
    const topAdsets = adsets.slice(0, 20);
    const adsPromises = topAdsets.map(s =>
      fbGetAll(`/${s.id}/ads`, {
        fields: 'id,name,status,effective_status,adset_id',
        limit: 50
      }).catch(() => [])
    );
    const adsResults = await Promise.all(adsPromises);
    const allAdsData = adsResults.flat();

    // L·∫•y insights cho t·∫•t c·∫£ ads song song
    if (allAdsData.length > 0) {
      try {
        const insPromises = allAdsData.map(ad =>
          fbGet(`/${ad.id}/insights`, {
            fields: 'spend,impressions,clicks,ctr,cpc,cpm',
            date_preset: datePreset
          }, { noCache: false }).catch(() => null)
        );
        const insResults = await Promise.all(insPromises);
        allAdsData.forEach((ad, i) => {
          ad._ins = insResults[i]?.data?.[0] || {};
        });
      } catch(e2) { allAdsData.forEach(ad => { ad._ins = {}; }); }
    }

    allAds = allAdsData;
    renderAds(allAdsData);
    document.getElementById('countAds').textContent = allAdsData.length;
    updateContextBar();
  } catch(e) {
    setTableMsg('ads', `<span style="color:#f87171">L·ªói: ${e.message}</span>`);
  }
}

function renderCampaigns(data) {
  const tbody = document.getElementById('tbody-campaigns');
  if (!data.length) {
    tbody.innerHTML = '<tr class="loading-row"><td colspan="10">Kh√¥ng c√≥ chi·∫øn d·ªãch n√†o</td></tr>';
    return;
  }
  tbody.innerHTML = data.map(c => {
    const ins = c._ins || {};
    const budget = c.daily_budget ? fmtMoney(c.daily_budget/100, 'VND') : (c.lifetime_budget ? fmtMoney(c.lifetime_budget/100, 'VND') + ' (tr·ªçn ƒë·ªùi)' : '‚Äî');
    const effStatus = c.effective_status || c.status;
    return `<tr style="cursor:pointer" onclick="selectCampaign('${c.id}','${(c.name||'').replace(/'/g,"\\'")}')">  
      <td><input type="checkbox" onclick="event.stopPropagation()"></td>
      <td><div style="font-weight:600;font-size:13px">${c.name||'‚Äî'}</div><div style="font-size:11px;color:rgba(255,255,255,.3)">${c.id}</div></td>
      <td>${statusBadge(effStatus)}</td>
      <td style="font-size:12px;color:rgba(255,255,255,.6)">${c.objective||'‚Äî'}</td>
      <td style="font-size:12px">${budget}</td>
      <td style="color:#60a5fa">${ins.spend ? fmtMoney(ins.spend,'VND') : '‚Äî'}</td>
      <td>${fmtNum(ins.impressions)}</td>
      <td>${fmtNum(ins.clicks)}</td>
      <td>${fmtPct(ins.ctr)}</td>
      <td>${ins.cpc ? fmtMoney(ins.cpc,'VND') : '‚Äî'}</td>
    </tr>`;
  }).join('');
}

function selectCampaign(campaignId, campaignName) {
  selectedCampaignId = campaignId;
  selectedCampaignName = campaignName;
  switchTab('adsets');
  // N·∫øu ƒë√£ c√≥ allAdsets th√¨ l·ªçc theo campaign, kh√¥ng c·∫ßn g·ªçi API l·∫°i
  if (allAdsets.length > 0) {
    const filtered = allAdsets.filter(s => s.campaign_id === campaignId);
    if (filtered.length > 0) {
      renderAdsets(filtered);
      document.getElementById('countAdsets').textContent = filtered.length;
      updateContextBar();
      return;
    }
  }
  // N·∫øu ch∆∞a c√≥ th√¨ load m·ªõi
  loadAdsets(campaignId);
}

async function loadAdsets(campaignId) {
  setLoading('adsets');
  try {
    const datePreset = document.getElementById('datePreset')?.value || 'last_7d';
    // B∆∞·ªõc 1: L·∫•y danh s√°ch adsets
    const data = await fbGetAll(`/${campaignId}/adsets`, {
      fields: 'id,name,status,effective_status,campaign_id,daily_budget',
      limit: 50
    });
    // B∆∞·ªõc 2: L·∫•y insights t·ª´ng adset song song (batch)
    if (data.length > 0) {
      try {
        const insPromises = data.map(s =>
          fbGet(`/${s.id}/insights`, {
            fields: 'spend,impressions,clicks,cpm,cpc',
            date_preset: datePreset
          }, { noCache: false }).catch(() => null)
        );
        const insResults = await Promise.all(insPromises);
        data.forEach((s, i) => {
          s._ins = insResults[i]?.data?.[0] || {};
        });
      } catch(e2) { data.forEach(s => { s._ins = {}; }); }
    }
    allAdsets = data;
    renderAdsets(data);
    document.getElementById('countAdsets').textContent = data.length;
    updateContextBar();
  } catch(e) {
    setTableMsg('adsets', `<span style="color:#f87171">L·ªói: ${e.message}</span>`);
  }
}

function renderAdsets(data) {
  const tbody = document.getElementById('tbody-adsets');
  if (!data.length) {
    tbody.innerHTML = '<tr class="loading-row"><td colspan="10">Kh√¥ng c√≥ nh√≥m qu·∫£ng c√°o n√†o</td></tr>';
    return;
  }
  tbody.innerHTML = data.map(s => {
    const ins = s._ins || {};
    const budget = s.daily_budget ? fmtMoney(s.daily_budget/100, 'VND') : '‚Äî';
    const effStatus = s.effective_status || s.status;
    return `<tr style="cursor:pointer" onclick="selectAdset('${s.id}','${(s.name||'').replace(/'/g,"\\'")}')">  
      <td><input type="checkbox" onclick="event.stopPropagation()"></td>
      <td><div style="font-weight:600;font-size:13px">${s.name||'‚Äî'}</div><div style="font-size:11px;color:rgba(255,255,255,.3)">${s.id}</div></td>
      <td>${statusBadge(effStatus)}</td>
      <td style="font-size:12px;color:rgba(255,255,255,.5)">${s.campaign_id||'‚Äî'}</td>
      <td style="font-size:12px">${budget}</td>
      <td style="color:#60a5fa">${ins.spend ? fmtMoney(ins.spend,'VND') : '‚Äî'}</td>
      <td>${fmtNum(ins.impressions)}</td>
      <td>${fmtNum(ins.clicks)}</td>
      <td>${ins.cpm ? fmtMoney(ins.cpm,'VND') : '‚Äî'}</td>
      <td>${ins.cpc ? fmtMoney(ins.cpc,'VND') : '‚Äî'}</td>
    </tr>`;
  }).join('');
}

function selectAdset(adsetId, adsetName) {
  selectedAdsetId = adsetId;
  selectedAdsetName = adsetName;
  switchTab('ads');
  // N·∫øu ƒë√£ c√≥ allAds th√¨ l·ªçc theo adset, kh√¥ng c·∫ßn g·ªçi API l·∫°i
  if (allAds.length > 0) {
    const filtered = allAds.filter(ad => ad.adset_id === adsetId);
    if (filtered.length > 0) {
      renderAds(filtered);
      document.getElementById('countAds').textContent = filtered.length;
      updateContextBar();
      return;
    }
  }
  // N·∫øu ch∆∞a c√≥ th√¨ load m·ªõi
  loadAds(adsetId);
}

async function loadAds(adsetId) {
  setLoading('ads');
  try {
    const datePreset = document.getElementById('datePreset')?.value || 'last_7d';
    // B∆∞·ªõc 1: L·∫•y danh s√°ch ads
    const data = await fbGetAll(`/${adsetId}/ads`, {
      fields: 'id,name,status,effective_status,adset_id',
      limit: 50
    });
    // B∆∞·ªõc 2: L·∫•y insights t·ª´ng ad song song
    if (data.length > 0) {
      try {
        const insPromises = data.map(ad =>
          fbGet(`/${ad.id}/insights`, {
            fields: 'spend,impressions,clicks,ctr,cpc,cpm',
            date_preset: datePreset
          }, { noCache: false }).catch(() => null)
        );
        const insResults = await Promise.all(insPromises);
        data.forEach((ad, i) => {
          ad._ins = insResults[i]?.data?.[0] || {};
        });
      } catch(e2) { data.forEach(ad => { ad._ins = {}; }); }
    }
    allAds = data;
    renderAds(data);
    document.getElementById('countAds').textContent = data.length;
    updateContextBar();
  } catch(e) {
    setTableMsg('ads', `<span style="color:#f87171">L·ªói: ${e.message}</span>`);
  }
}

function renderAds(data) {
  const tbody = document.getElementById('tbody-ads');
  if (!data.length) {
    tbody.innerHTML = '<tr class="loading-row"><td colspan="10">Kh√¥ng c√≥ qu·∫£ng c√°o n√†o</td></tr>';
    return;
  }
  tbody.innerHTML = data.map(ad => {
    const ins = ad._ins || {};
    const effStatus = ad.effective_status || ad.status;
    return `<tr>  
      <td><input type="checkbox"></td>
      <td><div style="font-weight:600;font-size:13px">${ad.name||'‚Äî'}</div><div style="font-size:11px;color:rgba(255,255,255,.3)">${ad.id}</div></td>
      <td>${statusBadge(effStatus)}</td>
      <td style="font-size:12px;color:rgba(255,255,255,.5)">${ad.adset_id||'‚Äî'}</td>
      <td style="color:#60a5fa">${ins.spend ? fmtMoney(ins.spend,'VND') : '‚Äî'}</td>
      <td>${fmtNum(ins.impressions)}</td>
      <td>${fmtNum(ins.clicks)}</td>
      <td>${fmtPct(ins.ctr)}</td>
      <td>${ins.cpc ? fmtMoney(ins.cpc,'VND') : '‚Äî'}</td>
      <td>${ins.cpm ? fmtMoney(ins.cpm,'VND') : '‚Äî'}</td>
    </tr>`;
  }).join('');
}

// -- Tab switching ------------------------------------------------------------
function switchTab(tab) {
  currentTab = tab;
  ['accounts','campaigns','adsets','ads','rules'].forEach(t => {
    document.getElementById('panel-' + t).style.display = t === tab ? 'block' : 'none';
    document.getElementById('tab-' + t).classList.toggle('active', t === tab);
  });
  if (tab === 'rules') renderRules();
  updateContextBar();
}

function updateContextBar() {
  const bar = document.getElementById('contextBar');
  if (!bar) return;
  if (selectedAccountName && currentTab !== 'accounts') {
    bar.style.display = 'flex';
    let html = `<i class="bi bi-credit-card" style="color:#00d4ff"></i> <span style="color:rgba(255,255,255,.5)">TKQC:</span> <strong style="color:#00d4ff" style="cursor:pointer" onclick="switchTab('accounts')">${selectedAccountName}</strong>`;
    if (currentTab === 'adsets' && selectedCampaignId) {
      html += ` <span style="color:rgba(255,255,255,.3)">‚Ä∫</span> <span style="color:rgba(255,255,255,.5)">Chi·∫øn d·ªãch:</span> <strong style="color:#a78bfa">${selectedCampaignName}</strong>`;
      html += ` <button onclick="showAllAdsets()" style="margin-left:8px;padding:2px 8px;font-size:11px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:4px;color:rgba(255,255,255,.6);cursor:pointer">Xem t·∫•t c·∫£ nh√≥m QC</button>`;
    }
    if (currentTab === 'ads' && selectedAdsetId) {
      html += ` <span style="color:rgba(255,255,255,.3)">‚Ä∫</span> <span style="color:rgba(255,255,255,.5)">Nh√≥m QC:</span> <strong style="color:#34d399">${selectedAdsetName}</strong>`;
      html += ` <button onclick="showAllAds()" style="margin-left:8px;padding:2px 8px;font-size:11px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:4px;color:rgba(255,255,255,.6);cursor:pointer">Xem t·∫•t c·∫£ QC</button>`;
    }
    bar.innerHTML = html;
  } else {
    bar.style.display = 'none';
  }
}

function showAllAdsets() {
  selectedCampaignId = null;
  selectedCampaignName = '';
  renderAdsets(allAdsets);
  document.getElementById('countAdsets').textContent = allAdsets.length;
  updateContextBar();
}

function showAllAds() {
  selectedAdsetId = null;
  selectedAdsetName = '';
  renderAds(allAds);
  document.getElementById('countAds').textContent = allAds.length;
  updateContextBar();
}

function loadCurrentTab() {
  if (currentTab === 'accounts') loadAccounts();
  else if (selectedAccountId) loadCampaigns(selectedAccountId);
}

function refreshData() {
  loadCurrentTab();
  GZ.toast('ƒêang l√†m m·ªõi...', 'info');
}

function clearAllCache() {
  Object.keys(API_CACHE).forEach(k => delete API_CACHE[k]);
  rateLimitUntil = 0;
  updateRateLimitUI();
  loadCurrentTab();
  GZ.toast('Xo√° cache ‚Äî ƒëang t·∫£i l·∫°i d·ªØ li·ªáu m·ªõi...', 'success');
}

// -- Search & filter ----------------------------------------------------------
function filterTable() {
  const q = document.getElementById('searchInput').value.toLowerCase();
  const tbody = document.getElementById('tbody-' + currentTab);
  if (!tbody) return;
  tbody.querySelectorAll('tr').forEach(row => {
    row.style.display = row.textContent.toLowerCase().includes(q) ? '' : 'none';
  });
}

function sortTable(tab, field) {
  // Simple sort toggle
  const asc = sortState[tab + field] !== 'asc';
  sortState[tab + field] = asc ? 'asc' : 'desc';
  let arr = tab === 'accounts' ? allAccounts : tab === 'campaigns' ? allCampaigns : tab === 'adsets' ? allAdsets : allAds;
  arr.sort((a, b) => {
    const va = a[field] ?? '';
    const vb = b[field] ?? '';
    if (typeof va === 'number') return asc ? va - vb : vb - va;
    return asc ? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
  });
  if (tab === 'accounts') renderAccounts(arr);
  else if (tab === 'campaigns') renderCampaigns(arr);
  else if (tab === 'adsets') renderAdsets(arr);
  else renderAds(arr);
}

function toggleCheckAll(cb) {
  document.querySelectorAll('.row-check').forEach(c => c.checked = cb.checked);
}

// -- Export CSV ---------------------------------------------------------------
function exportCSV() {
  let rows = [], headers = [];
  if (currentTab === 'accounts') {
    headers = ['ID','T√™n','Tr·∫°ng th√°i','Qu·ªëc gia','M√∫i gi·ªù','Ti·ªÅn t·ªá','S·ªë d∆∞','Chi ti√™u'];
    rows = allAccounts.map(a => [a.id, a.name, a.account_status, a.country, a.timezone_name, a.currency, a.balance, a.amount_spent]);
  } else if (currentTab === 'campaigns') {
    headers = ['ID','T√™n','Tr·∫°ng th√°i','M·ª•c ti√™u','Ng√¢n s√°ch ng√†y'];
    rows = allCampaigns.map(c => [c.id, c.name, c.status, c.objective, c.daily_budget]);
  }
  if (!rows.length) { GZ.toast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t', 'error'); return; }
  let csv = headers.join(',') + '\n' + rows.map(r => r.map(v => `"${String(v||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob(['\ufeff'+csv], {type:'text/csv;charset=utf-8'}));
  a.download = `tkqc_${currentTab}_${Date.now()}.csv`;
  a.click();
  GZ.toast('ƒê√£ xu·∫•t CSV!', 'success');
}

// -- Rules --------------------------------------------------------------------
function openRuleModal() { document.getElementById('ruleModal').classList.add('open'); }
function closeRuleModal() { document.getElementById('ruleModal').classList.remove('open'); }

function saveRule() {
  const name = document.getElementById('ruleName').value.trim();
  if (!name) { GZ.toast('Vui l√≤ng nh·∫≠p t√™n quy t·∫Øc', 'error'); return; }
  const rule = {
    id: Date.now(),
    name,
    condType: document.getElementById('ruleCondType').value,
    condValue: document.getElementById('ruleCondValue').value,
    action: document.getElementById('ruleAction').value,
    scope: document.getElementById('ruleScope').value,
    notifyBrowser: document.getElementById('ruleNotifyBrowser').checked,
    notifyLog: document.getElementById('ruleNotifyLog').checked,
    enabled: true,
    createdAt: Date.now()
  };
  rules.unshift(rule);
  localStorage.setItem('gz_auto_rules', JSON.stringify(rules));
  closeRuleModal();
  renderRules();
  document.getElementById('countRules').textContent = rules.length;
  GZ.toast('ƒê√£ l∆∞u quy t·∫Øc!', 'success');
}

function deleteRule(id) {
  rules = rules.filter(r => r.id !== id);
  localStorage.setItem('gz_auto_rules', JSON.stringify(rules));
  renderRules();
  document.getElementById('countRules').textContent = rules.length;
  GZ.toast('ƒê√£ x√≥a quy t·∫Øc', 'info');
}

function toggleRule(id) {
  const r = rules.find(r => r.id === id);
  if (r) { r.enabled = !r.enabled; localStorage.setItem('gz_auto_rules', JSON.stringify(rules)); renderRules(); }
}

function applyPreset(type) {
  const presets = {
    spend_spike: { name: 'T·∫Øt khi th·ªëc ti·ªÅn ƒë·ªôt ng·ªôt', condType: 'spend_spike', condValue: '50', action: 'pause_campaign' },
    high_cpc: { name: 'T·∫Øt khi CPC qu√° ƒë·∫Øt', condType: 'cpc_above', condValue: '50000', action: 'pause_ad' },
    low_balance: { name: 'C·∫£nh b√°o s·∫Øp h·∫øt ti·ªÅn', condType: 'balance_below', condValue: '500000', action: 'notify_only' },
    account_disabled: { name: 'T√†i kho·∫£n b·ªã v√¥ hi·ªáu h√≥a', condType: 'account_disabled', condValue: '0', action: 'pause_campaign' }
  };
  const p = presets[type];
  if (!p) return;
  document.getElementById('ruleName').value = p.name;
  document.getElementById('ruleCondType').value = p.condType;
  document.getElementById('ruleCondValue').value = p.condValue;
  document.getElementById('ruleAction').value = p.action;
  openRuleModal();
}

function updateCondUnit() {
  const type = document.getElementById('ruleCondType').value;
  const units = { spend_spike: '%', cpc_above: 'VND', cpm_above: 'VND', ctr_below: '%', balance_below: 'VND', spend_above: 'VND', account_disabled: '', no_conversion: 'gi·ªù' };
  document.getElementById('condUnit').textContent = units[type] || '';
}

function renderRules() {
  const el = document.getElementById('rulesList');
  document.getElementById('countRules').textContent = rules.length;
  if (!rules.length) {
    el.innerHTML = '<div style="text-align:center;padding:30px;color:rgba(255,255,255,.3);font-size:13px">Ch∆∞a c√≥ quy t·∫Øc n√†o. T·∫°o quy t·∫Øc ho·∫∑c ch·ªçn preset b√™n tr√™n.</div>';
    return;
  }
  el.innerHTML = rules.map(r => `
    <div style="background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.07);border-radius:10px;padding:12px 16px;margin-bottom:8px;display:flex;align-items:center;gap:12px">
      <div style="flex:1">
        <div style="font-weight:600;font-size:13px">${r.name}</div>
        <div style="font-size:11.5px;color:rgba(255,255,255,.4);margin-top:3px">${r.condType} > ${r.condValue} ‚Üí ${r.action}</div>
      </div>
      <label style="display:flex;align-items:center;gap:5px;cursor:pointer;font-size:12px;color:${r.enabled ? '#4ade80' : 'rgba(255,255,255,.3)'}">
        <input type="checkbox" ${r.enabled ? 'checked' : ''} onchange="toggleRule(${r.id})" style="accent-color:#4ade80"> ${r.enabled ? 'B·∫≠t' : 'T·∫Øt'}
      </label>
      <button onclick="deleteRule(${r.id})" style="background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.2);border-radius:6px;padding:4px 10px;color:#f87171;cursor:pointer;font-size:12px"><i class="bi bi-trash"></i></button>
    </div>`).join('');
}

// -- Edit Timezone Modal ------------------------------------------------------
function openEditTzModal(accountId, accountName) {
  document.getElementById('editTzModal').classList.add('open');
  document.getElementById('editTzAccName').textContent = accountName;
  const acc = allAccounts.find(a => a.id === accountId);
  if (acc) {
    document.getElementById('currentCountryDisplay').textContent = acc.country || '‚Äî';
    document.getElementById('currentTzDisplay').textContent = acc.timezone_name || '‚Äî';
    if (acc.country) document.getElementById('editCountry').value = acc.country;
    if (acc.timezone_name) document.getElementById('editTimezone').value = acc.timezone_name;
  }
  document.getElementById('editTzModal').dataset.accountId = accountId;
}

function closeEditTzModal() {
  document.getElementById('editTzModal').classList.remove('open');
}

async function saveTimezone() {
  const accountId = document.getElementById('editTzModal').dataset.accountId;
  const country = document.getElementById('editCountry').value;
  const tz = document.getElementById('editTimezone').value;
  const token = getToken();
  if (!token) { GZ.toast('C·∫ßn token ƒë·ªÉ c·∫≠p nh·∫≠t', 'error'); return; }
  try {
    const resp = await fetch(`${FB_GRAPH}/${accountId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ access_token: token, timezone_id: tz, country: country })
    });
    const data = await resp.json();
    if (data.error) throw new Error(data.error.message);
    closeEditTzModal();
    loadAccounts();
    GZ.toast('ƒê√£ c·∫≠p nh·∫≠t m√∫i gi·ªù!', 'success');
  } catch(e) {
    GZ.toast('L·ªói: ' + e.message, 'error');
  }
}

// -- Misc ---------------------------------------------------------------------
function toggleSubNav(e, id) {
  e.preventDefault();
  const el = document.getElementById(id);
  const arrow = document.getElementById(id + 'Arrow');
  if (el) { const open = el.style.display !== 'none'; el.style.display = open ? 'none' : 'flex'; if(arrow) arrow.style.transform = open ? '' : 'rotate(180deg)'; }
}

function openSettings() { if(window.GZ?.openSettings) window.GZ.openSettings(); }

// -- Init ---------------------------------------------------------------------
document.addEventListener('DOMContentLoaded', () => {
  updateTokenUI();
  const token = getToken();
  if (token) {
    loadAccounts();
  } else {
    setTableMsg('accounts', 'üîë Ch∆∞a c√≥ token ‚Äî nh·∫•n n√∫t <strong style="color:#fbbf24"><i class="bi bi-key"></i> Token</strong> ·ªü g√≥c tr√™n ph·∫£i ƒë·ªÉ nh·∫≠p Facebook Access Token');
  }
  renderRules();
  // ƒê√≥ng modal khi click ngo√†i
  ['tokenModal','ruleModal','editTzModal'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('click', e => { if (e.target === el) el.classList.remove('open'); });
  });
});
</script>

<script id="gz-universe-bg">
(function(){
  'use strict';
  const isMobile = /Mobi|Android/i.test(navigator.userAgent);

  // -- Stars Canvas --
  const cs = document.getElementById('gz-stars');
  if (!cs) return;
  const ctxS = cs.getContext('2d');
  function resizeS(){ cs.width=window.innerWidth; cs.height=window.innerHeight; }
  resizeS();
  const stars = [];
  const N = isMobile ? 80 : 180;
  for(let i=0;i<N;i++){
    stars.push({
      x: Math.random()*cs.width, y: Math.random()*cs.height,
      r: Math.random()*1.6+0.2,
      a: Math.random(), da: (Math.random()-0.5)*0.004,
      vx: (Math.random()-0.5)*0.07, vy: (Math.random()-0.5)*0.07,
      hue: [210,195,270,180][Math.floor(Math.random()*4)] // xanh d∆∞∆°ng, cyan, t√≠m, xanh l√°
    });
  }
  function animStars(){
    ctxS.clearRect(0,0,cs.width,cs.height);
    stars.forEach(s=>{
      s.x+=s.vx; s.y+=s.vy; s.a+=s.da;
      if(s.a<0.08) s.da=Math.abs(s.da);
      if(s.a>0.95) s.da=-Math.abs(s.da);
      if(s.x<0) s.x=cs.width; if(s.x>cs.width) s.x=0;
      if(s.y<0) s.y=cs.height; if(s.y>cs.height) s.y=0;
      const g=ctxS.createRadialGradient(s.x,s.y,0,s.x,s.y,s.r*2.5);
      g.addColorStop(0,`hsla(${s.hue},100%,90%,${s.a*0.9})`);
      g.addColorStop(0.5,`hsla(${s.hue},100%,70%,${s.a*0.4})`);
      g.addColorStop(1,`hsla(${s.hue},100%,60%,0)`);
      ctxS.fillStyle=g;
      ctxS.beginPath(); ctxS.arc(s.x,s.y,s.r*2.5,0,Math.PI*2); ctxS.fill();
    });
    requestAnimationFrame(animStars);
  }
  animStars();

  // -- Data Particles Canvas --
  const cp = document.getElementById('gz-particles');
  if(!cp) return;
  const ctxP = cp.getContext('2d');
  function resizeP(){ cp.width=window.innerWidth; cp.height=window.innerHeight; }
  resizeP();
  const parts = [];
  const NP = isMobile ? 8 : 18;
  for(let i=0;i<NP;i++){
    parts.push({
      x:0, y:0,
      r: Math.random()*2.5+1,
      cx: Math.random()*cp.width, cy: Math.random()*cp.height,
      rx: Math.random()*120+40, ry: Math.random()*120+40,
      angle: Math.random()*Math.PI*2,
      speed: Math.random()*0.008+0.004,
      pulse: Math.random()*Math.PI*2, ps: Math.random()*0.02+0.01,
      color: [[24,119,242],[0,212,255],[139,92,246],[6,182,212]][Math.floor(Math.random()*4)]
    });
  }
  function animParts(){
    ctxP.clearRect(0,0,cp.width,cp.height);
    parts.forEach(p=>{
      p.angle+=p.speed;
      p.x=p.cx+Math.cos(p.angle)*p.rx;
      p.y=p.cy+Math.sin(p.angle)*p.ry;
      p.pulse+=p.ps;
      const ps=1+Math.sin(p.pulse)*0.5;
      const [r,g,b]=p.color;
      const grd=ctxP.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r*ps*4);
      grd.addColorStop(0,`rgba(${r},${g},${b},${0.75*ps})`);
      grd.addColorStop(0.4,`rgba(${r},${g},${b},${0.3*ps})`);
      grd.addColorStop(1,`rgba(${r},${g},${b},0)`);
      ctxP.fillStyle=grd;
      ctxP.beginPath(); ctxP.arc(p.x,p.y,p.r*ps*4,0,Math.PI*2); ctxP.fill();
    });
    requestAnimationFrame(animParts);
  }
  animParts();

  // -- Custom Cursor --
  const cur=document.getElementById('custom-cursor');
  if(cur && !('ontouchstart' in window)){
    let mx=0,my=0,cx=0,cy=0,shown=false;
    document.body.style.cursor='none';
    document.addEventListener('mousemove',e=>{
      mx=e.clientX; my=e.clientY;
      if(!shown){ shown=true; cur.style.opacity='1'; }
    });
    document.addEventListener('mouseleave',()=>{ shown=false; cur.style.opacity='0'; });
    function animCur(){ if(shown){ cx+=(mx-cx)*0.15; cy+=(my-cy)*0.15; cur.style.left=cx+'px'; cur.style.top=cy+'px'; } requestAnimationFrame(animCur); }
    animCur();
  }

  // -- Resize handler --
  window.addEventListener('resize',()=>{ resizeS(); resizeP(); });
})();
</script>
</body>
</html>
